////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

// Хранит дерево кнопок подменю заполнение ТЧ
Перем мКнопкиЗаполненияТЧ;

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// Процедура устанавливает подменю "Заполнить" в командных панелях ТЧ документа при необходимости
//
Процедура УстановитьКнопкиПодменюЗаполненияТЧ();
	
	мКнопкиЗаполненияТЧ = УниверсальныеМеханизмы.ПолучитьДеревоКнопокЗаполненияТабличныхЧастей(Ссылка,Новый Действие("НажатиеНаДополнительнуюКнопкуЗаполненияТЧ"));
	
	СоответствиеТЧ = Новый Соответствие;
	СоответствиеТЧ.Вставить(ЭлементыФормы.СоответствиеСчетовБУиНУ,ЭлементыФормы.КоманднаяПанельСоответствиеСчетов.Кнопки.ПодменюЗаполнить);
	
	УниверсальныеМеханизмы.СформироватьПодменюЗаполненияТЧПоДеревуКнопок(мКнопкиЗаполненияТЧ,СоответствиеТЧ);
	
КонецПроцедуры

// Процедура - обработчик события "ПередОткрытием" формы.
//
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	// Установка кнопок заполнение ТЧ
	УстановитьКнопкиПодменюЗаполненияТЧ();
	
	
КонецПроцедуры // ПередОткрытием()

// Обработчик события ПриОткрытии формы.
//
Процедура ПриОткрытии()
	
	
	Если НЕ ЭтоНовый() Тогда 
		НастройкаПравДоступа.ОпределитьДоступностьВозможностьИзмененияДокументаПоДатеЗапрета(ДокументОбъект, ЭтаФорма);
	КонецЕсли;
	
	Если ЭтоНовый() Тогда 
		ЗаполнениеДокументов.ЗаполнитьШапкуДокумента(ЭтотОбъект);
	КонецЕсли;
	
	// Вывести в заголовке формы вид операции.
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	
	МеханизмНумерацииОбъектов.ДобавитьВМенюДействияКнопкуРедактированияНомера(ЭлементыФормы.ДействияФормы.Кнопки.Подменю);
	МеханизмНумерацииОбъектов.УстановитьДоступностьПоляВводаНомера(Метаданные(), ЭтаФорма, ЭлементыФормы.ДействияФормы.Кнопки.Подменю,ЭлементыФормы.Номер);
	
	
	// Создать кнопки печати
	ФормированиеПечатныхФорм.СоздатьКнопкиПечати(ЭтотОбъект, ЭтаФорма);
	РаботаСДиалогами.АктивизироватьРеквизитВФорме(ЭтотОбъект, ЭтаФорма);
	
КонецПроцедуры // ПриОткрытии

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Процедура заполняет Табличную часть "СоответствиеСчетовБУиНУ"
// из РегистрСведений.СоответствиеСчетовБУиНУ
// по состоянию на дату документа
//
Процедура ЗаполнитьСоответствиеСчетовБУиНУпоСостояниюНаДату()
	
	Если СоответствиеСчетовБУиНУ.Количество() > 0 Тогда
		Ответ = Вопрос("Таблица будет очищена. Продолжить?", РежимДиалогаВопрос.ОКОтмена);
		Если Ответ <> КодВозвратаДиалога.ОК  Тогда
			Возврат;
		КонецЕсли; 
	КонецЕсли; 
	
	Запрос = Новый Запрос();
	
	Запрос.Текст = "
	|ВЫБРАТЬ *
	|ИЗ
	|	РегистрСведений.СоответствиеСчетовБУиНУ.СрезПоследних(&ДатаСреза) КАК СоответствиеСчетовБУиНУ
	|Где Учитывается";
	
	Запрос.УстановитьПараметр("ДатаСреза", Дата);
	
	СоответствиеСчетовБУиНУ.Загрузить(Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры 

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Процедура установливет все флажки (реквизит "Учитывается")
// Табличной части 
// 
Процедура КоманднаяПанельСоответствиеСчетовУстановитьФлажки(Кнопка)
	Для каждого Строка Из СоответствиеСчетовБУиНУ Цикл
		Строка.Учитывается = Истина;
	КонецЦикла; 
КонецПроцедуры

// Процедура снимает все флажки (реквизит "Учитывается")
// Табличной части 
// 
Процедура КоманднаяПанельСоответствиеСчетовСнятьФлажки(Кнопка)
	Для каждого Строка Из СоответствиеСчетовБУиНУ Цикл
		Строка.Учитывается = Ложь;
	КонецЦикла; 
КонецПроцедуры

// Процедура вызывает заполнение Табличной части  "СоответствиеСчетовБУиНУ"
// из РегистрСведений.СоответствиеСчетовБУиНУ
// по умолчанию
//
Процедура КоманднаяПанельСоответствиеСчетовЗаполнитьПоУмолчанию(Кнопка)
	
	Если СоответствиеСчетовБУиНУ.Количество() > 0 Тогда
		Ответ = Вопрос("Таблица будет очищена. Продолжить?", РежимДиалогаВопрос.ОКОтмена);
		Если Ответ <> КодВозвратаДиалога.ОК  Тогда
			Возврат;
		КонецЕсли; 
	КонецЕсли; 
	
	ЗаполнитьСоответствиеСчетовБУиНУпоУмолчанию();
	
КонецПроцедуры

// Процедура вызывает заполнение Табличной части  "СоответствиеСчетовБУиНУ"
// из РегистрСведений.СоответствиеСчетовБУиНУ
// по состоянию на дату документа
//
Процедура КоманднаяПанельСоответствиеСчетовПоТекущемуСоответствию(Кнопка)
	
	ЗаполнитьСоответствиеСчетовБУиНУпоСостояниюНаДату()
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ТЧ

// Процедура - обработчик события "ПриНачалеРедактирования" 
// Табличной части
// Устанавливает реквизит "Учитывается" для новой строки
//
Процедура СоответствиеСчетовБУиНУПриНачалеРедактирования(Элемент, НоваяСтрока)
	Если НоваяСтрока Тогда
		ТекущиеДанные = ЭлементыФормы.СоответствиеСчетовБУиНУ.ТекущиеДанные;
		ТекущиеДанные.Учитывается = Истина;
	КонецЕсли; 
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ТЧ
 
Процедура ДействияФормыРедактироватьНомер(Кнопка)
	МеханизмНумерацииОбъектов.ИзменениеВозможностиРедактированияНомера(ЭтотОбъект.Метаданные(), ЭтаФорма, ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
КонецПроцедуры

// Процедура вызова структуры подчиненности документа
Процедура ДействияФормыСтруктураПодчиненностиДокумента(Кнопка)
	РаботаСДиалогами.ПоказатьСтруктуруПодчиненностиДокумента(Ссылка);
КонецПроцедуры

// Процедура - обработчик нажатия на любую из дополнительных кнопок по заполнению ТЧ
//
Процедура НажатиеНаДополнительнуюКнопкуЗаполненияТЧ(Кнопка)
	
	УниверсальныеМеханизмы.ОбработатьНажатиеНаДополнительнуюКнопкуЗаполненияТЧ(мКнопкиЗаполненияТЧ.Строки.Найти(Кнопка.Имя,"Имя",Истина),ЭтотОбъект);
	
КонецПроцедуры

// Процедура - обработчик нажатия на кнопку "Печать".
// Открывает форму выбора печатных форм объекта.
//
Процедура ОсновныеДействияФормыПечать(Кнопка)
	
	УниверсальныеМеханизмы.ОткрытьФормуВыбораПечатныхФормОбъекта(ЭтотОбъект, ЭтаФорма);
	
КонецПроцедуры // ОсновныеДействияФормыПечать() 

// Процедура - обработчик нажатия на кнопку "Печать по умолчанию"
//
Процедура ОсновныеДействияФормыПечатьПоУмолчанию(Кнопка)

	УниверсальныеМеханизмы.НапечататьДокументПоУмолчанию(ЭтотОбъект);

КонецПроцедуры

Процедура ПослеЗаписи()
	
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	МеханизмНумерацииОбъектов.ОбновитьПодсказкуКодНомерОбъекта(ЭтотОбъект.Метаданные(), ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
	
КонецПроцедуры