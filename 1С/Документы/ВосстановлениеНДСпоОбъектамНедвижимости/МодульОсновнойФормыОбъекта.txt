////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

// Хранит текущую дату документа - для проверки перехода документа в другой период установки номера
Перем мТекущаяДатаДокумента;

// Хранит дерево кнопок подменю заполнение ТЧ
Перем мКнопкиЗаполненияТЧ;

Перем СтруктураОтбораСФ;

Перем СоответствиеВидовЦенности;

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Процедура устанавливает подменю "Заполнить" в командных панелях ТЧ документа при необходимости
//
Процедура УстановитьКнопкиПодменюЗаполненияТЧ();
	
	мКнопкиЗаполненияТЧ = УниверсальныеМеханизмы.ПолучитьДеревоКнопокЗаполненияТабличныхЧастей(Ссылка,Новый Действие("НажатиеНаДополнительнуюКнопкуЗаполненияТЧ"));
	
	СоответствиеТЧ = Новый Соответствие;
	СоответствиеТЧ.Вставить(ЭлементыФормы.ОбъектыНедвижимости, ЭлементыФормы.КоманднаяПанельОбъектыНедвижимости.Кнопки.ПодменюЗаполнить);
	СоответствиеТЧ.Вставить(ЭлементыФормы.СчетаФактуры, ЭлементыФормы.КоманднаяПанельСчетаФактуры.Кнопки.ПодменюЗаполнить);
	
	УниверсальныеМеханизмы.СформироватьПодменюЗаполненияТЧПоДеревуКнопок(мКнопкиЗаполненияТЧ,СоответствиеТЧ);
	
КонецПроцедуры

// Процедура - обработчик нажатия на кнопку "Печать".
// Открывает форму выбора печатных форм объекта.
//
Процедура ОсновныеДействияФормыПечать(Кнопка)
	
	УниверсальныеМеханизмы.ОткрытьФормуВыбораПечатныхФормОбъекта(ЭтотОбъект, ЭтаФорма);
	
КонецПроцедуры // ОсновныеДействияФормыПечать() 

// Процедура - обработчик нажатия на кнопку "Печать по умолчанию"
//
Процедура ОсновныеДействияФормыПечатьПоУмолчанию(Кнопка)

	УниверсальныеМеханизмы.НапечататьДокументПоУмолчанию(ЭтотОбъект);

КонецПроцедуры
 
// Возврат - сумма к восстановлению
// Сумма - общая сумма
// ДоляВыручки - процент выручки, не облагаемый НДС
Функция ПолучитьСуммуВосстановления(Сумма, ДоляВыручки)
	
	Возврат Сумма * (ДоляВыручки/100) / 10;
	
КонецФункции

// Процедура заполняет счет налогового учета на основании счета и аналитики бухгалтерского учета.
//
Процедура ЗаполнитьСчетНалоговогоУчетаВШапке(ИзменениеСубконто = ЛОЖЬ)
	
	Если ТипЗнч(СубконтоСписанияНДС1) = Тип("СправочникСсылка.СтатьиЗатрат") Тогда
		ВидЗатратНУ = СубконтоСписанияНДС1.ВидРасходовНУ;
	ИначеЕсли ТипЗнч(СубконтоСписанияНДС2) = Тип("СправочникСсылка.СтатьиЗатрат") Тогда
		ВидЗатратНУ = СубконтоСписанияНДС2.ВидРасходовНУ;
	ИначеЕсли ТипЗнч(СубконтоСписанияНДС3) = Тип("СправочникСсылка.СтатьиЗатрат") Тогда
		ВидЗатратНУ = СубконтоСписанияНДС3.ВидРасходовНУ;
	ИначеЕсли ИзменениеСубконто Тогда
		Возврат;
	Иначе
		ВидЗатратНУ = Перечисления.ВидыРасходовНУ.ПустаяСсылка();
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ВидЗатратНУ) Тогда
		СчетСписанияНДСНУ = БухгалтерскийУчет.ПреобразоватьСчетаБУвСчетНУ(Новый Структура("СчетБУ, ВидЗатратНУ", СчетСписанияНДС, ВидЗатратНУ));
	Иначе
		СчетСписанияНДСНУ = БухгалтерскийУчет.ПреобразоватьСчетаБУвСчетНУ(Новый Структура("СчетБУ, ", СчетСписанияНДС));
	КонецЕсли;
	Если ОтражатьВНалоговомУчете Тогда
		РаботаСДиалогами.ПриВыбореСчета(СчетСписанияНДСНУ, 	ЭлементыФормы.СубконтоСписанияНДСНУ1, ЭлементыФормы.НадписьСубконтоСписанияНДСНУ1,
		                         			ЭлементыФормы.СубконтоСписанияНДСНУ2, ЭлементыФормы.НадписьСубконтоСписанияНДСНУ2,
		                         			ЭлементыФормы.СубконтоСписанияНДСНУ3, ЭлементыФормы.НадписьСубконтоСписанияНДСНУ3);
	КонецЕсли;
	
КонецПроцедуры // ЗаполнитьСчетНалоговогоУчетаВШапке()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ВНЕШНИМ ВИДОМ ФОРМЫ

Процедура УстановитьЗаголовокГруппыСчетаФактуры()
	
	ТекущиеДанные = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		ЭлементыФормы.РамкаГруппыСчетаФактуры.Заголовок = "Счета-фактуры";
	Иначе
		НаименоваениеОбъекта = ?(НЕ ЗначениеЗаполнено(ТекущиеДанные.ОбъектНедвижимости), "объект недвижимости не выбран", ТекущиеДанные.ОбъектНедвижимости);
		ЭлементыФормы.РамкаГруппыСчетаФактуры.Заголовок = "Счета-фактуры (" + НаименоваениеОбъекта + ")";
	КонецЕсли;
	
		
КонецПроцедуры	

Процедура ОтобразитьСчетаФактуры()
	
	ТекущиеДанные = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено Тогда
		
		// Включаем отбор ключу из текущей строки табличной части "ОбъектыНедвижимости"
		ЭлементыФормы.СчетаФактуры.ТолькоПросмотр = Ложь;
		ЭлементыФормы.СчетаФактуры.ОтборСтрок.КлючСтроки.Значение = ТекущиеДанные.КлючСтроки;

	Иначе
		
		// Текущая строка в таблице косвенных расходов не установлена
		ЭлементыФормы.СчетаФактуры.ТолькоПросмотр = Истина;
		Если ОбъектыНедвижимости.Количество() = 0 Тогда
			Если СчетаФактуры.Количество() <> 0 Тогда
				СчетаФактуры.Очистить();
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьВидимостьДоступность()
	
	ЭлементыФормы.ОтражатьВНалоговомУчете.Доступность = ОтражатьВосстановлениеВКнигеПродаж;
	
	ТекущиеДанныеОбъекты = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъекты <> Неопределено Тогда
		
		ЭлементыФормы.СчетаФактуры.Колонки.СуммаБезНДСВосстановлена.Видимость = ТекущиеДанныеОбъекты.ИспользуетсяДляОперацийНеОблагаемыхНДС;
		ЭлементыФормы.СчетаФактуры.Колонки.НДСВосстановлен.Видимость = ТекущиеДанныеОбъекты.ИспользуетсяДляОперацийНеОблагаемыхНДС;
		ЭлементыФормы.СчетаФактуры.Колонки.СчетФактура.АвтоОтметкаНезаполненного = ТекущиеДанныеОбъекты.ИспользуетсяДляОперацийНеОблагаемыхНДС;
		ЭлементыФормы.СчетаФактуры.Колонки.ВидЦенности.АвтоОтметкаНезаполненного = ТекущиеДанныеОбъекты.ИспользуетсяДляОперацийНеОблагаемыхНДС;
		ЭлементыФормы.СчетаФактуры.Колонки.КодОперацииДляДекларации.АвтоОтметкаНезаполненного = ТекущиеДанныеОбъекты.ИспользуетсяДляОперацийНеОблагаемыхНДС;
		ЭлементыФормы.КоманднаяПанельОбъектыНедвижимости.Кнопки.ПодменюЗаполнить.Кнопки.ЗаполнитьСуммыНДСПоСФвСтроке.Доступность = Истина;
		ЭлементыФормы.КоманднаяПанельСчетаФактуры.Кнопки.ПодменюЗаполнить.Кнопки.ПодборСчетовфактур.Доступность = Истина;
		
	Иначе
		
		ЭлементыФормы.СчетаФактуры.Колонки.СуммаБезНДСВосстановлена.Видимость = Ложь;
		ЭлементыФормы.СчетаФактуры.Колонки.НДСВосстановлен.Видимость = Ложь;
		ЭлементыФормы.КоманднаяПанельОбъектыНедвижимости.Кнопки.ПодменюЗаполнить.Кнопки.ЗаполнитьСуммыНДСПоСФвСтроке.Доступность = Ложь;
		ЭлементыФормы.КоманднаяПанельСчетаФактуры.Кнопки.ПодменюЗаполнить.Кнопки.ПодборСчетовфактур.Доступность = Ложь;
		
	КонецЕсли;
	
	ЭлементыФормы.ОбъектыНедвижимости.Колонки.СуммаНДСПоОбъектуНедвижимостиВосстановлена.Доступность = Не ОтражатьВосстановлениеВКнигеПродаж;
	ЭлементыФормы.ОбъектыНедвижимости.Колонки.СуммаНДСПоПодряднымРаботамВосстановлена.Доступность = Не ОтражатьВосстановлениеВКнигеПродаж;
	ЭлементыФормы.ОбъектыНедвижимости.Колонки.СуммаНДСПоСМРДляСобственногоПотребленияВосстановлена.Доступность = Не ОтражатьВосстановлениеВКнигеПродаж;
		
	РаботаСДиалогами.ПриВыбореСчета(СчетСписанияНДС, ЭлементыФормы.СубконтоСписанияНДС1, ЭлементыФормы.НадписьСубконтоСписанияНДС1,
							   			ЭлементыФормы.СубконтоСписанияНДС2, ЭлементыФормы.НадписьСубконтоСписанияНДС2,
						       			ЭлементыФормы.СубконтоСписанияНДС3, ЭлементыФормы.НадписьСубконтоСписанияНДС3);

	Если ОтражатьВНалоговомУчете Тогда
		ЭлементыФормы.НадписьСчетСписанияНДСНУ.Видимость		= Истина;
		ЭлементыФормы.СчетСписанияНДСНУ.Видимость				= Истина;
		РаботаСДиалогами.ПриВыбореСчета(СчетСписанияНДСНУ, ЭлементыФормы.СубконтоСписанияНДСНУ1, ЭлементыФормы.НадписьСубконтоСписанияНДСНУ1,
								 		ЭлементыФормы.СубконтоСписанияНДСНУ2, ЭлементыФормы.НадписьСубконтоСписанияНДСНУ2,
								 		ЭлементыФормы.СубконтоСписанияНДСНУ3, ЭлементыФормы.НадписьСубконтоСписанияНДСНУ3);
	Иначе
		ЭлементыФормы.НадписьСчетСписанияНДСНУ.Видимость		= Ложь;
		ЭлементыФормы.СчетСписанияНДСНУ.Видимость				= Ложь;
		ЭлементыФормы.СубконтоСписанияНДСНУ1.Видимость 			= Ложь;
		ЭлементыФормы.СубконтоСписанияНДСНУ2.Видимость 			= Ложь;
		ЭлементыФормы.СубконтоСписанияНДСНУ3.Видимость 			= Ложь;
		ЭлементыФормы.НадписьСубконтоСписанияНДСНУ1.Видимость 	= Ложь;
		ЭлементыФормы.НадписьСубконтоСписанияНДСНУ2.Видимость 	= Ложь;
		ЭлементыФормы.НадписьСубконтоСписанияНДСНУ3.Видимость 	= Ложь;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	// Установка кнопок заполнение ТЧ
	УстановитьКнопкиПодменюЗаполненияТЧ();

КонецПроцедуры

Процедура ПриОткрытии()
	
	
	Если НЕ ЭтоНовый() Тогда 
		НастройкаПравДоступа.ОпределитьДоступностьВозможностьИзмененияДокументаПоДатеЗапрета(ДокументОбъект, ЭтаФорма);
	КонецЕсли;
	
	Если ЭтоНовый() Тогда
		
		// Заполнить реквизиты значениями по умолчанию.
		ЗаполнениеДокументов.ЗаполнитьШапкуДокумента(ЭтотОбъект);
		
		ОтражатьВосстановлениеВКнигеПродаж = Истина;
		
		//Счета списания НДС по умолчанию
		СчетСписанияНДС = ПланыСчетов.Хозрасчетный.ПрочиеРасходыНеОблагаемыеЕНВД;
		СчетСписанияНДСНУ = ПланыСчетов.Налоговый.ПрочиеКосвенныеРасходы;
		
	КонецЕсли;
	
	мТекущаяДатаДокумента = Дата;
	
	УстановитьЗаголовокГруппыСчетаФактуры();
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	
	// Предполагается использовать отбор по таблице "СчетаФактуры"
	ЭлементыФормы.СчетаФактуры.ОтборСтрок.КлючСтроки.Использование = Истина;
	ЭлементыФормы.СчетаФактуры.ОтборСтрок.КлючСтроки.Значение = 0;
	
	ОтобразитьСчетаФактуры();
	УстановитьВидимостьДоступность();
	
	// Установить активный реквизит.
	РаботаСДиалогами.АктивизироватьРеквизитВФорме(ЭтотОбъект, ЭтаФорма);

	МеханизмНумерацииОбъектов.ДобавитьВМенюДействияКнопкуРедактированияНомера(ЭлементыФормы.ДействияФормы.Кнопки.Подменю);
	МеханизмНумерацииОбъектов.УстановитьДоступностьПоляВводаНомера(Метаданные(), ЭтаФорма, ЭлементыФормы.ДействияФормы.Кнопки.Подменю,ЭлементыФормы.Номер);
	
	// Создать кнопки печати
	ФормированиеПечатныхФорм.СоздатьКнопкиПечати(ЭтотОбъект, ЭтаФорма);
	
КонецПроцедуры

Процедура ПослеЗаписи()
	
	// Вывести в заголовке формы статус документа (новый, не проведен, проведен).
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	МеханизмНумерацииОбъектов.ОбновитьПодсказкуКодНомерОбъекта(ЭтотОбъект.Метаданные(), ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
	
КонецПроцедуры

// Процедура - обработчик нажатия на любую из дополнительных кнопок по заполнению ТЧ
//
Процедура НажатиеНаДополнительнуюКнопкуЗаполненияТЧ(Кнопка)
	
	УниверсальныеМеханизмы.ОбработатьНажатиеНаДополнительнуюКнопкуЗаполненияТЧ(мКнопкиЗаполненияТЧ.Строки.Найти(Кнопка.Имя,"Имя",Истина),ЭтотОбъект);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

Процедура ДействияФормыРедактироватьНомер(Кнопка)
	МеханизмНумерацииОбъектов.ИзменениеВозможностиРедактированияНомера(ЭтотОбъект.Метаданные(), ЭтаФорма, ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
КонецПроцедуры
// Процедура вызывается при выборе пункта подменю "Движения документа по регистрам" меню "Перейти".
// командной панели формы. Процедура отрабатывает печать движений документа по регистрам.
//
Процедура ДействияФормыДвиженияДокументаПоРегистрам(Кнопка)

	РаботаСДиалогами.НапечататьДвиженияДокумента(Ссылка);

КонецПроцедуры // ДействияФормыДвиженияДокументаПоРегистрам()

// Процедура вызова структуры подчиненности документа
Процедура ДействияФормыСтруктураПодчиненностиДокумента(Кнопка)
	РаботаСДиалогами.ПоказатьСтруктуруПодчиненностиДокумента(Ссылка);
КонецПроцедуры

// Процедура открывает журнал проводок БУ с отбором по текущему регистратору
//
Процедура ДействияФормыПроводкиДтКт(Кнопка)

	БухгалтерскийУчет.ОткрытьЖурналПроводок(Ссылка);

КонецПроцедуры

// Процедура открывает журнал проводок НУ с отбором по текущему регистратору
//
Процедура ДействияФормыПроводкиДтКтНУ(Кнопка)

	БухгалтерскийУчет.ОткрытьЖурналПроводок(Ссылка, "НУ");

КонецПроцедуры

Процедура КоманднаяПанельОбъектыНедвижимостиПодборОбъектыНедвижимости(Кнопка)
	
	ТекущиеДанныеОбъектыНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	ФормаПодбора = ПолучитьФорму("ФормаПодбораОбъектовНедвижимости");
	ФормаПодбора.ДокументОбъект = ДокументОбъект;
	Для Каждого СтрокаОбъектНедвижимости Из ОбъектыНедвижимости Цикл
		НоваяСтрока = ФормаПодбора.ОбъектыНедвижимостиПодбор.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаОбъектНедвижимости);
		НоваяСтрока.Выбран = Истина;
	КонецЦикла;
	Результат = ФормаПодбора.ОткрытьМодально();
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
		
	СтруктураОтбора = Новый Структура("ОбъектНедвижимости");
	Для Каждого СтрокаРезультата Из Результат Цикл
		
		СтруктураОтбора.ОбъектНедвижимости = СтрокаРезультата.ОбъектНедвижимости;
		СтрокиОбъектыНедвижимости = ОбъектыНедвижимости.НайтиСтроки(СтруктураОтбора);
		Если СтрокиОбъектыНедвижимости.Количество() <> 0 Тогда
			СтрокаРезультата.Выбран = Ложь;
			Для Каждого СтрокаОбъектНедвижимости Из СтрокиОбъектыНедвижимости Цикл
				ЗаполнитьЗначенияСвойств(СтрокаОбъектНедвижимости, СтрокаРезультата);
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого СтрокаРезультата Из Результат Цикл
		Если СтрокаРезультата.Выбран Тогда
			НоваяСтрока = ОбъектыНедвижимости.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаРезультата);
			// Инициализируем значение "КлючСтроки" для установки связи данной таблицы с таблицей 
			// "СчетаФактуры".
			// Значение должно быть уникальным
			НеУстановлено = Истина;
			Кандидат = ОбъектыНедвижимости.Количество();

			Пока НеУстановлено Цикл
				Если ОбъектыНедвижимости.Найти(Кандидат, "КлючСтроки") = Неопределено Тогда
					// Уникальное значение ключа
					НоваяСтрока.КлючСтроки = Кандидат;
					НеУстановлено = Ложь;
				Иначе
					// Такое значение ключа уже использовано
					Кандидат = Кандидат + 1;
				КонецЕсли;
			КонецЦикла;
			
		КонецЕсли;
	КонецЦикла;
	
	// Удалим ОСы, которые не были отобраны в форме подбора, но есть в ТЧ
	СтрокиКУдалению = Новый Массив;
	Для Каждого СтрокаОбъектНедвижимости ИЗ ОбъектыНедвижимости Цикл
		СтруктураОтбора.ОбъектНедвижимости = СтрокаОбъектНедвижимости.ОбъектНедвижимости;
		Если Результат.Найти(СтрокаОбъектНедвижимости.ОбъектНедвижимости, "ОбъектНедвижимости") = Неопределено Тогда
			СтруктураОтбораСФ.КлючСтроки = СтрокаОбъектНедвижимости.КлючСтроки;
			СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
			Для Каждого СтрокаКУдалению из СтрокиСчетаФактуры Цикл
				СчетаФактуры.Удалить(СтрокаКУдалению);
			КонецЦикла;
			СтрокиКУдалению.Добавить(СтрокаОбъектНедвижимости);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого СтрокаКУдалению из СтрокиКУдалению Цикл
		ОбъектыНедвижимости.Удалить(СтрокаКУдалению);
	КонецЦикла;
		
    ЗаполнитьСуммыПоСчетамФактурам();
	
	ОтобразитьСчетаФактуры();
	
КонецПроцедуры

Процедура КоманднаяПанельОбъектыНедвижимостиЗаполнитьДолюВыручки(Кнопка)

	Если ОбъектыНедвижимости.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ФормаВвода = ПолучитьФорму("ФормаВводаВыручки");
	
	ЕстьОбщаяДоля = Истина;
	ОбщаяДоля = ОбъектыНедвижимости[0].ДоляВыручкиНеОблагаемаяНДС;
	Для Каждого СтрокаОбъектНедвижимости Из ОбъектыНедвижимости Цикл
		Если ОбщаяДоля И СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС <> 0 Тогда
			ОбщаяДоля = СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС;
		КонецЕсли;
		Если СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС <> 0 И СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС <> ОбщаяДоля Тогда
			ЕстьОбщаяДоля = Ложь;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ЕстьОбщаяДоля Тогда
		ФормаВвода.ОбщаяВыручка = 100;
		ФормаВвода.ВыручкаНеОблагаемаяНДС = ОбщаяДоля;
		ФормаВвода.ДоляВыручкиНеОблагаемаяНДС = ОбщаяДоля;
	КонецЕсли;
	
	ДоляВыручки = ФормаВвода.ОткрытьМодально();
	Если ДоляВыручки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого СтрокаОбъектНедвижимости Из ОбъектыНедвижимости Цикл
		Если СтрокаОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС Тогда
			СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС = ДоляВыручки;
			СтруктураОтбораСФ.КлючСтроки = СтрокаОбъектНедвижимости.КлючСтроки;
			СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
			Для Каждого СтрокаСчетФактура Из СтрокиСчетаФактуры Цикл
				РассчитатьСуммыВосстановления(СтрокаОбъектНедвижимости, СтрокаСчетФактура);

			КонецЦикла;
			ЗаполнитьСуммыПоСчетамФактурамВСтроке(СтрокаОбъектНедвижимости);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанельСчетаФактурыПодборСчетовфактур(Кнопка)
	
	ТекущиеДанныеОбъектыНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	Если ТекущиеДанныеОбъектыНедвижимости = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(ТекущиеДанныеОбъектыНедвижимости.ОбъектНедвижимости) Тогда
		Предупреждение("В табличном поле ""Объекты недвижимости"" не указан объект недвижимости");
		Возврат;
	КонецЕсли;
	
	ФормаПодбора = ПолучитьФорму("ФормаПодбораСчетовФактур");
	ФормаПодбора.ДокументОбъект = ДокументОбъект;
	ФормаПодбора.ОсновноеСредство = ТекущиеДанныеОбъектыНедвижимости.ОбъектНедвижимости;
	СтруктураОтбораСФ.КлючСтроки = ТекущиеДанныеОбъектыНедвижимости.КлючСтроки;
	СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
	Для Каждого СтрокаСчетФактура Из СтрокиСчетаФактуры Цикл
		НоваяСтрока = ФормаПодбора.СчетаФактурыПодбор.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаСчетФактура);
		НоваяСтрока.Выбрана = Истина;
	КонецЦикла;
	Результат = ФормаПодбора.ОткрытьМодально();
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
		
	Результат.Колонки.Добавить("КлючСтроки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(10, 0)));
	Результат.ЗаполнитьЗначения(ТекущиеДанныеОбъектыНедвижимости.КлючСтроки, "КлючСтроки");
	
	СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
	Для Каждого СтрокаСчетФактура Из СтрокиСчетаФактуры Цикл
		СчетаФактуры.Удалить(СтрокаСчетФактура);
	КонецЦикла;	
	
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(Результат, СчетаФактуры);
	
	СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
	Для Каждого СтрокаСчетФактура Из СтрокиСчетаФактуры Цикл
		РассчитатьСуммыВосстановления(ТекущиеДанныеОбъектыНедвижимости, СтрокаСчетФактура);
	КонецЦикла;
	ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектыНедвижимости);
	
КонецПроцедуры

Процедура КоманднаяПанельОбъектыНедвижимостиЗаполнитьПараметрыОбъектовНедвижимости(Кнопка)
	
	Если ОбъектыНедвижимости.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	СтоимостьОбъектов = ПолучитьПараметрыОСпоСписку(ОбъектыНедвижимости.ВыгрузитьКолонку("ОбъектНедвижимости"));
	Если СтоимостьОбъектов.Количество() <> 0 Тогда
		
		СтруктураОтбора = Новый Структура("ОбъектНедвижимости");
		Для Каждого Объект Из СтоимостьОбъектов Цикл
			
			СтруктураОтбора.ОбъектНедвижимости = Объект.ОбъектНедвижимости;
			СтрокиОбъектыНедвижимости = ОбъектыНедвижимости.НайтиСтроки(СтруктураОтбора);
			Для Каждого СтрокаОбъектНедвижимости Из СтрокиОбъектыНедвижимости Цикл 
				ЗаполнитьЗначенияСвойств(СтрокаОбъектНедвижимости, Объект);
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЕсли;
		
КонецПроцедуры


Процедура КоманднаяПанельОбъектыНедвижимостиЗаполнитьСуммыНДСПоСФ(Кнопка)
	
	Ответ = Вопрос("Суммы вычетов и восстановления по объектам недвижимости будут заполнены по данным счетов-фактур. Вы уверены?", РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ЗаполнитьСуммыПоСчетамФактурам(Истина);
	КонецЕсли;
		
КонецПроцедуры

Процедура КоманднаяПанельОбъектыНедвижимостиЗаполнитьСуммыНДСПоСФвСтроке(Кнопка)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Ответ = Вопрос("Суммы вычетов и восстановления по «" + ТекущиеДанныеОбъектНедвижимости.ОбъектНедвижимости + "» будут заполнены по данным счетов-фактур. Вы уверены?", РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости, Истина);
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ШАПКИ

Процедура ДатаПриИзменении(Элемент)
	
	РаботаСДиалогами.ПроверитьНомерДокумента(ЭтотОбъект, мТекущаяДатаДокумента);
	МеханизмНумерацииОбъектов.ОбновитьПодсказкуКодНомерОбъекта(ЭтотОбъект.Метаданные(), ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
	мТекущаяДатаДокумента = Дата; // запомним текущую дату документа для контроля номера документа
	
КонецПроцедуры

Процедура ОрганизацияПриИзменении(Элемент)
	
	Если Не ПустаяСтрока(Номер) Тогда
		МеханизмНумерацииОбъектов.СброситьУстановленныйКодНомерОбъекта(ЭтотОбъект, "Номер", ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОтражатьВосстановлениеВКнигеПродажПриИзменении(Элемент)
	
	Если ОтражатьВосстановлениеВКнигеПродаж Тогда
		Ответ = Вопрос("При установке флага суммы вычетов и восстановления объектов недвижимости, которые используются для операций, не облагаемых НДС, будут заполнены по данным счетов-фактур. Вы уверены?", РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			Для Каждого СтрокаОбъектНедвижимости Из ОбъектыНедвижимости Цикл
				Если СтрокаОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС Тогда
					ЗаполнитьСуммыПоСчетамФактурамВСтроке(СтрокаОбъектНедвижимости);
				КонецЕсли;
			КонецЦикла;
		Иначе
			ОтражатьВосстановлениеВКнигеПродаж = Ложь;
		КонецЕсли;
	ИначеЕсли ОтражатьВНалоговомУчете Тогда
		ОтражатьВНалоговомУчете = Ложь;
	КонецЕсли;
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры

Процедура ОтражатьВНалоговомУчетеПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();

КонецПроцедуры

Процедура СчетСписанияНДСПриИзменении(Элемент)
		
	ЗаполнитьСчетНалоговогоУчетаВШапке();
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры

Процедура СчетСписанияНДСОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	СтандартнаяОбработка = БухгалтерскийУчет.СчетМожноИспользоватьВПроводках(ВыбранноеЗначение);

КонецПроцедуры

// Процедура - обработчик события "ПриИзменении" поля ввода СубконтоСписанияНДС1
//
Процедура СубконтоСписанияНДС1ПриИзменении(Элемент)
	
	ЗаполнитьСчетНалоговогоУчетаВШапке(Истина);
	Если ЗначениеЗаполнено(СчетСписанияНДСНУ) Тогда
		Если ТипЗнч(СубконтоСписанияНДСНУ1) = ТипЗнч(СубконтоСписанияНДС1) Тогда
			СубконтоСписанияНДСНУ1 = СубконтоСписанияНДС1;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // СубконтоСписанияНДС1ПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода СубконтоСписанияНДС2
//
Процедура СубконтоСписанияНДС2ПриИзменении(Элемент)
	
	ЗаполнитьСчетНалоговогоУчетаВШапке(Истина);
	Если ЗначениеЗаполнено(СчетСписанияНДСНУ) Тогда
		Если ТипЗнч(СубконтоСписанияНДСНУ2) = ТипЗнч(СубконтоСписанияНДС2) Тогда
			СубконтоСписанияНДСНУ2 = СубконтоСписанияНДС2;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // СубконтоСписанияНДС2ПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода СубконтоСписанияНДС3
//
Процедура СубконтоСписанияНДС3ПриИзменении(Элемент)
	
	ЗаполнитьСчетНалоговогоУчетаВШапке(Истина);
	Если ЗначениеЗаполнено(СчетСписанияНДСНУ) Тогда
		Если ТипЗнч(СубконтоСписанияНДСНУ3) = ТипЗнч(СубконтоСписанияНДС3) Тогда
			СубконтоСписанияНДСНУ3 = СубконтоСписанияНДС3;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры // СубконтоСписанияНДС3ПриИзменении()

// Процедура - обработчик события "ПриИзменении" поля ввода СчетСписанияНДСНУ.
//
Процедура СчетСписанияНДСНУПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры // СчетСписанияНДСНУПриИзменении()

// Процедура - обработчик события "ОбработкаВыбора" поля ввода СчетСписанияНДСНУ
//
Процедура СчетСписанияНДСНУОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	СтандартнаяОбработка = БухгалтерскийУчет.СчетМожноИспользоватьВПроводках(ВыбранноеЗначение);
	
КонецПроцедуры // СчетСписанияНДСНУОбработкаВыбора()

// Процедура - обработчик события "НачалоВыбора" поля ввода СубконтоСписанияНДС1
//
Процедура СубконтоСписанияНДС1НачалоВыбора(Элемент, СтандартнаяОбработка)

	БухгалтерскийУчет.ОбработатьВыборПервогоСубконто(Элемент, СтандартнаяОбработка, Организация);

КонецПроцедуры // СубконтоСписанияНДС1НачалоВыбора()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ТАБЛИЧНОГО ПОЛЯ ОБЪЕКТЫНЕДВИЖИМОСТИ

Процедура ЗаполнитьСуммыПоСчетамФактурамВСтроке(СтрокаОбъектНедвижимости, УчитыватьНеиспользуемые = Ложь)
	
	Если СтрокаОбъектНедвижимости = Неопределено 
		Или (Не УчитыватьНеиспользуемые И Не СтрокаОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС) Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураОтбораСФ.Вставить("КодОперацииДляДекларации");
	СтруктураОтбораСФ.КлючСтроки = СтрокаОбъектНедвижимости.КлючСтроки;
	
	Для Каждого ВидЦенности Из СоответствиеВидовЦенности Цикл
		
		СтруктураОтбораСФ.КодОперацииДляДекларации = ВидЦенности.Ключ;
		СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
		СтрокаОбъектНедвижимости[ВидЦенности.Значение] = 0;
		СтрокаОбъектНедвижимости[ВидЦенности.Значение + "Восстановлена"] = 0;
		Для Каждого СтрокаСчетФактура Из СтрокиСчетаФактуры Цикл
			
			СтрокаОбъектНедвижимости[ВидЦенности.Значение] = СтрокаОбъектНедвижимости[ВидЦенности.Значение] + СтрокаСчетФактура.НДС;
			СтрокаОбъектНедвижимости[ВидЦенности.Значение + "Восстановлена"] = СтрокаОбъектНедвижимости[ВидЦенности.Значение + "Восстановлена"] + СтрокаСчетФактура.НДСВосстановлен;
			
		КонецЦикла;
	КонецЦикла;
		
	СтруктураОтбораСФ.Удалить("КодОперацииДляДекларации");
	
КонецПроцедуры

Процедура ЗаполнитьСуммыПоСчетамФактурам(УчитыватьНеиспользуемые = Ложь)
	
	Для Каждого СтрокаОбъектНедвижимости Из ОбъектыНедвижимости Цикл
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(СтрокаОбъектНедвижимости, УчитыватьНеиспользуемые);
	КонецЦикла;

КонецПроцедуры
	
Процедура ОбъектыНедвижимостиПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		// Инициализируем значение "КлючСтроки" для установки связи данной таблицы с таблицей 
		// "СчетаФактуры".
		// Значение должно быть уникальным
		НеУстановлено = Истина;
		Кандидат = ОбъектыНедвижимости.Количество();

		Пока НеУстановлено Цикл
			Если ОбъектыНедвижимости.Найти(Кандидат, "КлючСтроки") = Неопределено Тогда
				// Уникальное значение ключа
				ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные.КлючСтроки = Кандидат;
				НеУстановлено = Ложь;
			Иначе
				// Такое значение ключа уже использовано
				Кандидат = Кандидат + 1;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ОтобразитьСчетаФактуры();

КонецПроцедуры

Процедура ОбъектыНедвижимостиПриАктивизацииСтроки(Элемент)

	УстановитьЗаголовокГруппыСчетаФактуры();
	
	ОтобразитьСчетаФактуры();
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиПриИзмененииФлажка(Элемент, Колонка)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущиеДанныеОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС Тогда
		Ответ = Вопрос("При установке флага суммы вычетов и восстановления будут заполнены по данным счетов-фактур. Вы уверены?", РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
		Иначе
			ТекущиеДанныеОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС = Ложь;
		КонецЕсли;
	Иначе
		ТекущиеДанныеОбъектНедвижимости.ДатаНачалаИспользованияДляОпераций = '00010101';
		ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС = 0;
		ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоПодряднымРаботамВосстановлена = 0;
		ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоСМРДляСобственногоПотребленияВосстановлена = 0;
		ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоОбъектуНедвижимостиВосстановлена = 0;
		СтруктураОтбораСФ.КлючСтроки = ТекущиеДанныеОбъектНедвижимости.КлючСтроки;
		СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
		Для Каждого СтрокаСчетФактура Из СтрокиСчетаФактуры Цикл
			СтрокаСчетФактура.СуммаБезНДСВосстановлена = 0;
			СтрокаСчетФактура.НДСВосстановлен = 0;
		КонецЦикла;
	КонецЕсли;
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиОбъектНедвижимостиПриИзменении(Элемент)
	
	УстановитьЗаголовокГруппыСчетаФактуры();
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиДоляВыручкиНеОблагаемаяНДСПриИзменении(Элемент)

	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураОтбораСФ.КлючСтроки = ТекущиеДанныеОбъектНедвижимости.КлючСтроки;
	СтрокиСчетаФактуры = СчетаФактуры.НайтиСтроки(СтруктураОтбораСФ);
	Для Каждого СтрокаСчетФактура Из СтрокиСчетаФактуры Цикл
		РассчитатьСуммыВосстановления(ТекущиеДанныеОбъектНедвижимости, СтрокаСчетФактура);
	КонецЦикла;
	
	Если ОтражатьВосстановлениеВКнигеПродаж Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
	Иначе
		ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоПодряднымРаботамВосстановлена = ПолучитьСуммуВосстановления(ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоПодряднымРаботам, ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
		ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоСМРДляСобственногоПотребленияВосстановлена = ПолучитьСуммуВосстановления(ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоСМРДляСобственногоПотребления, ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
		ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоОбъектуНедвижимостиВосстановлена = ПолучитьСуммуВосстановления(ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоОбъектуНедвижимости, ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиСуммаНДСПоПодряднымРаботамПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Или Не ТекущиеДанныеОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоПодряднымРаботамВосстановлена = ПолучитьСуммуВосстановления(
														ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоПодряднымРаботам,
														ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиСуммаНДСПоСМРДляСобственногоПотребленияПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Или Не ТекущиеДанныеОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоСМРДляСобственногоПотребленияВосстановлена = ПолучитьСуммуВосстановления(
														ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоСМРДляСобственногоПотребления,
														ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиСуммаНДСПоОбъектуНедвижимостиПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Или Не ТекущиеДанныеОбъектНедвижимости.ИспользуетсяДляОперацийНеОблагаемыхНДС Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоОбъектуНедвижимостиВосстановлена = ПолучитьСуммуВосстановления(
														ТекущиеДанныеОбъектНедвижимости.СуммаНДСПоОбъектуНедвижимости,
														ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	ОформлениеСтроки.Ячейки.ДатаНачалаИспользованияДляОпераций.ОтметкаНезаполненного = ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС И (ДанныеСтроки.ДатаНачалаИспользованияДляОпераций = '00010101');
	ОформлениеСтроки.Ячейки.СтоимостьОбъектаНедвижимости.ОтметкаНезаполненного = ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС И (ДанныеСтроки.СтоимостьОбъектаНедвижимости = 0);
	ОформлениеСтроки.Ячейки.СуммаНДСПоОбъектуНедвижимости.ТолькоПросмотр = ОтражатьВосстановлениеВКнигеПродаж И ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС;
	ОформлениеСтроки.Ячейки.СуммаНДСПоПодряднымРаботам.ТолькоПросмотр = ОтражатьВосстановлениеВКнигеПродаж И ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС;
	ОформлениеСтроки.Ячейки.СуммаНДСПоСМРДляСобственногоПотребления.ТолькоПросмотр = ОтражатьВосстановлениеВКнигеПродаж И ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС;
	ОформлениеСтроки.Ячейки.ДатаНачалаИспользованияДляОпераций.ТолькоПросмотр = Не ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС;
	ОформлениеСтроки.Ячейки.ДоляВыручкиНеОблагаемаяНДС.ТолькоПросмотр = Не ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС;
	ОформлениеСтроки.Ячейки.ДоляВыручкиНеОблагаемаяНДС.ОтметкаНезаполненного = ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС И ДанныеСтроки.ДоляВыручкиНеОблагаемаяНДС = 0;
	ОформлениеСтроки.Ячейки.СуммаНДСПоОбъектуНедвижимостиВосстановлена.ТолькоПросмотр = Не (Не ОтражатьВосстановлениеВКнигеПродаж И ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС);
	ОформлениеСтроки.Ячейки.СуммаНДСПоПодряднымРаботамВосстановлена.ТолькоПросмотр = Не (Не ОтражатьВосстановлениеВКнигеПродаж И ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС);
	ОформлениеСтроки.Ячейки.СуммаНДСПоСМРДляСобственногоПотребленияВосстановлена.ТолькоПросмотр = Не (Не ОтражатьВосстановлениеВКнигеПродаж И ДанныеСтроки.ИспользуетсяДляОперацийНеОблагаемыхНДС);
	
КонецПроцедуры

Процедура ОбъектыНедвижимостиПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)

	Если НоваяСтрока И ОтменаРедактирования Тогда
		Возврат;		
	КонецЕсли;
	
	ТекущиеДанныеОбъектНедвижимости = Элемент.ТекущиеДанные;
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураОтбора = Новый Структура("ОбъектНедвижимости", ТекущиеДанныеОбъектНедвижимости.ОбъектНедвижимости);
	СтрокиОбъектыНедвижимости = ОбъектыНедвижимости.НайтиСтроки(СтруктураОтбора);
	Если СтрокиОбъектыНедвижимости.Количество() <> 0 Тогда
		Для Каждого СтрокаОбъектНедвижимости Из СтрокиОбъектыНедвижимости Цикл
			Если СтрокаОбъектНедвижимости.НомерСтроки <> ТекущиеДанныеОбъектНедвижимости.НомерСтроки Тогда
				ОбщегоНазначения.СообщитьОбОшибке("В табличной части уже есть строка с указанным объектом недвижимости (строка № " + СтрокиОбъектыНедвижимости[0].НомерСтроки + ")", Отказ);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ТАБЛИЧНОГО ПОЛЯ СЧЕТАФАКТУРЫ

Процедура РассчитатьСуммыВосстановления(СтрокаОбъектНедвижимости, СтрокаСчетФактура)
	
	Если СтрокаСчетФактура = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если СтрокаОбъектНедвижимости = Неопределено Или СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС = 0 Тогда
		СтрокаСчетФактура.СуммаБезНДСВосстановлена = 0;
		СтрокаСчетФактура.НДСВосстановлен = 0;
	Иначе
		СтрокаСчетФактура.СуммаБезНДСВосстановлена = ПолучитьСуммуВосстановления(СтрокаСчетФактура.СуммаБезНДС, СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
		СтрокаСчетФактура.НДСВосстановлен = ПолучитьСуммуВосстановления(СтрокаСчетФактура.НДС, СтрокаОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	КонецЕсли;
	
КонецПроцедуры

Процедура СчетаФактурыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		ЭлементыФормы.СчетаФактуры.ТекущиеДанные.КлючСтроки = ЭлементыФормы.СчетаФактуры.ОтборСтрок.КлючСтроки.Значение;
	КонецЕсли;
	
КонецПроцедуры

Процедура СчетаФактурыСуммаБезНДСПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	ТекущиеДанныеСчетФактура = ЭлементыФормы.СчетаФактуры.ТекущиеДанные;
	
	Если ТекущиеДанныеСчетФактура = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанныеСчетФактура.НДС = УчетНДС.РассчитатьСуммуНДС(ТекущиеДанныеСчетФактура.СуммаБезНДС, Истина, Ложь, УчетНДС.ПолучитьСтавкуНДС(ТекущиеДанныеСчетФактура.СтавкаНДС));
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Или ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС = 0 Тогда
		ТекущиеДанныеСчетФактура.СуммаБезНДСВосстановлена = 0;
		ТекущиеДанныеСчетФактура.НДСВосстановлен = 0;
	Иначе
		ТекущиеДанныеСчетФактура.СуммаБезНДСВосстановлена = ПолучитьСуммуВосстановления(ТекущиеДанныеСчетФактура.СуммаБезНДС, ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
		ТекущиеДанныеСчетФактура.НДСВосстановлен = ПолучитьСуммуВосстановления(ТекущиеДанныеСчетФактура.НДС, ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	КонецЕсли;
	
	Если ТекущиеДанныеОбъектНедвижимости <> Неопределено Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
	КонецЕсли;	
	
КонецПроцедуры

Процедура СчетаФактурыСтавкаНДСПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	ТекущиеДанныеСчетФактура = ЭлементыФормы.СчетаФактуры.ТекущиеДанные;
	
	Если ТекущиеДанныеСчетФактура = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанныеСчетФактура.НДС = УчетНДС.РассчитатьСуммуНДС(ТекущиеДанныеСчетФактура.СуммаБезНДС, Истина, Ложь, УчетНДС.ПолучитьСтавкуНДС(ТекущиеДанныеСчетФактура.СтавкаНДС));
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Или ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС = 0 Тогда
		ТекущиеДанныеСчетФактура.НДСВосстановлен = 0;
	Иначе
		ТекущиеДанныеСчетФактура.НДСВосстановлен = ПолучитьСуммуВосстановления(ТекущиеДанныеСчетФактура.НДС, ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	КонецЕсли;
		
	Если ТекущиеДанныеОбъектНедвижимости <> Неопределено Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
	КонецЕсли;	
	
КонецПроцедуры

Процедура СчетаФактурыНДСПриИзменении(Элемент)

	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	ТекущиеДанныеСчетФактура = ЭлементыФормы.СчетаФактуры.ТекущиеДанные;
	
	Если ТекущиеДанныеСчетФактура = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущиеДанныеОбъектНедвижимости = Неопределено Или ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС = 0 Тогда
		ТекущиеДанныеСчетФактура.НДСВосстановлен = 0;
	Иначе
		ТекущиеДанныеСчетФактура.НДСВосстановлен = ПолучитьСуммуВосстановления(ТекущиеДанныеСчетФактура.НДС, ТекущиеДанныеОбъектНедвижимости.ДоляВыручкиНеОблагаемаяНДС);
	КонецЕсли;
	
	Если ТекущиеДанныеОбъектНедвижимости <> Неопределено Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
	КонецЕсли;	
	
КонецПроцедуры

Процедура СчетаФактурыВидЦенностиПриИзменении(Элемент)
	
	ТекущиеДанныеСчетФактура = ЭлементыФормы.СчетаФактуры.ТекущиеДанные;
	Если ТекущиеДанныеСчетФактура = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НовыйКодОперацииДляДекларации = ПолучитьКодОперацииДляДекларации(ТекущиеДанныеСчетФактура.ВидЦенности);
	Если НовыйКодОперацииДляДекларации <> Неопределено Тогда
		ТекущиеДанныеСчетФактура.КодОперацииДляДекларации = НовыйКодОперацииДляДекларации;
	КонецЕсли;
	
КонецПроцедуры

Процедура СчетаФактурыПослеУдаления(Элемент)
	
	ТекущаяСтрокаОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущаяСтрокаОбъектНедвижимости = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ОтражатьВосстановлениеВКнигеПродаж Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущаяСтрокаОбъектНедвижимости);
    КонецЕсли;
		
КонецПроцедуры

Процедура СчетаФактурыСуммаБезНДСВосстановленаПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;

	Если ТекущиеДанныеОбъектНедвижимости <> Неопределено Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
	КонецЕсли;	

КонецПроцедуры

Процедура СчетаФактурыНДСВосстановленПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъектНедвижимости <> Неопределено Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
	КонецЕсли;	
	
КонецПроцедуры

Процедура СчетаФактурыКодОперацииДляДекларацииПриИзменении(Элемент)
	
	ТекущиеДанныеОбъектНедвижимости = ЭлементыФормы.ОбъектыНедвижимости.ТекущиеДанные;
	
	Если ТекущиеДанныеОбъектНедвижимости <> Неопределено Тогда
		ЗаполнитьСуммыПоСчетамФактурамВСтроке(ТекущиеДанныеОбъектНедвижимости);
	КонецЕсли;	
	
КонецПроцедуры

Процедура СчетаФактурыСчетФактураНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	ТекущиеДанныеСчетФактура = ЭлементыФормы.СчетаФактуры.ТекущиеДанные;
	
	Если ТекущиеДанныеСчетФактура = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	Отбор = Новый Структура("Организация", Организация);
	Если ЗначениеЗаполнено(ТекущиеДанныеСчетФактура.Поставщик) Тогда
		Отбор.Вставить("Контрагент", ТекущиеДанныеСчетФактура.Поставщик);
	КонецЕсли;
	РаботаСДиалогами.НачалоВыбораЗначенияДокументаСоставногоТипа(ЭтотОбъект, ЭтаФорма, Элемент, СтандартнаяОбработка, Отбор, "СчетаФактуры");

КонецПроцедуры

Процедура СчетаФактурыДокументОплатыНачалоВыбора(Элемент, СтандартнаяОбработка)
		
	ТекущиеДанныеСчетФактура = ЭлементыФормы.СчетаФактуры.ТекущиеДанные;
	
	Если ТекущиеДанныеСчетФактура = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	Отбор = Новый Структура("Организация", Организация);
	Если ЗначениеЗаполнено(ТекущиеДанныеСчетФактура.Поставщик) Тогда
		Отбор.Вставить("Контрагент", ТекущиеДанныеСчетФактура.Поставщик);
	КонецЕсли;
	
	ОграничениеТипов = Новый Массив;
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ПлатежноеПоручениеИсходящее"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.РасходныйКассовыйОрдер"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ПлатежныйОрдерСписаниеДенежныхСредств"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ПлатежноеТребованиеПолученное"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.АккредитивПереданный"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ИнкассовоеПоручениеПолученное"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ГТДИмпорт"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.АвансовыйОтчет"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.КорректировкаДолга"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ОперацияБух"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ОтчетКомиссионераОПродажах"));
	ОграничениеТипов.Добавить(Тип("ДокументСсылка.ВводНачальныхОстатковНДС"));
	
	РаботаСДиалогами.НачалоВыбораЗначенияДокументаСоставногоТипа(ЭтотОбъект, ЭтаФорма, Элемент, СтандартнаяОбработка, Отбор, "СчетаФактуры", ОграничениеТипов);

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ

СтруктураОтбораСФ = Новый Структура("КлючСтроки");

СоответствиеВидовЦенности = Новый Соответствие;
СоответствиеВидовЦенности.Вставить(Перечисления.НДСКодыОперацийПоОбъектамНедвижимости.СМРПодрядные, "СуммаНДСПоПодряднымРаботам");
СоответствиеВидовЦенности.Вставить(Перечисления.НДСКодыОперацийПоОбъектамНедвижимости.СМРСобственные, "СуммаНДСПоСМРДляСобственногоПотребления");
СоответствиеВидовЦенности.Вставить(Перечисления.НДСКодыОперацийПоОбъектамНедвижимости.Приобретение, "СуммаНДСПоОбъектуНедвижимости");