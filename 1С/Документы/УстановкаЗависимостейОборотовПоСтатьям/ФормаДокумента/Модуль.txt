// Хранит дерево кнопок подменю заполнение ТЧ
Перем мКнопкиЗаполненияТЧ;




// Процедура устанавливает подменю "Заполнить" в командных панелях ТЧ документа при необходимости
//
Процедура УстановитьКнопкиПодменюЗаполненияТЧ();
	
	мКнопкиЗаполненияТЧ = УниверсальныеМеханизмы.ПолучитьДеревоКнопокЗаполненияТабличныхЧастей(Ссылка,Новый Действие("НажатиеНаДополнительнуюКнопкуЗаполненияТЧ"));
	
	СоответствиеТЧ = Новый Соответствие;
	СоответствиеТЧ.Вставить(ЭлементыФормы.ЗависимостиОборотовПоСтатьям,ЭлементыФормы.КоманднаяПанель1);
	
	УниверсальныеМеханизмы.СформироватьПодменюЗаполненияТЧПоДеревуКнопок(мКнопкиЗаполненияТЧ,СоответствиеТЧ);
	
КонецПроцедуры


// Изменяет доступность реквизитов формы в зависимости от внесенных значений
//
Процедура УправлениеДоступностьюРеквизитов()

	Если ЭлементыФормы.СтатьяОборотовВлияющая.Значение.РазделениеПоКонтрагентам Тогда

		ЭлементыФормы.Контрагент.Доступность=Истина;

	Иначе

		ЭлементыФормы.Контрагент.Значение="";
		ЭлементыФормы.Контрагент.Доступность=Ложь;
        		
	КонецЕсли;

	Если ЭлементыФормы.СтатьяОборотовВлияющая.Значение.РазделениеПоНоменклатуре Тогда

		ЭлементыФормы.Номенклатура.Доступность=Истина;

	Иначе

		ЭлементыФормы.Номенклатура.Значение="";
		ЭлементыФормы.Номенклатура.Доступность=Ложь;

	КонецЕсли;

	СписокРеквизитов= Новый СписокЗначений;
	
	Если ЭлементыФормы.СтатьяОборотовВлияющая.Значение.УчетПоКоличеству Тогда

		СписокРеквизитов.Добавить(Перечисления.РеквизитыДляРасчетаЗависимыхСтатейБюджета.Количество,"Количество");

	КонецЕсли;

	Если ЭлементыФормы.СтатьяОборотовВлияющая.Значение.УчетПоСумме Тогда

		СписокРеквизитов.Добавить(Перечисления.РеквизитыДляРасчетаЗависимыхСтатейБюджета.Сумма,"Сумма");

	КонецЕсли;

	ЭлементыФормы.ЗависимостиОборотовПоСтатьям.Колонки.РеквизитВлияющейСтатьиДляРасчетаКоличества.ЭлементУправления.СписокВыбора=СписокРеквизитов;
	ЭлементыФормы.ЗависимостиОборотовПоСтатьям.Колонки.РеквизитВлияющейСтатьиДляРасчетаСуммы.ЭлементУправления.СписокВыбора=СписокРеквизитов;

	
КонецПроцедуры // УправлениеДоступностьюРеквизитов()

Процедура СтатьяОборотовВлияющаяПриИзменении(Элемент)

	УправлениеДоступностьюРеквизитов();

КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)

	// Установка кнопок заполнение ТЧ
	УстановитьКнопкиПодменюЗаполненияТЧ();
	
	
    УправлениеДоступностьюРеквизитов();
	
КонецПроцедуры

Процедура ЗависимостиОборотовПоСтатьямСтатьяОборотовЗависимаяПриИзменении(Элемент)
	
	Если Элемент.Значение=ЭлементыФормы.СтатьяОборотовВлияющая.Значение Тогда
		
		Сообщить("Обнаружена циклическая зависимость статей!");
		Элемент.Значение="";
		
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	|	СтатьиОборотовПоБюджетам.УчетПоКоличеству,
	|	СтатьиОборотовПоБюджетам.УчетПоСумме,
	|	СтатьиОборотовПоБюджетам.РазделениеПоКонтрагентам,
	|	СтатьиОборотовПоБюджетам.РазделениеПоНоменклатуре
	|ИЗ
	|	Справочник.СтатьиОборотовПоБюджетам КАК СтатьиОборотовПоБюджетам
	|ГДЕ
	|	СтатьиОборотовПоБюджетам.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка",Элемент.Значение);
	Результат=Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() Тогда
		
		Если Не Результат.РазделениеПоКонтрагентам Тогда
			ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.ЗависимыйКонтрагент=Справочники.Контрагенты.ПустаяСсылка();
		КонецЕсли;
		
		Если Не Результат.РазделениеПоНоменклатуре Тогда
			ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.ЗависимаяНоменклатура=Неопределено;
		КонецЕсли;
		
		Если Не Результат.УчетПоСумме Тогда
			ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.РеквизитВлияющейСтатьиДляРасчетаСуммы=Перечисления.РеквизитыДляРасчетаЗависимыхСтатейБюджета.ПустаяСсылка();
			ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.КоэффициентДляРасчетаСуммы=0;
		КонецЕсли;
		
		Если Не Результат.УчетПоКоличеству Тогда
			ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.РеквизитВлияющейСтатьиДляРасчетаКоличества=Перечисления.РеквизитыДляРасчетаЗависимыхСтатейБюджета.ПустаяСсылка();
			ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.КоэффициентДляРасчетаКоличества=0;
		КонецЕсли;
		
	Иначе
		ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.ЗависимыйКонтрагент=Справочники.Контрагенты.ПустаяСсылка();
        ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.ЗависимаяНоменклатура=Неопределено;
		ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.РеквизитВлияющейСтатьиДляРасчетаСуммы=Перечисления.РеквизитыДляРасчетаЗависимыхСтатейБюджета.ПустаяСсылка();
		ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.КоэффициентДляРасчетаСуммы=0;
		ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.РеквизитВлияющейСтатьиДляРасчетаКоличества=Перечисления.РеквизитыДляРасчетаЗависимыхСтатейБюджета.ПустаяСсылка();
		ЭлементыФормы.ЗависимостиОборотовПоСтатьям.ТекущиеДанные.КоэффициентДляРасчетаКоличества=0;
	КонецЕсли;
	
КонецПроцедуры


Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если Ответственный.Пустая() Тогда
		Ответственный = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнойОтветственный");
	КонецЕсли;
	
КонецПроцедуры

 ////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

Процедура ДействияФормыРедактироватьНомер(Кнопка)
	МеханизмНумерацииОбъектов.ИзменениеВозможностиРедактированияНомера(ЭтотОбъект.Метаданные(), ЭтаФорма, ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
КонецПроцедуры
// Процедура вызывается при выборе пункта подменю "Движения документа по регистрам" меню "Перейти".
// командной панели формы. Процедура отрабатывает печать движений документа по регистрам.
//
Процедура ДействияФормыДвиженияДокументаПоРегистрам(Кнопка)

	РаботаСДиалогами.НапечататьДвиженияДокумента(Ссылка);

КонецПроцедуры // ДействияФормыДвиженияДокументаПоРегистрам()

Процедура НоменклатураНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка=Ложь;
	
	Если Сценарий.ДетализацияПланирования=Перечисления.ДетализацияПланирования.НоменклатурныеГруппы Тогда
		ФормаВыбора=Справочники.НоменклатурныеГруппы.ПолучитьФормуВыбора(,Элемент,);
	Иначе
		ФормаВыбора=Справочники.Номенклатура.ПолучитьФормуВыбора(,Элемент,);
	КонецЕсли;
	
	ФормаВыбора.РежимВыбора=Истина;
	ФормаВыбора.Открыть();
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	
	Если НЕ ЭтоНовый() Тогда 
		НастройкаПравДоступа.ОпределитьДоступностьВозможностьИзмененияДокументаПоДатеЗапрета(ДокументОбъект, ЭтаФорма);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Ответственный) Тогда
		Ответственный = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнойОтветственный");
	КонецЕсли;
		
	МеханизмНумерацииОбъектов.ДобавитьВМенюДействияКнопкуРедактированияНомера(ЭлементыФормы.ДействияФормы.Кнопки.Подменю);
	МеханизмНумерацииОбъектов.УстановитьДоступностьПоляВводаНомера(Метаданные(), ЭтаФорма, ЭлементыФормы.ДействияФормы.Кнопки.Подменю,ЭлементыФормы.Номер);
	
	// Создать кнопки печати
	ФормированиеПечатныхФорм.СоздатьКнопкиПечати(ЭтотОбъект, ЭтаФорма);
	
	РаботаСДиалогами.АктивизироватьРеквизитВФорме(ЭтотОбъект,ЭтаФорма);
	
	// Вывести в заголовке формы статус документа (новый, не проведен, проведен).
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	
КонецПроцедуры

// Процедура вызова структуры подчиненности документа
Процедура ДействияФормыСтруктураПодчиненностиДокумента(Кнопка)
	РаботаСДиалогами.ПоказатьСтруктуруПодчиненностиДокумента(Ссылка);
КонецПроцедуры

Процедура ЗависимостиОборотовПоСтатьямПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	
	Запрос=Новый Запрос;
	
	Запрос.Текст="ВЫБРАТЬ
	|	СтатьиОборотовПоБюджетам.УчетПоКоличеству,
	|	СтатьиОборотовПоБюджетам.УчетПоСумме,
	|	СтатьиОборотовПоБюджетам.РазделениеПоКонтрагентам,
	|	СтатьиОборотовПоБюджетам.РазделениеПоНоменклатуре
	|ИЗ
	|	Справочник.СтатьиОборотовПоБюджетам КАК СтатьиОборотовПоБюджетам
	|ГДЕ
	|	СтатьиОборотовПоБюджетам.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка",ДанныеСтроки.ЗависимаяСтатьяОборотов);
	Результат=Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() Тогда
		
		ОформлениеСтроки.Ячейки.ЗависимыйКонтрагент.ТолькоПросмотр=НЕ Результат.РазделениеПоКонтрагентам;
		ОформлениеСтроки.Ячейки.ЗависимаяНоменклатура.ТолькоПросмотр=НЕ Результат.РазделениеПоНоменклатуре;
		
		ОформлениеСтроки.Ячейки.КоэффициентДляРасчетаКоличества.ТолькоПросмотр=НЕ Результат.УчетПоКоличеству;
		ОформлениеСтроки.Ячейки.РеквизитВлияющейСтатьиДляРасчетаКоличества.ТолькоПросмотр=НЕ Результат.УчетПоКоличеству;
		
		ОформлениеСтроки.Ячейки.РеквизитВлияющейСтатьиДляРасчетаСуммы.ТолькоПросмотр=НЕ Результат.УчетПоСумме;
		ОформлениеСтроки.Ячейки.КоэффициентДляРасчетаСуммы.ТолькоПросмотр=НЕ Результат.УчетПоСумме;
				
	КонецЕсли;
	
КонецПроцедуры

// Процедура - обработчик нажатия на любую из дополнительных кнопок по заполнению ТЧ
//
Процедура НажатиеНаДополнительнуюКнопкуЗаполненияТЧ(Кнопка)
	
	УниверсальныеМеханизмы.ОбработатьНажатиеНаДополнительнуюКнопкуЗаполненияТЧ(мКнопкиЗаполненияТЧ.Строки.Найти(Кнопка.Имя,"Имя",Истина),ЭтотОбъект);
	
КонецПроцедуры

// Процедура - обработчик нажатия на кнопку "Печать".
// Открывает форму выбора печатных форм объекта.
//
Процедура ОсновныеДействияФормыПечать(Кнопка)
	
	УниверсальныеМеханизмы.ОткрытьФормуВыбораПечатныхФормОбъекта(ЭтотОбъект, ЭтаФорма);
	
КонецПроцедуры // ОсновныеДействияФормыПечать() 

// Процедура - обработчик нажатия на кнопку "Печать по умолчанию"
//
Процедура ОсновныеДействияФормыПечатьПоУмолчанию(Кнопка)

	УниверсальныеМеханизмы.НапечататьДокументПоУмолчанию(ЭтотОбъект);

КонецПроцедуры

Процедура ПослеЗаписи()
	
	// Вывести в заголовке формы статус документа (новый, не проведен, проведен).
	РаботаСДиалогами.УстановитьЗаголовокФормыДокумента(, ЭтотОбъект, ЭтаФорма);
	
	МеханизмНумерацииОбъектов.ОбновитьПодсказкуКодНомерОбъекта(ЭтотОбъект.Метаданные(), ЭлементыФормы.ДействияФормы.Кнопки.Подменю, ЭлементыФормы.Номер);
	
КонецПроцедуры