Перем СчетХозрасчетный, СчетМеждународный, ЗначениеТип, СчетДт, СчетКт;
Перем ДокументОбъект Экспорт;
Процедура ПриОткрытии()

	ИмяФайла = "mapping.xml";

КонецПроцедуры

Процедура ОсновныеДействияФормыВыполнить(Кнопка)
	Попытка
		Если ФлажокСоответствиеСчетовБУиМСФО Тогда
			ДокументОбъект.СоответствиеСчетовБУиМСФО.Очистить();
		КонецЕсли;
		Если ФлажокИсключениеПроводок Тогда
			ДокументОбъект.ИсключениеПроводок.Очистить();
		КонецЕсли; 
		НаборЗаписей = Неопределено;
		Запись       = Неопределено;
		ИмяЭлемента  = "";

		Файл = Новый ЧтениеXML;
		Файл.ОткрытьФайл(ИмяФайла);

		Пока Файл.Прочитать() Цикл

			Если (Файл.ТипУзла = ТипУзлаXML.НачалоЭлемента) и (Файл.Имя = "СоответствиеСчетов") Тогда
				Если ФлажокСоответствиеСчетовБУиМСФО Тогда
					НаборЗаписей = ДокументОбъект.СоответствиеСчетовБУиМСФО;
				КонецЕсли;
				Продолжить;

			ИначеЕсли (Файл.ТипУзла = ТипУзлаXML.КонецЭлемента) и (Файл.Имя = "СоответствиеСчетов") Тогда
				НаборЗаписей = Неопределено;
				Продолжить;

			ИначеЕсли (Файл.ТипУзла = ТипУзлаXML.НачалоЭлемента) и (Файл.Имя = "ИсключениеПроводок") Тогда
				Если ФлажокИсключениеПроводок Тогда
					НаборЗаписей =  ДокументОбъект.ИсключениеПроводок;
				КонецЕсли; 
				Продолжить;

			ИначеЕсли (Файл.ТипУзла = ТипУзлаXML.КонецЭлемента) и (Файл.Имя = "ИсключениеПроводок") Тогда
				НаборЗаписей = Неопределено;
				Продолжить;

			ИначеЕсли (Файл.ТипУзла = ТипУзлаXML.НачалоЭлемента) и (Файл.Имя = "Запись") Тогда
				Если НаборЗаписей <> Неопределено Тогда
					Запись = НаборЗаписей.Добавить();
					Запись.Учитывается = Истина;
				КонецЕсли; 
				Продолжить;

			ИначеЕсли (Файл.ТипУзла = ТипУзлаXML.КонецЭлемента) и (Файл.Имя = "Запись") Тогда
				Продолжить;

			ИначеЕсли (Файл.ТипУзла = ТипУзлаXML.Текст) и (НаборЗаписей <> Неопределено) и (Запись <> Неопределено) Тогда

				ТипЗнач = "";

				Если (ИмяЭлемента = "СчетХозрасчетный") или (ИмяЭлемента = "СчетДт") или (ИмяЭлемента = "СчетКт") Тогда
					ТипЗнач = Тип("ПланСчетовСсылка.Хозрасчетный");

				ИначеЕсли ИмяЭлемента = "СчетМеждународный" Тогда
					ТипЗнач = Тип("ПланСчетовСсылка.Международный");

				ИначеЕсли ИмяЭлемента = "ВидДвижения" Тогда
					ТипЗнач = Тип("ПеречислениеСсылка.ВидыДвиженийБухгалтерии");

				ИначеЕсли (ИмяЭлемента = "Комментарий") или (ИмяЭлемента = "Реквизит") или (ИмяЭлемента = "РеквизитПредставление") Тогда
					ТипЗнач = Тип("Строка");

				ИначеЕсли ИмяЭлемента = "СубконтоХозр1" Тогда
					Если СчетХозрасчетный.ВидыСубконто.Количество() > 0 Тогда
						Типы    = СчетХозрасчетный.ВидыСубконто[0].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоХозр2" Тогда
					Если СчетХозрасчетный.ВидыСубконто.Количество() > 1 Тогда
						Типы    = СчетХозрасчетный.ВидыСубконто[1].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоХозр3" Тогда
					Если СчетХозрасчетный.ВидыСубконто.Количество() > 2 Тогда
						Типы    = СчетХозрасчетный.ВидыСубконто[2].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоМежд1" Тогда
					Если СчетМеждународный.ВидыСубконто.Количество() > 0 Тогда
						Типы    = СчетМеждународный.ВидыСубконто[0].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоМежд2" Тогда
					Если СчетМеждународный.ВидыСубконто.Количество() > 1 Тогда
						Типы    = СчетМеждународный.ВидыСубконто[1].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоМежд3" Тогда
					Если СчетМеждународный.ВидыСубконто.Количество() > 2 Тогда
						Типы    = СчетМеждународный.ВидыСубконто[2].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоДт1" Тогда
					Если СчетДт.ВидыСубконто.Количество() > 0 Тогда
						Типы    = СчетДт.ВидыСубконто[0].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоДт2" Тогда
					Если СчетДт.ВидыСубконто.Количество() > 1 Тогда
						Типы    = СчетДт.ВидыСубконто[1].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоДт3" Тогда
					Если СчетДт.ВидыСубконто.Количество() > 2 Тогда
						Типы    = СчетДт.ВидыСубконто[2].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоКт1" Тогда
					Если СчетКт.ВидыСубконто.Количество() > 0 Тогда
						Типы    = СчетКт.ВидыСубконто[0].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоКт2" Тогда
					Если СчетКт.ВидыСубконто.Количество() > 1 Тогда
						Типы    = СчетКт.ВидыСубконто[1].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "СубконтоКт3" Тогда
					Если СчетКт.ВидыСубконто.Количество() > 2 Тогда
						Типы = СчетКт.ВидыСубконто[2].ВидСубконто.ТипЗначения.Типы();
						ТипЗнач = Типы[0];
					КонецЕсли;

				ИначеЕсли ИмяЭлемента = "ЗначениеТип" Тогда
					ТипЗнач = ЗначениеИзСтрокиВнутр(Файл.Значение);;

				ИначеЕсли ИмяЭлемента = "Значение" Тогда
					ТипЗнач = ЗначениеТип;
				КонецЕсли;

				Если ТипЗнач <> "" Тогда

					Если ИмяЭлемента <> "ЗначениеТип" Тогда
						Запись[ИмяЭлемента] = XMLЗначение(ТипЗнач,Файл.Значение);
						
						Попытка
							Если НЕ ДокументОбъект.ОпределитьКорректностьСсылки(Запись[ИмяЭлемента]) Тогда
								СтрокаСообщения = "В строке "+Запись.НомерСтроки+" не найден объект в базе данных для "+ИмяЭлемента+". Необходимо установить соответствие вручную.";
								Сообщить(СтрокаСообщения, СтатусСообщения.Внимание);
							КонецЕсли;
						Исключение
						КонецПопытки;
					КонецЕсли;

					Если ИмяЭлемента = "СчетХозрасчетный" Тогда
						СчетХозрасчетный = Запись[ИмяЭлемента];

					ИначеЕсли ИмяЭлемента = "СчетМеждународный" Тогда
						СчетМеждународный = Запись[ИмяЭлемента];

					ИначеЕсли ИмяЭлемента = "СчетДт" Тогда
						СчетДт = Запись[ИмяЭлемента];

					ИначеЕсли ИмяЭлемента = "СчетКт" Тогда
						СчетКт = Запись[ИмяЭлемента];

					ИначеЕсли ИмяЭлемента = "ЗначениеТип" Тогда
						ЗначениеТип = ТипЗнач;

					КонецЕсли;

				КонецЕсли;

			Иначе
				ИмяЭлемента = Файл.Имя;

			КонецЕсли;

		КонецЦикла;

	Исключение

		Сообщить("Во время импорта произошла ошибка!",СтатусСообщения.Важное);
		Сообщить("Описание ошибки:");
		Сообщить(ОписаниеОшибки());

	КонецПопытки;
	Закрыть();
КонецПроцедуры // ОсновныеДействияФормыИмпорт

Процедура ИмяФайлаНачалоВыбора(Элемент, СтандартнаяОбработка)

	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);

	ДиалогВыбораФайла.Фильтр                      = "Файл данных (*.xml)|*.xml";
	ДиалогВыбораФайла.Заголовок                   = "Выберите файл";
	ДиалогВыбораФайла.ПредварительныйПросмотр     = Ложь;
	ДиалогВыбораФайла.Расширение                  = "xml";
	ДиалогВыбораФайла.ИндексФильтра               = 0;
	ДиалогВыбораФайла.ПолноеИмяФайла              = Элемент.Значение;

	Если ДиалогВыбораФайла.Выбрать() Тогда
		Элемент.Значение = ДиалогВыбораФайла.ПолноеИмяФайла;
	КонецЕсли;

КонецПроцедуры