Перем мТекущееЗначениеНастройки;

//ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	ЭтаФорма.ТолькоПросмотр = не ПолучитьРазрешениеНаИзменениеНастроекУчета();
КонецПроцедуры

Процедура ПриОткрытии()
	ПрочитатьТекущиеНастройки();
КонецПроцедуры

Процедура ВестиПартионныйУчетПоСкладамРеглПриИзменении(Элемент)
	УстановитьДоступность();
КонецПроцедуры

//ОБРАБОТЧИКИ НАЖАТИЯ КНОПОК КОМАНДНЫХ ПАНЕЛЕЙ

Процедура КнопкаОКНажатие(Кнопка)
	ЗаписатьИзменения();
	ЭтаФорма.Закрыть();
КонецПроцедуры

//ПРОЦЕДУРЫ ИЗМЕНЕНИЯ ВНЕШНЕГО ВИДА ФОРМЫ
Процедура УстановитьДоступность()
	ЭлементыФормы.ОсновныеДействияФормы.Кнопки.ОК.Доступность = НЕ (мТекущееЗначениеНастройки=ВестиПартионныйУчетПоСкладамРегл) 
КонецПроцедуры

//ПРОЦЕДУРЫ РАБОТЫ С ПЕРЕМЕННЫМИ ФОРМЫ

Процедура ПрочитатьТекущиеНастройки()
	// запомним текущее значение константы "Использовать регистр Свободные Остатки"
	мТекущееЗначениеНастройки = Константы.ВестиПартионныйУчетПоСкладамРегл.Получить();
	ВестиПартионныйУчетПоСкладамРегл = мТекущееЗначениеНастройки;
	УстановитьДоступность();
КонецПроцедуры

//ПРОЦЕДУРЫ ИЗМЕНЕНИЯ ДАННЫХ ИБ

Процедура ЗаписатьИзменения()
	//перечитаем еще раз значение чтобы убедиться что его никто не поменял
	мТекущееЗначениеНастройки_старое = мТекущееЗначениеНастройки;
	мТекущееЗначениеНастройки = Константы.ВестиПартионныйУчетПоСкладамРегл.Получить();
	Если мТекущееЗначениеНастройки_старое<>мТекущееЗначениеНастройки Тогда
		Предупреждение("Настройка была изменена другим пользователем. Для отображения актуальных настроек обновите данные формы");
		Возврат;
	КонецЕсли;
	
	Если мТекущееЗначениеНастройки = ВестиПартионныйУчетПоСкладамРегл Тогда
		Возврат;
	ИначеЕсли не ПолучитьПодтверждениеПользователя("Изменение настройки ""Вести партионный учет по складам в регл. учете""") Тогда
		Возврат;
	КонецЕсли;

	НачатьТранзакцию();
	// изменение значения константы
	МенеджерЗаписи = Константы.ВестиПартионныйУчетПоСкладамРегл.СоздатьМенеджерЗначения();
	МенеджерЗаписи.Значение = ВестиПартионныйУчетПоСкладамРегл;
	Попытка
		МенеджерЗаписи.Записать();
		ОбщегоНазначения.СообщитьОСостоянииИзмененияНастройки("Вести партионный учет по складам регл","Изменено значение константы ""Вести партионный учет по складам в регламентированном учете""", "новое значение - "+ ?(ВестиПартионныйУчетПоСкладамРегл,"включено","отключено"));
	Исключение
		Предупреждение("Не удалось изменить значение константы ""Вести партионный учет по складам в регламентированном учете"": "+ОписаниеОшибки(),60);
		ОбщегоНазначения.СообщитьОСостоянииИзмененияНастройки("Вести партионный учет по складам регл","Не удалось изменить значение константы ""Вести партионный учет по складам в регламентированном учете"": "+ОписаниеОшибки(), ,,СтатусСообщения.Важное);
		ОтменитьТранзакцию();
		Возврат;
	КонецПопытки;
	//изменение аналитики Склады
	ОбработатьИзмененияПартионногоУчета();
	ОбщегоНазначения.СообщитьОСостоянииИзмененияНастройки("Вести партионный учет по складам регл","Изменен признак ведения суммового учета на субконто Склады");

    ЗафиксироватьТранзакцию();
	Оповестить("ИспользованиеПартионногоУчетаПоСкладамРегл");
КонецПроцедуры

Процедура ОбработатьИзмененияПартионногоУчета()
	
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ОборудованиеКУстановке", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ПриобретениеОбъектовОсновныхСредств", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "Материалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "СырьеИМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ПокупныеПолуфабрикатыИКомплектующие", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "Топливо", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "Тара", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ЗапасныеЧасти", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ПрочиеМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "СтроительныеМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ИнвентарьИХозяйственныеПринадлежности", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "Полуфабрикаты", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "Товары", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ТоварыНаСкладах", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ТоварыВРозничнойТорговле", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ТараПодТоваромИПорожняя", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ПокупныеИзделия", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ГотоваяПродукция", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "ТМЦпринятыеНаОтветственноеХранение", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "СпецоснасткаИСпецодеждаНаСкладе", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "МатериалыВСоставеОСвНУ", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "МатериалыПринятыеВПереработку_", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "МатериалыПринятыеВПереработку", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Хозрасчетный",  "ВидыСубконтоХозрасчетные",  "КорректировкаТоваровПрошлогоПериода", ВестиПартионныйУчетПоСкладамРегл);
	
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ОборудованиеКУстановке", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ПриобретениеОбъектовОсновныхСредств", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "Материалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "СырьеИМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ПокупныеПолуфабрикатыИКомплектующие", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "Топливо", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "Тара", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ЗапасныеЧасти", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ПрочиеМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "СтроительныеМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ИнвентарьИХозяйственныеПринадлежности", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "СпецоснасткаИСпецодеждаНаСкладе", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "Полуфабрикаты", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "Товары", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ТоварыНаСкладах", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ТоварыВРозничнойТорговле", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ТараПодТоваромИПорожняя", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ПокупныеИзделия", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "ГотоваяПродукция", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Налоговый",     "ВидыСубконтоХозрасчетные",  "КорректировкаТоваровПрошлогоПериода", ВестиПартионныйУчетПоСкладамРегл);
	
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "СырьеИМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "СырьеИОсновныеМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "Топливо", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "Тара", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "ЗапасныеЧасти", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "ПрочиеМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "СтроительныеМатериалы", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "ТоварыНаСкладе", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "ТоварыВРознице", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "ГотоваяПродукция", ВестиПартионныйУчетПоСкладамРегл);
	УстановитьВидСубконтоДляСчета("Международный", "ВидыСубконтоМеждународные", "КомплектующиеИПолуфабрикаты", ВестиПартионныйУчетПоСкладамРегл);
	
	
КонецПроцедуры // ОбработатьИзмененияПартионногоУчета

// Устанавливает субконто "Склады" у указанного счета.
//
Процедура УстановитьВидСубконтоДляСчета(ИмяПланаСчетов, ВидСубконто, ИмяСчета, Значение)

	Попытка

		Счет        = ПланыСчетов[ИмяПланаСчетов][ИмяСчета];
		Объект      = Счет.ПолучитьОбъект();
		ВидСубконто = Объект.ВидыСубконто.Найти(ПланыВидовХарактеристик[ВидСубконто].Склады, "ВидСубконто");

		Если ВидСубконто = Неопределено Тогда
			Возврат;
		КонецЕсли;

		ВидСубконто.Суммовой = Значение;
		Объект.Записать();
		Состояние("Обновление значений реквизитов субконто плана счетов """ + ИмяПланаСчетов + """...");

	Исключение

		Состояние("В плане счетов """ + ИмяПланаСчетов + """ не определен счет " + ИмяСчета);

	КонецПопытки;

КонецПроцедуры // УстановитьФлагНаСчете()