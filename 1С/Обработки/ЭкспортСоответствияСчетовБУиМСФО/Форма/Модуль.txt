Перем СчетХозрасчетный, СчетМеждународный, ЗначениеТип, СчетДт, СчетКт;

Процедура ПриОткрытии()

	Период   = РабочаяДата;
	ИмяФайла = "mapping.xml";

КонецПроцедуры


Процедура ОсновныеДействияФормыВыполнить(Кнопка)

	Попытка

		// Создаем объект ЗаписьXML
		Файл = Новый ЗаписьXML;
		Файл.ОткрытьФайл(ИмяФайла);
		Файл.ЗаписатьОбъявлениеXML();
		Файл.ЗаписатьКомментарий("Файл выгрузки соответствий счетов и исключений проводок для 1С:Управление производственным предприятием 8.0");
		Файл.ЗаписатьНачалоЭлемента("Mapping");

		// Перенос соответствий
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	*
		|ИЗ
		|	РегистрСведений.СоответствиеСчетовБУиМСФО.СрезПоследних(&Период, ) КАК СоответствиеСчетовСрезПоследних
		|Где
		|	Учитывается = Истина";

		Запрос.УстановитьПараметр("Период", Период);

		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();

		Файл.ЗаписатьНачалоЭлемента("СоответствиеСчетов");
		Пока Выборка.Следующий() Цикл

			Файл.ЗаписатьНачалоЭлемента("Запись");

				Файл.ЗаписатьНачалоЭлемента("СчетХозрасчетный");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СчетХозрасчетный));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("ВидДвижения");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.ВидДвижения));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоХозр1");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоХозр1));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоХозр2");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоХозр2));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоХозр3");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоХозр3));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("Реквизит");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.Реквизит));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("РеквизитПредставление");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.РеквизитПредставление));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("ЗначениеТип");
					Файл.ЗаписатьТекст(ЗначениеВСтрокуВнутр(ТипЗнч(Выборка.Значение)));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("Значение");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.Значение));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СчетМеждународный");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СчетМеждународный));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоМежд1");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоМежд1));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоМежд2");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоМежд2));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоМежд3");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоМежд3));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("Комментарий");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.Комментарий));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("Приоритет");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.Приоритет));
				Файл.ЗаписатьКонецЭлемента();

			Файл.ЗаписатьКонецЭлемента();

		КонецЦикла;

		Файл.ЗаписатьКонецЭлемента();

		// Перенос исключений
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	*
		|ИЗ
		|	РегистрСведений.ИсключениеПроводок.СрезПоследних(&Период, ) КАК ИсключениеПроводокСрезПоследних
		|Где
		|	Учитывается = Истина";

		Запрос.УстановитьПараметр("Период", Период);

		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();

		Файл.ЗаписатьНачалоЭлемента("ИсключениеПроводок");
		Пока Выборка.Следующий() Цикл

			Файл.ЗаписатьНачалоЭлемента("Запись");

				Файл.ЗаписатьНачалоЭлемента("СчетДт");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СчетДт));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоДт1");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоДт1));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоДт2");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоДт2));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоДт3");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоДт3));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СчетКт");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СчетКт));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоКт1");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоКт1));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоКт2");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоКт2));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("СубконтоКт3");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.СубконтоКт3));
				Файл.ЗаписатьКонецЭлемента();

				Файл.ЗаписатьНачалоЭлемента("Комментарий");
					Файл.ЗаписатьТекст(XMLСтрока(Выборка.Комментарий));
				Файл.ЗаписатьКонецЭлемента();

			Файл.ЗаписатьКонецЭлемента();

		КонецЦикла;

		Файл.ЗаписатьКонецЭлемента();

		//Закрываем выгрузку
		Файл.ЗаписатьКонецЭлемента();

	Исключение

		Сообщить("Во время экспорт произошла ошибка!",СтатусСообщения.Важное);
		Сообщить("Описание ошибки:");
		Сообщить(ОписаниеОшибки());

	КонецПопытки


КонецПроцедуры

Процедура ИмяФайлаНачалоВыбора(Элемент, СтандартнаяОбработка)

	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);

	ДиалогВыбораФайла.Фильтр                      = "Файл данных (*.xml)|*.xml";
	ДиалогВыбораФайла.Заголовок                   = "Выберите файл";
	ДиалогВыбораФайла.ПредварительныйПросмотр     = Ложь;
	ДиалогВыбораФайла.Расширение                  = "xml";
	ДиалогВыбораФайла.ИндексФильтра               = 0;
	ДиалогВыбораФайла.ПолноеИмяФайла              = Элемент.Значение;

	Если ДиалогВыбораФайла.Выбрать() Тогда
		Элемент.Значение = ДиалогВыбораФайла.ПолноеИмяФайла;
	КонецЕсли;

КонецПроцедуры