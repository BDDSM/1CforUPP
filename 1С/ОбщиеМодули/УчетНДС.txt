// Для переданного в качестве параметра счета-факутры выданного, получает для него
// ключевые сведения: Контрагент, Договор, Сумма и др., которые содержатся в 
// документе основнии.
//
// Параметры:
//  СчетФактура  - счет-фактура для которого нужно определить параметры
//  Результат - структура в которой возвращаются значения параметров
//
Процедура ПолучитьПараметрыСчетаФактуры(СчетФактура, мВалютаРегламентированногоУчета, Результат) Экспорт

	Результат = Новый Структура("Организация, Контрагент, Договор, СуммаДокумента, ВалютаДокумента, 
		|СуммаУвеличение, СуммаУменьшение, СуммаНДСУвеличение, СуммаНДСУменьшение, СуммаНДСДокумента, СчетФактураБезНДС,
		|БланкСтрогойОтчетности");
		
	Результат.СуммаДокумента = 0;
	Результат.СуммаНДСДокумента = 0;
	Результат.СуммаУвеличение = 0;
	Результат.СуммаНДСУвеличение = 0;
	Результат.СуммаУменьшение = 0;
	Результат.СуммаНДСУменьшение = 0;
	Результат.СчетФактураБезНДС = 0;
	
	Если ТипЗнч(СчетФактура)= Тип("ДокументСсылка.СчетФактураПолученный")
		ИЛИ ТипЗнч(СчетФактура)= Тип("ДокументСсылка.СчетФактураВыданный") Тогда
		Ссылка = СчетФактура;
	Иначе
		Ссылка = СчетФактура.Ссылка;
	КонецЕсли; 
	
	ЭтоПолученныйСФ = Ложь;
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураПолученный") Тогда
		ЭтоПолученныйСФ = Истина;
		Если СчетФактура.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс 
			И СчетФактура.ДокументыОснования.Количество() > 0
			И ТипЗнч(СчетФактура.ДокументыОснования[0].ДокументОснование) = Тип("ДокументСсылка.КорректировкаДолга") Тогда
			// Реквизиты заново не определяются, получаются из счета-фактуры
			Результат.Вставить("Организация"	, СчетФактура.Организация);
			Результат.Вставить("Контрагент"		, СчетФактура.Контрагент);
			Результат.Вставить("Договор"		, СчетФактура.ДоговорКонтрагента);
			Результат.Вставить("ВалютаДокумента", СчетФактура.ВалютаДокумента);
			Результат.Вставить("СуммаДокумента"	, СчетФактура.СуммаДокумента);
			Возврат;
		КонецЕсли;			
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.СчетФактураВыданный") 
		И (СчетФактура.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.НаАванс 
		ИЛИ СчетФактура.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.НаСуммовуюРазницу) Тогда
		// Реквизиты заново не определяются, получаются из счета-фактуры
		Результат.Вставить("Организация"	, СчетФактура.Организация);
		Результат.Вставить("Контрагент"		, СчетФактура.Контрагент);
		Результат.Вставить("Договор"		, СчетФактура.ДоговорКонтрагента);
		Результат.Вставить("ВалютаДокумента", СчетФактура.ВалютаДокумента);
		Результат.Вставить("СуммаДокумента"	, СчетФактура.СуммаДокумента);
		Возврат;
	КонецЕслИ;
	
	ДокументыОснования = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(СчетФактура.ДокументыОснования.ВыгрузитьКолонку("ДокументОснование"), Истина);
	
	ТипыОснований = Новый Соответствие();
	Для каждого Основание Из ДокументыОснования Цикл
		Если не ЗначениеЗаполнено(Основание) Тогда
			Продолжить;			
		КонецЕсли; 

		МассивДокументов = ТипыОснований[ТипЗнч(Основание)];
		
		Если МассивДокументов = Неопределено Тогда
			МассивДокументов = новый Массив();
			ТипыОснований.Вставить(ТипЗнч(Основание),МассивДокументов);
		КонецЕсли; 
		
		МассивДокументов.Добавить(Основание);
	КонецЦикла; 
	
	Если ТипыОснований.Количество() = 0 Тогда
		// ТЧ оснований не заполнена, параметры определить нельзя
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТекущийДокумент", Ссылка);
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", мВалютаРегламентированногоУчета);
	
	Для каждого ТипОснования Из ТипыОснований Цикл
		ТипДокументаОснования	= ТипОснования.Ключ;
		ДокументыОснования		= ТипОснования.Значение;
	    ТекстЗапроса = "";
		Если ТипДокументаОснования = Тип("ДокументСсылка.ВводНачальныхОстатковНДС") Тогда
			// Для данного документа применяется специфический запрос для расчета параметров счета-фактуры
			Запрос.УстановитьПараметр("ДокументОснованиеВНО", ДокументыОснования);

			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	ВводНачальныхОстатковНДСДанныеПоСФ.Ссылка.Организация КАК Организация,
			|	ВводНачальныхОстатковНДСДанныеПоСФ.Контрагент,
			|	ВводНачальныхОстатковНДСДанныеПоСФ.ДоговорКонтрагента КАК Договор,
			|	СУММА(ВводНачальныхОстатковНДСДанныеПоСФ.СуммаБезНДС + ВводНачальныхОстатковНДСДанныеПоСФ.НДС) КАК СуммаДокумента,
			|	&ВалютаРегламентированногоУчета КАК ВалютаДокумента
			|ИЗ
			|	Документ.ВводНачальныхОстатковНДС.ДанныеПоСФ КАК ВводНачальныхОстатковНДСДанныеПоСФ
			|ГДЕ
			|	ВводНачальныхОстатковНДСДанныеПоСФ.Ссылка В(&ДокументОснованиеВНО)
			|	И ВводНачальныхОстатковНДСДанныеПоСФ.СчетФактура = &ТекущийДокумент
			|
			|СГРУППИРОВАТЬ ПО
			|	ВводНачальныхОстатковНДСДанныеПоСФ.Контрагент,
			|	ВводНачальныхОстатковНДСДанныеПоСФ.ДоговорКонтрагента,
			|	ВводНачальныхОстатковНДСДанныеПоСФ.Ссылка.Организация";
		
		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.АвансовыйОтчет") Тогда
			// Для данного документа применяется специфический запрос для расчета параметров счета-фактуры
			Запрос.УстановитьПараметр("ДокументОснованиеАО", ДокументыОснования);
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	АвансовыйОтчетПрочее.Ссылка.Организация КАК Организация,
			|	АвансовыйОтчетПрочее.Поставщик КАК Контрагент,
			|	НЕОПРЕДЕЛЕНО КАК Договор,
			|	СУММА(ВЫБОР
			|			КОГДА АвансовыйОтчетПрочее.Ссылка.СуммаВключаетНДС
			|				ТОГДА АвансовыйОтчетПрочее.Сумма
			|			ИНАЧЕ АвансовыйОтчетПрочее.Сумма + АвансовыйОтчетПрочее.СуммаНДС
			|		КОНЕЦ) КАК СуммаДокумента,
			|	АвансовыйОтчетПрочее.Ссылка.ВалютаДокумента КАК ВалютаДокумента,
			|	СУММА(АвансовыйОтчетПрочее.СуммаНДС) КАК СуммаНДСДокумента,
			|	ВЫБОР
			|		КОГДА АвансовыйОтчетПрочее.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ КАК ЕстьНДС,
			|	АвансовыйОтчетПрочее.БланкСтрогойОтчетности КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ.АвансовыйОтчет.Прочее КАК АвансовыйОтчетПрочее
			|ГДЕ
			|	АвансовыйОтчетПрочее.Ссылка В(&ДокументОснованиеАО)
			|	И АвансовыйОтчетПрочее.ПредъявленСФ
			|	И АвансовыйОтчетПрочее.СчетФактура = &ТекущийДокумент
			|
			|СГРУППИРОВАТЬ ПО
			|	АвансовыйОтчетПрочее.Поставщик,
			|	АвансовыйОтчетПрочее.Ссылка.ВалютаДокумента,
			|	АвансовыйОтчетПрочее.Ссылка.Организация,
			|	ВЫБОР
			|		КОГДА АвансовыйОтчетПрочее.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ,
			|	АвансовыйОтчетПрочее.БланкСтрогойОтчетности
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	АвансовыйОтчетТовары.Ссылка.Организация,
			|	АвансовыйОтчетТовары.Поставщик,
			|	НЕОПРЕДЕЛЕНО,
			|	СУММА(ВЫБОР
			|			КОГДА АвансовыйОтчетТовары.Ссылка.СуммаВключаетНДС
			|				ТОГДА АвансовыйОтчетТовары.Сумма
			|			ИНАЧЕ АвансовыйОтчетТовары.Сумма + АвансовыйОтчетТовары.СуммаНДС
			|		КОНЕЦ),
			|	АвансовыйОтчетТовары.Ссылка.ВалютаДокумента,
			|	СУММА(АвансовыйОтчетТовары.СуммаНДС),
			|	ВЫБОР
			|		КОГДА АвансовыйОтчетТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ,
			|	ЛОЖЬ
			|ИЗ
			|	Документ.АвансовыйОтчет.Товары КАК АвансовыйОтчетТовары
			|ГДЕ
			|	АвансовыйОтчетТовары.Ссылка В(&ДокументОснованиеАО)
			|	И АвансовыйОтчетТовары.СчетФактура = &ТекущийДокумент
			|	И АвансовыйОтчетТовары.ПредъявленСФ
			|
			|СГРУППИРОВАТЬ ПО
			|	АвансовыйОтчетТовары.Поставщик,
			|	АвансовыйОтчетТовары.Ссылка.ВалютаДокумента,
			|	АвансовыйОтчетТовары.Ссылка.Организация,
			|	ВЫБОР
			|		КОГДА АвансовыйОтчетТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ";
		
		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах")
			И ТипЗнч(Ссылка) <> Тип("ДокументСсылка.СчетФактураПолученный") Тогда
			
			// Для данного документа применяется специфический запрос для расчета параметров счета-фактуры
			Запрос.УстановитьПараметр("ДокументыОснования", ДокументыОснования);
			ТекстЗапроса =
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ОтчетКомиссионераОПродажах.Ссылка КАК Ссылка,
			|	ОтчетКомиссионераОПродажах.Ссылка.Организация КАК Организация,
			|	ОтчетКомиссионераОПродажах.Ссылка.ВалютаДокумента КАК ВалютаДокумента,
			|	ОтчетКомиссионераОПродажах.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС
			|ПОМЕСТИТЬ ВТ_ОтчетКомиссионераОПродажах
			|ИЗ
			|	Документ.ОтчетКомиссионераОПродажах.Покупатели КАК ОтчетКомиссионераОПродажах
			|ГДЕ
			|	ОтчетКомиссионераОПродажах.Ссылка В(&ДокументыОснования)
			|	И ОтчетКомиссионераОПродажах.ВыставленСФ
			|	И ОтчетКомиссионераОПродажах.СчетФактура = &ТекущийДокумент
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	Ссылка
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ОтчетКомиссионераОПродажахТовары.КлючСтроки КАК КлючСтроки,
			|	СУММА(ОтчетКомиссионераОПродажахТовары.Сумма) КАК Сумма,
			|	СУММА(ОтчетКомиссионераОПродажахТовары.СуммаНДС) КАК СуммаНДС
			|ПОМЕСТИТЬ ВТ_Суммы
			|ИЗ
			|	ВТ_ОтчетКомиссионераОПродажах КАК ВТ_ОтчетКомиссионераОПродажах
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах.Товары КАК ОтчетКомиссионераОПродажахТовары
			|		ПО ВТ_ОтчетКомиссионераОПродажах.Ссылка = ОтчетКомиссионераОПродажахТовары.Ссылка
			|
			|СГРУППИРОВАТЬ ПО
			|	ОтчетКомиссионераОПродажахТовары.КлючСтроки
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	КлючСтроки
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВТ_ОтчетКомиссионераОПродажах.Организация КАК Организация,
			|	ОтчетКомиссионераОПродажахПокупатели.Покупатель КАК Контрагент,
			|	ОтчетКомиссионераОПродажахПокупатели.ДатаСФ КАК Дата,
			|	ВЫБОР
			|		КОГДА ОтчетКомиссионераОПродажахПокупатели.Покупатель = ОтчетКомиссионераОПродажахПокупатели.Ссылка.Контрагент
			|			ТОГДА НЕОПРЕДЕЛЕНО
			|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
			|	КОНЕЦ КАК Договор,
			|	СУММА(ВТ_Суммы.Сумма + ВЫБОР
			|			КОГДА ВТ_ОтчетКомиссионераОПродажах.СуммаВключаетНДС
			|				ТОГДА 0
			|			ИНАЧЕ ВТ_Суммы.СуммаНДС
			|		КОНЕЦ) КАК СуммаДокумента,
			|	СУММА(ВТ_Суммы.СуммаНДС) КАК СуммаНДСДокумента,
			|	ВТ_ОтчетКомиссионераОПродажах.ВалютаДокумента КАК ВалютаДокумента,
			|	1 КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ.ОтчетКомиссионераОПродажах.Покупатели КАК ОтчетКомиссионераОПродажахПокупатели
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ОтчетКомиссионераОПродажах КАК ВТ_ОтчетКомиссионераОПродажах
			|		ПО ОтчетКомиссионераОПродажахПокупатели.Ссылка = ВТ_ОтчетКомиссионераОПродажах.Ссылка
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Суммы КАК ВТ_Суммы
			|		ПО ОтчетКомиссионераОПродажахПокупатели.КлючСтроки = ВТ_Суммы.КлючСтроки
			|ГДЕ
			|	ОтчетКомиссионераОПродажахПокупатели.СчетФактура = &ТекущийДокумент
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_ОтчетКомиссионераОПродажах.ВалютаДокумента,
			|	ОтчетКомиссионераОПродажахПокупатели.Покупатель,
			|	ВТ_ОтчетКомиссионераОПродажах.Организация,
			|	ВЫБОР
			|		КОГДА ОтчетКомиссионераОПродажахПокупатели.Покупатель = ОтчетКомиссионераОПродажахПокупатели.Ссылка.Контрагент
			|			ТОГДА НЕОПРЕДЕЛЕНО
			|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
			|	КОНЕЦ,
			|	ОтчетКомиссионераОПродажахПокупатели.ДатаСФ";
			
		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.КорректировкаПоступления") Тогда
			
			Запрос.УстановитьПараметр("ДокументОснование_КорректировкаПоступления", ДокументыОснования);
			Запрос.УстановитьПараметр("КорректировочныйСчетФактура", СчетФактура.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.Корректировочный);
			
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	КорректировкаПоступленияТовары.Ссылка.Организация КАК Организация,
			|	КорректировкаПоступленияТовары.Ссылка.Контрагент КАК Контрагент,
			|	КорректировкаПоступленияТовары.Ссылка.ДоговорКонтрагента КАК Договор,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияТовары.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаПоступленияТовары.Сумма - КорректировкаПоступленияТовары.СуммаДоИзменения > 0
			|								ТОГДА КорректировкаПоступленияТовары.Сумма - КорректировкаПоступленияТовары.СуммаДоИзменения
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаПоступленияТовары.Сумма + КорректировкаПоступленияТовары.СуммаНДС - (КорректировкаПоступленияТовары.СуммаДоИзменения + КорректировкаПоступленияТовары.СуммаНДСДоИзменения) > 0
			|							ТОГДА КорректировкаПоступленияТовары.Сумма + КорректировкаПоступленияТовары.СуммаНДС - (КорректировкаПоступленияТовары.СуммаДоИзменения + КорректировкаПоступленияТовары.СуммаНДСДоИзменения)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаУвеличение,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияТовары.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаПоступленияТовары.Сумма - КорректировкаПоступленияТовары.СуммаДоИзменения < 0
			|								ТОГДА КорректировкаПоступленияТовары.СуммаДоИзменения - КорректировкаПоступленияТовары.Сумма
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаПоступленияТовары.Сумма + КорректировкаПоступленияТовары.СуммаНДС - (КорректировкаПоступленияТовары.СуммаДоИзменения + КорректировкаПоступленияТовары.СуммаНДСДоИзменения) < 0
			|							ТОГДА КорректировкаПоступленияТовары.СуммаДоИзменения + КорректировкаПоступленияТовары.СуммаНДСДоИзменения - (КорректировкаПоступленияТовары.Сумма + КорректировкаПоступленияТовары.СуммаНДС)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаУменьшение,
			|	КорректировкаПоступленияТовары.Ссылка.ВалютаДокумента КАК ВалютаДокумента,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияТовары.СуммаНДС - КорректировкаПоступленияТовары.СуммаНДСДоИзменения > 0
			|					ТОГДА КорректировкаПоступленияТовары.СуммаНДС - КорректировкаПоступленияТовары.СуммаНДСДоИзменения
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаНДСУвеличение,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияТовары.СуммаНДС - КорректировкаПоступленияТовары.СуммаНДСДоИзменения < 0
			|					ТОГДА КорректировкаПоступленияТовары.СуммаНДСДоИзменения - КорректировкаПоступленияТовары.СуммаНДС
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаНДСУменьшение,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА ВЫБОР
			|					КОГДА КорректировкаПоступленияТовары.Ссылка.СуммаВключаетНДС
			|						ТОГДА КорректировкаПоступленияТовары.Сумма
			|					ИНАЧЕ КорректировкаПоступленияТовары.Сумма + КорректировкаПоступленияТовары.СуммаНДС
			|				КОНЕЦ
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияТовары.Ссылка.СуммаВключаетНДС
			|					ТОГДА КорректировкаПоступленияТовары.Сумма - КорректировкаПоступленияТовары.СуммаДоИзменения
			|				ИНАЧЕ КорректировкаПоступленияТовары.Сумма + КорректировкаПоступленияТовары.СуммаНДС - (КорректировкаПоступленияТовары.СуммаДоИзменения + КорректировкаПоступленияТовары.СуммаНДСДоИзменения)
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаДокумента,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА КорректировкаПоступленияТовары.СуммаНДС
			|		ИНАЧЕ КорректировкаПоступленияТовары.СуммаНДС - КорректировкаПоступленияТовары.СуммаНДСДоИзменения
			|	КОНЕЦ КАК СуммаНДСДокумента,
			|	ВЫБОР
			|		КОГДА КорректировкаПоступленияТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ.КорректировкаПоступления.Товары КАК КорректировкаПоступленияТовары
			|ГДЕ
			|	КорректировкаПоступленияТовары.Ссылка В(&ДокументОснование_КорректировкаПоступления)
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	КорректировкаПоступленияУслуги.Ссылка.Организация,
			|	КорректировкаПоступленияУслуги.Ссылка.Контрагент,
			|	КорректировкаПоступленияУслуги.Ссылка.ДоговорКонтрагента,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияУслуги.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаПоступленияУслуги.Сумма - КорректировкаПоступленияУслуги.СуммаДоИзменения > 0
			|								ТОГДА КорректировкаПоступленияУслуги.Сумма - КорректировкаПоступленияУслуги.СуммаДоИзменения
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаПоступленияУслуги.Сумма + КорректировкаПоступленияУслуги.СуммаНДС - (КорректировкаПоступленияУслуги.СуммаДоИзменения + КорректировкаПоступленияУслуги.СуммаНДСДоИзменения) > 0
			|							ТОГДА КорректировкаПоступленияУслуги.Сумма + КорректировкаПоступленияУслуги.СуммаНДС - (КорректировкаПоступленияУслуги.СуммаДоИзменения + КорректировкаПоступленияУслуги.СуммаНДСДоИзменения)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияУслуги.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаПоступленияУслуги.Сумма - КорректировкаПоступленияУслуги.СуммаДоИзменения < 0
			|								ТОГДА КорректировкаПоступленияУслуги.СуммаДоИзменения - КорректировкаПоступленияУслуги.Сумма
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаПоступленияУслуги.Сумма + КорректировкаПоступленияУслуги.СуммаНДС - (КорректировкаПоступленияУслуги.СуммаДоИзменения + КорректировкаПоступленияУслуги.СуммаНДСДоИзменения) < 0
			|							ТОГДА КорректировкаПоступленияУслуги.СуммаДоИзменения + КорректировкаПоступленияУслуги.СуммаНДСДоИзменения - (КорректировкаПоступленияУслуги.Сумма + КорректировкаПоступленияУслуги.СуммаНДС)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ,
			|	КорректировкаПоступленияУслуги.Ссылка.ВалютаДокумента,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияУслуги.СуммаНДС - КорректировкаПоступленияУслуги.СуммаНДСДоИзменения > 0
			|					ТОГДА КорректировкаПоступленияУслуги.СуммаНДС - КорректировкаПоступленияУслуги.СуммаНДСДоИзменения
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияУслуги.СуммаНДС - КорректировкаПоступленияУслуги.СуммаНДСДоИзменения < 0
			|					ТОГДА КорректировкаПоступленияУслуги.СуммаНДСДоИзменения - КорректировкаПоступленияУслуги.СуммаНДС
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА ВЫБОР
			|					КОГДА КорректировкаПоступленияУслуги.Ссылка.СуммаВключаетНДС
			|						ТОГДА КорректировкаПоступленияУслуги.Сумма
			|					ИНАЧЕ КорректировкаПоступленияУслуги.Сумма + КорректировкаПоступленияУслуги.СуммаНДС
			|				КОНЕЦ
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаПоступленияУслуги.Ссылка.СуммаВключаетНДС
			|					ТОГДА КорректировкаПоступленияУслуги.Сумма - КорректировкаПоступленияУслуги.СуммаДоИзменения
			|				ИНАЧЕ КорректировкаПоступленияУслуги.Сумма + КорректировкаПоступленияУслуги.СуммаНДС - (КорректировкаПоступленияУслуги.СуммаДоИзменения + КорректировкаПоступленияУслуги.СуммаНДСДоИзменения)
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА КорректировкаПоступленияУслуги.СуммаНДС
			|		ИНАЧЕ КорректировкаПоступленияУслуги.СуммаНДС - КорректировкаПоступленияУслуги.СуммаНДСДоИзменения
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА КорректировкаПоступленияУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ,
			|	ЛОЖЬ
			|ИЗ
			|	Документ.КорректировкаПоступления.Услуги КАК КорректировкаПоступленияУслуги
			|ГДЕ
			|	КорректировкаПоступленияУслуги.Ссылка В(&ДокументОснование_КорректировкаПоступления)";
			
			Если СчетФактура.Исправление Тогда
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ДоИзменения", "ДоКорректировки");
			КонецЕсли;
			
		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
			
			Запрос.УстановитьПараметр("ДокументОснование_КорректировкаРеализации", ДокументыОснования);
			Запрос.УстановитьПараметр("КорректировочныйСчетФактура", СчетФактура.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.Корректировочный);
			
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	КорректировкаРеализацииТовары.Ссылка.Организация КАК Организация,
			|	КорректировкаРеализацииТовары.Ссылка.Контрагент КАК Контрагент,
			|	КорректировкаРеализацииТовары.Ссылка.ДоговорКонтрагента КАК Договор,
			|	КорректировкаРеализацииТовары.Ссылка.ВалютаДокумента КАК ВалютаДокумента,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииТовары.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаДоИзменения > 0
			|								ТОГДА КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаДоИзменения
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС - (КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения) > 0
			|							ТОГДА КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС - (КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаУвеличение,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииТовары.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаДоИзменения < 0
			|								ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.Сумма
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС - (КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения) < 0
			|							ТОГДА КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения - (КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаУменьшение,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииТовары.СуммаНДС - КорректировкаРеализацииТовары.СуммаНДСДоИзменения > 0
			|					ТОГДА КорректировкаРеализацииТовары.СуммаНДС - КорректировкаРеализацииТовары.СуммаНДСДоИзменения
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаНДСУвеличение,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииТовары.СуммаНДС - КорректировкаРеализацииТовары.СуммаНДСДоИзменения < 0
			|					ТОГДА КорректировкаРеализацииТовары.СуммаНДСДоИзменения - КорректировкаРеализацииТовары.СуммаНДС
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаНДСУменьшение,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА ВЫБОР
			|					КОГДА КорректировкаРеализацииТовары.Ссылка.СуммаВключаетНДС
			|						ТОГДА КорректировкаРеализацииТовары.Сумма
			|					ИНАЧЕ КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС
			|				КОНЕЦ
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииТовары.Ссылка.СуммаВключаетНДС
			|					ТОГДА КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаДоИзменения
			|				ИНАЧЕ КорректировкаРеализацииТовары.Сумма + КорректировкаРеализацииТовары.СуммаНДС - (КорректировкаРеализацииТовары.СуммаДоИзменения + КорректировкаРеализацииТовары.СуммаНДСДоИзменения)
			|			КОНЕЦ
			|	КОНЕЦ КАК СуммаДокумента,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА КорректировкаРеализацииТовары.СуммаНДС
			|		ИНАЧЕ КорректировкаРеализацииТовары.СуммаНДС - КорректировкаРеализацииТовары.СуммаНДСДоИзменения
			|	КОНЕЦ КАК СуммаНДСДокумента,
			|	ВЫБОР
			|		КОГДА КорректировкаРеализацииТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ.КорректировкаРеализации.Товары КАК КорректировкаРеализацииТовары
			|ГДЕ
			|	КорректировкаРеализацииТовары.Ссылка В(&ДокументОснование_КорректировкаРеализации)
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	КорректировкаРеализацииУслуги.Ссылка.Организация,
			|	КорректировкаРеализацииУслуги.Ссылка.Контрагент,
			|	КорректировкаРеализацииУслуги.Ссылка.ДоговорКонтрагента,
			|	КорректировкаРеализацииУслуги.Ссылка.ВалютаДокумента,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииУслуги.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаДоИзменения > 0
			|								ТОГДА КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаДоИзменения
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС - (КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения) > 0
			|							ТОГДА КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС - (КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииУслуги.Ссылка.СуммаВключаетНДС
			|					ТОГДА ВЫБОР
			|							КОГДА КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаДоИзменения < 0
			|								ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.Сумма
			|							ИНАЧЕ 0
			|						КОНЕЦ
			|				ИНАЧЕ ВЫБОР
			|						КОГДА КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС - (КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения) < 0
			|							ТОГДА КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - (КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС)
			|						ИНАЧЕ 0
			|					КОНЕЦ
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииУслуги.СуммаНДС - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения > 0
			|					ТОГДА КорректировкаРеализацииУслуги.СуммаНДС - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА 0
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииУслуги.СуммаНДС - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения < 0
			|					ТОГДА КорректировкаРеализацииУслуги.СуммаНДСДоИзменения - КорректировкаРеализацииУслуги.СуммаНДС
			|				ИНАЧЕ 0
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА ВЫБОР
			|					КОГДА КорректировкаРеализацииУслуги.Ссылка.СуммаВключаетНДС
			|						ТОГДА КорректировкаРеализацииУслуги.Сумма
			|					ИНАЧЕ КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС
			|				КОНЕЦ
			|		ИНАЧЕ ВЫБОР
			|				КОГДА КорректировкаРеализацииУслуги.Ссылка.СуммаВключаетНДС
			|					ТОГДА КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаДоИзменения
			|				ИНАЧЕ КорректировкаРеализацииУслуги.Сумма + КорректировкаРеализацииУслуги.СуммаНДС - (КорректировкаРеализацииУслуги.СуммаДоИзменения + КорректировкаРеализацииУслуги.СуммаНДСДоИзменения)
			|			КОНЕЦ
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА НЕ &КорректировочныйСчетФактура
			|			ТОГДА КорректировкаРеализацииУслуги.СуммаНДС
			|		ИНАЧЕ КорректировкаРеализацииУслуги.СуммаНДС - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения
			|	КОНЕЦ,
			|	ВЫБОР
			|		КОГДА КорректировкаРеализацииУслуги.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ,
			|	ЛОЖЬ
			|ИЗ
			|	Документ.КорректировкаРеализации.Услуги КАК КорректировкаРеализацииУслуги
			|ГДЕ
			|	КорректировкаРеализацииУслуги.Ссылка В(&ДокументОснование_КорректировкаРеализации)";
			
			Если СчетФактура.Исправление Тогда
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ДоИзменения", "ДоКорректировки");
			КонецЕсли;

		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.НачислениеНДСпоСМРхозспособом") тогда 
			
			Запрос.УстановитьПараметр("ДокументОснование_НачислениеНДСпоСМРхозспособом", ДокументыОснования);
		
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	НачислениеНДСпоСМРхозспособом.Ссылка.Организация,
			|	НЕОПРЕДЕЛЕНО КАК Контрагент,
			|	НЕОПРЕДЕЛЕНО КАК Договор,
			|	СУММА(НачислениеНДСпоСМРхозспособом.СуммаБезНДС + НачислениеНДСпоСМРхозспособом.НДС) КАК СуммаДокумента,
			|	&ВалютаРегламентированногоУчета КАК ВалютаДокумента,
			|	СУММА(НачислениеНДСпоСМРхозспособом.НДС) КАК СуммаНДСДокумента,
			|	1 КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ.НачислениеНДСпоСМРхозспособом.СМРхозспособом КАК НачислениеНДСпоСМРхозспособом
			|ГДЕ
			|	НачислениеНДСпоСМРхозспособом.Ссылка В(&ДокументОснование_НачислениеНДСпоСМРхозспособом)
			|
			|СГРУППИРОВАТЬ ПО
			|	НачислениеНДСпоСМРхозспособом.Ссылка.Организация";
			
		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.ПринятиеКУчетуОС") Тогда
			
			Запрос.УстановитьПараметр("ДокументОснование_ПринятиеКУчетуОС", ДокументыОснования);
		
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	НДСНачисленныйОбороты.Организация КАК Организация,
			|	НЕОПРЕДЕЛЕНО КАК Контрагент,
			|	НЕОПРЕДЕЛЕНО КАК Договор,
			|	НДСНачисленныйОбороты.СуммаБезНДСПриход + НДСНачисленныйОбороты.НДСПриход КАК СуммаДокумента,
			|	&ВалютаРегламентированногоУчета КАК ВалютаДокумента,
			|	НДСНачисленныйОбороты.НДСПриход КАК СуммаНДСДокумента,
			|	1 КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	РегистрНакопления.НДСНачисленный.Обороты(
			|			,
			|			,
			|			Период,
			|			СчетФактура ССЫЛКА Документ.ПринятиеКУчетуОС
			|				И СчетФактура В (&ДокументОснование_ПринятиеКУчетуОС)) КАК НДСНачисленныйОбороты";

		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.МодернизацияОС") Тогда
			
			Запрос.УстановитьПараметр("ДокументОснование_МодернизацияОС", ДокументыОснования);
		
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	НДСНачисленныйОбороты.Организация КАК Организация,
			|	НЕОПРЕДЕЛЕНО КАК Контрагент,
			|	НЕОПРЕДЕЛЕНО КАК Договор,
			|	НДСНачисленныйОбороты.СуммаБезНДСПриход + НДСНачисленныйОбороты.НДСПриход КАК СуммаДокумента,
			|	&ВалютаРегламентированногоУчета КАК ВалютаДокумента,
			|	НДСНачисленныйОбороты.НДСПриход КАК СуммаНДСДокумента,
			|	1 КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	РегистрНакопления.НДСНачисленный.Обороты(
			|			,
			|			,
			|			Период,
			|			СчетФактура ССЫЛКА Документ.МодернизацияОС
			|				И СчетФактура В (&ДокументОснование_МодернизацияОС)) КАК НДСНачисленныйОбороты";
		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.РеализацияОтгруженныхТоваров") Тогда
			
			Запрос.УстановитьПараметр("ДокументОснование_РеализацияОтгруженныхТоваров", ДокументыОснования);
		
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	РеализацияОтгруженныхТоваров.Организация,
			|	РеализацияОтгруженныхТоваров.Контрагент,
			|	РеализацияОтгруженныхТоваров.ДоговорКонтрагента КАК Договор,
			|	РеализацияОтгруженныхТоваров.СуммаДокумента КАК СуммаДокумента,
			|	РеализацияОтгруженныхТоваров.ДокументОтгрузки.ВалютаДокумента КАК ВалютаДокумента,
			|	РеализацияОтгруженныхТоваров.ДокументОтгрузки КАК ДокументОтгрузки
			|ПОМЕСТИТЬ ВТ_РеализацияОтгруженныхТоваров
			|ИЗ
			|	Документ.РеализацияОтгруженныхТоваров КАК РеализацияОтгруженныхТоваров
			|ГДЕ
			|	РеализацияОтгруженныхТоваров.Ссылка В(&ДокументОснование_РеализацияОтгруженныхТоваров)
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	ДокументОтгрузки
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
			|	СУММА(РеализацияТоваровУслугТовары.СуммаНДС) КАК СуммаНДСДокумента,
			|	СУММА(ВЫБОР
			|			КОГДА РеализацияТоваровУслугТовары.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|				ТОГДА 0
			|			ИНАЧЕ 1
			|		КОНЕЦ) КАК ЕстьНДС
			|ПОМЕСТИТЬ ВТ_ТаблицыНДС
			|ИЗ
			|	ВТ_РеализацияОтгруженныхТоваров КАК ВТ_РеализацияОтгруженныхТоваров
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
			|		ПО ВТ_РеализацияОтгруженныхТоваров.ДокументОтгрузки = РеализацияТоваровУслугТовары.Ссылка
			|
			|СГРУППИРОВАТЬ ПО
			|	РеализацияТоваровУслугТовары.Ссылка
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ПередачаОСОС.Ссылка,
			|	СУММА(ПередачаОСОС.СуммаНДС),
			|	СУММА(ВЫБОР
			|			КОГДА ПередачаОСОС.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|				ТОГДА 0
			|			ИНАЧЕ 1
			|		КОНЕЦ)
			|ИЗ
			|	ВТ_РеализацияОтгруженныхТоваров КАК ВТ_РеализацияОтгруженныхТоваров
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаОС.ОС КАК ПередачаОСОС
			|		ПО ВТ_РеализацияОтгруженныхТоваров.ДокументОтгрузки = ПередачаОСОС.Ссылка
			|
			|СГРУППИРОВАТЬ ПО
			|	ПередачаОСОС.Ссылка
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВТ_РеализацияОтгруженныхТоваров.Организация,
			|	ВТ_РеализацияОтгруженныхТоваров.Контрагент,
			|	ВТ_РеализацияОтгруженныхТоваров.Договор,
			|	ВТ_РеализацияОтгруженныхТоваров.СуммаДокумента,
			|	ВТ_РеализацияОтгруженныхТоваров.ВалютаДокумента,
			|	СУММА(ВТ_ТаблицыНДС.СуммаНДСДокумента) КАК СуммаНДСДокумента,
			|	СУММА(ВТ_ТаблицыНДС.ЕстьНДС) КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	ВТ_РеализацияОтгруженныхТоваров КАК ВТ_РеализацияОтгруженныхТоваров
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТаблицыНДС КАК ВТ_ТаблицыНДС
			|		ПО ВТ_РеализацияОтгруженныхТоваров.ДокументОтгрузки = ВТ_ТаблицыНДС.Ссылка
			|
			|СГРУППИРОВАТЬ ПО
			|	ВТ_РеализацияОтгруженныхТоваров.Организация,
			|	ВТ_РеализацияОтгруженныхТоваров.Контрагент,
			|	ВТ_РеализацияОтгруженныхТоваров.Договор,
			|	ВТ_РеализацияОтгруженныхТоваров.СуммаДокумента,
			|	ВТ_РеализацияОтгруженныхТоваров.ВалютаДокумента";
		
		ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.ПоступлениеДопРасходов") Тогда
			
			Запрос.УстановитьПараметр("ДокументОснование_ПоступлениеДопРасходов", ДокументыОснования);
				
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	Таблица.Ссылка.Организация КАК Организация,
			|	Таблица.Ссылка.Контрагент КАК Контрагент,
			|	Таблица.Ссылка.ДоговорКонтрагента КАК Договор,
			|	СУММА(Таблица.Сумма + ВЫБОР
			|			КОГДА Таблица.Ссылка.СуммаВключаетНДС
			|				ТОГДА 0
			|			ИНАЧЕ Таблица.СуммаНДС
			|		КОНЕЦ) КАК СуммаДокумента,
			|	Таблица.Ссылка.ВалютаДокумента КАК ВалютаДокумента,
			|	СУММА(Таблица.СуммаНДС) КАК СуммаНДСДокумента,
			|	СУММА(ВЫБОР
			|			КОГДА Таблица.Ссылка.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|				ТОГДА 0
			|			ИНАЧЕ 1
			|		КОНЕЦ) КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ.ПоступлениеДопРасходов.Товары КАК Таблица
			|ГДЕ
			|	Таблица.Ссылка В(&ДокументОснование_ПоступлениеДопРасходов)
			|
			|СГРУППИРОВАТЬ ПО
			|	Таблица.Ссылка,
			|	Таблица.Ссылка.Организация,
			|	Таблица.Ссылка.Контрагент,
			|	Таблица.Ссылка.ДоговорКонтрагента,
			|	Таблица.Ссылка.ВалютаДокумента
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ПоступлениеДопРасходов.Организация,
			|	ПоступлениеДопРасходов.Контрагент,
			|	ПоступлениеДопРасходов.ДоговорКонтрагента,
			|	СУММА(ПоступлениеДопРасходов.Сумма + ВЫБОР
			|			КОГДА ПоступлениеДопРасходов.СуммаВключаетНДС
			|				ТОГДА 0
			|			ИНАЧЕ ПоступлениеДопРасходов.СуммаНДС
			|		КОНЕЦ),
			|	ПоступлениеДопРасходов.ВалютаДокумента,
			|	СУММА(ПоступлениеДопРасходов.СуммаНДС),
			|	СУММА(ВЫБОР
			|			КОГДА ПоступлениеДопРасходов.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|				ТОГДА 0
			|			ИНАЧЕ 1
			|		КОНЕЦ),
			|	ЛОЖЬ
			|ИЗ
			|	Документ.ПоступлениеДопРасходов КАК ПоступлениеДопРасходов
			|ГДЕ
			|	ПоступлениеДопРасходов.Ссылка В(&ДокументОснование_ПоступлениеДопРасходов)
			|
			|СГРУППИРОВАТЬ ПО
			|	ПоступлениеДопРасходов.Организация,
			|	ПоступлениеДопРасходов.Контрагент,
			|	ПоступлениеДопРасходов.ДоговорКонтрагента,
			|	ПоступлениеДопРасходов.ВалютаДокумента";
				
		Иначе
			
			ТекстЗапроса = ПолучитьТекстЗапросаОпределенияПараметровСФ(ДокументыОснования, ЭтоПолученныйСФ, Запрос.Параметры);
			
		КонецЕсли;
		
		Если НЕ ПустаяСтрока(ТекстЗапроса) Тогда
			Если НЕ ПустаяСтрока(Запрос.Текст) Тогда
				Запрос.Текст = Запрос.Текст + Символы.ПС + Символы.ПС + "ОБЪЕДИНИТЬ ВСЕ" + Символы.ПС + Символы.ПС;
			КонецЕсли;
			
			Запрос.Текст = Запрос.Текст + ТекстЗапроса;
		КонецЕсли;

	КонецЦикла;
	
	Если ПустаяСтрока(Запрос.Текст) Тогда
	    Возврат;
	Иначе
		РезультатЗапроса = Запрос.Выполнить();
		Если РезультатЗапроса.Пустой() Тогда
			Возврат;
		КонецЕсли;
		
		Выборка = РезультатЗапроса.Выбрать();
		ПерваяСтрока      = Истина;
		РазныеОрганизации = Ложь;
		РазныеКонтрагенты = Ложь;
		РазныеДоговоры    = Ложь;
		РазныеВалюты      = Ложь;
		Пока Выборка.Следующий() Цикл
			Если ПерваяСтрока Тогда
				ПерваяСтрока = Ложь;
				ЗаполнитьЗначенияСвойств(Результат, Выборка);
				Результат.СчетФактураБезНДС = Выборка.ЕстьНДС = 0;
			Иначе
				РазныеОрганизации = РазныеОрганизации ИЛИ Результат.Организация <> Выборка.Организация;
				РазныеКонтрагенты = РазныеКонтрагенты ИЛИ Результат.Контрагент <> Выборка.Контрагент;
				РазныеВалюты      = РазныеВалюты ИЛИ Результат.ВалютаДокумента <> Выборка.ВалютаДокумента;
				РазныеДоговоры    = ?(ЭтоПолученныйСФ, Ложь, РазныеДоговоры ИЛИ Результат.Договор <> Выборка.Договор);
				
				Результат.СуммаДокумента = 	Результат.СуммаДокумента + Выборка.СуммаДокумента;
				Результат.СуммаНДСДокумента = Результат.СуммаНДСДокумента + Выборка.СуммаНДСДокумента;
				
				Если ТипДокументаОснования = Тип("ДокументСсылка.КорректировкаРеализации") 
					ИЛИ ТипДокументаОснования = Тип("ДокументСсылка.КорректировкаПоступления") Тогда
					
					Результат.СуммаУвеличение       =	Результат.СуммаУвеличение    + Выборка.СуммаУвеличение;
					Результат.СуммаУменьшение    =	Результат.СуммаУменьшение + Выборка.СуммаУменьшение;
					Результат.СуммаНДСУвеличение    =	Результат.СуммаНДСУвеличение    + Выборка.СуммаНДСУвеличение;
					Результат.СуммаНДСУменьшение = Результат.СуммаНДСУменьшение + Выборка.СуммаНДСУменьшение;
				Иначе
					Результат.СуммаУвеличение = 0;
					Результат.СуммаУменьшение = 0;					
					Результат.СуммаНДСУвеличение = 0;
					Результат.СуммаНДСУменьшение = 0;					
				КонецЕсли;
				
				Если Результат.СчетФактураБезНДС Тогда
					Результат.СчетФактураБезНДС = Выборка.ЕстьНДС = 0;
				КонецЕсли;
				
			КонецЕсли;
		КонецЦикла;
		
		Если РазныеОрганизации ИЛИ РазныеКонтрагенты ИЛИ РазныеВалюты Тогда
			ОбщегоНазначения.СообщитьОбОшибке("Реквизиты документов, на основании которых зарегистрирован счет-фактура, не совпадают:"+
				?(РазныеОрганизации,Символы.ПС+" - не совпадает организация","")+
				?(РазныеКонтрагенты,Символы.ПС+" - не совпадает контрагент","")+
				?(РазныеДоговоры,Символы.ПС+" - не совпадает договор","")+
				?(РазныеВалюты,Символы.ПС+" - не совпадает валюта документа","")+
				Символы.ПС+"Необходимо изменить параметры документов-оснований или зарегистрировать по документам с расхождениями отдельные счета-фактуры.", Ложь, Строка(СчетФактура), СтатусСообщения.Внимание); 
			Если РазныеОрганизации Тогда
				 Результат.Организация = Неопределено;
			КонецЕсли; 				
			Если РазныеКонтрагенты Тогда
				 Результат.Контрагент = Неопределено;
			КонецЕсли; 				
			Если РазныеВалюты Тогда
				 Результат.ВалютаДокумента = Неопределено;
			КонецЕсли; 				
			Если РазныеДоговоры Тогда
				 Результат.Договор = Неопределено;
			КонецЕсли;
		КонецЕсли; 
	КонецЕсли;

КонецПроцедуры // ПолучитьПараметрыСчетаФактуры()

Функция ПолучитьТекстЗапросаОпределенияПараметровСФ(ДокументыОснования, ЭтоПолученныйСФ, ПараметрыЗапроса, ИмяВременнойТаблицы = "") Экспорт
	
	ИгнорироватьТЧ = Новый Массив;
	ИгнорироватьТЧ.Добавить("ВозвратнаяТара");
	ИгнорироватьТЧ.Добавить("ВыданныеАвансы");
	ИгнорироватьТЧ.Добавить("ДенежныеСредства");
	ИгнорироватьТЧ.Добавить("ПрочиеЗатраты");
	ИгнорироватьТЧ.Добавить("РаспределениеПрочихЗатрат");
	ИгнорироватьТЧ.Добавить("ИспользованныеМатериалы");
	
	МетаданныеДокумента = ДокументыОснования[0].Метаданные();
	ТипДокументаОснования = ТипЗнч(ДокументыОснования[0]);
	
	ИмяОбъекта = МетаданныеДокумента.Имя;
	ПараметрыЗапроса.Вставить("ДокументОснование_" + ИмяОбъекта, ДокументыОснования);
	
	ПостфиксСумм = "";
	Множитель = 1;
	ИмяРеквизитаСтавкаНДС = "СтавкаНДС";
	
	Если ТипДокументаОснования = Тип("ДокументСсылка.ОтчетКомитентуОПродажах")
		ИЛИ ТипДокументаОснования = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах") И ЭтоПолученныйСФ Тогда
			
		ПостфиксСумм = "Вознаграждения";
		ИмяРеквизитаСтавкаНДС = "Ссылка.СтавкаНДСВознаграждения";
	ИначеЕсли ТипДокументаОснования = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя") И НЕ ЭтоПолученныйСФ
		ИЛИ ТипДокументаОснования = Тип("ДокументСсылка.ВозвратТоваровПоставщику") И ЭтоПолученныйСФ Тогда
			
		Множитель = - 1;
	КонецЕсли;
	
	ПараметрыЗапроса.Вставить("Множитель_" + ИмяОбъекта, Множитель);
	
	ТекстЗапроса = "";
	
	ТекстСекцииПоместить = "";
	
	Для каждого МетаданныеТЧ Из МетаданныеДокумента.ТабличныеЧасти Цикл
		Если ИгнорироватьТЧ.Найти(МетаданныеТЧ.Имя) <> Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если МетаданныеТЧ.Реквизиты.Найти("Сумма") = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		ЕстьСуммаВключаетНДС = МетаданныеДокумента.Реквизиты.Найти("СуммаВключаетНДС") <> Неопределено;
		
		Если ПустаяСтрока(ТекстЗапроса) Тогда
			Если НЕ ПустаяСтрока(ИмяВременнойТаблицы) Тогда
				ТекстСекцииПоместить = "
				|ПОМЕСТИТЬ
				|	" + ИмяВременнойТаблицы + "
				|";
			КонецЕсли;
		Иначе
			ТекстЗапроса = ТекстЗапроса + Символы.ПС + Символы.ПС + "ОБЪЕДИНИТЬ ВСЕ" + Символы.ПС + Символы.ПС;
			ТекстСекцииПоместить = "";
		КонецЕсли;
		
		ТекстЗапроса = ТекстЗапроса +
		"ВЫБРАТЬ
		|	Таблица.Ссылка.Организация КАК Организация,
		|	Таблица.Ссылка.Контрагент КАК Контрагент,
		|	Таблица.Ссылка.ДоговорКонтрагента КАК Договор,
		|	СУММА(Таблица.Сумма" + ПостфиксСумм + ?(ЕстьСуммаВключаетНДС, " + ВЫБОР
		|			КОГДА Таблица.Ссылка.СуммаВключаетНДС
		|				ТОГДА 0
		|			ИНАЧЕ Таблица.СуммаНДС" + ПостфиксСумм + "
		|		КОНЕЦ", "") + ") * &Множитель_" + ИмяОбъекта + " КАК СуммаДокумента,
		|	Таблица.Ссылка.ВалютаДокумента КАК ВалютаДокумента,
		|	СУММА(Таблица.СуммаНДС" + ПостфиксСумм + ") * &Множитель_" + ИмяОбъекта + " КАК СуммаНДСДокумента,
		|	СУММА(ВЫБОР
		|			КОГДА Таблица." + ИмяРеквизитаСтавкаНДС + " = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
		|				ТОГДА 0
		|			ИНАЧЕ 1
		|		КОНЕЦ) КАК ЕстьНДС,
		|	ЛОЖЬ КАК БланкСтрогойОтчетности" + ТекстСекцииПоместить + "
		|ИЗ
		|	Документ." + МетаданныеДокумента.Имя + "." + МетаданныеТЧ.Имя + " КАК Таблица
		|ГДЕ
		|	Таблица.Ссылка В (&ДокументОснование_" + ИмяОбъекта + ")
		|
		|СГРУППИРОВАТЬ ПО
		|	Таблица.Ссылка,
		|	Таблица.Ссылка.Организация,
		|	Таблица.Ссылка.Контрагент,
		|	Таблица.Ссылка.ДоговорКонтрагента,
		|	Таблица.Ссылка.ВалютаДокумента";
	КонецЦикла;
	
	Если НЕ ЗначениеЗаполнено(ТекстЗапроса) Тогда // в документе не оказалось табличных частей
		
		Если МетаданныеДокумента.Реквизиты.Найти("СуммаНДС") <> Неопределено Тогда
			
			ТекстЗапроса = 
			"ВЫБРАТЬ
			|	ДокОснование.Организация КАК Организация,
			|	ДокОснование.Контрагент КАК Контрагент,
			|	ДокОснование.ДоговорКонтрагента КАК Договор,
			|	СУММА(ДокОснование.Сумма + ВЫБОР
			|			КОГДА ДокОснование.Ссылка.СуммаВключаетНДС
			|				ТОГДА 0
			|			ИНАЧЕ ДокОснование.СуммаНДС
			|		КОНЕЦ) КАК СуммаДокумента,
			|	&ВалютаРегламентированногоУчета КАК ВалютаДокумента,
			|	ДокОснование.СуммаНДС КАК СуммаНДСДокумента,
			|	ВЫБОР
			|		КОГДА ДокОснование.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ КАК ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ." + МетаданныеДокумента.Имя + " КАК ДокОснование
			|ГДЕ
			|	ДокОснование.Ссылка В (&ДокументОснование_" + МетаданныеДокумента.Имя + ")
			|
			|СГРУППИРОВАТЬ ПО
			|	ДокОснование.Ссылка,
			|	ДокОснование.ДоговорКонтрагента,
			|	ДокОснование.СуммаНДС,
			|	ДокОснование.Организация,
			|	ДокОснование.Контрагент,
			|	ВЫБОР
			|		КОГДА ДокОснование.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
			|			ТОГДА 0
			|		ИНАЧЕ 1
			|	КОНЕЦ";
			
			
		Иначе
			
			Если (ТипДокументаОснования = Тип("ДокументСсылка.ОтчетКомитентуОПродажах"))
				или ((ТипДокументаОснования = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах")) И ЭтоПолученныйСФ) Тогда
				ИдРеквСумма = "СуммаВознаграждения";
			ИначеЕсли (ТипДокументаОснования = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя") И не ЭтоПолученныйСФ) тогда
				ИдРеквСумма = "СуммаДокумента*(-1)";
			ИначеЕсли (ТипДокументаОснования = Тип("ДокументСсылка.ВозвратТоваровПоставщику") И ЭтоПолученныйСФ) тогда
				ИдРеквСумма = "СуммаДокумента*(-1)";
			Иначе
				ИдРеквСумма = "СуммаДокумента";
			КонецЕсли;
			
			ИмяОбъекта = МетаданныеДокумента.Имя;
			
			ТекстЗапроса = "ВЫБРАТЬ
			|	" + ИмяОбъекта + ".Организация,
			|	" + ИмяОбъекта + ".Контрагент,
			|	" + ИмяОбъекта + ".ДоговорКонтрагента как Договор,
			|	" + ИмяОбъекта + "." + ИдРеквСумма + " Как СуммаДокумента,
			|	" + ИмяОбъекта + ".ВалютаДокумента Как ВалютаДокумента,
			|	0 Как СуммаНДСДокумента,
			|	1 Как ЕстьНДС,
			|	ЛОЖЬ КАК БланкСтрогойОтчетности
			|ИЗ
			|	Документ." + ИмяОбъекта + " КАК " + ИмяОбъекта + "
			
			|ГДЕ
			|	" + ИмяОбъекта + ".Ссылка в (&ДокументОснование_"+ИмяОбъекта+")";
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

//Функция определения вида ценности по группе критериев
//
Функция ОпределитьВидЦенности(Объект, СчетУчета, ЭтоДопРасходы = Ложь, ЭтоТаможенныйНДС = Ложь, ЭтоАгентскийНДС = Ложь, ВидАгентскогоДоговора = "", ЭтоУслуга = Неопределено, СтруктураШапкиДокумента = Неопределено, СпособСтроительства = Неопределено, ВидыЦенностейПоСчетамУчета = Неопределено) Экспорт

	ВидЦенности = Перечисления.ВидыЦенностей.ПустаяСсылка();

	ДатаДокумента = ?(СтруктураШапкиДокумента = Неопределено, '00010101', СтруктураШапкиДокумента.Дата);
	Если ЭтоТаможенныйНДС Тогда
		Если ВидыЦенностейПоСчетамУчета = Неопределено Тогда
			ВидыЦенностейПоСчетамУчета = Новый Соответствие;
		КонецЕсли;
		СчетаУчетаЦенностей = ВидыЦенностейПоСчетамУчета["ОС"];
		Если СчетаУчетаЦенностей = Неопределено Тогда
			СчетаУчетаЦенностей = ОпределитьСчетаУчетаЦенностей("ОС", ДатаДокумента);
			ВидыЦенностейПоСчетамУчета.Вставить("ОС", СчетаУчетаЦенностей);
		КонецЕсли;
		Для Каждого СчетУчетаЦенности Из СчетаУчетаЦенностей Цикл
			ВидыЦенностейПоСчетамУчета.Вставить(СчетУчетаЦенности.Значение, Перечисления.ВидыЦенностей.ТаможенныеПлатежиОС);
		КонецЦикла;
		Если СтруктураШапкиДокумента.Дата >= '20060101' 
			И Не СчетаУчетаЦенностей.НайтиПоЗначению(СчетУчета) = Неопределено Тогда
			ВидЦенности = Перечисления.ВидыЦенностей.ТаможенныеПлатежиОС;
		Иначе
			ВидЦенности = Перечисления.ВидыЦенностей.ТаможенныеПлатежи;
		КонецЕсли;
		
	ИначеЕсли ЭтоАгентскийНДС Тогда
		// Это агентский НДС - для него применяется специальный вид ценности
		Если ВидАгентскогоДоговора = Перечисления.ВидыАгентскихДоговоров.Аренда Тогда
			ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентАренда;
		ИначеЕсли ВидАгентскогоДоговора = Перечисления.ВидыАгентскихДоговоров.РеализацияИмущества Тогда
			ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентРеализацияИмущества;
		Иначе
			ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентИностранцы;
		КонецЕсли;
		
	ИначеЕсли Не ЗначениеЗаполнено(СчетУчета) Тогда
		ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги;

	ИначеЕсли ЭтоДопРасходы Тогда
		// Это всегда услуги
		Если СчетУчета.ПринадлежитЭлементу(ПланыСчетов.Хозрасчетный.СтроительствоОбъектовОсновныхСредств) тогда
			ВидЦенности = Перечисления.ВидыЦенностей.СМРПодрядные;
		Иначе
			ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги;
		КонецЕслИ;

	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.Номенклатура") тогда	
		ВидЦенности = ?(ВидыЦенностейПоСчетамУчета = Неопределено, Неопределено, ВидыЦенностейПоСчетамУчета[СчетУчета]);
		Если ВидЦенности = Неопределено Тогда
			Если ВидыЦенностейПоСчетамУчета = Неопределено Тогда
				ВидыЦенностейПоСчетамУчета = Новый Соответствие;
			КонецЕсли;
			СчетаУчетаЦенностей = ВидыЦенностейПоСчетамУчета["Материалы"];
			Если СчетаУчетаЦенностей = Неопределено Тогда
				СчетаУчетаЦенностей = ОпределитьСчетаУчетаЦенностей("Материалы");
				ВидыЦенностейПоСчетамУчета.Вставить("Материалы", СчетаУчетаЦенностей);
			КонецЕсли;
			Для Каждого СчетУчетаЦенности Из СчетаУчетаЦенностей Цикл
				ВидыЦенностейПоСчетамУчета.Вставить(СчетУчетаЦенности.Значение, Перечисления.ВидыЦенностей.Материалы);
			КонецЦикла;
			Если СчетаУчетаЦенностей.НайтиПоЗначению(СчетУчета) <> Неопределено тогда
				ВидЦенности = Перечисления.ВидыЦенностей.Материалы;
			Иначе
				СчетаУчетаЦенностей = ВидыЦенностейПоСчетамУчета["ОС"];
				Если СчетаУчетаЦенностей = Неопределено Тогда
					СчетаУчетаЦенностей = ОпределитьСчетаУчетаЦенностей("ОС", ДатаДокумента);
					ВидыЦенностейПоСчетамУчета.Вставить("ОС", СчетаУчетаЦенностей);
				КонецЕсли;
				Для Каждого СчетУчетаЦенности Из СчетаУчетаЦенностей Цикл
					ВидыЦенностейПоСчетамУчета.Вставить(СчетУчетаЦенности.Значение, Перечисления.ВидыЦенностей.ОС);
				КонецЦикла;
				Если СчетаУчетаЦенностей.НайтиПоЗначению(СчетУчета) <> Неопределено тогда
					ВидЦенности = Перечисления.ВидыЦенностей.ОС;
				Иначе
					СчетаУчетаЦенностей = ВидыЦенностейПоСчетамУчета["Оборудование"];
					Если СчетаУчетаЦенностей = Неопределено Тогда
						СчетаУчетаЦенностей = ОпределитьСчетаУчетаЦенностей("Оборудование", ДатаДокумента);
						ВидыЦенностейПоСчетамУчета.Вставить("Оборудование", СчетаУчетаЦенностей);
					КонецЕсли;
					Для Каждого СчетУчетаЦенности Из СчетаУчетаЦенностей Цикл
						ВидыЦенностейПоСчетамУчета.Вставить(СчетУчетаЦенности.Значение, Перечисления.ВидыЦенностей.ОС);
					КонецЦикла;
					Если СчетаУчетаЦенностей.НайтиПоЗначению(СчетУчета) <> Неопределено тогда
						ВидЦенности = Перечисления.ВидыЦенностей.ОС;
					Иначе
						СчетаУчетаЦенностей = ВидыЦенностейПоСчетамУчета["НМА"];
						Если СчетаУчетаЦенностей = Неопределено Тогда
							СчетаУчетаЦенностей = ОпределитьСчетаУчетаЦенностей("НМА");
							ВидыЦенностейПоСчетамУчета.Вставить("НМА", СчетаУчетаЦенностей);
						КонецЕсли;
						Для Каждого СчетУчетаЦенности Из СчетаУчетаЦенностей Цикл
							ВидыЦенностейПоСчетамУчета.Вставить(СчетУчетаЦенности.Значение, Перечисления.ВидыЦенностей.НМА);
						КонецЦикла;
						Если СчетаУчетаЦенностей.НайтиПоЗначению(СчетУчета) <> Неопределено тогда
							ВидЦенности = Перечисления.ВидыЦенностей.НМА;
						Иначе
							Если ЭтоУслуга = Неопределено Или ЭтоУслуга = Null Тогда
								ЭтоУслуга = Объект.Услуга;
							КонецЕсли;
							Если ЭтоУслуга Тогда
								ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги;	
							Иначе
								ВидЦенности = Перечисления.ВидыЦенностей.Товары;	
							КонецЕсли; 
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
			
	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.НематериальныеАктивы") тогда	
		ВидЦенности = Перечисления.ВидыЦенностей.НМА;

	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.ОсновныеСредства") тогда	
		ВидЦенности = Перечисления.ВидыЦенностей.ОС;

	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.ОбъектыСтроительства") тогда	
		ВидЦенности = Перечисления.ВидыЦенностей.ОбъектыНезавершенногоСтроительства;

	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.СтатьиЗатрат") тогда	
		Если ВидыЦенностейПоСчетамУчета = Неопределено Тогда
			ВидыЦенностейПоСчетамУчета = Новый Соответствие;
		КонецЕсли;
		СчетаУчетаЦенностей = ВидыЦенностейПоСчетамУчета["ОбъектыСтроительства"];
		Если СчетаУчетаЦенностей = Неопределено Тогда
			СчетаУчетаЦенностей = ОпределитьСчетаУчетаЦенностей("ОбъектыСтроительства");
			ВидыЦенностейПоСчетамУчета.Вставить("ОбъектыСтроительства", СчетаУчетаЦенностей);
		КонецЕсли;
		Если СчетаУчетаЦенностей.НайтиПоЗначению(СчетУчета) <> Неопределено тогда
			Если СпособСтроительства = Перечисления.СпособыСтроительства.Хозспособ Тогда
				//Такая ситуация возникает при приобретении услуг, включаемых в затраты по строительству 
				// не от строительной организации (не от подрядчика) (например, это услуги по охране объекта строительства).
				// Необходимо учитывать данные услуги как "Прочие работы и услуги".
				ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги;
			Иначе	
				ВидЦенности = Перечисления.ВидыЦенностей.СМРПодрядные;
			КонецЕсли; 
			
		ИначеЕсли ЗначениеЗаполнено(Объект) Тогда
			Если Объект.ВидРасходовНУ = Перечисления.ВидыРасходовНУ.КомандировочныеРасходы Тогда
				ВидЦенности = Перечисления.ВидыЦенностей.КомандировочныеРасходы;
			ИначеЕсли Объект.ВидРасходовНУ = Перечисления.ВидыРасходовНУ.ПредставительскиеРасходы Тогда
				ВидЦенности = Перечисления.ВидыЦенностей.ПредставительскиеРасходы;
			Иначе
				ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги;
			КонецЕсли;
		Иначе
			ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги;
		КонецЕсли;
		Если ВидыЦенностейПоСчетамУчета = Неопределено Тогда
			ВидыЦенностейПоСчетамУчета = Новый Соответствие;
		КонецЕсли;
		Для Каждого СчетУчетаЦенности Из СчетаУчетаЦенностей Цикл
			  ВидыЦенностейПоСчетамУчета.Вставить(СчетУчетаЦенности, ВидЦенности);
		КонецЦикла;
		
	Иначе	
		ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги;
		
	КонецЕсли;

	Возврат ВидЦенности;

КонецФункции // ОпределитьВидЦенности()

// Функция определяет объект учета (ценность) в строке табличной части.
// Сама табличная часть задается в параметре ТаблицаЗначений. В результате 
// анализа этой табличной части определяется из какой именно колонки нужно 
// взять объект учета.
Функция ОпределитьЦенностьИзСтрокиТабличнойЧасти(СтрокаТаблицы, ТаблицаЗначений)

	Ценность = "";

	Если ТаблицаЗначений.Колонки.Найти("Номенклатура") <> Неопределено Тогда
		Ценность = СтрокаТаблицы.Номенклатура;

	ИначеЕсли ТаблицаЗначений.Колонки.Найти("ОбъектСтроительства") <> Неопределено Тогда
		Ценность = СтрокаТаблицы.ОбъектСтроительства;

	ИначеЕсли ТаблицаЗначений.Колонки.Найти("НематериальныйАктив") <> Неопределено Тогда
		Ценность = СтрокаТаблицы.НематериальныйАктив;

	КонецЕсли;

	Возврат Ценность;

КонецФункции // ОпределитьЦенностьИзСтрокиТабличнойЧасти()

// Процедура арифметически распределяет заданную сумму
// по столбцу таблицы значений пропрционально колонке базы распределения
// при этом размерность таблицы и базы распределения должны совпадать.
// Как правило база распределения - просто одна из колонок таблицы
Процедура РаспределитьСуммуПоСтолбцу(МассивБазыРаспределения, РаспределяемаяСумма, ТаблицаРезультата, ИдКолонкиРезультата) Экспорт

	// Определяем сумму базы
	СуммаБазы = 0;

	Для Индекс = 0 По МассивБазыРаспределения.Количество() - 1 Цикл
		СуммаБазы = СуммаБазы + МассивБазыРаспределения[Индекс];
	КонецЦикла;

	Если СуммаБазы > 0 Тогда
		// Выполняем распределение
		УчтеноБазыРаспределения = 0;
		УжеРаспределено = 0;

		Для Индекс = 0 По МассивБазыРаспределения.Количество() - 1 Цикл

			// Рассчитываем шаг распределения
			ШагРаспределения = Окр(РаспределяемаяСумма * (УчтеноБазыРаспределения + МассивБазыРаспределения[Индекс])/СуммаБазы, 2) - УжеРаспределено;

			// Записываем результат
			ТаблицаРезультата[Индекс][ИдКолонкиРезультата] = ШагРаспределения;

			// Учитываем полученный результат для вычисления последующих шагов распределения
			УчтеноБазыРаспределения = УчтеноБазыРаспределения + МассивБазыРаспределения[Индекс];
			УжеРаспределено         = УжеРаспределено + ШагРаспределения;

		КонецЦикла;

	КонецЕсли;

КонецПроцедуры // РаспределитьСуммуПоСтолбцу()

// Процедура подготовки таблицы значений для целей формирования движений
// по подсистеме НДС. Доопределяет дополнительные колонки "ВидЦенности" и "Ценность"
// в таблице значений, переданной в качестве параметра

Процедура ОпределениеДополнительныхПараметровТаблицыПартийДляПодсистемыУчетаНДС(СтруктураШапкиДокумента, ТаблицаЗначений) Экспорт

	ВидыЦенностейПоСчетамУчета = Неопределено;
	
	ЕстьКолонкаУслуга 				= ТаблицаЗначений.Колонки.Найти("Услуга") <> Неопределено;
	ЕстьКолонкаСчетУчетаБУ 			= ТаблицаЗначений.Колонки.Найти("СчетУчетаБУ") <> Неопределено;
	ЕстьКолонкаСчетУчета 			= ТаблицаЗначений.Колонки.Найти("СчетУчета") <> Неопределено;
	ЕстьКолонкаСчетЗатрат 			= ТаблицаЗначений.Колонки.Найти("СчетЗатрат") <> Неопределено;
	ЕстьКолонкаСубконто1 			= ТаблицаЗначений.Колонки.Найти("Субконто1") <> Неопределено;
	ЕстьКолонкаНоменклатура 		= ТаблицаЗначений.Колонки.Найти("Номенклатура") <> Неопределено;
	ЕстьКолонкаОсновноеСредство 	= ТаблицаЗначений.Колонки.Найти("ОсновноеСредство") <> Неопределено;
	ЕстьКолонкаНематериальныйАктив 	= ТаблицаЗначений.Колонки.Найти("НематериальныйАктив") <> Неопределено;
	ЕстьСпособСтроительства 		= ТаблицаЗначений.Колонки.Найти("СпособСтроительства") <> Неопределено;
	ЕстьСчетУчетаНДС 				= ТаблицаЗначений.Колонки.Найти("СчетУчетаНДС") <> Неопределено;
	
	Для Каждого СтрокаТаблицы Из ТаблицаЗначений Цикл

		СчетУчетаЦенности = "";
        СпособСтроительства = ?(ЕстьСпособСтроительства, СтрокаТаблицы.СпособСтроительства, Неопределено);

		Если ЕстьКолонкаСчетУчетаБУ Тогда
			СчетУчетаЦенности = СтрокаТаблицы.СчетУчетаБУ;
			Ценность          = ОпределитьЦенностьИзСтрокиТабличнойЧасти(СтрокаТаблицы, ТаблицаЗначений);

		ИначеЕсли ЕстьКолонкаСчетЗатрат И ЕстьКолонкаСубконто1 Тогда
			СчетУчетаЦенности = СтрокаТаблицы.СчетЗатрат;
			Ценность          = ПолучитьЦенностьПоСубконто(СтрокаТаблицы.Субконто1, СтрокаТаблицы.Субконто2, СтрокаТаблицы.Субконто3);
			
			Если Не ЕстьСпособСтроительства Тогда
				// Особая обработка для затрат на строительство если способ строительства не указан явно в таблице
				Если ТипЗнч(Ценность) = Тип("СправочникСсылка.СтатьиЗатрат") Тогда
					Для НомерСубконто =1 По 3 Цикл
						Если ТипЗнч(СтрокаТаблицы["Субконто"+НомерСубконто]) = Тип("ПеречислениеСсылка.СпособыСтроительства")  Тогда
							СпособСтроительства = СтрокаТаблицы["Субконто"+НомерСубконто];
							Прервать;
						КонецЕсли; 
					КонецЦикла; 
				КонецЕсли; 
			КонецЕсли;

		ИначеЕсли ЕстьКолонкаСчетУчета Тогда
			СчетУчетаЦенности = СтрокаТаблицы.СчетУчета;
			Ценность          = ОпределитьЦенностьИзСтрокиТабличнойЧасти(СтрокаТаблицы, ТаблицаЗначений);
			
		ИначеЕсли ЕстьКолонкаНоменклатура Тогда
			СчетУчетаЦенности = "нет";
			Ценность          = ОпределитьЦенностьИзСтрокиТабличнойЧасти(СтрокаТаблицы, ТаблицаЗначений);
			
		ИначеЕсли ЕстьКолонкаОсновноеСредство Тогда
			СчетУчетаЦенности = "нет";
			Ценность          = СтрокаТаблицы.ОсновноеСредство;

		ИначеЕсли ЕстьКолонкаНематериальныйАктив Тогда
			СчетУчетаЦенности = "нет";
			Ценность          = СтрокаТаблицы.НематериальныйАктив;
			
		КонецЕсли;

		ЭтоДопРасходы         = (СтруктураШапкиДокумента.ВидДокумента = "ПоступлениеДопРасходов");
		ЭтоТаможенныйНДС	  = (СтруктураШапкиДокумента.ВидДокумента = "ГТДИмпорт");
		УчетАгентскогоНДС     = Ложь;
		ВидАгентскогоДоговора = "";

		Если СтруктураШапкиДокумента.Свойство("УчетАгентскогоНДС") и ЗначениеЗаполнено(СтруктураШапкиДокумента.УчетАгентскогоНДС) тогда
			УчетАгентскогоНДС = СтруктураШапкиДокумента.УчетАгентскогоНДС;
		КонецЕсли;
		Если СтруктураШапкиДокумента.Свойство("ВидАгентскогоДоговора") тогда
			ВидАгентскогоДоговора = СтруктураШапкиДокумента.ВидАгентскогоДоговора;
		КонецЕсли;
		
		СтрокаТаблицы.ВидЦенности       = ОпределитьВидЦенности(Ценность, СчетУчетаЦенности, ЭтоДопРасходы, ЭтоТаможенныйНДС, УчетАгентскогоНДС, ВидАгентскогоДоговора, ?(ЕстьКолонкаУслуга, СтрокаТаблицы.Услуга, Неопределено), СтруктураШапкиДокумента, СпособСтроительства, ВидыЦенностейПоСчетамУчета);
		СтрокаТаблицы.СчетУчетаЦенности = СчетУчетаЦенности;
		СтрокаТаблицы.Ценность          = Ценность;
		
		Если ЕстьСчетУчетаНДС Тогда
			Если Не ЗначениеЗаполнено(СтрокаТаблицы.СчетУчетаНДС) Тогда
				Если СтруктураШапкиДокумента.Свойство("СчетУчетаНДС") Тогда
					СтрокаТаблицы.СчетУчетаНДС = СтруктураШапкиДокумента.СчетУчетаНДС;
	            Иначе
					СтрокаТаблицы.СчетУчетаНДС = ОпределитьСчетУчетаНДС(СтрокаТаблицы.ВидЦенности);
				КонецЕсли;
			КонецЕсли;
        КонецЕсли;
			
	КонецЦикла

КонецПроцедуры // ОпределениеДополнительныхПараметровТаблицыПартийДляПодсистемыУчетаНДС()

// Процедура вызывается по кнопке "Рассчитать" из формы диалога документа.
// Выполняется расчет объемов реализации в текущем периоде по данным
// регистра НДСНачисленный в разрезе различных ставок НДС.
//
Процедура РассчитатьВыручкуДляНДС(Организация, НачалоПериода, КонецПериода, ВыручкаЕНВД, ВыручкаБезНДС, ВыручкаНДС0, ВыручкаНДС) Экспорт

	ВыручкаЕНВД   = 0;
	ВыручкаБезНДС = 0;
	ВыручкаНДС0   = 0;
	ВыручкаНДС    = 0;

	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(НачалоПериода));
	Запрос.УстановитьПараметр("КонецПериода", КонецМесяца(КонецПериода));
	
	ВидыНачисленияРеализация = Новый СписокЗначений;
	ВидыНачисленияРеализация.Добавить(Перечисления.НДСВидНачисления.РеализацияСНДС);
	ВидыНачисленияРеализация.Добавить(Перечисления.НДСВидНачисления.РеализацияБезНДС);
	ВидыНачисленияРеализация.Добавить(Перечисления.НДСВидНачисления.Реализация0);
	ВидыНачисленияРеализация.Добавить(Перечисления.НДСВидНачисления.РеализацияЕНВД);
	
	Запрос.УстановитьПараметр("ВидыНачисленияРеализация", ВидыНачисленияРеализация);
	
	Запрос.Текст = "ВЫБРАТЬ
	               |	НДСНачисленныйОбороты.ВидНачисления,
	               |	СУММА(НДСНачисленныйОбороты.СуммаБезНДСПриход) КАК СуммаБезНДС
	               |ИЗ
	               |	РегистрНакопления.НДСНачисленный.Обороты(
	               |		НАЧАЛОПЕРИОДА(&НачалоПериода, ДЕНЬ),
	               |		КОНЕЦПЕРИОДА(&КонецПериода, ДЕНЬ),
	               |		,
	               |		Организация = &Организация
	               |		    И (СчетФактура.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&НачалоПериода, ДЕНЬ) И КОНЕЦПЕРИОДА(&КонецПериода, ДЕНЬ))
	               |		    И ВидНачисления В (&ВидыНачисленияРеализация)) КАК НДСНачисленныйОбороты
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	НДСНачисленныйОбороты.ВидНачисления";
			
				   
	ТаблицаРезультата = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрокаРезультата Из ТаблицаРезультата Цикл
		
		Если СтрокаРезультата.ВидНачисления = Перечисления.НДСВидНачисления.РеализацияСНДС Тогда
		    ВыручкаНДС = ВыручкаНДС + СтрокаРезультата.СуммаБезНДС;
			
		ИначеЕсли СтрокаРезультата.ВидНачисления = Перечисления.НДСВидНачисления.РеализацияБезНДС Тогда	
			ВыручкаБезНДС = ВыручкаБезНДС + СтрокаРезультата.СуммаБезНДС;
			
		ИначеЕсли СтрокаРезультата.ВидНачисления = Перечисления.НДСВидНачисления.РеализацияЕНВД Тогда	
			ВыручкаЕНВД = ВыручкаЕНВД + СтрокаРезультата.СуммаБезНДС;
			
		ИначеЕсли СтрокаРезультата.ВидНачисления = Перечисления.НДСВидНачисления.Реализация0 Тогда	
			ВыручкаНДС0 = ВыручкаНДС0 + СтрокаРезультата.СуммаБезНДС;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // РассчитатьВыручкуДляНДС()

// Функция определяет наличие счетов-фактур, полученных по документам,
// которые могут являться основаниями для ввода счетов-фактур полученных.
//
// Применяется для контроля за наличием в ИБ информации о наличии счетов-
// фактур.
// 
// Параметры:
//  НачПериода       - Дата - Начальная дата выборки (включительно, с 00:00:00)
//  КонПериода       - Дата - Конечная дата выборки (включительно, по 23:59:59)
//  Организация      - Справочник.Ссылка - Организация, по которой
//                     осуществляется отбор. Необязательный параметр. Если не
//                     задан, отбор осуществляется по всем организациям.
//  Фильтр           - Документ.Ссылка, Массив - Документ или список документов, 
//                     по которым осуществляется отбор. Необязательный параметр. 
//                     Если не задан, отбор осуществляется по всем документам, 
//                     которые могут являться основаниями для ввода счетов-фактур 
//                     полученных.
//  ВсеКромеФильтра  - Булево - Признак отбора документов, не входящих в Фильтр. 
//                     Необязательный параметр. Значение по умолчаню - Ложь.
//                     Если не задан, отбираются документы, заданные в Фильтре.
//  НаличиеСчетаФактуры - Булево - Признак отбора документов:
//                        Истина - Отбирать документы, по которым существуют
//                        счета-фактуры.
//                        Ложь - Отбирать документы, по которым счета-фактуры
//                        отсутствуют.
//                        Необязательный параметр. Если не задан, осуществляется
//                        отбор всех документов.
// СчетФактураПроведен - Булево - Признак отбора счетов-фактур:
//                        Истина - Отбирать проведенные счета-фактуры
//                        Ложь - Отбирать непроведенные счета-фактуры
//                        Необязательный параметр. Если не задан, осуществляется
//                        отбор всех счетов-фактур.
// ФильтроватьКорректировкуРеализации - Булево - Признак отбора счетов-фактур
//                        Истина - Отбирать все счета-фактуры, кроме тех, у которых основание "Корректировка реализации"
//                        Ложь   - Отбирать все счета-фактуры, в т.ч. и те, у которых основание "Корректировка реализации"
//                        Необязательный параметр. Если не задан, осуществляется
//                        отбор всех счетов-фактур.
//
// Возвращаемое значение:
//  ТаблицаЗначений - Таблица значений - Состав колонок:
//                    Документ - Документ.Ссылка - Документ, по которому
//                               производился поиск счета-фактуры полученного
//                    СчетФактура - Документ.Ссылка - Ссылка на счет-
//                                  фактуру полученный, либо Неопределено
//
Функция ОпределитьНаличиеСчетовФактурПолученных(
		НачПериода = Неопределено,
		КонПериода = Неопределено,
		Организация,
		Фильтр = Неопределено,
		ВсеКромеФильтра = Ложь,
		НаличиеСчетаФактуры = Неопределено,
		СчетФактураПроведен = Неопределено,
		ДатаСФНеБолее = Неопределено,
		ФильтроватьКорректировкуРеализации = Ложь) Экспорт

	Запрос = Новый Запрос();
	
	Запрос.УстановитьПараметр("НачПериода",  НачПериода);
	Запрос.УстановитьПараметр("КонПериода",  ?(НЕ ЗначениеЗаполнено(КонПериода),'00010101',КонецДня(КонПериода)));
	Запрос.УстановитьПараметр("ДатаСФНеБолее",  ?(НЕ ЗначениеЗаполнено(ДатаСФНеБолее),Неопределено,КонецДня(ДатаСФНеБолее)));
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Фильтр",      Фильтр);
	
	// Дополняем условие запроса отбором по периоду
	Если (ЗначениеЗаполнено(НачПериода)) И (ЗначениеЗаполнено(КонПериода)) Тогда
		Условие_Основание = "СчетФактура.Дата МЕЖДУ &НачПериода И &КонПериода
		                 |";
	ИначеЕсли (ЗначениеЗаполнено(НачПериода)) И (НЕ ЗначениеЗаполнено(КонПериода)) Тогда
		Условие_Основание = "СчетФактура.Дата >= &НачПериода
		                 |";
	ИначеЕсли (НЕ ЗначениеЗаполнено(НачПериода)) И (ЗначениеЗаполнено(КонПериода)) Тогда
		Условие_Основание = "СчетФактура.Дата <= &КонПериода
		                 |";
	Иначе
		Условие_Основание = "";
	КонецЕсли;
	
	// Дополняем условие запроса отбором по организации
	Условие_Основание = Условие_Основание 
	               + ?(НЕ ЗначениеЗаполнено(Организация), "", ?(НЕ ЗначениеЗаполнено(Условие_Основание), "", " И ") + "Организация = &Организация ");
	
	// Дополняем условие запроса отбором по документу-основанию или списку документов-оснований
	Условие_Основание = Условие_Основание
	               + ?(НЕ ЗначениеЗаполнено(Фильтр), "", ?(НЕ ЗначениеЗаполнено(Условие_Основание), "", " И ") + "СчетФактура " + ?(ВсеКромеФильтра, " НЕ ", "") + " В (&Фильтр) ");
	
	// Дополняем условие запроса отбором по признаку наличия/отсутствия счета-фактуры
	УсловиеЗапроса = ?(НаличиеСчетаФактуры = Неопределено, "", ?(НЕ ЗначениеЗаполнено(УсловиеЗапроса), "", " И ") + ?(НаличиеСчетаФактуры, "НЕ (", "(") + "
					|	ВЫБОР
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураВыданный
					|			ИЛИ НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ГТДИмпорт
					|			ИЛИ НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетОРозничныхПродажах
					|			ТОГДА НДСПредъявленныйОбороты.СчетФактура
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
					|			ТОГДА СчетФактураПолученный.Ссылка
					|		ИНАЧЕ ЕСТЬNULL(СчетФактураПолученный.Ссылка, СчетФактураВыданный.Ссылка)
					|	КОНЕЦ ЕСТЬ NULL) ");
	// Дополняем условие запроса отбором по признаку проведения счета-фактуры
	УсловиеЗапроса = УсловиеЗапроса
	               + ?(СчетФактураПроведен = Неопределено, "", ?(НЕ ЗначениеЗаполнено(УсловиеЗапроса), "", " И ") + "
					|	ВЫБОР
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураВыданный
					|			ТОГДА СчетФактураВыданный.Проведен
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ГТДИмпорт
					|			ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ГТДИмпорт).Проведен
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетОРозничныхПродажах
					|			ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ОтчетОРозничныхПродажах).Проведен
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
					|			ТОГДА СчетФактураПолученный.Проведен
					|		ИНАЧЕ ЕСТЬNULL(СчетФактураПолученный.Проведен, СчетФактураВыданный.Проведен)
					|	КОНЕЦ = " + ?(СчетФактураПроведен, "ИСТИНА", "ЛОЖЬ") + " ");
				   
	// Дополняем условие запроса отбором по дате СФ	
	УсловиеЗапроса = УсловиеЗапроса
	               + ?(НЕ ЗначениеЗаполнено(ДатаСФНеБолее), "", ?(НЕ ЗначениеЗаполнено(УсловиеЗапроса), "", " И ") + "
					|	ВЫБОР
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураВыданный
					|			ТОГДА СчетФактураВыданный.Дата
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ГТДИмпорт
					|			ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ГТДИмпорт).Дата
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетОРозничныхПродажах
					|			ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ОтчетОРозничныхПродажах).Дата
					|		КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
					|			ТОГДА СчетФактураПолученный.Дата
					|		ИНАЧЕ ЕСТЬNULL(СчетФактураПолученный.Дата, СчетФактураВыданный.Дата)
					|	КОНЕЦ <= &ДатаСФНеБолее ");
	
	// Дополняем условие запроса отбором по признаку наличия/отсутствия счета-фактуры
	УсловиеЗапроса = УсловиеЗапроса + ?(НЕ ЗначениеЗаполнено(УсловиеЗапроса), "", " И ") + "
					|	ВЫБОР
					|		КОГДА " + ?(ФильтроватьКорректировкуРеализации, "НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.КорректировкаРеализации
					|			ИЛИ ", "") + "НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ПоступлениеТоваровУслуг
					|			И НДСПредъявленныйОбороты.ДоговорКонтрагента.УчетАгентскогоНДС
					|			И НДСПредъявленныйОбороты.ДоговорКонтрагента.НалоговыйАгентПоОплате
					|			ТОГДА ЛОЖЬ
					|		ИНАЧЕ ИСТИНА
					|	КОНЕЦ";
	
	// Дополняем условие запроса ключевым словом "ГДЕ"
	УсловиеЗапроса = ?(НЕ ЗначениеЗаполнено(УсловиеЗапроса), "", "ГДЕ " + УсловиеЗапроса);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка,
	|	СчетФактураПолученный.Дата,
	|	СчетФактураПолученный.Проведен,
	|	СчетФактураПолученный.Ссылка КАК ДокументОснование
	|
	|ПОМЕСТИТЬ ВТ_СчетФактурыПолученные
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|	
	|" + ?(ЗначениеЗаполнено(Организация), "ГДЕ Организация = &Организация", "") + "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка,
	|	СчетФактураПолученный.Ссылка.Дата КАК Дата,
	|	СчетФактураПолученный.Ссылка.Проведен КАК Проведен,
	|	СчетФактураПолученный.ДокументОснование КАК ДокументОснование
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученный
	|
	|" + ?(ЗначениеЗаполнено(Организация), "ГДЕ Ссылка.Организация = &Организация", "") + "
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОснование
	|;
	|
	|ВЫБРАТЬ
	|	СчетФактураВыданный.Ссылка,
	|	СчетФактураВыданный.Дата,
	|	СчетФактураВыданный.Проведен,
	|	СчетФактураВыданный.Ссылка КАК ДокументОснование
	|
	|ПОМЕСТИТЬ ВТ_СчетФактураВыданный
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаРеализацию)
	|	" + ?(ЗначениеЗаполнено(Организация), "И Организация = &Организация", "") + "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СчетФактураВыданный.Ссылка,
	|	СчетФактураВыданный.Ссылка.Дата КАК Дата,
	|	СчетФактураВыданный.Ссылка.Проведен КАК Проведен,
	|	СчетФактураВыданный.ДокументОснование
	|ИЗ
	|	Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.Ссылка.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаРеализацию)
	|	" + ?(ЗначениеЗаполнено(Организация), "И Ссылка.Организация = &Организация", "") + "
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОснование
	|;
	|
	|ВЫБРАТЬ
	|	НДСПредъявленныйОбороты.СчетФактура,
	|	НДСПредъявленныйОбороты.ДоговорКонтрагента
	|
	|ПОМЕСТИТЬ ВТ_НДСПредъявленныйОбороты
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный.Обороты(, , Период, 
	|				Организация = &Организация //ДляЗамены
	|		) КАК НДСПредъявленныйОбороты
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СчетФактура
	|;
	|
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЕСТЬNULL(НДСПредъявленныйОбороты.СчетФактура, НЕОПРЕДЕЛЕНО) КАК Документ,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураПолученный
	|				ТОГДА СчетФактураПолученный.ДокументОснование
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураВыданный
	|				ТОГДА СчетФактураВыданный.ДокументОснование
	|			ИНАЧЕ НДСПредъявленныйОбороты.СчетФактура
	|		КОНЕЦ, НЕОПРЕДЕЛЕНО) КАК ДокументОснование,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураВыданный
	|					ИЛИ НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ГТДИмпорт
	|					ИЛИ НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетОРозничныхПродажах
	|				ТОГДА НДСПредъявленныйОбороты.СчетФактура
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|				ТОГДА СчетФактураПолученный.Ссылка
	|			ИНАЧЕ ЕСТЬNULL(СчетФактураПолученный.Ссылка, СчетФактураВыданный.Ссылка)
	|		КОНЕЦ, НЕОПРЕДЕЛЕНО) КАК СчетФактура,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураВыданный
	|				ТОГДА СчетФактураВыданный.Проведен
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ГТДИмпорт
	|				ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ГТДИмпорт).Проведен
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетОРозничныхПродажах
	|				ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ОтчетОРозничныхПродажах).Проведен
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|				ТОГДА СчетФактураПолученный.Ссылка.Проведен
	|			ИНАЧЕ ЕСТЬNULL(СчетФактураПолученный.Проведен, СчетФактураВыданный.Проведен)
	|		КОНЕЦ, НЕОПРЕДЕЛЕНО) КАК СчетФактураПроведен,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.СчетФактураВыданный
	|				ТОГДА СчетФактураВыданный.Дата
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ГТДИмпорт
	|				ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ГТДИмпорт).Дата
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетОРозничныхПродажах
	|				ТОГДА ВЫРАЗИТЬ(НДСПредъявленныйОбороты.СчетФактура КАК Документ.ОтчетОРозничныхПродажах).Дата
	|			КОГДА НДСПредъявленныйОбороты.СчетФактура ССЫЛКА Документ.ОтчетКомиссионераОПродажах
	|				ТОГДА СчетФактураПолученный.Дата
	|			ИНАЧЕ ЕСТЬNULL(СчетФактураПолученный.Дата, СчетФактураВыданный.Дата)
	|		КОНЕЦ, НЕОПРЕДЕЛЕНО) КАК СчетФактураДата
	|ИЗ
	|	ВТ_НДСПредъявленныйОбороты КАК НДСПредъявленныйОбороты
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СчетФактурыПолученные КАК СчетФактураПолученный
	|		ПО НДСПредъявленныйОбороты.СчетФактура = СчетФактураПолученный.ДокументОснование
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СчетФактураВыданный КАК СчетФактураВыданный
	|		ПО НДСПредъявленныйОбороты.СчетФактура = СчетФактураВыданный.ДокументОснование
	|";
	
	Запрос.Текст =  Запрос.Текст + УсловиеЗапроса;
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"Организация = &Организация //ДляЗамены",Условие_Основание);
	
	Если ЗначениеЗаполнено(КонПериода) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,", Период","&КонПериода, Период");
	КонецЕсли; 
	Запрос.Текст = Запрос.Текст + "
									|УПОРЯДОЧИТЬ ПО
									|	СчетФактураДата";
	
	ТаблицаДокументов = Запрос.Выполнить().Выгрузить();
	
	Возврат ТаблицаДокументов;
	
КонецФункции // ОпределитьНаличиеСчетовФактурПолученных()

Функция РасчетНДСвРубляхПоСтавкеДокумента(ДатаДокумента) Экспорт
	
	ДатаРасчетаПоСтавкеНДС = Константы.ДатаНачалаПересчетаСуммыНДСвРубляхПоДокументамВИностраннойВалютеПоСтавкеНДС.Получить();
	
	Возврат ?(ЗначениеЗаполнено(ДатаРасчетаПоСтавкеНДС), ДатаРасчетаПоСтавкеНДС<= ДатаДокумента,Ложь);
	
КонецФункции

// Определяет дату начала налогового периода для НДС по учетной политике
Функция ПолучитьНачалоПериодаПоУчетнойПолитике(Организация, Дата, Отказ = Ложь, УчетнаяПолитикаНУ = Неопределено) Экспорт
	
	Если УчетнаяПолитикаНУ = неопределено Тогда
		УчетнаяПолитикаНУ = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(Дата, Организация);
		Если НЕ ЗначениеЗаполнено(УчетнаяПолитикаНУ) Тогда
			Отказ = Истина;
		КонецЕсли;
	ИначеЕсли НЕ УчетнаяПолитикаНУ.Свойство("НДСНалоговыйПериод") тогда
		 Отказ = Истина;
	КонецЕсли; 
	
	Если Отказ Тогда
		Возврат ?(Дата >= '20080101', НачалоКвартала(Дата), НачалоМесяца(Дата));
	КонецЕсли;
	
	Если УчетнаяПолитикаНУ.НДСНалоговыйПериод = Перечисления.Периодичность.Квартал Тогда
		Результат = НачалоКвартала(Дата);
	Иначе
		Результат = НачалоМесяца(Дата);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Определяет дату окончания налогового периода для НДС по учетной политике
Функция ПолучитьКонецПериодаПоУчетнойПолитике(Организация, Дата, Отказ = Ложь, УчетнаяПолитикаНУ = Неопределено) Экспорт
	
	Если УчетнаяПолитикаНУ = неопределено Тогда
		УчетнаяПолитикаНУ = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(Дата, Организация);
		Если НЕ ЗначениеЗаполнено(УчетнаяПолитикаНУ) Тогда
			Отказ = Истина;
		КонецЕсли;	
	ИначеЕсли не УчетнаяПолитикаНУ.Свойство("НДСНалоговыйПериод") тогда
		 Отказ = Истина;
	КонецЕсли; 
	
	Если Отказ Тогда
		Возврат ?(Дата >= '20080101', КонецКвартала(Дата), КонецМесяца(Дата));
	КонецЕсли;
	
	Если УчетнаяПолитикаНУ.НДСНалоговыйПериод = Перечисления.Периодичность.Квартал Тогда
		Результат = КонецКвартала(Дата);
	Иначе
		Результат = КонецМесяца(Дата);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Функция производит поиск счета-фактуры (полученного или выданного), у которого в качестве документа-основания указана
// переданная ссылка.
//
// Параметры:
//  ДокументСсылка  - ссылка на документ, для которого надо найти подчиненный документ,
//  ВидСчетаФактуры - строка, вид документа, по умолчанию "СчетФактураВыданный"
//  Отбор 			- структура с именами и значениями реквизитов СФ для дополнительного отбора
//	
// Возвращаемое значение:
//  Если нашли, то возвращаем ссылку, не нашли - Неопределено
//
Функция НайтиПодчиненныйСчетФактуру(Знач ДокументСсылка, ВидДокумента = "СчетФактураВыданный", Отбор = Неопределено, ИсключитьИзВыборкиСФ = Неопределено, МетаданныеОснования = Неопределено) Экспорт

	Если не ЗначениеЗаполнено(ДокументСсылка) Тогда
		Возврат Неопределено;
	Иначе
		
		Если МетаданныеОснования = Неопределено Тогда
			МетаданныеОснования = ДокументСсылка.Метаданные();
		КонецЕсли; 
		
		Если МетаданныеОснования.Реквизиты.Найти("ИспользоватьДокументРасчетовКакСчетФактуру") <> Неопределено
			И МетаданныеОснования.Реквизиты.Найти("РасчетныйДокумент") <> Неопределено 
			И ДокументСсылка.ИспользоватьДокументРасчетовКакСчетФактуру Тогда
			Если Не ЗначениеЗаполнено(ДокументСсылка.РасчетныйДокумент) Тогда
				Возврат Неопределено;
			Иначе
				Если ТипЗнч(ДокументСсылка.РасчетныйДокумент) = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя") 
					И Не ДокументСсылка.РасчетныйДокумент.ПокупателемВыставляетсяСчетФактураНаВозврат Тогда
					ДокументСсылка = ДокументСсылка.РасчетныйДокумент.Сделка;
					Если Не ЗначениеЗаполнено(ДокументСсылка) Тогда
						Возврат Неопределено;
					КонецЕсли;
					МетаданныеОснования = ДокументСсылка.Метаданные();					
				Иначе
					ДокументСсылка = ДокументСсылка.РасчетныйДокумент;
					МетаданныеОснования = ДокументСсылка.Метаданные();
				КонецЕсли;
			КонецЕсли; 
		КонецЕсли;
		Если ВидДокумента = "СчетФактураПолученный" 
			И МетаданныеОснования.Реквизиты.Найти("ПредъявленСчетФактура") <> Неопределено 
			И ДокументСсылка.ПредъявленСчетФактура 
			И Не ?(ТипЗнч(ИсключитьИзВыборкиСФ) = Тип("Массив"), ИсключитьИзВыборкиСФ.Найти(ДокументСсылка) <> Неопределено, ДокументСсылка = ИсключитьИзВыборкиСФ) Тогда
			Возврат ДокументСсылка;
		КонецЕсли;
		
	КонецЕсли;
	
	НайденныйДокумент = Неопределено;

	Запрос = Новый Запрос;

	// Установим параметры запроса
	Запрос.УстановитьПараметр("ДокументСсылка", ДокументСсылка);

	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СФ.Ссылка
	|ПОМЕСТИТЬ ВрмТбл
	|ИЗ
	|	Документ.СчетФактураВыданный.ДокументыОснования КАК СФ
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.Авансы КАК Авансы
	|		ПО СФ.Ссылка = Авансы.Ссылка
	|ГДЕ
	|	СФ.ДокументОснование = &ДокументСсылка";
	
	Если не ВидДокумента = "СчетФактураВыданный" Тогда
		Запрос.Текст = СтрЗаменитЬ(Запрос.Текст,"СчетФактураВыданный",ВидДокумента);
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(ИсключитьИзВыборкиСФ) Тогда
		Запрос.УстановитьПараметр("ИсключитьИзВыборкиСФ", ИсключитьИзВыборкиСФ);
		Если ТипЗнч(ИсключитьИзВыборкиСФ) = Тип("Массив") Тогда
			Запрос.Текст = Запрос.Текст + "
				|	И НЕ СФ.Ссылка В (&ИсключитьИзВыборкиСФ)
				|";
		Иначе
			Запрос.Текст = Запрос.Текст + "
				|	И НЕ СФ.Ссылка = &ИсключитьИзВыборкиСФ
				|";
		КонецЕсли;
	КонецЕсли; 
	Если не Отбор = Неопределено Тогда
		Для каждого ЭлементОтбора Из Отбор Цикл
			Если ТипЗнч(ЭлементОтбора.Значение) = Тип("Булево") Тогда
			
				Запрос.Текст = Запрос.Текст + "
					|	И "+?(ЭлементОтбора.Значение," "," НЕ ")+" СФ.Ссылка."+ЭлементОтбора.Ключ;
			ИначеЕсли ЭлементОтбора.Ключ = "СтавкиНДС" Тогда
			
				Запрос.УстановитьПараметр(ЭлементОтбора.Ключ, ЭлементОтбора.Значение);
				Запрос.Текст = Запрос.Текст + "
					|	И Авансы.СтавкаНДС В (&"+ЭлементОтбора.Ключ+")";
			ИначеЕсли ЭлементОтбора.Ключ = "СчетНаОплату" 
						И ВидДокумента = "СчетФактураВыданный" Тогда
			
				Запрос.УстановитьПараметр(ЭлементОтбора.Ключ, ЭлементОтбора.Значение);
				Запрос.Текст = Запрос.Текст + "
					|	И Авансы.СчетНаОплату В (&"+ЭлементОтбора.Ключ+")";
			Иначе
				
				Запрос.УстановитьПараметр(ЭлементОтбора.Ключ, ЭлементОтбора.Значение);
				Запрос.Текст = Запрос.Текст + "
					|	И СФ.Ссылка."+ЭлементОтбора.Ключ+" = &"+ЭлементОтбора.Ключ;
			КонецЕсли; 
		КонецЦикла; 
	КонецЕсли; 
	
	Запрос.Текст = Запрос.Текст + ";";
	
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ Ссылка
	| ИЗ ВрмТбл
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка.ПометкаУдаления,
	|	Ссылка.Проведен УБЫВ,
	|	Ссылка.Дата";
	
	ВыборкаИзЗапроса = Запрос.Выполнить().Выбрать();

	Если ВыборкаИзЗапроса.Следующий() Тогда
		НайденныйДокумент = ВыборкаИзЗапроса.Ссылка;
	КонецЕсли;

	Возврат НайденныйДокумент;

КонецФункции // НайтиПодчиненныйСчетФактуру()

//Определяет налоговый период по НДС
//
Функция ПолучитьУПНДСНалоговыйПериод(Организация, Знач Дата, УчетнаяПолитика = Неопределено) Экспорт
	
	Если Не ЗначениеЗаполнено(Дата) Тогда
		Дата = ТекущаяДата();
	КонецЕсли;

	Если Не ЗначениеЗаполнено(Организация) Тогда
		Возврат ?(Дата < '20080101', Перечисления.Периодичность.Месяц, Перечисления.Периодичность.Квартал);
	КонецЕсли;
	
	Если УчетнаяПолитика <> Неопределено
		и УчетнаяПолитика.Количество() > 0
		И УчетнаяПолитика.Организация = Организация
		И УчетнаяПолитика.Период = НачалоМесяца(Дата)
		И УчетнаяПолитика.Свойство("НДСНалоговыйПериод") Тогда
		Возврат УчетнаяПолитика.НДСНалоговыйПериод;
	КонецЕсли;
	
	УчетнаяПолитика = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(Дата, Организация, Ложь);
		
	Возврат ?(НЕ ЗначениеЗаполнено(УчетнаяПолитика), 
				?(Дата < '20080101', Перечисления.Периодичность.Месяц, Перечисления.Периодичность.Квартал),
				УчетнаяПолитика.НДСНалоговыйПериод);

КонецФункции

Функция ПолучитьУППорядокРегистрацииСчетовФактурНаАванс(Организация, Знач Дата, УчетнаяПолитика = Неопределено) Экспорт

	Если Не ЗначениеЗаполнено(Организация) Тогда
		Возврат Перечисления.ПорядокРегистрацииСчетовФактурНаАванс.НаВсеАвансы;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Дата) Тогда
		Дата = ТекущаяДата();
	КонецЕсли;

	Если УчетнаяПолитика <> Неопределено
		и УчетнаяПолитика.Количество() > 0
		И УчетнаяПолитика.Организация = Организация
		И УчетнаяПолитика.Период = НачалоМесяца(Дата)
		И УчетнаяПолитика.Свойство("ПорядокРегистрацииСчетовФактурНаАванс") Тогда
		Возврат УчетнаяПолитика.ПорядокРегистрацииСчетовФактурНаАванс;
	КонецЕсли;
	
	ОшибкаВПолучении = Ложь;
	УчетнаяПолитика = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитики(Дата, ОшибкаВПолучении, Организация, "Нал" ,Ложь);
		
	Возврат ?(ОшибкаВПолучении, Перечисления.ПорядокРегистрацииСчетовФактурНаАванс.НаВсеАвансы, УчетнаяПолитика.ПорядокРегистрацииСчетовФактурНаАванс);

КонецФункции

// Определяет наличие соглашения с контрагентом, на электронный обмен документами
//
Функция НаличиеСоглашенияОбменаЭД(СсылкаНаВладельца) Экспорт
	
	Если НЕ ЭлектронныеДокументыСлужебный.ИспользуетсяОбменЭД() 
		ИЛИ НЕ ЗначениеЗаполнено(СсылкаНаВладельца) Тогда
		Возврат Ложь;
	КонецЕсли;	
	
	ПараметрыЭД = Новый Структура("ВидЭд,НаправлениеЭД,Организация,Контрагент");
	
	ЗаполнитьЗначенияСвойств(ПараметрыЭД, СсылкаНаВладельца);
		
	ПараметрыЭД.ВидЭД         = Перечисления.ВидыЭД.СчетФактура;
	ПараметрыЭД.НаправлениеЭД = Перечисления.НаправленияЭД.Исходящий;
			
	Результат = ЭлектронныеДокументыСлужебный.ОпределитьНастройкиОбменаЭД(ПараметрыЭД);
	
	Возврат ЗначениеЗаполнено(Результат);
	
КонецФункции

//////////////////////////////////////////////////////////////////////////
//Преобразование промежуточных таблиц для НДС

// Преобразует таблицу значений в дерево значений, группируя значения по колонкам, формирование итога по строкам
Функция ТаблицуЗначенийВДеревоСГруппировкой(ТаблицаРезультатов, знач ГруппировочныеКолонки= "",знач КолонкиИтогов = "") Экспорт
	
	ДеревоРезультатов  = Новый ДеревоЗначений();
	Для каждого Колонка из ТаблицаРезультатов.Колонки Цикл
		ДеревоРезультатов.Колонки.Добавить(Колонка.Имя,Колонка.ТипЗначения,Колонка.Заголовок,Колонка.Ширина);
	КонецЦикла; 
	
	Если ПустаяСтрока(ГруппировочныеКолонки) Тогда
		Для каждого СтрокаТаблицы Из ТаблицаРезультатов Цикл
			СтрокаДерева = ДеревоРезультатов.Строки.Добавить();

			ЗаполнитьЗначенияСвойств(СтрокаДерева, СтрокаТаблицы);

		КонецЦикла; 
		
		Возврат ДеревоРезультатов;
	КонецЕсли;
	
	ТаблицаГруппировок = ТаблицаРезультатов.Скопировать();
	ТаблицаГруппировок.Свернуть(ГруппировочныеКолонки,КолонкиИтогов);

	Для каждого СтрокаТаблицы Из ТаблицаГруппировок Цикл
		СтрокаДерева = ДеревоРезультатов.Строки.Добавить();
		
		ЗаполнитьЗначенияСвойств(СтрокаДерева, СтрокаТаблицы);
		
	КонецЦикла; 
	
	ЗначенияОтбора = Новый Структура(ГруппировочныеКолонки);
	Для каждого СтрокаДерева из  ДеревоРезультатов.Строки Цикл
		//Формирование структуры отбора
		Для каждого ПараметрОтбора Из ЗначенияОтбора Цикл
			ЗначенияОтбора.Вставить(ПараметрОтбора.Ключ, СтрокаДерева[ПараметрОтбора.Ключ]);
		КонецЦикла; 
		
		//Поиск и заполнение подчиненными колонками
		МассивПодчиненныйхСтрок = ТаблицаРезультатов.НайтиСтроки(ЗначенияОтбора);
		Для каждого СтрокаТаблицы Из МассивПодчиненныйхСтрок Цикл
			ПодчиненнаяСтрокаДерева = СтрокаДерева.Строки.Добавить();
			
			ЗаполнитьЗначенияСвойств(ПодчиненнаяСтрокаДерева, СтрокаТаблицы);
			
		КонецЦикла; 
	КонецЦикла;
		
	Возврат ДеревоРезультатов;
КонецФункции

Функция ОпределитьПартииСписанияПоРегиструНДСПартии(СтруктураШапкиДокумента, ТаблицаВыручки,Отказ, Заголовок, ЭтоВозврат = Ложь, ЭтоВозвратОтПокупателя = Ложь, СтруктураПараметров) Экспорт
	
	ВидДокумента = "";
	СтруктураШапкиДокумента.Свойство("ВидДокумента", ВидДокумента);
	ВестиСуммовойУчетПоСкладамБУ = УправлениеЗапасамиПартионныйУчет.ВедетсяСуммовойУчетПоСкладам(ПланыСчетов.Хозрасчетный.Товары);
	
	ДополнитьСтруктуруШапкиДокументаДляНДС(СтруктураШапкиДокумента, Истина);
	
	ПартионныйУчетБУ = ((СтруктураШапкиДокумента.БухгалтерскийУчетСпособОценкиМПЗ = Перечисления.СпособыОценки.ФИФО 
					Или СтруктураШапкиДокумента.БухгалтерскийУчетСпособОценкиМПЗ = Перечисления.СпособыОценки.ЛИФО)
					И (Не УправлениеЗапасами.ИспользуетсяРасширеннаяАналитикаУчета(СтруктураШапкиДокумента.Дата)));
	
	ТаблицаСписанияНДСПоСтрокам = РегистрыНакопления.НДСПартииТоваров.СоздатьНаборЗаписей().Выгрузить();
	ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить("ДействияНДСПокупки_ВключитьВСтоимость", Новый ОписаниеТипов("Булево"));
	ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить("ДействияНДСПокупки_ИсключитьИзСтоимости", Новый ОписаниеТипов("Булево"));
	ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить("ДействияНДСПокупки_ПредположениеСтавки0", Новый ОписаниеТипов("Булево"));
	
	Если СтруктураШапкиДокумента.СложныйУчетНДС 
		И Не СтруктураШапкиДокумента.ПартионныйУчетНДСвРазрезеСерийИХарактеристик
		Тогда
		
		ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить("СерияНоменклатуры_Базовая");
		ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить("ХарактеристикаНоменклатуры_Базовая");
		
		ТаблицаВыручки.Колонки.Добавить("СерияНоменклатуры_Базовая");
		ТаблицаВыручки.ЗагрузитьКолонку(ТаблицаВыручки.ВыгрузитьКолонку("СерияНоменклатуры"), "СерияНоменклатуры_Базовая");
		ТаблицаВыручки.Колонки.Добавить("ХарактеристикаНоменклатуры_Базовая");
		ТаблицаВыручки.ЗагрузитьКолонку(ТаблицаВыручки.ВыгрузитьКолонку("ХарактеристикаНоменклатуры"), "ХарактеристикаНоменклатуры_Базовая");
		
	КонецЕсли;
	
	Если ЭтоВозврат 
		И Не ЭтоВозвратОтПокупателя Тогда
		ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить("ПартияСовпадаетСУказаннымДокументомДляВозврата", Новый ОписаниеТипов("Булево"));
	КонецЕсли; 
	
	Для Каждого Колонка Из ТаблицаВыручки.Колонки Цикл
		Если ТаблицаСписанияНДСПоСтрокам.Колонки.Найти(Колонка.Имя) = Неопределено Тогда
			ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить(Колонка.Имя, Колонка.ТипЗначения); 
		КонецЕсли; 
	КонецЦикла;
		
	ТаблицаВыручки.Колонки.Добавить("НДСВСтоимостиТоваров", Новый ОписаниеТипов("ПеречислениеСсылка.ДействиеНДСВСтоимостиТоваров"));
	Если СтруктураШапкиДокумента.Свойство("НДСВСтоимостиТоваров") Тогда
		ТаблицаВыручки.ЗаполнитьЗначения(СтруктураШапкиДокумента.НДСВСтоимостиТоваров, "НДСВСтоимостиТоваров")	
	КонецЕсли; 
	
	ЕстьСтавкаНДС = ТаблицаВыручки.Колонки.Найти("СтавкаНДС") <> Неопределено И Не СтруктураШапкиДокумента.Свойство("НДСВСтоимостиТоваров");
	ЕстьСкладВТЧ = ТаблицаВыручки.Колонки.Найти("Склад") <> Неопределено;
	
	//////////////////////////////////////////////////////////////////////////////////
	// Определяем партии к списанию по регистру по ключевым наборам реквизитов.
	ТаблицаВыручки.Колонки.Добавить("СписыватьПоПартиямНДС", Новый ОписаниеТипов("Булево"));
	ВыданоСообщениеБезНДС = Ложь;
	ВыданоСообщение0 = Ложь;
	
	Для каждого СтрокаСписания Из ТаблицаВыручки Цикл
		
		Если СтруктураШапкиДокумента.ОрганизацияПрименяетУСН Тогда
			// Не ведется партионный учет если организация применяет УСН
			СтрокаСписания.СписыватьПоПартиямНДС = Ложь;
			
		ИначеЕсли НЕ ЗначениеЗаполнено(СтрокаСписания.СчетУчетаБУ) Тогда
			// Не указан счет учета ТМЦ, такое возможно только для услуг.
			СтрокаСписания.СписыватьПоПартиямНДС = Ложь;
			
		ИначеЕсли СтрокаСписания.СчетУчетаБУ.Забалансовый Тогда
			// Для товаров, учтываемых на забалансовых счетах учет НДС не ведется.
			СтрокаСписания.СписыватьПоПартиямНДС = Ложь;
			
		ИначеЕсли НЕ ЗначениеЗаполнено(СтрокаСписания.Количество) Тогда
			// Строки с пустым количеством игнорируем
			СтрокаСписания.СписыватьПоПартиямНДС = Ложь;
			
		ИначеЕсли СтруктураШапкиДокумента.СложныйУчетНДС Тогда
			//Все партии приобретенных ТМЦ учтены в регистре, все надо списывать.
			СтрокаСписания.СписыватьПоПартиямНДС = Истина;
			
		ИначеЕсли ОпределитьСчетаУчетаОСиНМА("ОС").НайтиПоЗначению(СтрокаСписания.СчетУчетаБУ) <> Неопределено Тогда
			// Оставляем строки только по ОС. По ним партионный учет ведется всегда!
			СтрокаСписания.СписыватьПоПартиямНДС = Истина;
			
		Иначе 
			
			Если ЕстьСтавкаНДС Тогда
				
				Если СтрокаСписания.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС 
					И Не ВыданоСообщениеБезНДС Тогда
					
					ОбщегоНазначения.СообщитьОбОшибке("При реализации без НДС, НДС по приобретенным ценностям необходимо включать в стоимость реализуемой партии товаров (ст. 170 НК РФ).
					|Для автоматического контроля включения НДС в стоимость в учетной политике по налоговому учету необходимо установить флаг ""Наличие операций без НДС или с НДС 0%""
					|и выполнить все связанные с этим действия!", ВыданоСообщениеБезНДС , Заголовок, СтатусСообщения.Информация);
					
				ИначеЕсли СтрокаСписания.СтавкаНДС = Перечисления.СтавкиНДС.НДС0 
					И Не ВыданоСообщение0 Тогда
					
					ОбщегоНазначения.СообщитьОбОшибке("При реализации с НДС 0%, вычет НДС по приобретенным ценностям возможен только после подтверждения ставки НДС 0% (п.3 ст. 172 НК РФ).
					|До этого момента вычет должен быть заблокирован.
					|Для автоматической блокировки вычета НДС в учетной политике по налоговому учету необходимо установить флаг ""Наличие операций без НДС или с НДС 0%""
					|и выполнить все связанные с этим действия!", ВыданоСообщение0, Заголовок, СтатусСообщения.Информация);
					
				КонецЕсли;
				
			ИначеЕсли СтрокаСписания.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ВключитьВСтоимость
				Или СтрокаСписания.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ИсключитьИзСтоимости 
				И Не ВыданоСообщениеБезНДС Тогда
				
				Если ВидДокумента = "СписаниеТоваров" тогда
					ОбщегоНазначения.СообщитьОбОшибке("При списании ТМЦ в результате инвентаризации на счет 94 <Недостачи и потери от порчи ценностей>,
					|НДС по приобретенным ценностям необходимо включать в стоимость списываемой партии товаров.
					|Для автоматического контроля включения НДС в стоимость в учетной политике по налоговому учету необходимо установить флаг ""Наличие операций без НДС или с НДС 0%""
					|и выполнить все связанные с этим действия!", ВыданоСообщениеБезНДС, Заголовок, СтатусСообщения.Информация);
				Иначе
					ОбщегоНазначения.СообщитьОбОшибке("Для автоматического контроля включения НДС в стоимость (исключения из стоимости) в учетной политике по налоговому учету необходимо установить флаг ""Наличие операций без НДС или с НДС 0%""
					|и выполнить все связанные с этим действия!",ВыданоСообщениеБезНДС , Заголовок, СтатусСообщения.Информация);
				КонецЕсли; 
				
			КонецЕсли;
			
			СтрокаСписания.СписыватьПоПартиямНДС = Ложь;
			
		КонецЕсли;
		
		Если СтрокаСписания.СписыватьПоПартиямНДС 
			И ЕстьСтавкаНДС Тогда
			
			Если ЭтоВозврат Тогда 
				СтрокаСписания.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.НеИзменять;	 
			ИначеЕсли СтрокаСписания.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС Тогда
				СтрокаСписания.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ВключитьВСтоимость;
			ИначеЕсли ЗначениеЗаполнено(СтрокаСписания.СтавкаНДС) Тогда
				СтрокаСписания.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ИсключитьИзСтоимости;
			КонецЕсли; 
			
		КонецЕсли;
		
		Если ЕстьСкладВТЧ тогда
			Если Не ЗначениеЗаполнено(СтрокаСписания.Склад)  Тогда
				СтрокаСписания.Склад = Справочники.Склады.ПустаяСсылка();
			КонецЕсли; 
		КонецЕсли;
		
	КонецЦикла; 

	КолвоЭлементовКоллекции = ТаблицаВыручки.Количество(); 
	
	Для ОбратныйИндекс = 1 По КолвоЭлементовКоллекции Цикл 
		ЭлементКоллекции = ТаблицаВыручки[КолвоЭлементовКоллекции - ОбратныйИндекс]; 
		Если Не ЭлементКоллекции.СписыватьПоПартиямНДС Тогда 
			ТаблицаВыручки.Удалить(ЭлементКоллекции); 
		КонецЕсли; 
		
	КонецЦикла;
	
	Если ТаблицаВыручки.Количество() = 0 Тогда
		//Возвращаем пустую таблицу списаний. Все прошло удачно, но движения по партиям не требуются.
		Возврат ТаблицаСписанияНДСПоСтрокам;
	КонецЕсли; 

	Если ТаблицаВыручки.Колонки.Найти("Склад") = Неопределено Тогда
	    ТаблицаВыручки.Колонки.Добавить("Склад", Новый ОписаниеТипов("СправочникСсылка.Склады"));
	КонецЕсли;
	Если ТаблицаВыручки.Колонки.Найти("КоличествоПоступление") = Неопределено Тогда
	    ТаблицаВыручки.Колонки.Добавить("КоличествоПоступление", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
		ТаблицаВыручки.ЗаполнитьЗначения(0, "КоличествоПоступление");		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Если Не ЭтоВозвратОтПокупателя Тогда
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	НДСПартииТоваровОстатки.Склад КАК Склад,
		|	НДСПартииТоваровОстатки.СчетУчета КАК СчетУчета,
		|	НДСПартииТоваровОстатки.Номенклатура КАК Номенклатура,
		|	НДСПартииТоваровОстатки.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
		|	НДСПартииТоваровОстатки.СерияНоменклатуры КАК СерияНоменклатуры,
		|	НДСПартииТоваровОстатки.Партия.Дата КАК ДатаПартии,
		|	НДСПартииТоваровОстатки.Партия КАК Партия,
		|	НДСПартииТоваровОстатки.Заказ КАК Заказ,
		|	НДСПартииТоваровОстатки.СчетФактура.Дата КАК ДатаСФ,
		|	НДСПартииТоваровОстатки.СчетФактура КАК СчетФактура,
		|	НДСПартииТоваровОстатки.НДСВключенВСтоимость,
		|	НДСПартииТоваровОстатки.КоличествоОстаток,
		|	НДСПартииТоваровОстатки.СтоимостьОстаток,
		|	НДСПартииТоваровОстатки.НДСОстаток,
		|	ВЫБОР
		|		КОГДА НДСПартииТоваровОстатки.КоличествоОстаток > 0
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЕстьКоличество,
		|	НДСПартииТоваровОстатки.ВидЦенности,
		|	НДСПартииТоваровОстатки.СчетУчетаНДС,
		|	НДСПартииТоваровОстатки.СтавкаНДС
		|ИЗ
		|	РегистрНакопления.НДСПартииТоваров.Остатки(
		|			&МоментСписания,
		|			Организация = &Организация
		|				И СчетУчета В (&СписокСчетовУчета)
		|				И Номенклатура В (&СписокНоменклатуры)
		|				И Склад В (&СписокСкладов)) КАК НДСПартииТоваровОстатки
		|ГДЕ
		|	(НЕ НДСПартииТоваровОстатки.СтоимостьОстаток < 0)
		|
		|УПОРЯДОЧИТЬ ПО
		|	ДатаПартии,
		|	ДатаСФ";
		
		СписокСкладов = Новый Массив;
		
		Если СтруктураШапкиДокумента.ВидДокумента = "ВозвратТоваровОтПокупателя" 
			И СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
			// Не производится отбор по складу. При передаче на комиссию в партионном учете склад не указывается.
		ИначеЕсли ВестиСуммовойУчетПоСкладамБУ Тогда
			СписокСкладов = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(ТаблицаВыручки.ВыгрузитьКолонку("Склад"));
		КонецЕсли; 
		
		СписокСкладов.Добавить(Справочники.Склады.ПустаяСсылка());
		
		Запрос.УстановитьПараметр("СписокСкладов", СписокСкладов);
												
		Если ПартионныйУчетБУ Тогда 	
			Запрос.УстановитьПараметр("ОтборПоПартиямБУ", ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(ТаблицаВыручки.ВыгрузитьКолонку("Партия")));
			Запрос.Текст = СтрЗаменить(Запрос.Текст,"Номенклатура В (&СписокНоменклатуры)","Номенклатура В (&СписокНоменклатуры) " +символы.ПС+
													"И Партия В (&ОтборПоПартиямБУ)");
		КонецЕсли;

	Иначе // ЭтоВозвратОтПокупателя
		
		СписокДокументовРеализации = ТаблицаВыручки.ВыгрузитьКолонку("ДокументПартии");
		// Возврат может осуществляться как с указанием документа реализации, так и с указанием документа поступления
		// Необходимо разделить возвраты на две группы
		СписокДокументовПартии	   = ТаблицаВыручки.ВыгрузитьКолонку("Партия");
		
		Для ИндексЭлемента = 0 По СписокДокументовРеализации.Количество() - 1 Цикл
			Если СписокДокументовРеализации[ИндексЭлемента] = СписокДокументовПартии[ИндексЭлемента] Тогда
				 СписокДокументовРеализации[ИндексЭлемента] = Неопределено;
			Иначе
				 СписокДокументовПартии[ИндексЭлемента] = Неопределено;
			КонецЕсли; 
		КонецЦикла; 
		
		СписокДокументовРеализации	= ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(СписокДокументовРеализации, Истина);
		СписокДокументовПартии 		= ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(СписокДокументовПартии, Истина);
		
		Если ТипЗнч(СтруктураПараметров) = Тип("Структура") 
			И СтруктураПараметров.Свойство("ДеревоРасходныхОрдеров") Тогда
			
			// Дополним список документов реализации расходными ордерами, которые могли отразить непосредственное списание партии
			КоличествоДокументовРеализации = СписокДокументовРеализации.Количество();
			Для ИндексЭлемента = 0 по КоличествоДокументовРеализации - 1 Цикл
				
				ДокументРеализации = СписокДокументовРеализации[ИндексЭлемента];
				СтрокаРегистратора = СтруктураПараметров.ДеревоРасходныхОрдеров.Строки.Найти(ДокументРеализации, "Регистратор");
				
				Если Не СтрокаРегистратора = Неопределено 
					И СтрокаРегистратора.Строки.Количество() <> 0 Тогда
					
					МассивОрдеров = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(СтрокаРегистратора.Строки.ВыгрузитьКолонку("РасходныйОрдерНаТовары"));
					Для Каждого Ордер Из МассивОрдеров Цикл
						СписокДокументовРеализации.Добавить(Ордер);
					КонецЦикла; 
					
				КонецЕсли; 
				
			КонецЦикла;
			
		КонецЕсли; 
		
		Если СписокДокументовРеализации.Количество() = 0 
			И СписокДокументовПартии.Количество() = 0 Тогда
			//Возвращаем пустую таблицу списаний. Все прошло удачно, но движения по партиям не требуются.
			Возврат ТаблицаСписанияНДСПоСтрокам;
		КонецЕсли; 
		
		Запрос.УстановитьПараметр("ВидДвиженияРасход", ВидДвиженияНакопления.Расход);
		Запрос.УстановитьПараметр("СписокДокументовРеализации", СписокДокументовРеализации);
		
		Если СписокДокументовРеализации.Количество()>0 Тогда
		
			ТекстЗапросаПоДокументамРеализации = 
			"ВЫБРАТЬ
			|	НДСПартииТоваров.Склад КАК Склад,
			|	НДСПартииТоваров.СчетУчета КАК СчетУчета,
			|	НДСПартииТоваров.Номенклатура КАК Номенклатура,
			|	НДСПартииТоваров.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
			|	НДСПартииТоваров.СерияНоменклатуры КАК СерияНоменклатуры,
			|	НДСПартииТоваров.Партия.Дата КАК ДатаПартии,
			|	НДСПартииТоваров.Партия КАК Партия,
			|	НДСПартииТоваров.Заказ КАК Заказ,
			|	НДСПартииТоваров.СчетФактура.Дата КАК ДатаСФ,
			|	НДСПартииТоваров.СчетФактура КАК СчетФактура,
			|	НДСПартииТоваров.НДСВключенВСтоимость,
			|	НДСПартииТоваров.Количество КАК КоличествоОстаток,
			|	НДСПартииТоваров.Стоимость КАК СтоимостьОстаток,
			|	ВЫБОР
			|		КОГДА НДСПартииТоваров.Количество > 0
			|			ТОГДА ИСТИНА
			|		ИНАЧЕ ЛОЖЬ
			|	КОНЕЦ КАК ЕстьКоличество,
			|	НДСПартииТоваров.ВидЦенности,
			|	НДСПартииТоваров.СчетУчетаНДС,
			|	НДСПартииТоваров.СтавкаНДС,
			|	НДСПартииТоваров.НДС КАК НДСОстаток
			|ИЗ
			|	РегистрНакопления.НДСПартииТоваров КАК НДСПартииТоваров
			|ГДЕ
			|	НДСПартииТоваров.Регистратор В(&СписокДокументовРеализации)
			|	И НДСПартииТоваров.Номенклатура В(&СписокНоменклатуры)
			|	И НДСПартииТоваров.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)";
			Если ПартионныйУчетБУ Тогда 	
				Запрос.УстановитьПараметр("ОтборПоПартиямБУ", ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(ТаблицаВыручки.ВыгрузитьКолонку("Партия")));
				Запрос.Текст = СтрЗаменить(Запрос.Текст,"Номенклатура В (&СписокНоменклатуры)","Номенклатура В (&СписокНоменклатуры) " +символы.ПС+
														"И Партия В (&ОтборПоПартиямБУ)");
			КонецЕсли;
			
		Иначе
			ТекстЗапросаПоДокументамРеализации = "";
		КонецЕсли; 
		
		Если СписокДокументовПартии.Количество()>0 Тогда
			Запрос.УстановитьПараметр("СписокДокументовПартии",		СписокДокументовПартии);
		    ТекстЗапросаПоДокументамПоступления =
			"ВЫБРАТЬ
			|	НДСПартииТоваров.Склад КАК Склад,
			|	НДСПартииТоваров.СчетУчета КАК СчетУчета,
			|	НДСПартииТоваров.Номенклатура КАК Номенклатура,
			|	НДСПартииТоваров.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
			|	НДСПартииТоваров.СерияНоменклатуры КАК СерияНоменклатуры,
			|	НДСПартииТоваров.Партия.Дата КАК ДатаПартии,
			|	НДСПартииТоваров.Партия КАК Партия,
			|	НДСПартииТоваров.Заказ КАК Заказ,
			|	НДСПартииТоваров.СчетФактура.Дата КАК ДатаСФ,
			|	НДСПартииТоваров.СчетФактура КАК СчетФактура,
			|	НДСПартииТоваров.НДСВключенВСтоимость,
			|	НДСПартииТоваров.КоличествоРасход КАК КоличествоОстаток,
			|	НДСПартииТоваров.СтоимостьРасход КАК СтоимостьОстаток,
			|	ВЫБОР
			|		КОГДА НДСПартииТоваров.КоличествоРасход > 0
			|			ТОГДА ИСТИНА
			|		ИНАЧЕ ЛОЖЬ
			|	КОНЕЦ КАК ЕстьКоличество,
			|	НДСПартииТоваров.ВидЦенности,
			|	НДСПартииТоваров.СчетУчетаНДС,
			|	НДСПартииТоваров.СтавкаНДС,
			|	НДСПартииТоваров.НДСРасход КАК НДСОстаток
			|ИЗ
			|	РегистрНакопления.НДСПартииТоваров.Обороты(
			|		,
			|		&МоментСписания,
			|		Регистратор,
			|		Организация = &Организация
			|		    И Номенклатура В (&СписокНоменклатуры)
			|		    И Партия В (&СписокДокументовПартии)) КАК НДСПартииТоваров
			|ГДЕ
			|	(НЕ НДСПартииТоваров.Регистратор В (&СписокДокументовРеализации))
			|	И (НДСПартииТоваров.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
			|			ИЛИ НДСПартииТоваров.Регистратор ССЫЛКА Документ.ОтчетОРозничныхПродажах)";
		КонецЕсли; 
		
		Запрос.Текст = ТекстЗапросаПоДокументамРеализации 
					+?(ПустаяСтрока(ТекстЗапросаПоДокументамРеализации) или ПустаяСтрока(ТекстЗапросаПоДокументамПоступления),""," Объединить Все ") 
					+ ТекстЗапросаПоДокументамПоступления 
					+"
					|УПОРЯДОЧИТЬ ПО
					|	ДатаПартии УБЫВ,
					|	ДатаСФ УБЫВ";
	КонецЕсли; 

	Запрос.УстановитьПараметр("МоментСписания", 		Новый Граница(СтруктураШапкиДокумента.Ссылка.МоментВремени(), ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("Организация", 			СтруктураШапкидокумента.Организация);
	
	Запрос.УстановитьПараметр("СписокСчетовУчета", 		ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(ТаблицаВыручки.выгрузитьКолонку("СчетУчетаБУ")));
	Запрос.УстановитьПараметр("СписокНоменклатуры", 	ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(ТаблицаВыручки.выгрузитьКолонку("Номенклатура")));
	
	ТаблицаПартий = Запрос.Выполнить().Выгрузить();
	
	СортироватьПоУказанномуДокументуПриВозврате = ЭтоВозврат и не ЭтоВозвратОтПокупателя;

	Если СортироватьПоУказанномуДокументуПриВозврате Тогда
		ТаблицаПартий.Колонки.Добавить("ПартияСовпадаетСУказаннымДокументомДляВозврата", новый описаниеТипов("Булево"));
	КонецЕсли; 
	
	ОбособленныйУчетТоваровПоЗаказамПокупателейВСтроке = ТаблицаВыручки.Колонки.Найти("ОбособленныйУчетТоваровПоЗаказамПокупателей") <> Неопределено;
	ЕстьКолонка_ЗаказПартии =  ТаблицаВыручки.Колонки.Найти("ЗаказПартии") <> Неопределено;
	
	ТаблицаВыручки.Колонки.Добавить("НДСЭтоЕНВД", Новый ОписаниеТипов("Булево"));
	ЕстьКолонкаСчетДоходовБУ = ТаблицаВыручки.Колонки.Найти("СчетДоходовБУ") <> Неопределено;
	ЕстьСчетДоходовБУ 		 = СтруктураШапкиДокумента.Свойство("СчетДоходовБУ");
		
	Для каждого СтрокаКСписанию Из ТаблицаВыручки Цикл
		
		Если (СтрокаКСписанию.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ВключитьВСтоимость) И ЕстьКолонкаСчетДоходовБУ Тогда
			СтрокаКСписанию.НДСЭтоЕНВД = НалоговыйУчетУСН.ОтноситсяКДеятельностиЕНВД(СтрокаКСписанию.СчетДоходовБУ);
		ИначеЕсли (СтрокаКСписанию.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ВключитьВСтоимость) И ЕстьСчетДоходовБУ Тогда
			СтрокаКСписанию.НДСЭтоЕНВД = НалоговыйУчетУСН.ОтноситсяКДеятельностиЕНВД(СтруктураШапкиДокумента.СчетДоходовБУ);
		Иначе
			СтрокаКСписанию.НДСЭтоЕНВД = Ложь;
		КонецЕсли;
				
		//Установим отбор таблицы запроса
		Если ЭтоВозвратОтПокупателя Тогда
			Отбор = Новый Структура("Номенклатура, ЕстьКоличество", СтрокаКСписанию.Номенклатура, Истина);
		Иначе
			Отбор = Новый Структура("СчетУчета, Номенклатура, ЕстьКоличество", СтрокаКСписанию.СчетУчетаБУ, СтрокаКСписанию.Номенклатура, Истина);
		КонецЕсли; 
		
		Если СтруктураШапкиДокумента.ВидДокумента = "ВозвратТоваровОтПокупателя" и СтруктураШапкиДокумента.ВидДоговора = перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
			// Не производится отбор по складу. При передаче на комиссию в партионном учете склад не указывается.
		ИначеЕсли УправлениеЗапасамиПартионныйУчет.ВедетсяСуммовойУчетПоСкладам(СтрокаКСписанию.СчетУчетаБУ) и Не ЭтоВозвратОтПокупателя Тогда
			Отбор.Вставить("Склад", СтрокаКСписанию.Склад);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СтрокаКСписанию.Партия) Тогда
			Отбор.Вставить("Партия", СтрокаКСписанию.Партия);
		КонецЕсли;
		
		Если ЭтоВозвратОтПокупателя тогда
			// Заказ не анализируется
		ИначеЕсли не ЕстьКолонка_ЗаказПартии тогда
			Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
		ИначеЕсли НЕ ЗначениеЗаполнено(СтрокаКСписанию.ЗаказПартии) тогда
			Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
		ИначеЕсли не ТипЗнч(СтрокаКСписанию.ЗаказПартии) = Тип("ДокументСсылка.ЗаказПокупателя") тогда 
			Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
		ИначеЕсли ОбособленныйУчетТоваровПоЗаказамПокупателейВСтроке И ?(СтрокаКСписанию.ОбособленныйУчетТоваровПоЗаказамПокупателей = Неопределено, Ложь, СтрокаКСписанию.ОбособленныйУчетТоваровПоЗаказамПокупателей) Тогда 
			Отбор.Вставить("Заказ", СтрокаКСписанию.ЗаказПартии);
		ИначеЕсли СтрокаКСписанию.ЗаказПартии.ВидОперации = Перечисления.ВидыОперацийЗаказПокупателя.Переработка Тогда
			Отбор.Вставить("Заказ", СтрокаКСписанию.ЗаказПартии);
		Иначе 
			Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
		КонецЕсли; 
		
		Если СтруктураШапкиДокумента.ПартионныйУчетНДСвРазрезеСерийИХарактеристик Тогда
			Отбор.Вставить("ХарактеристикаНоменклатуры", ?(СтрокаКСписанию.ХарактеристикаНоменклатуры = Неопределено, Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка(), СтрокаКСписанию.ХарактеристикаНоменклатуры));
			Если СтрокаКСписанию.Номенклатура.ВестиПартионныйУчетПоСериям И ВидДокумента <> "ОтчетКомиссионераОПродажах" Тогда //товары у комиссонера не учитываются по сериям
				Отбор.Вставить("СерияНоменклатуры", ?(СтрокаКСписанию.СерияНоменклатуры = Неопределено, Справочники.СерииНоменклатуры.ПустаяСсылка(), СтрокаКСписанию.СерияНоменклатуры));
			КонецЕсли;
		КонецЕсли;
		
		ОтборТаблицыПартийПоКлючу = ТаблицаПартий.НайтиСтроки(Отбор);
		СписатьПоКлючу = СтрокаКСписанию.Количество;
		
		// Найденные строки перенесем в таблицу значений, которую нужно отсортировать в соответствии со стратегией списания
		ТаблицаОстатки  = Новый ТаблицаЗначений;
		// Добавим колонку с индексом
		ТаблицаОстатки.Колонки.Добавить("ИндексНайденнойСтроки", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
		
		Для Каждого Кол Из ТаблицаПартий.Колонки Цикл
			ТаблицаОстатки.Колонки.Добавить(Кол.Имя, Кол.ТипЗначения);
		КонецЦикла;
		Индекс = 0;
		Для Каждого СтрокаТЧ Из ОтборТаблицыПартийПоКлючу Цикл
			НоваяСтрока = ТаблицаОстатки.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрокаТЧ); 
			НоваяСтрока.ИндексНайденнойСтроки = Индекс;
			Если СортироватьПоУказанномуДокументуПриВозврате Тогда
				НоваяСтрока.ПартияСовпадаетСУказаннымДокументомДляВозврата = ( ЗначениеЗаполнено(СтрокаКСписанию.ДокументПартии) и НоваяСтрока.Партия = СтрокаКСписанию.ДокументПартии);
			КонецЕсли; 
			
			Индекс = Индекс + 1;
		КонецЦикла;
		
		НаправлениеСортировкиДляНДС = ?(СтрокаКСписанию.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ВключитьВСтоимость, "Убыв", "Возр");
		НаправлениеСортировкиПартий = ?(ЭтоВозврат,"убыв","Возр");
		ТаблицаОстатки.Сортировать(?(СортироватьПоУказанномуДокументуПриВозврате,"ПартияСовпадаетСУказаннымДокументомДляВозврата Убыв, ","")+"ДатаПартии "+НаправлениеСортировкиПартий+", Партия "+НаправлениеСортировкиПартий+", ДатаСФ "+НаправлениеСортировкиПартий+", СчетФактура "+НаправлениеСортировкиПартий+", НДСВключенВСтоимость "+НаправлениеСортировкиДляНДС);
		
		ТаблицаСписанияПоСтроке = Новый ТаблицаЗначений;
		ТаблицаСписанияПоСтроке.Колонки.Добавить("Партия");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("Заказ", Новый ОписаниеТипов("ДокументСсылка.ЗаказПокупателя"));
		ТаблицаСписанияПоСтроке.Колонки.Добавить("ДействияНДСПокупки_ВключитьВСтоимость");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("ДействияНДСПокупки_ИсключитьИзСтоимости");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("ДействияНДСПокупки_ПредположениеСтавки0");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("НДСВключенВСтоимость");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("ВидЦенности");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("СчетУчетаНДС");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("СтавкаНДС");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("СчетФактура");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
		ТаблицаСписанияПоСтроке.Колонки.Добавить("КоличествоПоступление", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
		ТаблицаСписанияПоСтроке.Колонки.Добавить("Стоимость", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
		ТаблицаСписанияПоСтроке.Колонки.Добавить("НДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
		ТаблицаСписанияПоСтроке.Колонки.Добавить("Склад");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("СерияНоменклатуры");
		ТаблицаСписанияПоСтроке.Колонки.Добавить("ХарактеристикаНоменклатуры");
		Если ЭтоВозврат и не ЭтоВозвратОтПокупателя Тогда
			ТаблицаСписанияПоСтроке.Колонки.Добавить("ПартияСовпадаетСУказаннымДокументомДляВозврата", Новый описаниеТипов("Булево"));
		КонецЕсли; 
		
		Для каждого СтрокаТаблицыПартийНДС Из ТаблицаОстатки Цикл
			
			Если НЕ СтрокаТаблицыПартийНДС.ЕстьКоличество Тогда
				Продолжить;
			КонецЕсли;
			Если СтрокаТаблицыПартийНДС.КоличествоОстаток=0 Тогда
				Продолжить;
			КонецЕсли; 
			
			СтрокаТаблицыСписания 						= ТаблицаСписанияПоСтроке.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицыСписания,СтрокаТаблицыПартийНДС);
			
			СтрокаТаблицыСписания.Количество 			= Мин(СписатьПоКлючу, СтрокаТаблицыПартийНДС.КоличествоОстаток);
			СтрокаТаблицыСписания.Стоимость 			= ?(СтрокаТаблицыПартийНДС.КоличествоОстаток = 0, 0, СтрокаТаблицыПартийНДС.СтоимостьОстаток * СтрокаТаблицыСписания.Количество / СтрокаТаблицыПартийНДС.КоличествоОстаток) ;
			СтрокаТаблицыСписания.НДС 					= ?(СтрокаТаблицыПартийНДС.КоличествоОстаток = 0, 0, СтрокаТаблицыПартийНДС.НДСОстаток * СтрокаТаблицыСписания.Количество / СтрокаТаблицыПартийНДС.КоличествоОстаток) ;
			СтрокаТаблицыСписания.КоличествоПоступление	= ?(СтрокаКСписанию.Количество = 0, 0, СтрокаКСписанию.КоличествоПоступление * СтрокаТаблицыСписания.Количество / СтрокаКСписанию.Количество) ;
			
			Если ЭтоВозвратОтПокупателя и не УправлениеЗапасамиПартионныйУчет.ВедетсяСуммовойУчетПоСкладам(СтрокаКСписанию.СчетУчетаБУ) Тогда
			    СтрокаТаблицыСписания.Склад = Справочники.Склады.ПустаяСсылка();
			//Иначе
			//	СтрокаТаблицыСписания.Склад					= СтрокаТаблицыПартийНДС.Склад;	
			КонецЕсли; 
			Если Не СтруктураШапкиДокумента.ПартионныйУчетНДСвРазрезеСерийИХарактеристик Тогда
				СтрокаТаблицыСписания.ХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				СтрокаТаблицыСписания.СерияНоменклатуры = Справочники.СерииНоменклатуры.ПустаяСсылка();
			ИначеЕсли Не СтрокаТаблицыПартийНДС.Номенклатура.ВестиПартионныйУчетПоСериям Тогда
				СтрокаТаблицыСписания.СерияНоменклатуры = Справочники.СерииНоменклатуры.ПустаяСсылка();
			КонецЕсли;
			
			Если (СтрокаКСписанию.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ВключитьВСтоимость) И (НЕ СтрокаТаблицыПартийНДС.НДСВключенВСтоимость) И
				(СтрокаТаблицыПартийНДС.СтавкаНДС <> Перечисления.СтавкиНДС.БезНДС Или СтрокаКСписанию.НДСЭтоЕНВД) Тогда
				СтрокаТаблицыСписания.ДействияНДСПокупки_ВключитьВСтоимость = Истина;
				СтрокаТаблицыСписания.ДействияНДСПокупки_ИсключитьИзСтоимости = Ложь;
			ИначеЕсли (СтрокаКСписанию.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ИсключитьИзСтоимости) И (СтрокаТаблицыПартийНДС.НДСВключенВСтоимость) Тогда
				СтрокаТаблицыСписания.ДействияНДСПокупки_ВключитьВСтоимость = Ложь;
				СтрокаТаблицыСписания.ДействияНДСПокупки_ИсключитьИзСтоимости = Истина;
			Иначе
				СтрокаТаблицыСписания.ДействияНДСПокупки_ВключитьВСтоимость = Ложь;
				СтрокаТаблицыСписания.ДействияНДСПокупки_ИсключитьИзСтоимости = Ложь;
			КонецЕсли;
			
			СтрокаТаблицыСписания.ДействияНДСПокупки_ПредположениеСтавки0 = Ложь;
			
			Если ЕстьСтавкаНДС  и не ЭтоВозврат Тогда
				Если СтрокаКСписанию.СтавкаНДС = Перечисления.СтавкиНДС.НДС0 Тогда
					СтрокаТаблицыСписания.ДействияНДСПокупки_ПредположениеСтавки0 = Истина;
				КонецЕсли;
			КонецЕсли;
						
			СписатьПоКлючу = СписатьПоКлючу - СтрокаТаблицыСписания.Количество;
			
			СтрокаТаблицыПартийНДС.КоличествоОстаток = СтрокаТаблицыПартийНДС.КоличествоОстаток - СтрокаТаблицыСписания.Количество;
			СтрокаТаблицыПартийНДС.СтоимостьОстаток = СтрокаТаблицыПартийНДС.СтоимостьОстаток - СтрокаТаблицыСписания.Стоимость;
			СтрокаТаблицыПартийНДС.НДСОстаток = СтрокаТаблицыПартийНДС.НДСОстаток - СтрокаТаблицыСписания.НДС;
			
			Если СписатьПоКлючу<=0 Тогда
				прервать;
			КонецЕсли; 
			
		КонецЦикла;
		
		//Распределение доп. расходов
		ПартииКСписнию = ТаблицаСписанияПоСтроке.Скопировать();
		ПартииКСписнию.Свернуть("Партия", "Количество, Стоимость");
		
		Для Каждого Партия Из ПартииКСписнию Цикл
			//Установим отбор таблицы запроса
			Если ЭтоВозвратОтПокупателя Тогда
				Отбор = Новый Структура("Номенклатура, Партия", СтрокаКСписанию.Номенклатура, Партия.Партия);
            Иначе
				Отбор = Новый Структура("СчетУчета, Номенклатура, Партия", СтрокаКСписанию.СчетУчетаБУ, СтрокаКСписанию.Номенклатура, Партия.Партия);
			КонецЕсли;
			
			Если СтруктураШапкиДокумента.ВидДокумента = "ВозвратТоваровОтПокупателя" и СтруктураШапкиДокумента.ВидДоговора = перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
				// Не производится отбор по складу. При передаче на комиссию в партионном учете склад не указывается.
			ИначеЕсли УправлениеЗапасамиПартионныйУчет.ВедетсяСуммовойУчетПоСкладам(СтрокаКСписанию.СчетУчетаБУ) Тогда
				Отбор.Вставить("Склад", СтрокаКСписанию.Склад);
			КонецЕсли;
		
			Если ЭтоВозвратОтПокупателя тогда
				// Заказ не анализируется
			ИначеЕсли не ЕстьКолонка_ЗаказПартии тогда
				Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
			ИначеЕсли НЕ ЗначениеЗаполнено(СтрокаКСписанию.ЗаказПартии) тогда
				Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
			ИначеЕсли не ТипЗнч(СтрокаКСписанию.ЗаказПартии) = Тип("ДокументСсылка.ЗаказПокупателя") тогда 
				Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
			ИначеЕсли ОбособленныйУчетТоваровПоЗаказамПокупателейВСтроке И ?(СтрокаКСписанию.ОбособленныйУчетТоваровПоЗаказамПокупателей = Неопределено, Ложь, СтрокаКСписанию.ОбособленныйУчетТоваровПоЗаказамПокупателей) Тогда 
				Отбор.Вставить("Заказ", СтрокаКСписанию.ЗаказПартии);
			ИначеЕсли СтрокаКСписанию.ЗаказПартии.ВидОперации = Перечисления.ВидыОперацийЗаказПокупателя.Переработка Тогда
				Отбор.Вставить("Заказ", СтрокаКСписанию.ЗаказПартии);
			Иначе 
				Отбор.Вставить("Заказ", Документы.ЗаказПокупателя.ПустаяСсылка());
			КонецЕсли; 
			
			Если СтруктураШапкиДокумента.ПартионныйУчетНДСвРазрезеСерийИХарактеристик Тогда
				Отбор.Вставить("ХарактеристикаНоменклатуры", ?(СтрокаКСписанию.ХарактеристикаНоменклатуры = Неопределено, Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка(), СтрокаКСписанию.ХарактеристикаНоменклатуры));
				Если СтрокаКСписанию.Номенклатура.ВестиПартионныйУчетПоСериям И ВидДокумента <> "ОтчетКомиссионераОПродажах" Тогда //товары у комиссонера не учитываются по сериям
					Отбор.Вставить("СерияНоменклатуры", ?(СтрокаКСписанию.СерияНоменклатуры = Неопределено, Справочники.СерииНоменклатуры.ПустаяСсылка(), СтрокаКСписанию.СерияНоменклатуры));
				КонецЕсли;
			КонецЕсли;

			ОтборДляДопРасходов = ТаблицаПартий.НайтиСтроки(Отбор);
			
			//Определим коэффициент доп. расходов
			СуммаПоПартии = 0;
			Для Каждого СтрокаПартии Из ОтборДляДопРасходов Цикл
				Если СтрокаПартии.ЕстьКоличество Тогда
					СуммаПоПартии = СуммаПоПартии + СтрокаПартии.СтоимостьОстаток;
				ИначеЕсли СортироватьПоУказанномуДокументуПриВозврате Тогда
					СтрокаПартии.ПартияСовпадаетСУказаннымДокументомДляВозврата = ( ЗначениеЗаполнено(СтрокаКСписанию.ДокументПартии) и СтрокаПартии.Партия = СтрокаКСписанию.ДокументПартии);
				КонецЕсли;
			КонецЦикла;
			
			// Если в партии нулевая сумма, то списание доп. расходов производим пропорционально количеству.
			Если СуммаПоПартии = 0 Тогда
				КоличествоПоПартии = 0;
				Для Каждого СтрокаПартии Из ОтборДляДопРасходов Цикл
					Если СтрокаПартии.ЕстьКоличество Тогда
						КоличествоПоПартии = КоличествоПоПартии + СтрокаПартии.КоличествоОстаток;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			//Проверим наличие доп расходов
			Если СуммаПоПартии = 0 И КоличествоПоПартии = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Если СуммаПоПартии <> 0 Тогда
				К = Партия.Стоимость / СуммаПоПартии;
			Иначе
				К = Партия.Количество / КоличествоПоПартии;
			КонецЕсли;
			
			//Спишем доп. расходы
			Для Каждого СтрокаПартии Из ОтборДляДопРасходов Цикл
				
				Если СтрокаПартии.ЕстьКоличество ИЛИ Окр(СтрокаПартии.СтоимостьОстаток*К,2,1) = 0 Тогда
					Продолжить;
				КонецЕсли;
				
				СтрокаТаблицыСписания = ТаблицаСписанияПоСтроке.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаблицыСписания, СтрокаПартии);
				
				СтрокаТаблицыСписания.Стоимость = СтрокаПартии.СтоимостьОстаток * К;
				СтрокаТаблицыСписания.НДС = СтрокаПартии.НДСОстаток * К;
					
				Если ЭтоВозвратОтПокупателя и не УправлениеЗапасамиПартионныйУчет.ВедетсяСуммовойУчетПоСкладам(СтрокаКСписанию.СчетУчетаБУ) Тогда
				    СтрокаТаблицыСписания.Склад = Справочники.Склады.ПустаяСсылка();
				//Иначе
				//	СтрокаТаблицыСписания.Склад					= СтрокаПартии.Склад;	
				КонецЕсли; 
				Если Не СтруктураШапкиДокумента.ПартионныйУчетНДСвРазрезеСерийИХарактеристик Тогда
					СтрокаТаблицыСписания.ХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
					СтрокаТаблицыСписания.СерияНоменклатуры = Справочники.СерииНоменклатуры.ПустаяСсылка();
				ИначеЕсли Не СтрокаТаблицыПартийНДС.Номенклатура.ВестиПартионныйУчетПоСериям Тогда
					СтрокаТаблицыСписания.СерияНоменклатуры = Справочники.СерииНоменклатуры.ПустаяСсылка();
				КонецЕсли;
				
			
				Если (СтрокаКСписанию.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ВключитьВСтоимость) И (НЕ СтрокаПартии.НДСВключенВСтоимость) 
					И (СтрокаПартии.СтавкаНДС <> Перечисления.СтавкиНДС.БезНДС Или СтрокаКСписанию.НДСЭтоЕНВД) Тогда
					СтрокаТаблицыСписания.ДействияНДСПокупки_ВключитьВСтоимость = Истина;
					СтрокаТаблицыСписания.ДействияНДСПокупки_ИсключитьИзСтоимости = Ложь;
				ИначеЕсли (СтрокаКСписанию.НДСВСтоимостиТоваров = Перечисления.ДействиеНДСВСтоимостиТоваров.ИсключитьИзСтоимости) И (СтрокаПартии.НДСВключенВСтоимость) Тогда
					СтрокаТаблицыСписания.ДействияНДСПокупки_ВключитьВСтоимость = Ложь;
					СтрокаТаблицыСписания.ДействияНДСПокупки_ИсключитьИзСтоимости = Истина;
				Иначе
					СтрокаТаблицыСписания.ДействияНДСПокупки_ВключитьВСтоимость = Ложь;
					СтрокаТаблицыСписания.ДействияНДСПокупки_ИсключитьИзСтоимости = Ложь;
				КонецЕсли;
				
				СтрокаТаблицыСписания.ДействияНДСПокупки_ПредположениеСтавки0 = Ложь;
				
				Если ЕстьСтавкаНДС и не ЭтоВозврат Тогда
					Если СтрокаКСписанию.СтавкаНДС = Перечисления.СтавкиНДС.НДС0 Тогда
						СтрокаТаблицыСписания.ДействияНДСПокупки_ПредположениеСтавки0 = Истина;
					КонецЕсли;
				КонецЕсли;
			    				
				СтрокаПартии.СтоимостьОстаток = СтрокаПартии.СтоимостьОстаток - СтрокаТаблицыСписания.Стоимость;
				СтрокаПартии.НДСОстаток = СтрокаПартии.НДСОстаток - СтрокаТаблицыСписания.НДС;
				
			КонецЦикла;
			
		КонецЦикла;
		
		//Перенесем данные в итоговую таблицу движений
		Для Каждого СтрокаСписания ИЗ ТаблицаСписанияПоСтроке Цикл
			
			СтрокаТаблицыСписанияНДС = ТаблицаСписанияНДСПоСтрокам.Добавить();
			
			Для Каждого Кол Из ТаблицаСписанияНДСПоСтрокам.Колонки Цикл
				Если НЕ ТаблицаСписанияПоСтроке.Колонки.Найти(Кол.Имя) = Неопределено Тогда
					СтрокаТаблицыСписанияНДС[Кол.Имя] = СтрокаСписания[Кол.Имя];
				ИначеЕсли НЕ ТаблицаВыручки.Колонки.Найти(Кол.Имя) = Неопределено Тогда 
					СтрокаТаблицыСписанияНДС[Кол.Имя] = СтрокаКСписанию[Кол.Имя];
				КонецЕсли;
			КонецЦикла;
			СтрокаТаблицыСписанияНДС["СчетУчета"] = СтрокаТаблицыСписанияНДС["СчетУчетаБУ"];
		КонецЦикла;
		
		// Таблицу значений перенесем в найденные строки
		Для Каждого СтрокаТЧ Из ТаблицаОстатки Цикл
			ЗаполнитьЗначенияСвойств(ОтборТаблицыПартийПоКлючу[СтрокаТЧ.ИндексНайденнойСтроки],СтрокаТЧ);
		КонецЦикла;
		
		Если СписатьПоКлючу>0 тогда
			ТекстСообщения = "Для целей учета НДС не списано " + Формат(СписатьПоКлючу, "ЧЦ=15; ЧДЦ=3") + " товара " + СтрокаКСписанию.Номенклатура;
			Если СтруктураШапкиДокумента.ПартионныйУчетНДСвРазрезеСерийИХарактеристик Тогда 
				Если ЗначениеЗаполнено(СтрокаКСписанию.ХарактеристикаНоменклатуры) Тогда
					ТекстСообщения = ТекстСообщения + ", х-ка: " + СтрокаКСписанию.ХарактеристикаНоменклатуры;
				КонецЕсли;
				Если СтрокаКСписанию.Номенклатура.ВестиПартионныйУчетПоСериям И ЗначениеЗаполнено(СтрокаКСписанию.СерияНоменклатуры) Тогда
					ТекстСообщения = ТекстСообщения + ", серия: " + СтрокаКСписанию.СерияНоменклатуры;
				КонецЕсли;
			КонецЕсли;
			ТекстСообщения = ТекстСообщения + ", счет учета " + СтрокаКСписанию.СчетУчетаБУ +?(НЕ ЗначениеЗаполнено(СтрокаКСписанию.Склад),"",", склад "+строка(СтрокаКСписанию.Склад))+?(НЕ ЗначениеЗаполнено(СтрокаКСписанию.Партия),""," (партия <"+строка(СтрокаКСписанию.Партия)+">)");
			Если ВидДокумента = "ПоступлениеИзПереработки" Тогда
				ТекстСообщения = ТекстСообщения + Символы.ПС + "Возможно, для изготовления продукции использовались полуфабрикаты или продукция собственного производства";
			КонецЕсли;
			ОбщегоНазначения.СообщитьОбОшибке(ТекстСообщения, ,Заголовок);
		КонецЕсли;
		
	КонецЦикла;
	
	ТаблицаСписанияНДСПоСтрокам.ЗаполнитьЗначения(СтруктураШапкиДокумента.Организация,"Организация"); 
	Если ТаблицаСписанияНДСПоСтрокам.Колонки.Найти("QuieryId") = Неопределено Тогда
		ТаблицаСписанияНДСПоСтрокам.Колонки.Добавить("QuieryId");
	КонецЕсли; 
	
	Если ЭтоВозвратОтПокупателя Тогда
		ТаблицаСписанияНДСПоСтрокам.ЗаполнитьЗначения(Неопределено,"Заказ"); 
	КонецЕсли; 
	
	СтруктураПараметров.Вставить("СоответствиеКодовОперацийСтрокамНДСПартий", Новый Соответствие);
	QuieryId = 0;
	
	Для каждого СтрокаСписания Из ТаблицаСписанияНДСПоСтрокам Цикл
		QuieryId = QuieryId + 1;
		СтрокаСписания.QuieryId = QuieryId;
		
		// Для ускорения поиска добавим строку в соответствие
		МассивСтрокПоКоду = СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[СтрокаСписания.КодОперацииПартииТоваров];
		Если МассивСтрокПоКоду = Неопределено Тогда
			СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий.Вставить(СтрокаСписания.КодОперацииПартииТоваров, Новый Массив);
			МассивСтрокПоКоду = СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[СтрокаСписания.КодОперацииПартииТоваров];
		КонецЕсли;
		МассивСтрокПоКоду.Добавить(СтрокаСписания);
		
	КонецЦикла;
	
	Возврат ТаблицаСписанияНДСПоСтрокам;
	
КонецФункции

/////////////////////
// СЛУЖЕБНЫЕ ФУНКЦИИ

//Преименование колонок таблицы значений по данным соответствия
Процедура ПереименованиеКолонок(ТаблицаЗначений, СоответствиеНазваний, Обратное = Ложь, СообщатьОбОшибке = Истина) Экспорт
	
	Колонки = ТаблицаЗначений.Колонки;
	
	Для каждого Колонка Из СоответствиеНазваний Цикл
		Если Обратное Тогда
			СтароеНазвание = Колонка.Значение;
			НовоеНазвание =  Колонка.Ключ;
		Иначе
			СтароеНазвание = Колонка.Ключ;
			НовоеНазвание =  Колонка.Значение;
		КонецЕсли;
		Если Колонки.Найти(СтароеНазвание) = неопределено тогда
			Если СообщатьОбОшибке Тогда
			    ОбщегоНазначения.СообщитьОбОшибке("При переименовании колонок таблицы не обнаружена колонка с именем """+СтароеНазвание+"""! Переименование колонки не произведено.");
			КонецЕсли; 
		ИначеЕсли не Колонки.Найти(НовоеНазвание) = неопределено тогда
			Если СообщатьОбОшибке Тогда
			    ОбщегоНазначения.СообщитьОбОшибке("При переименовании колонок таблицы обнаружена колонка с именем """+НовоеНазвание+""", переименование существующей колонки """+СтароеНазвание+""" невозможно! Переименование колонки не произведено.");
			КонецЕсли; 
		Иначе
			Колонки[СтароеНазвание].Имя = НовоеНазвание;
		КонецЕсли;
	КонецЦикла; 
	

КонецПроцедуры

// ВОЗВРАТ ТОВАРОВ ОТ ПОКУПАТЕЛЯ
//////////////////////////////////////////////////////////////////////////

Процедура СнятиеРезерваНДСПартииПоЗаказамПокупателя(ТаблицаПартий,СтруктураПараметров)
		
	Для Каждого СтрокаПартии Из ТаблицаПартий Цикл
		
		// Количество по строке больше 0
		Если СтрокаПартии.Количество = 0 Тогда
			Продолжить;
		КонецЕсли; 
		
		// Добавим новую строку
		Движение = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПартииТоваров", СтруктураПараметров);
		
		// Свойства
		Движение.Период 				= СтруктураПараметров.Период;
		Движение.Регистратор 			= СтруктураПараметров.Регистратор;
		Движение.Активность 			= Истина;
		Движение.ВидДвижения 			= ВидДвиженияНакопления.Расход;
		
		ЗаполнитьЗначенияСвойств(Движение,СтрокаПартии);
		
		Строка = Движение;
		
		// Добавим новую строку
		Движение = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПартииТоваров", СтруктураПараметров);
		ЗаполнитьЗначенияСвойств(Движение,Строка);
		Движение.Заказ  				= Неопределено;
		Движение.ВидДвижения 			= ВидДвиженияНакопления.Приход;
		
	КонецЦикла;
	
КонецПроцедуры

/////////////////////////////////////////////////////////////////////////////////////
// ОТРАЖЕНИЕ ДВИЖЕНИЙ ПО РЕГИСТРУ НДС ПО ПАРТИЯМ ЗАПАСОВ, ПАРТИОННЫЙ УЧЕТ ДЛЯ НДС

// Доподняет структуру шапки документа параметрами ПартионныйУчетНДСвРазрезеСкладов и
// ПартионныйУчетНДСвРазрезеСерийИХарактеристик
//
Процедура ДополнитьПараметрамиПартионногоУчетаНДС(СтруктураШапкиДокумента, УчетнаяПолитика = Неопределено)
	
	Если УчетнаяПолитика = Неопределено Тогда
		УчетнаяПолитика = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация);
	КонецЕсли;
	
	Если Не СтруктураШапкиДокумента.Свойство("ПартионныйУчетНДСвРазрезеСкладов") Тогда
		Если УчетнаяПолитика <> Ложь 
			И ЗначениеЗаполнено(УчетнаяПолитика) 
			И УчетнаяПолитика.Свойство("ПартионныйУчетНДСвРазрезеСкладов") Тогда
			СтруктураШапкиДокумента.Вставить("ПартионныйУчетНДСвРазрезеСкладов", УчетнаяПолитика.ПартионныйУчетНДСвРазрезеСкладов);
		Иначе
			СтруктураШапкиДокумента.Вставить("ПартионныйУчетНДСвРазрезеСкладов", Ложь);
		КонецЕсли;
	КонецЕсли;
	Если Не СтруктураШапкиДокумента.Свойство("ПартионныйУчетНДСвРазрезеСерийИХарактеристик") Тогда
		Если УчетнаяПолитика <> Ложь 
			И ЗначениеЗаполнено(УчетнаяПолитика) 
			И УчетнаяПолитика.Свойство("ПартионныйУчетНДСвРазрезеСерийИХарактеристик") Тогда
			СтруктураШапкиДокумента.Вставить("ПартионныйУчетНДСвРазрезеСерийИХарактеристик", УчетнаяПолитика.ПартионныйУчетНДСвРазрезеСерийИХарактеристик);
		Иначе
			СтруктураШапкиДокумента.Вставить("ПартионныйУчетНДСвРазрезеСерийИХарактеристик", Ложь);
		КонецЕсли;
	КонецЕсли;
	Если Не СтруктураШапкиДокумента.Свойство("БухгалтерскийУчетСпособОценкиМПЗ") Тогда
		Если УчетнаяПолитика <> Ложь 
			И ЗначениеЗаполнено(УчетнаяПолитика) 
			И УчетнаяПолитика.Свойство("БухгалтерскийУчетСпособОценкиМПЗ") Тогда
			СтруктураШапкиДокумента.Вставить("БухгалтерскийУчетСпособОценкиМПЗ", УчетнаяПолитика.ПартионныйУчетНДСвРазрезеСерийИХарактеристик);
		Иначе
			СтруктураШапкиДокумента.Вставить("БухгалтерскийУчетСпособОценкиМПЗ", Перечисления.СпособыОценки.ПоСредней);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// ОБОЛОЧКИ ДЛЯ ВЫЗОВА СООТВЕТСТВУЮЩИХ ПРОЦЕДУР И ФУНКЦИЙ ИЗ МОДУЛЯ УЧЕТ НДС
////////////////////////////////////////////////////////////////////////////////

// Рассчитываем сумму документа со всеми налогами
//
// Параметры: 
//  ДокументОбъект    - объект документа, сумму которого надо рассчитать
//  ИмяТабличнойЧасти - строка, имя табличной части, сумму которой надо рассчитать.
//                      Если она не заполнена, считаем по всем табличным частям, в которых есть "Сумма"
//  НеУчитыватьТару   - булево, если Истина и ИмяТабличнойЧасти неопределено, то в расчете сумм тару не учитываем
//
// Возвращаемое значение:
//  Сумма документа со всеми налогами.
//
Функция ПолучитьСуммуДокументаСНДС(ДокументОбъект, ИмяТабличнойЧасти = Неопределено, НеУчитыватьТару = Истина) Экспорт

	МетаданныеДокумента = ДокументОбъект.Метаданные();

	СуммаДокумента = 0;
	Если ИмяТабличнойЧасти <> Неопределено Тогда
		СуммаДокумента = СуммаДокумента + ДокументОбъект[ИмяТабличнойЧасти].Итог("Сумма");
		Если МетаданныеДокумента.Реквизиты.Найти("УчитыватьНДС") <> Неопределено 
			И МетаданныеДокумента.Реквизиты.Найти("СуммаВключаетНДС") <> Неопределено
			И МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧасти].Реквизиты.Найти("СуммаНДС") <> Неопределено
		  	И ДокументОбъект.УчитыватьНДС
		   	И Не ДокументОбъект.СуммаВключаетНДС Тогда
			СуммаДокумента = СуммаДокумента + ДокументОбъект[ИмяТабличнойЧасти].Итог("СуммаНДС");
		КонецЕсли; 
	Иначе
		Для Каждого ТЧОбъекта Из ДокументОбъект.Метаданные().ТабличныеЧасти Цикл
			Если НеУчитыватьТару и ТЧОбъекта.Имя = "ВозвратнаяТара" Тогда
				Продолжить;
			КонецЕсли;
			Если ТЧОбъекта.Имя = "ВыданныеАвансы" Тогда
				Продолжить;
			КонецЕсли;
			Если ТЧОбъекта.Имя = "ДенежныеСредства" Тогда
				Продолжить;
			КонецЕсли;
			Если ТЧОбъекта.Имя = "ОплатаПлатежнымиКартами" Тогда
				Продолжить;
			КонецЕсли;
			Если ТЧОбъекта.Имя = "ОплатаБанковскимиКредитами" Тогда
				Продолжить;
			КонецЕсли;
			Если ТЧОбъекта.Имя = "ПродажиПоДисконтнымКартам" Тогда
				Продолжить;
			КонецЕсли;
			Если МетаданныеДокумента.ТабличныеЧасти[ТЧОбъекта.Имя].Реквизиты.Найти("Сумма") <> Неопределено Тогда
				СуммаДокумента = СуммаДокумента + ДокументОбъект[ТЧОбъекта.Имя].Итог("Сумма");
				Если МетаданныеДокумента.Реквизиты.Найти("УчитыватьНДС") <> Неопределено
				   И МетаданныеДокумента.Реквизиты.Найти("СуммаВключаетНДС") <> Неопределено
				   И МетаданныеДокумента.ТабличныеЧасти[ТЧОбъекта.Имя].Реквизиты.Найти("СуммаНДС") <> Неопределено
				   И ДокументОбъект.УчитыватьНДС
				   И Не ДокументОбъект.СуммаВключаетНДС Тогда
					СуммаДокумента = СуммаДокумента + ДокументОбъект[ТЧОбъекта.Имя].Итог("СуммаНДС");
				КонецЕсли; 
			КонецЕсли;
		КонецЦикла;
		Если МетаданныеДокумента.Реквизиты.Найти("Сумма") <> Неопределено Тогда
			СуммаДокумента = СуммаДокумента + ДокументОбъект.Сумма;
			Если МетаданныеДокумента.Реквизиты.Найти("УчитыватьНДС") <> Неопределено
			   И МетаданныеДокумента.Реквизиты.Найти("СуммаВключаетНДС") <> Неопределено
			   И МетаданныеДокумента.Реквизиты.Найти("СуммаНДС") <> Неопределено
			   И ДокументОбъект.УчитыватьНДС
			   И Не ДокументОбъект.СуммаВключаетНДС Тогда
				СуммаДокумента = СуммаДокумента + ДокументОбъект.СуммаНДС;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	Возврат СуммаДокумента;

КонецФункции // ПолучитьСуммуДокументаСНДС()

// Рассчитываем сумму НДС документа
//
// Параметры: 
//  ДокументОбъект    - объект документа, сумму которого надо рассчитать
//  ИмяТабличнойЧасти - строка, имя табличной части, сумму которой надо рассчитать.
//                      Если она не заполнена, считаем по всем табличным частям, в которых есть "Сумма"
//
// Возвращаемое значение:
//  НДС документа
//
Функция ПолучитьНДСДокумента(ДокументОбъект, ИмяТабличнойЧасти = Неопределено) Экспорт

	МетаданныеДокумента = ДокументОбъект.Метаданные();

	СуммаНДС = 0;
	Если ИмяТабличнойЧасти <> Неопределено Тогда
		СуммаНДС = СуммаНДС + ДокументОбъект[ИмяТабличнойЧасти].Итог("СуммаНДС");
	Иначе
		Для каждого ТЧОбъекта Из ДокументОбъект.Метаданные().ТабличныеЧасти Цикл
			Если МетаданныеДокумента.ТабличныеЧасти[ТЧОбъекта.Имя].Реквизиты.Найти("СуммаНДС") <> Неопределено Тогда
				СуммаНДС = СуммаНДС + ДокументОбъект[ТЧОбъекта.Имя].Итог("СуммаНДС");
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;

	Возврат СуммаНДС;

КонецФункции // ПолучитьСуммуДокументаСНДС()

// Рассчитывает сумму НДС исходя из суммы и флагов налогообложения
//
// Параметры: 
//  Сумма            - число, сумма от которой надо рассчитывать налоги, 
//  УчитыватьНДС     - булево, признак учета НДС в сумме, 
//  СуммаВключаетНДС - булево, признак включения НДС в сумму ("внутри" или "сверху"),
//  СтавкаНДС        - число , процентная ставка НДС,
//
// Возвращаемое значение:
//  Число, полученная сумма НДС
//
Функция РассчитатьСуммуНДС(Сумма, УчитыватьНДС, СуммаВключаетНДС, СтавкаНДС) Экспорт

	Если (УчитыватьНДС) И (СуммаВключаетНДС) Тогда
		СуммаБезНДС = 100 * Сумма / (100 + СтавкаНДС);
		СуммаНДС = Сумма - СуммаБезНДС;
	Иначе
		СуммаБезНДС = Сумма;
	КонецЕсли;

	Если УчитыватьНДС Тогда 
		Если НЕ СуммаВключаетНДС Тогда
			СуммаНДС = СуммаБезНДС * СтавкаНДС / 100;
		КонецЕсли;
	Иначе
		СуммаНДС = 0;
	КонецЕсли;

	Возврат СуммаНДС;

КонецФункции // РассчитатьСуммуНДС()
// Функция возвращает курс ставку НДС
//
// Параметры:
//  Валюта - СправочникСсылка.Валюты, валюта, по которой необходимо получить курс
//  ДатаКурса - Дата, календарная дата, на которую необходимо получить курс валюты
//
// Возвращаемое значение:
//	Курс переданной валюты на переданную дату, 1 в случае отсутствия значения.
//
Функция ПолучитьСтавкуНДС(СтавкаНДС) Экспорт

	Если СтавкаНДС = Перечисления.СтавкиНДС.НДС20 ИЛИ СтавкаНДС = Перечисления.СтавкиНДС.НДС20_120 Тогда
		Возврат 20;

	ИначеЕсли СтавкаНДС = Перечисления.СтавкиНДС.НДС10 ИЛИ СтавкаНДС = Перечисления.СтавкиНДС.НДС10_110 Тогда
		Возврат 10;

	ИначеЕсли СтавкаНДС = Перечисления.СтавкиНДС.НДС18 ИЛИ СтавкаНДС = Перечисления.СтавкиНДС.НДС18_118 Тогда
		Возврат 18;

	КонецЕсли;

	Возврат 0;

КонецФункции // ПолучитьСтавкуНДС()

Процедура СформироватьДвиженияПоНДС(СтруктураПараметров, ТаблицаСписания, МассивНоменклатуры, Организация = Неопределено)
	
	Отказ = Ложь;
	
	СтруктураШапкиДокумента = ПолучитьСтруктуруШапкиДокументаПоСсылке(СтруктураПараметров.Регистратор);
		
	Если Не СтруктураШапкиДокумента.УчитыватьНДС тогда
		Возврат;
	КонецЕсли;
	
	Если Организация <> Неопределено тогда
		СтруктураШапкиДокумента.Вставить("Организация",Организация);
	КонецЕсли;
	
	Если ТипЗнч(СтруктураПараметров.Регистратор)= Тип("ДокументСсылка.РасходныйОрдерНаТовары") тогда
		
		ТаблицаСписания = УправлениеЗапасамиПартионныйУчет.ПолучитьТаблицуСтрокДокументов(СтруктураШапкиДокумента.Ссылка);
		УправлениеЗапасамиПартионныйУчет.ПодготовитьТаблицуСписания(СтруктураПараметров, ТаблицаСписания, Ложь, Истина, Истина);
		
	ИначеЕсли ТипЗнч(СтруктураПараметров.Регистратор)= Тип("ДокументСсылка.ПриходныйОрдерНаТовары") тогда
		
		ТаблицаСписания = УправлениеЗапасамиПартионныйУчет.ПолучитьТаблицуСписанияРасходнымОрдером(ТаблицаСписания[0], СтруктураПараметров);
		
		Если ТаблицаСписания = Неопределено Тогда
			Возврат;
		КонецЕсли; 
		
	КонецЕсли;

	СтруктураПолейУчетнойПолитикиНУ = Новый Структура("СложныйУчетНДС,НачислятьНДСПоОтгрузке");
	ОбщегоНазначения.ДополнитьПоложениямиУчетнойПолитики(СтруктураШапкиДокумента, СтруктураШапкиДокумента.Дата, Отказ, СтруктураШапкиДокумента.Организация, "Нал", СтруктураПолейУчетнойПолитикиНУ);
	
	// Если не указаны параметры учетной политики - движения по НДС не выполняем
	Если Отказ тогда
		Возврат;
	КонецЕсли;
		
	//Если сложный учет НДС не ведется - затрем параметры сложного учета ндс
	Если НЕ СтруктураШапкиДокумента.СложныйУчетНДС тогда 
		СтруктураШапкиДокумента.Вставить("НДСвСтоимостиТоваров",Перечисления.ДействиеНДСВСтоимостиТоваров.НеИзменять);
	КонецЕсли;
	
	ЭтоВозврат = СтруктураШапкиДокумента.ВидДокумента = "ВозвратТоваровПоставщику" 
				   или СтруктураШапкиДокумента.ВидДокумента = "ВозвратТоваровПоставщикуИзНТТ";
				   
	ЭтоВозвратОтПокупателя = СтруктураШапкиДокумента.ВидДокумента = "ВозвратТоваровОтПокупателя";
	
	Если глЗначениеПеременной("ИспользоватьРасширеннуюАналитикуУчетаНоменклатурыИЗатрат") 
	  И (глЗначениеПеременной("ДатаНачалаИспользованияРасширеннойАналитикиУчетаНоменклатурыИЗатрат") <= СтруктураПараметров.Период) Тогда
		ТаблицаПартий = ПолучитьТаблицуПартийПоДокументу(СтруктураПараметров, ТаблицаСписания);
	Иначе
		ТаблицаПартий = ПолучитьТаблицуПартийДляСписанияНДС(СтруктураПараметров);
	КонецЕсли;	
	
	Если ТаблицаПартий.Количество()= 0 тогда
		Возврат;
	КонецЕсли;
	
	Заголовок = ОбщегоНазначения.ПредставлениеДокументаПриПроведении(СтруктураШапкиДокумента.Ссылка);
	
	// Если вызов из партионного учета и проводиться не Закрытие заказов покупателя
	Если СтруктураПараметров.Свойство("ТаблицаСписанныхПартий") И Организация = Неопределено Тогда
		
		Если ЭтоВозврат тогда
			ДвиженияВозвратаТоваровПоставщикуПоРегистрамПодсистемыНДС(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаПартий, ТаблицаСписания, Отказ, Заголовок);
			Возврат;
		КонецЕсли;
		
		Если ТипЗнч(СтруктураПараметров.Регистратор)= Тип("ДокументСсылка.РасходныйОрдерНаТовары") тогда
			//При списании по ордеру таблица списанных партий не наследует суммовые реквизиты реализаци, необходимые для начисления НДС
			//В начале текущей процедуры недостающие данные были загружены в ТаблицаСписания
			РаспределеннаяТаблицаСписания = РаспределитьПартииПоТаблицеСписания(ТаблицаПартий, ТаблицаСписания, СтруктураШапкиДокумента, СтруктураПараметров);
		Иначе
			РаспределеннаяТаблицаСписания = ПреобразоватьТаблицуСписанныхПартийДляНДС(СтруктураПараметров);
		КонецЕсли;
		
		Если ЭтоВозвратОтПокупателя тогда
		    УчетНДСФормированиеДвижений.ДвиженияВозвратаТоваровОтПокупателяПоРегистрамПодсистемыНДС(СтруктураШапкиДокумента, СтруктураПараметров, РаспределеннаяТаблицаСписания, Отказ, Заголовок);
			Возврат;
		КонецЕсли;	
	Иначе	
	
		// Особые случаи списания партий НДС
		Если ЭтоВозврат тогда
		
			ДвиженияВозвратаТоваровПоставщикуПоРегистрамПодсистемыНДС(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаПартий, ТаблицаСписания, Отказ, Заголовок);
			Возврат;
		ИначеЕсли ЭтоВозвратОтПокупателя тогда
			
			ЗапросРасходныхОрдеров = Новый Запрос;
			ЗапросРасходныхОрдеров.Текст = 
			"ВЫБРАТЬ Подзапрос.Регистратор 		КАК Регистратор,
			|Подзапрос.РасходныйОрдерНаТовары 	КАК РасходныйОрдерНаТовары
			|ИЗ(
			|	ВЫБРАТЬ 
			|   	ПартииТоваровНаСкладах.ДокументДвижения КАК Регистратор,
			|		ВЫБОР
			|			КОГДА ПартииТоваровНаСкладах.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
			|				ТОГДА ПартииТоваровНаСкладах.Регистратор
			|			ИНАЧЕ НЕОПРЕДЕЛЕНО
			|		КОНЕЦ КАК РасходныйОрдерНаТовары
			|   ИЗ
			|     РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК ПартииТоваровНаСкладах
			|   ГДЕ 
			|	ПартииТоваровНаСкладах.ВидДвижения = &ВидДвиженияРасход
			|	И ПартииТоваровНаСкладах.КодОперации В(&КодыСписание)
            |   И ПартииТоваровНаСкладах.ДокументДвижения В (&МассивРегистраторов)
			|   И ПартииТоваровНаСкладах.Период < &Период
			|	ОБЪЕДИНИТЬ ВСЕ
			|	ВЫБРАТЬ
			|		ПартииТоваровНаСкладах.Регистратор КАК Регистратор,
			|		ВЫБОР
			|			КОГДА ПартииТоваровНаСкладах.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
			|				ТОГДА ПартииТоваровНаСкладах.Регистратор
			|			ИНАЧЕ НЕОПРЕДЕЛЕНО
			|		КОНЕЦ КАК РасходныйОрдерНаТовары
            |   ИЗ
			|     РегистрНакопления.ПартииТоваровНаСкладахБухгалтерскийУчет КАК ПартииТоваровНаСкладах
			|   ГДЕ 
			|	ПартииТоваровНаСкладах.ВидДвижения = &ВидДвиженияРасход
			|	И ПартииТоваровНаСкладах.КодОперации В(&КодыСписание)
            |   И ПартииТоваровНаСкладах.Регистратор В (&МассивРегистраторов)
			|   И ПартииТоваровНаСкладах.Период < &Период
			|) КАК Подзапрос
			|СГРУППИРОВАТЬ ПО
			|Подзапрос.Регистратор,
			|Подзапрос.РасходныйОрдерНаТовары
			|ИТОГИ ПО Регистратор";
			
			МассивРеализация = Новый Массив;
			КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
			МассивРеализация.Добавить(КодыОпераций.ПередачаТарыКонтрагенту);
			МассивРеализация.Добавить(КодыОпераций.Реализация);
			МассивРеализация.Добавить(КодыОпераций.РеализацияКомиссия);
			МассивРеализация.Добавить(КодыОпераций.РеализацияРозница);
			
			ЗапросРасходныхОрдеров.УстановитьПараметр("КодыСписание",МассивРеализация);
			
			МассивРегистраторов = ТаблицаСписания.ВыгрузитьКолонку("ДокументПередачи");
			ЗапросРасходныхОрдеров.УстановитьПараметр("МассивРегистраторов",МассивРегистраторов);
			// Возврат не может быть раньше реализации
			ЗапросРасходныхОрдеров.УстановитьПараметр("Период",СтруктураПараметров.Период);
			ЗапросРасходныхОрдеров.УстановитьПараметр("ВидДвиженияРасход",ВидДвиженияНакопления.Расход);
			
			ДеревоРасходныхОрдеров = ЗапросРасходныхОрдеров.Выполнить().Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам);
			СтруктураПараметров.Вставить("ДеревоРасходныхОрдеров",ДеревоРасходныхОрдеров);
			
			РаспределеннаяТаблицаСписания = РаспределитьПартииПоТаблицеСписания(ТаблицаПартий, ТаблицаСписания, СтруктураШапкиДокумента, СтруктураПараметров);
			УчетНДСФормированиеДвижений.ДвиженияВозвратаТоваровОтПокупателяПоРегистрамПодсистемыНДС(СтруктураШапкиДокумента, СтруктураПараметров, РаспределеннаяТаблицаСписания, Отказ, Заголовок);
			Возврат;
		// Закрытие заказов покупателя
		ИначеЕсли Организация <> Неопределено тогда
			МассивСчетов = ТаблицаПартий.ВыгрузитьКолонку(ТаблицаПартий.Колонки.СчетУчета);
			ТаблицаПартий.Колонки.Добавить("СчетУчетаБУ");
			ТаблицаПартий.ЗагрузитьКолонку(МассивСчетов,ТаблицаПартий.Колонки.СчетУчетаБУ);
			
			ТаблицаПартий.Колонки.Добавить("Партия");
			МассивПартий = ТаблицаПартий.ВыгрузитьКолонку(ТаблицаПартий.Колонки.ДокументОприходования);
			ТаблицаПартий.ЗагрузитьКолонку(МассивПартий,ТаблицаПартий.Колонки.Партия);
			
			ТаблицаПартий.Колонки.Добавить("ЗаказПартии");
			МассивЗаказов = ТаблицаПартий.ВыгрузитьКолонку(ТаблицаПартий.Колонки.Заказ);
			ТаблицаПартий.ЗагрузитьКолонку(МассивЗаказов,ТаблицаПартий.Колонки.ЗаказПартии);
			
			ТаблицаПартий.Колонки.Добавить("ОбособленныйУчетТоваровПоЗаказамПокупателей");
			Для Каждого ТекСтрокаПартии Из ТаблицаПартий Цикл
				Если (ЗначениеЗаполнено(ТекСтрокаПартии.ЗаказПартии)) И (ТипЗНЧ(ТекСтрокаПартии.ЗаказПартии) = Тип("ДокументСсылка.ЗаказПокупателя")) Тогда 
					ТекСтрокаПартии.ОбособленныйУчетТоваровПоЗаказамПокупателей = ТекСтрокаПартии.ЗаказПартии.ДоговорКонтрагента.ОбособленныйУчетТоваровПоЗаказамПокупателей;
				КонецЕсли;
			КонецЦикла;	
			
			ТаблицаПартий.Колонки.КодОперации.Имя = "КодОперацииПартииТоваров";
			ТаблицаНДСПартииСписания = ОпределитьПартииСписанияПоРегиструНДСПартии(СтруктураШапкиДокумента, ТаблицаПартий,Отказ, Заголовок, ЭтоВозврат, ЭтоВозвратОтПокупателя,СтруктураПараметров);
			СнятиеРезерваНДСПартииПоЗаказамПокупателя(ТаблицаНДСПартииСписания, СтруктураПараметров);
			Возврат;
		КонецЕсли;
		РаспределеннаяТаблицаСписания = РаспределитьПартииПоТаблицеСписания(ТаблицаПартий, ТаблицаСписания, СтруктураШапкиДокумента, СтруктураПараметров);
	КонецЕсли; 
	
	Для каждого СтрокаРаспределеннойТаблицы из РаспределеннаяТаблицаСписания Цикл
		ОтражатьНДСКомитента = СтруктураШапкиДокумента.Дата >= '20060101000000' И (СтрокаРаспределеннойТаблицы.Комиссионный 
							   И СтрокаРаспределеннойТаблицы.УчетАгентскогоНДС);
		Если ОтражатьНДСКомитента Тогда 
			СтрокаРаспределеннойТаблицы.ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентКомитент;
		КонецЕсли;
	КонецЦикла;
	
	ВыполнитьДвиженияНДСНалоговогоАгентаКомиссионер(СтруктураШапкиДокумента, РаспределеннаяТаблицаСписания, СтруктураПараметров);
	
	ВыполнитьДвиженияПоРегиструНДСНачисленныйОтражениеРеализации(СтруктураШапкиДокумента, РаспределеннаяТаблицаСписания, СтруктураПараметров, Отказ);
	
	СчетаУчетаОС = ОпределитьСчетаУчетаОСиНМА("ОС");
	УчетНДСПоОСиНМА = Ложь;
	Для Каждого СчетУчетаОС Из СчетаУчетаОС Цикл
		Если РаспределеннаяТаблицаСписания.Найти(СчетУчетаОС.Значение, "СчетУчетаБУ") <> Неопределено Тогда
			УчетНДСПоОСиНМА = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если СтруктураШапкиДокумента.СложныйУчетНДС
		Или УчетНДСПоОСиНМА Тогда
		
		// Получим таблицу НДС партий
		ТаблицаНДСПартииСписания = ОпределитьПартииСписанияПоРегиструНДСПартии(СтруктураШапкиДокумента, РаспределеннаяТаблицаСписания,Отказ, Заголовок, ЭтоВозврат, ЭтоВозвратОтПокупателя, СтруктураПараметров);
		
		Если ТаблицаНДСПартииСписания.Количество() = 0 Тогда
			//Партии не найдены или отражение в партионном учете НДС не производится.
			//Дальнейшая обработка не требуется
			Возврат;
		КонецЕсли;
		
		ВыполнитьДвиженияСписанияНДС(СтруктураШапкиДокумента, ТаблицаНДСПартииСписания, СтруктураПараметров, Заголовок);
		
		МассивОрганизаций = ТаблицаНДСПартииСписания.ВыгрузитьКолонку("Организация");
		
		МассивОрганизаций = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(МассивОрганизаций,Истина,Истина);
		
		МассивПартий = ТаблицаНДСПартииСписания.ВыгрузитьКолонку("Партия");
		МассивПартий = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(МассивПартий);
		
		СтруктураПараметров.Вставить("НоменклатурныеГруппыДляРеализацииБезНДСиНДС0", ПолучитьНоменклатурныеГруппыДляРеализацииБезНДСиНДС0(СтруктураПараметров.Период, МассивОрганизаций, СтруктураПараметров));
		
		ВыполнитьДвиженияНДСНезавершенноеПроизводство(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ);
		
		ВыполнитьДвиженияПоОтражениюПредположенияСтавки0(СтруктураШапкиДокумента, ТаблицаНДСПартииСписания, СтруктураПараметров, Заголовок);
		
		ВыполнитьДвиженияПоступленияПоРегиструНДСПартииТоваров(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ);

		ВыполнитьДвиженияПоступленияПоРегиструНДСПартииТоваровКомплектацияВыпуск(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ);
		
		ВыполнитьДвиженияПоРегиструНДСпоОСиНМА_ПеремещениеОборудования(СтруктураШапкиДокумента, СтруктураПараметров, Отказ);
		
		ВыполнитьДвиженияПоРегиструНДСпоОСиНМА_СписаниеМатериаловНаОСиНМА(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ);

		ВыполнитьДвиженияПоРегиструНДСКосвенныеРасходы_СписаниеМатериаловНаКосвенныеРасходы(СтруктураШапкиДокумента, ТаблицаНДСПартииСписания, СтруктураПараметров, Отказ);	
		
		ВыполнитьДвиженияПоРегистрамНДССписаниеРасходовпоВНА(СтруктураШапкиДокумента, ТаблицаНДСПартииСписания, СтруктураПараметров, Отказ);
		
	КонецЕсли;
		
КонецПроцедуры//СформироватьДвиженияПоНДС

// Процедура - вход для движений по НДС
// Параметры 
// СтруктураПараметров - структура, хранящая основные параметры модуля УправлениеЗапасамиПартионныйУчет 
// ТаблицаСписания - 	 таблица значений содержащая информацию о том что и в каком количестве нужно списывать,
// 						 обычно получается из регистра "СписанныеТовары"
Процедура ВыполнитьДвиженияПоНДС(СтруктураПараметров, ТаблицаСписания) Экспорт
	
	МассивНоменклатуры = ТаблицаСписания.ВыгрузитьКолонку("Номенклатура");
	
	МассивНоменклатуры = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(МассивНоменклатуры);
	
	Если ТипЗнч(СтруктураПараметров.Регистратор)= Тип("ДокументСсылка.ЗакрытиеЗаказовПокупателей") тогда
		МассивОрганизаций = ТаблицаСписания.ВыгрузитьКолонку(ТаблицаСписания.Колонки.Организация);
		МассивОрганизаций = ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(МассивОрганизаций,Истина,Истина);
		Для каждого Организация из МассивОрганизаций цикл
			СформироватьДвиженияПоНДС(СтруктураПараметров, ТаблицаСписания, МассивНоменклатуры, Организация);
		КонецЦикла;
	Иначе
		СформироватьДвиженияПоНДС(СтруктураПараметров, ТаблицаСписания, МассивНоменклатуры);
	КонецЕсли;
	
КонецПроцедуры//ВыполнитьДвиженияПоНДС

Процедура ЗагрузитьВТаблицуЗначенийСписанныеПартии(СтруктураПараметров, ИмяНабораДвижений, ИмяТаблицыПриемника)
	Перем НаборДвижений;
	
	Если НЕ СтруктураПараметров.Свойство(ИмяНабораДвижений, НаборДвижений) Тогда
		Возврат;
	КонецЕсли;
	
	НаборДвижений.Прочитать();
	ТаблицаДвижений = НаборДвижений.Выгрузить();
	
	// Заполним значения в совпадающих колонках.
	Для Каждого СтрокаТаблицыИсточника Из ТаблицаДвижений Цикл
		Если СтрокаТаблицыИсточника.СписаниеПартий Тогда
			СтрокаТаблицыПриемника = СтруктураПараметров[ИмяТаблицыПриемника].Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицыПриемника, СтрокаТаблицыИсточника);
        КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры // ЗагрузитьВТаблицуЗначенийСписанныеПартии()

// Добавляет в таблицу списанных товаров, данные по комиссии
//
// Параметры:
//  ОтчетКомиссионера       - документ-ссылка Отчет комиссионера о продажах.
//  ТаблицаСписанныхТоваров - выходная таблица значений, куда добавляются строки.
//
Процедура ДополнитьСписанныеТоварыДаннымиПоКомиссии(ОтчетКомиссионера, ТаблицаСписанныхТоваров) Экспорт
	
	Если ТипЗнч(ОтчетКомиссионера) <> Тип("ДокументСсылка.ОтчетКомиссионераОПродажах")
		ИЛИ ТипЗнч(ТаблицаСписанныхТоваров) <> Тип("ТаблицаЗначений")
		ИЛИ ТаблицаСписанныхТоваров.Колонки.Найти("ВыставленСФ") <> Неопределено
		ИЛИ ТаблицаСписанныхТоваров.Колонки.Найти("НомерСтроки") = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекстСписанныеТовары = "";
	Для каждого Колонка Из ТаблицаСписанныхТоваров.Колонки Цикл
		Если Колонка.Имя = "МоментВремени" Тогда
			Продолжить;
		КонецЕсли;
		
		ТекстСписанныеТовары = ТекстСписанныеТовары + ",
		|	СписанныеТовары." + Колонка.Имя + " КАК " + Колонка.Имя;
	КонецЦикла;
	
	ТаблицаСписанныхТоваров.Колонки.Добавить("СчетФактура", Новый ОписаниеТипов("ДокументСсылка.СчетФактураВыданный"));
	ТаблицаСписанныхТоваров.Колонки.Добавить("Покупатель",  Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	ТаблицаСписанныхТоваров.Колонки.Добавить("ДатаСФ",      Новый ОписаниеТипов("Дата"));
	ТаблицаСписанныхТоваров.Колонки.Добавить("ВыставленСФ", Новый ОписаниеТипов("Булево"));
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ" + Сред(ТекстСписанныеТовары, 2) + "
	|ПОМЕСТИТЬ ВТ_СписанныеТовары
	|ИЗ
	|	&ТаблицаСписанныхТоваров КАК СписанныеТовары
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажахТовары.КлючСтроки КАК КлючСтроки" + ТекстСписанныеТовары + "
	|ПОМЕСТИТЬ ВТ_КлючСтроки
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах.Товары КАК ОтчетКомиссионераОПродажахТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_СписанныеТовары КАК СписанныеТовары
	|		ПО ОтчетКомиссионераОПродажахТовары.НомерСтроки = СписанныеТовары.НомерСтроки
	|ГДЕ
	|	ОтчетКомиссионераОПродажахТовары.Ссылка = &Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	КлючСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажахПокупатели.Покупатель КАК Покупатель,
	|	ОтчетКомиссионераОПродажахПокупатели.ДатаСФ КАК ДатаСФ,
	|	ОтчетКомиссионераОПродажахПокупатели.ВыставленСФ КАК ВыставленСФ,
	|	ОтчетКомиссионераОПродажахПокупатели.СчетФактура КАК СчетФактура" + СтрЗаменить(ТекстСписанныеТовары, "СписанныеТовары.", "ВТ_КлючСтроки.") + "
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах.Покупатели КАК ОтчетКомиссионераОПродажахПокупатели
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_КлючСтроки КАК ВТ_КлючСтроки
	|		ПО ОтчетКомиссионераОПродажахПокупатели.КлючСтроки = ВТ_КлючСтроки.КлючСтроки
	|ГДЕ
	|	ОтчетКомиссионераОПродажахПокупатели.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка",                  ОтчетКомиссионера);
	Запрос.УстановитьПараметр("ТаблицаСписанныхТоваров", ТаблицаСписанныхТоваров);
	Выборка = Запрос.Выполнить().Выбрать();
	
	ТаблицаСписанныхТоваров.Очистить();
	Пока Выборка.Следующий() Цикл
		СтрокаТаблицы = ТаблицаСписанныхТоваров.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаТаблицы, Выборка);
	КонецЦикла;
	
КонецПроцедуры

Процедура ВыполнитьДвиженияПоРегиструНДСКосвенныеРасходы_СписаниеМатериаловНаКосвенныеРасходы(СтруктураШапкиДокумента, ТаблицаНДСПартииСписания, СтруктураПараметров, Отказ);	
	
	/////////////////////////////////////////////////////////////////////////////////
	// НДС по переданным ТМЦ на объект строительства или НМА - движения по регистру НДСпоОСиНМА для
	// последующего учета НДС.
	// НДС по переданным ТМЦ на объект строительства
	
	ДанныеДляОбработки = ТаблицаНДСПартииСписания.СкопироватьКолонки();
	
	ИспользоватьРА = УправлениеЗапасами.ИспользуетсяРасширеннаяАналитикаУчета(СтруктураШапкиДокумента.Дата);
	
	Для Каждого Строка из ТаблицаНДСПартииСписания Цикл
		
		ХарактерЗатрат = УправлениеЗатратами.ПолучитьХарактерЗатратПоСчетуЗатрат(Строка.КорСчетБУ, Строка.СтатьяЗатрат);
		Если ХарактерЗатрат = Перечисления.ХарактерЗатрат.ОбщехозяйственныеРасходы 
		   Или ХарактерЗатрат = Перечисления.ХарактерЗатрат.ОбщепроизводственныеРасходы
		   Или ХарактерЗатрат = Перечисления.ХарактерЗатрат.КоммерческиеРасходы
		   Или ХарактерЗатрат = Перечисления.ХарактерЗатрат.ИздержкиОбращения
		   Или ХарактерЗатрат = Перечисления.ХарактерЗатрат.БракВПроизводстве
		   Или (ИспользоватьРА И ХарактерЗатрат = Перечисления.ХарактерЗатрат.ПроизводственныеРасходы)
		   Тогда
		   
				НоваяСтрока = ДанныеДляОбработки.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
		КонецЕсли;

	КонецЦикла;
	
	СформироватьДвиженияПоРегиструНДСКосвенныеРасходы_СписаниеМатериаловНаКосвенныеРасходы(СтруктураШапкиДокумента, ДанныеДляОбработки, СтруктураПараметров, Отказ);

КонецПроцедуры

// НДС по партиям - отразить поступление на склад-получатель
//
Процедура ВыполнитьДвиженияПоступленияПоРегиструНДСПартииТоваров(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ)
	
	Если ТаблицаНДСПартииСписания.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Строка = "ВозвратОтКомиссионера, ВозвратОтПереработчика, ВозвратОтПокупателя, ВыпускПоОперацииСтоимость, ВыпускПродукцииФиксНаСклад,
			 |Комплектация, КорректировкаСерийИХарактеристик, ПередачаВПереработку, ПередачаНаКомиссию, ПеремещениеМеждуСкладами,
			 |РезервированиеПодЗаказ, СнятиеРезерваПодЗаказ, ВключениеАктиваВСоставМПЗ";
	ДанныеДляОбработки = ОтобратьСтрокиПартийПоКодамОпераций(Строка, ТаблицаНДСПартииСписания, СтруктураПараметров);
	
	ВыполнятьПоступление = Ложь;

	Если СтруктураШапкиДокумента.ВидДокумента = "РеализацияТоваровУслуг" тогда
		Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером 
			И СтруктураШапкиДокумента.СложныйУчетНДС
			Тогда
			ВыполнятьПоступление = Истина;
		КонецЕсли;
	Иначе
		ВыполнятьПоступление = Истина;
	КонецЕсли;
	
	Если ВыполнятьПоступление тогда
		ТаблицаДвиженийПартии = СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.СкопироватьКолонки();
		
		КолНДСПартииТоваров = СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.Количество();
		
		Если ДанныеДляОбработки.Колонки.Найти("ЗаказСписания") <> Неопределено Тогда
			ДанныеДляОбработки.Колонки.ЗаказСписания.Имя = "ЗаказПокупателя";
		КонецЕсли;
		
		ЕстьХарактеристикаНоменклатурыНовая = ДанныеДляОбработки.Колонки.Найти("ХарактеристикаНоменклатурыНовая") <> Неопределено;
		ЕстьСерияНоменклатурыНовая = ДанныеДляОбработки.Колонки.Найти("СерияНоменклатурыНовая") <> Неопределено;
		ЕстьНоменклатураНовая = ДанныеДляОбработки.Колонки.Найти("НоменклатураНовая") <> Неопределено;
		ЕстьДокументОприходованияНовый = ДанныеДляОбработки.Колонки.Найти("ДокументОприходованияНовый") <> Неопределено;
		ЕстьЗаказПокупателя = ДанныеДляОбработки.Колонки.Найти("ЗаказПокупателя") <> Неопределено;
		
		Для Каждого СтрокаТаблицы ИЗ ДанныеДляОбработки Цикл
			// Для того, чтобы правильно отразить поступление партий НДС нужно изменить таблицу ТаблицаНДСПартииСписания
			Если ЗначениеЗаполнено(СтрокаТаблицы.СкладПолучатель) тогда
				СтрокаТаблицы.Склад = СтрокаТаблицы.СкладПолучатель;
			КонецЕсли;
			Если ЕстьХарактеристикаНоменклатурыНовая И (ЗначениеЗаполнено(СтрокаТаблицы.ХарактеристикаНоменклатурыНовая) 
				Или СтрокаТаблицы.ИзменитьХарактеристику) тогда
				СтрокаТаблицы.ХарактеристикаНоменклатуры = СтрокаТаблицы.ХарактеристикаНоменклатурыНовая;
			КонецЕсли;
			Если ЕстьСерияНоменклатурыНовая И (ЗначениеЗаполнено(СтрокаТаблицы.СерияНоменклатурыНовая) 
				или СтрокаТаблицы.ИзменитьСерию) тогда
				СтрокаТаблицы.СерияНоменклатуры = СтрокаТаблицы.СерияНоменклатурыНовая;
			КонецЕсли;
			Если ЕстьНоменклатураНовая И ЗначениеЗаполнено(СтрокаТаблицы.НоменклатураНовая) тогда
				СтрокаТаблицы.Номенклатура = СтрокаТаблицы.НоменклатураНовая;
			КонецЕсли;
			Если ЕстьДокументОприходованияНовый И ЗначениеЗаполнено(СтрокаТаблицы.ДокументОприходованияНовый) Тогда
				СтрокаТаблицы.Партия = СтрокаТаблицы.ДокументОприходованияНовый;
			КонецЕсли; 
			
			// Утановка признака ОбособленныйУчетТоваровПоЗаказамПокупателей для движений поступления при резервировании товаров
			Если СтруктураПараметров.Свойство("СоответствиеКодовОперацийСтрокамНДСПартий") 
				и (
				СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[Перечисления.КодыОперацийПартииТоваров.РезервированиеПодЗаказ] <> Неопределено 
				или СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[Перечисления.КодыОперацийПартииТоваров.Комплектация] <> Неопределено
				)
				Тогда
				СоответствиеЗаказов = Новый Соответствие();
				Если СтрокаТаблицы.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.РезервированиеПодЗаказ
					или СтрокаТаблицы.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.Комплектация
					тогда
					Если Не ЕстьЗаказПокупателя Или Не ЗначениеЗаполнено(СтрокаТаблицы.ЗаказПокупателя) Тогда
						//Это снятие резерва
						СтрокаТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = Ложь;
					Иначе	
						ОбособленныйУчетТоваровПоЗаказамПокупателей = СоответствиеЗаказов[СтрокаТаблицы.ЗаказПокупателя];
					
						Если ОбособленныйУчетТоваровПоЗаказамПокупателей = Неопределено Тогда
								
							СтруктураЗаказа = Новый Структура("ДоговорКонтрагента");
							УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтрокаТаблицы.ЗаказПокупателя, СтруктураЗаказа);
								
							СтруктураДоговора = Новый Структура("ОбособленныйУчетТоваровПоЗаказамПокупателей");
							УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтруктураЗаказа.ДоговорКонтрагента, СтруктураДоговора);
								
							СтрокаТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = СтруктураДоговора.ОбособленныйУчетТоваровПоЗаказамПокупателей;
								
						Иначе
							СтрокаТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = ОбособленныйУчетТоваровПоЗаказамПокупателей;
						КонецЕсли;
					КонецЕсли;	
				КонецЕсли; 
			КонецЕсли;
		КонецЦикла;
		
		// Добавим колонки для обработки заказа покупателя.
		Если ТаблицаДвиженийПартии.Колонки.Найти("ОбособленныйУчетТоваровПоЗаказамПокупателей")= Неопределено Тогда
			ТаблицаДвиженийПартии.Колонки.Добавить("ОбособленныйУчетТоваровПоЗаказамПокупателей");
			ТаблицаДвиженийПартии.ЗаполнитьЗначения(Ложь,"ОбособленныйУчетТоваровПоЗаказамПокупателей");
		КонецЕсли;
			
		Если ТаблицаДвиженийПартии.Колонки.Найти("ЗаказПокупателя")= Неопределено Тогда
			ТаблицаДвиженийПартии.Колонки.Добавить("ЗаказПокупателя");
			ТаблицаДвиженийПартии.ЗаполнитьЗначения(Неопределено,"ЗаказПокупателя");
		КонецЕсли;
		
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ДанныеДляОбработки, ТаблицаДвиженийПартии);
		
		ТаблицаДвиженийПартии.Колонки.Добавить("Услуга", Новый ОписаниеТипов("Булево"));
		Для К = 0 По ТаблицаДвиженийПартии.Количество() - 1 Цикл
			СтрокаТаблицы = ТаблицаДвиженийПартии[К];
			Если Не СтрокаТаблицы.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.РезервированиеПодЗаказ Тогда
				СтрокаТаблицы.СчетУчета = ДанныеДляОбработки[К].КорСчетСписанияБУ;
			КонецЕсли;
			СтрокаТаблицы.Услуга = Ложь;
		КонецЦикла;
		ТаблицаДвиженийПартии.Колонки.СчетУчета.Имя = "СчетУчетаЦенности";
		
		Если СтруктураШапкиДокумента.ВидДокумента = "ПринятиеКУчетуОС" тогда
			
			КолСтрок = ТаблицаДвиженийПартии.Количество();
			Для ОбратныйИндекс = 1 По КолСтрок Цикл 
				Строка = ТаблицаДвиженийПартии[КолСтрок - ОбратныйИндекс]; 
				Если Строка.Количество = 0 Тогда 
					ТаблицаДвиженийПартии.Удалить(Строка); 
				КонецЕсли;
			КонецЦикла;
			
			ТаблицаДвиженийПартии.ЗаполнитьЗначения(СтруктураПараметров.Регистратор,"Партия");
			ТаблицаДвиженийПартии.ЗаполнитьЗначения(0,"Стоимость");
			ТаблицаДвиженийПартии.ЗаполнитьЗначения(0,"НДС");
		КонецЕсли;
		
		УчетНДСФормированиеДвижений.СформироватьДвиженияПоступленияПоРегиструНДСПартииТоваров(СтруктураШапкиДокумента, ТаблицаДвиженийПартии, СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров, Отказ);

		// Устанавливаем флаги модификации
		СтруктураПараметров.ИзмененыДвиженияНДСПартииТоваров = СтруктураПараметров.ИзмененыДвиженияНДСПартииТоваров 
									ИЛИ (КолНДСПартииТоваров <> СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.Количество());
	КонецЕсли;
	
КонецПроцедуры//ВыполнитьДвиженияПоступленияПоРегиструНДСПартииТоваров

Процедура ВыполнитьДвиженияПоРегиструНДСНачисленныйОтражениеРеализации(СтруктураШапкиДокумента, РаспределеннаяТаблицаСписания, СтруктураПараметров, Отказ)
	
	СтрокаКодовОпераций = "Реализация, РеализацияКомиссия, РеализацияРозница";
	
	ДанныеДляОбработки = ОтобратьСтрокиПостроителемЗапроса(СтрокаКодовОпераций, РаспределеннаяТаблицаСписания);
	
	Если ДанныеДляОбработки = Неопределено тогда
		Возврат;
	КонецЕсли;
	
	Если СтруктураШапкиДокумента.УчитыватьНДС Тогда
				
		УчетНДСФормированиеДвижений.СформироватьДвиженияПоРегиструНДСНачисленный_ОтражениеРеализации(СтруктураШапкиДокумента, ДанныеДляОбработки, СтруктураПараметров, Отказ, СчетОтнесенияНДС(СтруктураШапкиДокумента));
 
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыполнитьДвиженияПоОтражениюПредположенияСтавки0(СтруктураШапкиДокумента, ТаблицаНДСПартииСписания, СтруктураПараметров, Заголовок)
	
	СтрокаКодовОпераций = "Реализация, РеализацияКомиссия, РеализацияРозница";
	
	Если СтруктураШапкиДокумента.ВидДокумента = "РеализацияТоваровУслуг" 
		И СтруктураШапкиДокумента.ВидОперации = Перечисления.ВидыОперацийРеализацияТоваров.ОтгрузкаБезПереходаПраваСобственности  Тогда
		
		СтрокаКодовОпераций = СтрокаКодовОпераций + ", ПередачаНаКомиссию";
	КонецЕсли;
	
	ДанныеДляОбработки = ОтобратьСтрокиПартийПоКодамОпераций(СтрокаКодовОпераций, ТаблицаНДСПартииСписания, СтруктураПараметров);
	
	Если Не ДанныеДляОбработки = Неопределено тогда
		КолНДСПредъявленныйРеализация0 = СтруктураПараметров.ТаблицаДвиженийНДСПредъявленныйРеализация0.Количество();
		КолНДСХозрасчетный  = СтруктураПараметров.ДвиженияХозрасчетный.Количество();
		
		ОтразитьПредположениеСтавки0(СтруктураШапкиДокумента, ДанныеДляОбработки, СтруктураПараметров, Заголовок);
		
		СтруктураПараметров.ИзмененыДвиженияНДСПредъявленныйРеализация0  = СтруктураПараметров.ИзмененыДвиженияНДСПредъявленныйРеализация0 
						ИЛИ (КолНДСПредъявленныйРеализация0 <> СтруктураПараметров.ТаблицаДвиженийНДСПредъявленныйРеализация0.Количество());
		
		СтруктураПараметров.ИзмененыДвиженияХозрасчетный = СтруктураПараметров.ИзмененыДвиженияХозрасчетный
								ИЛИ (КолНДСХозрасчетный <> СтруктураПараметров.ДвиженияХозрасчетный.Количество());
		
	КонецЕсли;
	
КонецПроцедуры

// Выполняет списание НДС и включение в стоимость - исключение НДС из стоимости
//
Процедура ВыполнитьДвиженияСписанияНДС(СтруктураШапкиДокумента, ТаблицаНДСПартииСписания, СтруктураПараметров, Заголовок)
	
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	// НДС в стоимости товаров - отработка включения и исключения НДС из стоимости.
	// Включение НДС в стоимость может происходить только для строк с перечисленными ниже кодами операций
	СтрокаКодовОпераций = "Комплектация, ПередачаНаКомиссию, ПеремещениеМеждуСкладами, Реализация, ВключениеАктиваВСоставМПЗ,
						  |РеализацияРозница, РеализацияКомиссия, СписаниеНаБрак, СписаниеНаВложенияВоВнеоборотныеАктивы,
						  |СписаниеНаЗатраты, СписаниеНаСтроительствоОбъектовОС, СписаниеПартийВПроизводствоОперативно,
						  |СписаниеПартийПереданныхВПроизводство, СписаниеПоИнвентаризации";

	ДанныеДляОбработки = ОтобратьСтрокиПартийПоКодамОпераций(СтрокаКодовОпераций, ТаблицаНДСПартииСписания, СтруктураПараметров);
	
	КолНДСПартииТоваров = СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.Количество();
	КолНДСВключенныйВСтоимость = СтруктураПараметров.ТаблицаДвиженийНДСВключенныйВСтоимость.Количество();
	КолНДСПредъявленный = СтруктураПараметров.ТаблицаДвиженийНДСПредъявленный.Количество();
	КолНДСХозрасчетный  = СтруктураПараметров.ДвиженияХозрасчетный.Количество();
	
	Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете Тогда
		КолНДСНалоговый  = СтруктураПараметров.ДвиженияНалоговый.Количество();
	КонецЕсли;
	
	Если ДанныеДляОбработки.Количество() > 0 Тогда
			
		ТаблицаДвиженийПартии = СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров;
			
		// очистим предыдущие движения 
		Если НЕ СтруктураПараметров.Свойство("ТолькоДвиженияНДС") Тогда
			Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете Тогда
				ДвиженияРегистра = РегистрыБухгалтерии.Налоговый.СоздатьНаборЗаписей();
				ДвиженияРегистра.Очистить();
				ДвиженияРегистра.Отбор.Регистратор.Установить(СтруктураПараметров.Регистратор);
				ДвиженияРегистра.Прочитать();
				Инд=0;
				Пока Инд < ДвиженияРегистра.Количество() Цикл
					Если ДвиженияРегистра[Инд].СписаниеПартийНДС Тогда
						ДвиженияРегистра.Удалить(Инд);
					Иначе
						Инд=Инд+1;
					КонецЕсли;
				КонецЦикла;
				ДвиженияРегистра.Записать(Истина);
			КонецЕсли;
		КонецЕсли;
			
		// Включение НДС в стоимость
		УчетНДСФормированиеДвижений.ОтразитьВключениеИсключениеНДСВСтоимость(СтруктураШапкиДокумента, ДанныеДляОбработки, ТаблицаДвиженийПартии, Истина, СтруктураПараметров, Заголовок);
		// Исключение НДС из стоимости
		УчетНДСФормированиеДвижений.ОтразитьВключениеИсключениеНДСВСтоимость(СтруктураШапкиДокумента, ДанныеДляОбработки, ТаблицаДвиженийПартии, Ложь, СтруктураПараметров, Заголовок);
			
		Если ТаблицаДвиженийПартии.Количество() > 0 Тогда
			ТаблицаДвиженийПартии.ЗаполнитьЗначения(ВидДвиженияНакопления.Приход,"ВидДвижения");
		КонецЕсли;
			
	Иначе
		
		// партии у которых не произошло включение - исключение НДС из стоимости
		СтрокаКодовОпераций = "КорректировкаСерийИхарактеристик, РезервированиеПодЗаказ, СнятиеРезерваПодЗаказ,
							  |ВозвратОтКомиссионера, ВозвратОтПереработчика,
							  |ВыпускПоОперацииСтоимость, ВыпускПродукцииФиксНаСклад, ПередачаВПереработку,
							  |ПередачаМатериаловВЭксплуатацию, ПередачаОборудованияВМонтаж, ПринятиеКУчетуОС, ПринятиеКУчетуОССоСписаниемНаЗатраты";

		ДанныеДляОбработки = ОтобратьСтрокиПартийПоКодамОпераций(СтрокаКодовОпераций, ТаблицаНДСПартииСписания, СтруктураПараметров);
		
	КонецЕсли;
	
	ТаблицаНДСПартииСписания = ДанныеДляОбработки;
	
	СтруктураПараметров.Вставить("СоответствиеКодовОперацийСтрокамНДСПартий", Новый Соответствие);
	
	// НДС по партиям - отразить непосредственое списание.
	КолСтрокНДС = ТаблицаНДСПартииСписания.Количество();
	
	СтрокаПоступленияКомплектации = Неопределено;
	
	ЕстьХарактеристикаНоменклатурыНовая = ТаблицаНДСПартииСписания.Колонки.Найти("ХарактеристикаНоменклатурыНовая") <> Неопределено;
	ЕстьСерияНоменклатурыНовая 			= ТаблицаНДСПартииСписания.Колонки.Найти("СерияНоменклатурыНовая") <> Неопределено;
	ЕстьНоменклатураНовая 				= ТаблицаНДСПартииСписания.Колонки.Найти("НоменклатураНовая") <> Неопределено;
	ЕстьДокументОприходованияНовый 		= ДанныеДляОбработки.Колонки.Найти("ДокументОприходованияНовый") <> Неопределено;
		
	Для ИндексТекСтроки = 0 По КолСтрокНДС-1 Цикл
		
		СтрокаТаблицыНДСПартииСписания = ТаблицаНДСПартииСписания[ИндексТекСтроки];
		
		// Для ускорения поиска добавим строку в соответствие
		Если СтруктураПараметров.Свойство("СоответствиеКодовОперацийСтрокамНДСПартий") Тогда
			МассивСтрокПоКоду = СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[СтрокаТаблицыНДСПартииСписания.КодОперацииПартииТоваров];
			Если МассивСтрокПоКоду = Неопределено Тогда
				СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий.Вставить(СтрокаТаблицыНДСПартииСписания.КодОперацииПартииТоваров, Новый Массив);
				МассивСтрокПоКоду = СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[СтрокаТаблицыНДСПартииСписания.КодОперацииПартииТоваров];
			КонецЕсли;
			МассивСтрокПоКоду.Добавить(СтрокаТаблицыНДСПартииСписания);
		КонецЕсли;
		
		Движение = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПартииТоваров", СтруктураПараметров);
		ЗаполнитьЗначенияСвойств(Движение,СтрокаТаблицыНДСПартииСписания);
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		
		// Если это комплектация - поступление партий НДС выполняется особым способом
		Если СтрокаТаблицыНДСПартииСписания.КодОперацииПартииТоваров = КодыОпераций.Комплектация Тогда
			
			// Для того, чтобы правильно отразить поступление партий НДС нужно изменить таблицу ТаблицаНДСПартииСписания
			Если ЗначениеЗаполнено(СтрокаТаблицыНДСПартииСписания.СкладПолучатель) Тогда
				СтрокаТаблицыНДСПартииСписания.Склад = СтрокаТаблицыНДСПартииСписания.СкладПолучатель;
			КонецЕсли;
			Если ЕстьХарактеристикаНоменклатурыНовая И (ЗначениеЗаполнено(СтрокаТаблицыНДСПартииСписания.ХарактеристикаНоменклатурыНовая) 
				ИЛИ СтрокаТаблицыНДСПартииСписания.ИзменитьХарактеристику) Тогда
				СтрокаТаблицыНДСПартииСписания.ХарактеристикаНоменклатуры = СтрокаТаблицыНДСПартииСписания.ХарактеристикаНоменклатурыНовая;
			КонецЕсли;
			Если ЕстьСерияНоменклатурыНовая И (ЗначениеЗаполнено(СтрокаТаблицыНДСПартииСписания.СерияНоменклатурыНовая) 
				ИЛИ СтрокаТаблицыНДСПартииСписания.ИзменитьСерию) Тогда
				СтрокаТаблицыНДСПартииСписания.СерияНоменклатуры = СтрокаТаблицыНДСПартииСписания.СерияНоменклатурыНовая;
			КонецЕсли;
			Если ЕстьНоменклатураНовая И ЗначениеЗаполнено(СтрокаТаблицыНДСПартииСписания.НоменклатураНовая) Тогда
				СтрокаТаблицыНДСПартииСписания.Номенклатура = СтрокаТаблицыНДСПартииСписания.НоменклатураНовая;
			КонецЕсли;
			Если ЕстьДокументОприходованияНовый И ЗначениеЗаполнено(СтрокаТаблицыНДСПартииСписания.ДокументОприходованияНовый) Тогда
				СтрокаТаблицыНДСПартииСписания.Партия = СтрокаТаблицыНДСПартииСписания.ДокументОприходованияНовый;
			КонецЕсли;
			
			Если ТипЗнч(СтруктураШапкиДокумента.Ссылка) = Тип("ДокументСсылка.КомплектацияНоменклатуры")
				И СтруктураШапкиДокумента.ВидКомплектации = Перечисления.ВидыКомплектации.Разборка 
				И СтрокаТаблицыНДСПартииСписания.Количество <> 0 Тогда
					//Строка поступления для каждой комплектующей своя
			    	СтрокаПоступленияКомплектации = Неопределено;
			КонецЕсли; 
			
			Если СтрокаПоступленияКомплектации = Неопределено Тогда
				СтрокаПоступленияКомплектации = ТаблицаНДСПартииСписания.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаПоступленияКомплектации,СтрокаТаблицыНДСПартииСписания);
				СтрокаПоступленияКомплектации.НДС = 0;
				СтрокаПоступленияКомплектации.Стоимость = 0;
				Если ТипЗнч(СтруктураШапкиДокумента.Ссылка) = Тип("ДокументСсылка.КомплектацияНоменклатуры")
				 И СтруктураШапкиДокумента.ВидКомплектации = Перечисления.ВидыКомплектации.Сборка Тогда
				   	СтрокаПоступленияКомплектации.Количество = СтруктураШапкиДокумента.Количество;
				ИначеЕсли СтрокаТаблицыНДСПартииСписания.Количество <> 0 Тогда
					СтрокаПоступленияКомплектации.Количество = СтрокаТаблицыНДСПартииСписания.КоличествоПоступление;
				КонецЕсли;
				СтрокаПоступленияКомплектации.СчетФактура = Неопределено;
				СтрокаПоступленияКомплектации.ВидЦенности = Перечисления.ВидыЦенностей.Товары;
				СтрокаПоступленияКомплектации.СтавкаНДС   = Перечисления.СтавкиНДС.БезНДС;
				
				// Для ускорения поиска добавим строку в соответствие
				Если СтруктураПараметров.Свойство("СоответствиеКодовОперацийСтрокамНДСПартий") Тогда
					МассивСтрокПоКоду = СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[СтрокаПоступленияКомплектации.КодОперацииПартииТоваров];
					Если МассивСтрокПоКоду = Неопределено Тогда
						СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий.Вставить(СтрокаПоступленияКомплектации.КодОперацииПартииТоваров, Новый Массив);
						МассивСтрокПоКоду = СтруктураПараметров.СоответствиеКодовОперацийСтрокамНДСПартий[СтрокаПоступленияКомплектации.КодОперацииПартииТоваров];
					КонецЕсли;
					МассивСтрокПоКоду.Добавить(СтрокаПоступленияКомплектации);
				КонецЕсли;
			ИначеЕсли ТипЗнч(СтруктураШапкиДокумента.Ссылка) = Тип("ДокументСсылка.КомплектацияНоменклатуры")
				И СтруктураШапкиДокумента.ВидКомплектации = Перечисления.ВидыКомплектации.Сборка Тогда
				//Строка с полным количеством поступления уже создна. Дополнение количества не требуется 
			Иначе
				Если СтрокаТаблицыНДСПартииСписания.Количество <> 0 Тогда
					СтрокаПоступленияКомплектации.Количество = СтрокаПоступленияКомплектации.Количество + 
															   СтрокаТаблицыНДСПартииСписания.КоличествоПоступление;
				КонецЕсли;
			КонецЕсли;
			
			СтрокаТаблицыНДСПартииСписания.Количество = 0;
			
		КонецЕсли;//Если СтрокаТаблицыНДСПартииСписания.КодОперацииПартииТоваров = КодыОпераций.Комплектация Тогда 

	КонецЦикла;//	Для каждого СтрокаТаблицыНДСПартииСписания из ТаблицаНДСПартииСписания цикл

	СтруктураПараметров.ИзмененыДвиженияНДСПартииТоваров = СтруктураПараметров.ИзмененыДвиженияНДСПартииТоваров 
								ИЛИ (КолНДСПартииТоваров <> СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.Количество());
										
	СтруктураПараметров.ИзмененыДвиженияНДСВключенныйВСтоимость = СтруктураПараметров.ИзмененыДвиженияНДСВключенныйВСтоимость
								ИЛИ (КолНДСВключенныйВСтоимость <> СтруктураПараметров.ТаблицаДвиженийНДСВключенныйВСтоимость.Количество());
										
	СтруктураПараметров.ИзмененыДвиженияНДСПредъявленный = СтруктураПараметров.ИзмененыДвиженияНДСПредъявленный
								ИЛИ (КолНДСПредъявленный <> СтруктураПараметров.ТаблицаДвиженийНДСПредъявленный.Количество());
										
	СтруктураПараметров.ИзмененыДвиженияХозрасчетный = СтруктураПараметров.ИзмененыДвиженияХозрасчетный
								ИЛИ (КолНДСХозрасчетный <> СтруктураПараметров.ДвиженияХозрасчетный.Количество());
	Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете Тогда
		СтруктураПараметров.ИзмененыДвиженияНалоговый = СтруктураПараметров.ИзмененыДвиженияНалоговый
								ИЛИ (КолНДСНалоговый <> СтруктураПараметров.ДвиженияНалоговый.Количество());
	КонецЕсли;

КонецПроцедуры //ВыполнитьДвиженияСписанияНДС

//////////////////////////////////////////////////////////////////////////
// ПОЛУЧЕНИЕ ДАННЫХ ПО ДОКУМЕНТАМ

// Параметр ДляКнигиПродаж устанавливается в случае, когда для документа могут быть получены данные как 
// для книги покупок, так и для книги продаж
Функция ПолучитьТаблицуДокументаНДС(ДокументСсылка, Ошибка = Ложь, ДляКнигиПродаж = Ложь) Экспорт
	
	ТипОснования = ТипЗнч(ДокументСсылка);
	
	// По ссылке нужно получить объект
	Если Документы.ТипВсеСсылки().СодержитТип(ТипОснования)	Тогда
		ДокументОбъект = ДокументСсылка.ПолучитьОбъект();
	Иначе
		ТипОснования = ТипЗнч(ДокументСсылка.Ссылка);
		ДокументОбъект = ДокументСсылка;
	КонецЕсли;
	Попытка
		Если ТипОснования = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
			Возврат ПолучитьТаблицуПоступлениеТоваровУслуг(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ГТДИмпорт") Тогда
			Возврат ПолучитьТаблицуГТДИмпорт(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ОтражениеПоступленияТоваровИУслугНДС") Тогда
			Возврат ПолучитьТаблицуОтражениеПоступленияТоваровИУслугНДС(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ПоступлениеДопРасходов") Тогда
			Возврат ПолучитьТаблицуПоступлениеДопРасходов(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ПоступлениеНМА") Тогда
			Возврат ПолучитьТаблицуПоступлениеНМА(ДокументОбъект, Ошибка);
		//ИначеЕсли ТипОснования = Тип("ДокументСсылка.ПоступлениеИзПереработки") Тогда
		//	Возврат ПолучитьТаблицуПоступлениеИзПереработки(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.СчетФактураПолученный") Тогда
			Возврат ПолучитьТаблицуСчетФактураПолученный(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах") Тогда
			Возврат ПолучитьТаблицуОтчетКомиссионераОПродажах(ДокументОбъект, Ошибка, ДляКнигиПродаж);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.НачислениеНДСпоСМРхозспособом") Тогда
			Возврат ПолучитьТаблицуНачислениеНДСпоСМРхозспособом(ДокументОбъект, Ошибка, ДляКнигиПродаж);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
			Возврат ПолучитьТаблицуРеализацияТоваровУслуг(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ОтчетОРозничныхПродажах") Тогда
			Возврат ПолучитьТаблицуОтчетОРозничныхПродажах(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.РеализацияОтгруженныхТоваров") Тогда
			Возврат ПолучитьТаблицуРеализацияОтгруженныхТоваров(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.АктОбОказанииПроизводственныхУслуг") Тогда
			Возврат ПолучитьТаблицуАктОбОказанииПроизводственныхУслуг(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ПередачаОС") Тогда
			Возврат ПолучитьТаблицуПередачаОС(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ПередачаНМА") Тогда
			Возврат ПолучитьТаблицуПередачаНМА(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
			Возврат ПолучитьТаблицуСчетФактураВыданный(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ОтражениеРеализацииТоваровИУслугНДС") Тогда
			Возврат ПолучитьТаблицуОтражениеРеализацииТоваровИУслугНДС(ДокументОбъект, Ошибка);
		ИначеЕсли ТипОснования = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя") Тогда
			Возврат ПолучитьТаблицуВозвратТоваровОтПокупателя(ДокументОбъект, Ошибка);
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	Исключение
		Возврат Неопределено;	
	КонецПопытки;
	
КонецФункции

Функция ПолучитьТаблицуПоступлениеТоваровУслуг(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоОборудованию, ТаблицаПоУслугам, ТаблицаПоОбъектамСтроительства;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоУслугам, ТаблицаПоОборудованию, ТаблицаПоОбъектамСтроительства, Неопределено);
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоОборудованию, ТаблицаПоТоварам);
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоУслугам, ТаблицаПоТоварам);
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоОбъектамСтроительства, ТаблицаПоТоварам);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуГТДИмпорт(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, СтруктураШапкиДокументаВалюта, СтруктураШапкиДокументаРубли, ТаблицаПоТоварамВалюта, ТаблицаПоТоварамРубли;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, СтруктураШапкиДокументаВалюта, СтруктураШапкиДокументаРубли);
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, СтруктураШапкиДокументаВалюта, СтруктураШапкиДокументаРубли, ТаблицаПоТоварамВалюта, ТаблицаПоТоварамРубли);
	
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоТоварамВалюта, ТаблицаПоТоварамРубли);
	ТаблицаПоТоварамРубли.Колонки.Удалить("НДСВал");
	
	Возврат ТаблицаПоТоварамРубли.Скопировать(Новый Структура("Содержание", "НДС"));
	
КонецФункции

Функция ПолучитьТаблицуОтражениеПоступленияТоваровИУслугНДС(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Неопределено);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам, Неопределено);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуПоступлениеДопРасходов(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоОборудованию;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Неопределено);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоОборудованию);
	
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоОборудованию, ТаблицаПоТоварам);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуСчетФактураПолученный(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоДокументамОснованиям;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Неопределено);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоДокументамОснованиям, Истина);
	
	ТаблицаПоВсемДокументам = Неопределено;
	Для Каждого СтрокаТаблицы Из ТаблицаПоДокументамОснованиям Цикл
		Если ТаблицаПоВсемДокументам = Неопределено Тогда
			ТаблицаПоВсемДокументам = СтрокаТаблицы.ТаблицаДанных;
		Иначе
			ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(СтрокаТаблицы.ТаблицаДанных, ТаблицаПоВсемДокументам);
		КонецЕсли;
	КонецЦикла;
	
	Возврат ТаблицаПоВсемДокументам;
	
КонецФункции

Функция ПолучитьТаблицуОтчетКомиссионераОПродажах(ДокументОбъект, Ошибка, ДляКнигиПродаж = Ложь)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоДокументу;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Неопределено);
	
	Если ДляКнигиПродаж Тогда
		ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоДокументу, Неопределено, Неопределено);
	Иначе
		ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, Неопределено, ТаблицаПоДокументу, Неопределено);
	КонецЕсли;
	
	Возврат ТаблицаПоДокументу;
	
КонецФункции

Функция ПолучитьТаблицуРеализацияТоваровУслуг(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоУслугам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоУслугам, Неопределено);
	
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоУслугам, ТаблицаПоТоварам);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуОтчетОРозничныхПродажах(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Ошибка);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуОтражениеРеализацииТоваровИУслугНДС(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Ошибка);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам, Неопределено);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуСчетФактураВыданный(ДокументОбъект, Ошибка)
	
	Перем ТаблицаПоДокументамОснованиям, ТаблицаПоДокументуОснования;
	
	Если ДокументОбъект.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.НаРеализацию Тогда
	
		Для Каждого СтрокаТаблицы Из ДокументОбъект.ДокументыОснования Цикл
			Если ЗначениеЗаполнено(СтрокаТаблицы.ДокументОснование) Тогда
				ДокументОснованиеОбъект = СтрокаТаблицы.ДокументОснование.ПолучитьОбъект();
				ТаблицаПоДокументуОснования = ПолучитьТаблицуДокументаНДС(ДокументОснованиеОбъект, Ошибка);
				Если ТаблицаПоДокументуОснования <> Неопределено Тогда
					Если ТаблицаПоДокументамОснованиям = Неопределено Тогда
						ТаблицаПоДокументамОснованиям = ТаблицаПоДокументуОснования.Скопировать();
					Иначе	
						ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоДокументуОснования, ТаблицаПоДокументамОснованиям);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
			
		Возврат ТаблицаПоДокументамОснованиям;
		
	КонецЕсли;
	
	ТаблицаДокумента = Новый ТаблицаЗначений;
	ТаблицаДокумента.Колонки.Добавить("ВидЦенности");
	ТаблицаДокумента.Колонки.Добавить("СчетФактура");
	ТаблицаДокумента.Колонки.Добавить("Сумма");
	ТаблицаДокумента.Колонки.Добавить("СтавкаНДС");
	ТаблицаДокумента.Колонки.Добавить("НДС");
	ТаблицаДокумента.Колонки.Добавить("СчетУчетаНДС");
	ТаблицаДокумента.Колонки.Добавить("Событие");
	
	НоваяСтрока = ТаблицаДокумента.Добавить();
	НоваяСтрока.ВидЦенности = ?(ДокументОбъект.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыВыставленного.НаАванс, Перечисления.ВидыЦенностей.АвансыПолученные,
																										Перечисления.ВидыЦенностей.СуммыСвязанныеСРасчетамиПоОплате);
	НоваяСтрока.СчетФактура = ДокументОбъект.ДокументОснование;
	НоваяСтрока.Сумма = ДокументОбъект.Сумма;
	НоваяСтрока.СтавкаНДС = ДокументОбъект.СтавкаНДС;
	НоваяСтрока.НДС = ДокументОбъект.СуммаНДС;	
	НоваяСтрока.СчетУчетаНДС = ПланыСчетов.Хозрасчетный.НДСпоАвансамИПредоплатам;	
	НоваяСтрока.Событие = Перечисления.СобытияПоНДСПокупки.ПредъявленНДСКВычету;
	
	Возврат ТаблицаДокумента;
	
КонецФункции

Функция ПолучитьТаблицуВозвратТоваровОтПокупателя(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция РаспределитьПартииПоТаблицеСписания(ТаблицаПартий, ТаблицаСписания, СтруктураШапкиДокумента, СтруктураПараметров)
	
	ВидыЦенностейПоСчетамУчета = Неопределено;
	
	СоответствиеЗаказов = Новый Соответствие;
	
	КопияТаблицыСписания = ТаблицаСписания.Скопировать();
	
	КопияТаблицыСписания.Колонки.Удалить(КопияТаблицыСписания.Колонки.Подразделение);
	
	РаспределеннаяТаблица = КопияТаблицыСписания.СкопироватьКолонки();
	
	// Дополнительные колонки, используемые подсистемой НДС
	СтрокаНазванийКолонок = "Ценность, СчетУчетаЦенности, ВидЦенности, ДоговорПоставщика, Комиссионный, Партия,
							|КорСчетСписанияБУ, КорСчетСписанияНУ,
							|КорСубконтоСписанияНУ1, КорСубконтоСписанияНУ2, КорСубконтоСписанияНУ3,
							|КорСубконтоСписанияБУ1, КорСубконтоСписанияБУ2, КорСубконтоСписанияБУ3,
							|НДС, СуммаБезНДС,
							|ДокументОприходования,
							|НомерКорСтроки, ПостояннаяРазница, ВременнаяРазница,
							|ДоговорКомиссии, СчетРасчетовСКомитентом, ОбособленныйУчетТоваровПоЗаказамПокупателей,
							|Подразделение";

	// Ключ - название колонки
	// Значение - описание типа для добавляемой колонки
	СтруктураКолонокРаспределеннойТаблицы = Новый Структура(СтрокаНазванийКолонок);
	СтруктураКолонокРаспределеннойТаблицы.Вставить("УчетАгентскогоНДС", Новый описаниеТипов("Булево"));
	
	Для Каждого Элемент из СтруктураКолонокРаспределеннойТаблицы цикл
		Если РаспределеннаяТаблица.Колонки.Найти(Элемент.Ключ) = Неопределено тогда
			Если Элемент.Значение = Неопределено Тогда
				РаспределеннаяТаблица.Колонки.Добавить(Элемент.Ключ);
			Иначе
				РаспределеннаяТаблица.Колонки.Добавить(Элемент.Ключ,Элемент.Значение);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	Для каждого СтрокаТаблицыСписания из КопияТаблицыСписания цикл
		
		Если Не СтрокаТаблицыСписания.ОтражатьВБухгалтерскомУчете тогда
			Продолжить;
		КонецЕсли;
		
		РегистрУчета = "НаСкладах";
		
		МассивСтрокПартий = УправлениеЗапасамиПартионныйУчет.ОтобратьСтрокиПартий(ТаблицаПартий, СтрокаТаблицыСписания, РегистрУчета);
		Для Каждого СтрокаПартии из МассивСтрокПартий цикл
		
			Если СтрокаПартии.ВидДвижения = ВидДвиженияНакопления.Приход 
			   И  Не СтрокаПартии.КодОперации = КодыОпераций.ВозвратОтПокупателя тогда
				Продолжить;
			КонецЕсли;
			
			//// НДС по таре не учитывается
			Если СтрокаТаблицыСписания.КодОперацииПартииТоваров = КодыОпераций.ПередачаТарыКонтрагенту 
			   Или СтрокаТаблицыСписания.ВидТабличнойЧасти = Перечисления.ВидыТабличныхЧастей.Тара
				тогда
				Продолжить;
			КонецЕсли;
			
			Если СтрокаПартии.Количество <= 0 тогда 
				Продолжить;
			КонецЕсли;
			
			Если СтрокаТаблицыСписания.Количество <= 0 тогда
				Продолжить;
			КонецЕсли;
			
			Если НЕ УправлениеЗапасамиПартионныйУчет.ПроверитьПартиюНаСкладеБух(СтрокаПартии, СтрокаТаблицыСписания, СтруктураПараметров) тогда
				Продолжить;
			КонецЕсли;
			
			
			Если СтрокаТаблицыСписания.Количество > СтрокаПартии.Количество тогда
				КоэффСписания = СтрокаПартии.Количество/СтрокаТаблицыСписания.Количество;
				КоличествоСписать = СтрокаПартии.Количество;
			Иначе
				КоэффСписания = 1;
				КоличествоСписать = СтрокаТаблицыСписания.Количество;
			КонецЕсли;
			
			СтрокаРаспределеннойТаблицы = РаспределеннаяТаблица.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаРаспределеннойТаблицы, СтрокаТаблицыСписания);
			
			СтрокаРаспределеннойТаблицы.НДС   = Окр(СтрокаТаблицыСписания.СуммаНДС * КоэффСписания,2,1);
			
			СуммаЗадолженностиБУ = Окр(СтрокаТаблицыСписания.СуммаЗадолженностиБУ * КоэффСписания,2,1);
			СтрокаРаспределеннойТаблицы.СуммаБезНДС = СуммаЗадолженностиБУ - СтрокаРаспределеннойТаблицы.НДС;
			СтрокаТаблицыСписания.СуммаЗадолженностиБУ = СтрокаТаблицыСписания.СуммаЗадолженностиБУ - СуммаЗадолженностиБУ;
			
			СтрокаРаспределеннойТаблицы.КорВалютнаяСуммаЗадолженностиБУ = Окр(СтрокаТаблицыСписания.КорВалютнаяСуммаЗадолженностиБУ* КоэффСписания,2,1);
			СтрокаРаспределеннойТаблицы.КорВалютнаяСуммаНДСЗадолженностиБУ = Окр(СтрокаТаблицыСписания.КорВалютнаяСуммаНДСЗадолженностиБУ* КоэффСписания,2,1);
			
			СтрокаТаблицыСписания.КорВалютнаяСуммаЗадолженностиБУ = СтрокаТаблицыСписания.КорВалютнаяСуммаЗадолженностиБУ - СтрокаРаспределеннойТаблицы.КорВалютнаяСуммаЗадолженностиБУ;
			СтрокаТаблицыСписания.КорВалютнаяСуммаНДСЗадолженностиБУ = СтрокаТаблицыСписания.КорВалютнаяСуммаНДСЗадолженностиБУ- СтрокаРаспределеннойТаблицы.КорВалютнаяСуммаНДСЗадолженностиБУ;
			
			СтрокаТаблицыСписания.СуммаНДС = СтрокаТаблицыСписания.СуммаНДС - СтрокаРаспределеннойТаблицы.НДС;
			СтрокаТаблицыСписания.Количество = СтрокаТаблицыСписания.Количество - КоличествоСписать;
				
			СтрокаРаспределеннойТаблицы.Количество = КоличествоСписать;
			СтрокаРаспределеннойТаблицы.КоличествоПоступление = Окр(СтрокаТаблицыСписания.КоличествоПоступление * КоэффСписания,3,1);
			СтрокаРаспределеннойТаблицы.Партия = СтрокаПартии.ДокументОприходования;
			СтрокаРаспределеннойТаблицы.ДокументОприходования = СтрокаПартии.ДокументОприходования;
			СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = СтрокаПартии.КодОперации;
			
			Если СтрокаПартии.КодОперации = Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателя тогда
				СтрокаРаспределеннойТаблицы.СкладПолучатель = СтрокаРаспределеннойТаблицы.Склад;
			КонецЕсли;
			
			СтрокаПартии.Количество = СтрокаПартии.Количество - КоличествоСписать;
			СтрокаТаблицыСписания.КоличествоПоступление = СтрокаТаблицыСписания.КоличествоПоступление - СтрокаРаспределеннойТаблицы.КоличествоПоступление;
			
			СтрокаРаспределеннойТаблицы.Ценность = СтрокаРаспределеннойТаблицы.Номенклатура;
			СтрокаРаспределеннойТаблицы.СчетУчетаЦенности = СтрокаПартии.СчетУчета;
			СтрокаРаспределеннойТаблицы.СчетУчетаБУ		  = СтрокаПартии.СчетУчета;
			
			СтрокаРаспределеннойТаблицы.КорСубконтоСписанияБУ1 = СтрокаРаспределеннойТаблицы.КорСубконтоБУ1;
			СтрокаРаспределеннойТаблицы.КорСубконтоСписанияБУ2 = СтрокаРаспределеннойТаблицы.КорСубконтоБУ2;
			СтрокаРаспределеннойТаблицы.КорСубконтоСписанияБУ3 = СтрокаРаспределеннойТаблицы.КорСубконтоБУ3;
			
			КорСубконто1 = СтрокаРаспределеннойТаблицы.КорСубконтоБУ1;
			КорСубконто2 = СтрокаРаспределеннойТаблицы.КорСубконтоБУ2;
			КорСубконто3 = СтрокаРаспределеннойТаблицы.КорСубконтоБУ3;
			
			Если ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСубконтоНУ1) тогда
				КорСубконто1 = СтрокаРаспределеннойТаблицы.КорСубконтоНУ1;
			КонецЕсли;
			Если ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСубконтоНУ2) тогда
				КорСубконто2 = СтрокаРаспределеннойТаблицы.КорСубконтоНУ2;
			КонецЕсли;
			Если ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСубконтоНУ3) тогда
				КорСубконто3 = СтрокаРаспределеннойТаблицы.КорСубконтоНУ3;
			КонецЕсли;
			
			СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ1 = КорСубконто1;
			СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ2 = КорСубконто2;
			СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ3 = КорСубконто3;
			
			СтрокаРаспределеннойТаблицы.КорСчетСписанияБУ = СтрокаРаспределеннойТаблицы.КорСчетБУ;
			Если НЕ ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСчетСписанияБУ) тогда
				СтрокаРаспределеннойТаблицы.КорСчетСписанияБУ = СтрокаРаспределеннойТаблицы.СчетУчетаБУ;
			КонецЕсли;
			
			СтрокаРаспределеннойТаблицы.КорСчетСписанияНУ = СтрокаРаспределеннойТаблицы.КорСчетНУ;
			
			// Серия в документе может отличаться от серии в партии
			// Например заказ покупателя с пустой серией может списывать партии с непустой серией
			СтрокаРаспределеннойТаблицы.СерияНоменклатуры = СтрокаПартии.СерияНоменклатуры;
			
			СтрокаРаспределеннойТаблицы.Комиссионный  = УправлениеЗапасамиПартионныйУчет.КомиссионныйТовар(СтрокаРаспределеннойТаблицы.СчетУчетаБУ);
			
			Если СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.Комплектация или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.ПеремещениеМеждуСкладами или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.Реализация или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.РеализацияКомиссия или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.РеализацияРозница или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.РезервированиеПодЗаказ или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.ПередачаНаКомиссию или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.ВозвратОтКомиссионера или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.ВозвратОтПокупателя или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.ПереоценкаПринятыхНаКомиссию или
			   СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.КорректировкаСерийИХарактеристик
			   
			   тогда
				Если СтрокаРаспределеннойТаблицы.Комиссионный тогда
					СтруктураРеквизитовДокумента = Новый Структура("Контрагент,ДоговорКонтрагента");
					Если ЗначениеЗаполнено(СтрокаПартии.ДокументОприходования) Тогда
					
						УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтрокаПартии.ДокументОприходования, СтруктураРеквизитовДокумента);
						СтрокаРаспределеннойТаблицы.ДоговорКомиссии = СтруктураРеквизитовДокумента.ДоговорКонтрагента;
						СтруктураРеквизитовДоговора = Новый Структура("УчетАгентскогоНДС");
						УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтруктураРеквизитовДокумента.ДоговорКонтрагента, СтруктураРеквизитовДоговора);

						СтрокаРаспределеннойТаблицы.УчетАгентскогоНДС = СтруктураРеквизитовДоговора.УчетАгентскогоНДС;
						СчетаРасчетов = БухгалтерскийУчетРасчетовСКонтрагентами.ПолучитьСчетаРасчетовСКонтрагентом(СтрокаПартии.Организация, СтруктураРеквизитовДокумента.Контрагент, 
																			СтруктураРеквизитовДокумента.ДоговорКонтрагента);
																			
						СтрокаРаспределеннойТаблицы.СчетРасчетовСКомитентом = СчетаРасчетов.СчетРасчетовСКомитентом;
					Иначе
						СтрокаРаспределеннойТаблицы.УчетАгентскогоНДС = Ложь;
						СтрокаРаспределеннойТаблицы.Комиссионный = Ложь;
					КонецЕсли; 
					
				КонецЕсли;
			КонецЕсли;
			
			СтрокаРаспределеннойТаблицы.ВидЦенности	= ОпределитьВидЦенности(СтрокаРаспределеннойТаблицы.Номенклатура, СтрокаРаспределеннойТаблицы.СчетУчетаБУ,,,,,,,,ВидыЦенностейПоСчетамУчета);
			
			Если СтрокаПартии.Заказ <> Документы.ЗаказПокупателя.ПустаяСсылка() тогда
				ОбособленныйУчетТоваровПоЗаказамПокупателей = СоответствиеЗаказов[СтрокаПартии.Заказ];
				
				Если ОбособленныйУчетТоваровПоЗаказамПокупателей = Неопределено Тогда
					
					СтруктураЗаказа = Новый Структура("ДоговорКонтрагента");
					УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтрокаПартии.Заказ, СтруктураЗаказа);
					
					СтруктураДоговора = Новый Структура("ОбособленныйУчетТоваровПоЗаказамПокупателей");
					УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтруктураЗаказа.ДоговорКонтрагента, СтруктураДоговора);
					
					СтрокаРаспределеннойТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = СтруктураДоговора.ОбособленныйУчетТоваровПоЗаказамПокупателей;
					СоответствиеЗаказов.Вставить(СтрокаПартии.Заказ, СтруктураДоговора.ОбособленныйУчетТоваровПоЗаказамПокупателей);
					
				Иначе
					СтрокаРаспределеннойТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = ОбособленныйУчетТоваровПоЗаказамПокупателей;
				КонецЕсли;
			Иначе
				СтрокаРаспределеннойТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = Ложь;
			КонецЕсли;
			
			// В НДС Подразделение = ПодразделениеОрганизации
			СтрокаРаспределеннойТаблицы.Подразделение = СтрокаРаспределеннойТаблицы.ПодразделениеОрганизации;
			
		КонецЦикла;
	КонецЦикла;
	
	Возврат РаспределеннаяТаблица;
	
КонецФункции//РаспределитьПартииПоТаблицеСписания

// Функция возвращает значение реквизита произвольного объекта ссылочного типа
// Предназначена для получения реквизитов недоступных пользователю объектов
Функция ПолучитьРеквизитОбъекта(Ссылка, ИмяРеквизита)
	
	ОбъектМетаданные = Ссылка.Метаданные();
	ИмяТаблицы = ОбъектМетаданные.ПолноеИмя();
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ " + ИмяРеквизита + " КАК " + ИмяРеквизита + " ИЗ " + ИмяТаблицы + "
	|ГДЕ Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка[ИмяРеквизита];
	Иначе
		РеквизитМетаданные = ОбъектМетаданные.Реквизиты.Найти(ИмяРеквизита);
		Возврат РеквизитМетаданные.Тип.ПривестиЗначение();
	КонецЕсли;
		
КонецФункции //ПолучитьРеквизитОбъекта()

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ФУНКЦИИ ДЛЯ СОВМЕСТИМОСТИ С БП

Функция ПолучитьСтруктуруШапкиДокументаПоСсылке(Знач Ссылка) Экспорт

	Перем СтруктураКорректировкиЗаказа;
	Перем СтруктураКорректировкиОрдера;
	
	МетаданныеДокумента = Ссылка.Метаданные();

	Если МетаданныеДокумента.Имя = "РасходныйОрдерНаТовары" Тогда

		СтруктураКорректировкиОрдера = Новый Структура("ДокументПередачи, Дата");
		УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(Ссылка,СтруктураКорректировкиОрдера);
		МетаданныеДокумента = СтруктураКорректировкиОрдера.ДокументПередачи.Метаданные();
		Ссылка = СтруктураКорректировкиОрдера.ДокументПередачи;
		
	ИначеЕсли МетаданныеДокумента.Имя = "ПриходныйОрдерНаТовары" Тогда

		СтруктураКорректировкиОрдера = Новый Структура("ДокументПеремещения, Дата");
		УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(Ссылка,СтруктураКорректировкиОрдера);
		МетаданныеДокумента = СтруктураКорректировкиОрдера.ДокументПеремещения.Метаданные();
		Ссылка = СтруктураКорректировкиОрдера.ДокументПеремещения;
		
	ИначеЕсли МетаданныеДокумента.Имя = "КорректировкаЗаказаПокупателя" 
		ИЛИ МетаданныеДокумента.Имя = "ИзменениеЗаказаПокупателя" Тогда
		
		СтруктураКорректировкиЗаказа = Новый Структура("ЗаказПокупателя, Ссылка, Дата, Номер");
		УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(Ссылка,СтруктураКорректировкиЗаказа);
		МетаданныеДокумента = СтруктураКорректировкиЗаказа.ЗаказПокупателя.Метаданные();
		Ссылка = СтруктураКорректировкиЗаказа.ЗаказПокупателя;

	КонецЕсли;

	СтруктураШапкиДокумента = Новый Структура;

	СтруктураШапкиДокумента.Вставить("Ссылка");
	СтруктураШапкиДокумента.Вставить("Дата");
	СтруктураШапкиДокумента.Вставить("Номер");

	Для каждого Реквизит из МетаданныеДокумента.Реквизиты Цикл
		СтруктураШапкиДокумента.Вставить(Реквизит.Имя);
	КонецЦикла;

	УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(Ссылка, СтруктураШапкиДокумента);
	
	Если МетаданныеДокумента.Имя = "ОтчетКомиссионераОПродажах" Тогда
		СтруктураРеквизитовПокупатели = Новый Структура("Покупатели");
		РезультатЗапросаПокупатели = ПолучитьРеквизитОбъекта(Ссылка, "Покупатели");
		Если НЕ РезультатЗапросаПокупатели.Пустой() Тогда
			ТЧПокупатели = РезультатЗапросаПокупатели.Выгрузить();
			СтруктураШапкиДокумента.Вставить("КомиссияПоПокупателям", НЕ(ТЧПокупатели.Количество() = 1 И ТЧПокупатели[0].Покупатель = СтруктураШапкиДокумента.Контрагент));
		КонецЕсли;
		
	КонецЕсли;
	
	Если СтруктураКорректировкиЗаказа <> Неопределено тогда
		
		СтруктураШапкиДокумента.Вставить("Ссылка" , СтруктураКорректировкиЗаказа.Ссылка);
		СтруктураШапкиДокумента.Вставить("Дата"   , СтруктураКорректировкиЗаказа.Дата);
		СтруктураШапкиДокумента.Вставить("Номер"  , СтруктураКорректировкиЗаказа.Номер);
		
	ИначеЕсли СтруктураКорректировкиОрдера <> Неопределено тогда

		СтруктураШапкиДокумента.Вставить("Дата"   , СтруктураКорректировкиОрдера.Дата);
		
	КонецЕсли;

	Если СтруктураШапкиДокумента.Свойство("ДоговорКонтрагента") тогда

		СтруктураДоговора = Новый Структура ("ВидДоговора,
											 |УчетАгентскогоНДС, ВалютаВзаиморасчетов, РасчетыВУсловныхЕдиницах");

		УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтруктураШапкиДокумента.ДоговорКонтрагента, СтруктураДоговора);
		СтруктураШапкиДокумента.Вставить("ВидДоговора", СтруктураДоговора.ВидДоговора);
		СтруктураШапкиДокумента.Вставить("УчетАгентскогоНДС", СтруктураДоговора.УчетАгентскогоНДС);
		СтруктураШапкиДокумента.Вставить("ВалютаВзаиморасчетов", СтруктураДоговора.ВалютаВзаиморасчетов);
		СтруктураШапкиДокумента.Вставить("РасчетыВУсловныхЕдиницах", СтруктураДоговора.РасчетыВУсловныхЕдиницах);
		
	Иначе

		СтруктураШапкиДокумента.Вставить("ВидДоговора", Неопределено);

	КонецЕсли;

	
	Если НЕ СтруктураШапкиДокумента.Свойство("УчитыватьНДС") Тогда

		СтруктураШапкиДокумента.Вставить("УчитыватьНДС", Истина);

	КонецЕсли;

	
	Если НЕ СтруктураШапкиДокумента.Свойство("НДСВключенВСтоимость") Тогда

		СтруктураШапкиДокумента.Вставить("НДСВключенВСтоимость", Истина);

	КонецЕсли;

	Если НЕ СтруктураШапкиДокумента.Свойство("ОтражатьВНалоговомУчетеУСН") Тогда

		СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСН", Ложь);

	КонецЕсли;

	ВалютаРегламентированногоУчета = глЗначениеПеременной("ВалютаРегламентированногоУчета");
	СтруктураШапкиДокумента.Вставить("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);	
	СтруктураШапкиДокумента.Вставить("ВидДокумента",  МетаданныеДокумента.Имя);
	
	СтруктураШапкиДокумента.Вставить("ОрганизацияПрименяетУСН", ?(СтруктураШапкиДокумента.Свойство("Организация"), НалоговыйУчетУСН.ПрименениеУСН(СтруктураШапкиДокумента.Организация, СтруктураШапкиДокумента.Дата),Ложь));
	
	Если СтруктураШапкиДокумента.Свойство("ОтражатьВНалоговомУчете") И СтруктураШапкиДокумента.Свойство("Организация") Тогда

		Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете Тогда

			Если СтруктураШапкиДокумента.ОрганизацияПрименяетУСН Тогда

				Если НалоговыйУчетУСН.ПрименениеУСНДоходы(СтруктураШапкиДокумента.Организация, СтруктураШапкиДокумента.Дата) Тогда
					СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСНДоходы", Истина);
					СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСН", Ложь);
				Иначе
					СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСНДоходы", Ложь);
					СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСН", Истина);
				КонецЕсли;

				СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчете",    Ложь);

			Иначе
				СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСН", Ложь);
				СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСНДоходы", Ложь);

			КонецЕсли;

		Иначе
			СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСН", Ложь);
			СтруктураШапкиДокумента.Вставить("ОтражатьВНалоговомУчетеУСНДоходы", Ложь);

		КонецЕсли;
	
	КонецЕсли;
	
	ВидПоступления = Неопределено;
	Если СтруктураШапкиДокумента.Свойство("ВидПоступления",ВидПоступления) тогда
		Если ВидПоступления = Перечисления.ВидыПоступленияТоваров.ПоОрдеру тогда
			СтруктураСклада = Новый Структура("СкладОрдер");
			УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(Ссылка,СтруктураСклада);
			
			СтруктураСкладаОрдера = Новый Структура("Склад");
			УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтруктураСклада.СкладОрдер,СтруктураСкладаОрдера);
			
			СтруктураШапкиДокумента.Вставить("СкладПриходногоОрдера",СтруктураСкладаОрдера.Склад);
		КонецЕсли;
	КонецЕсли;
	СтруктураШапкиДокумента.Вставить("ОтгрузкаБезПереходаПраваСобственности", Ложь);
	ВидОперации = неопределено;
	Если СтруктураШапкиДокумента.Свойство("ВидОперации",ВидОперации) тогда
		Если ВидОперации = Перечисления.ВидыОперацийРеализацияТоваров.ОтгрузкаБезПереходаПраваСобственности Тогда
			СтруктураШапкиДокумента.Вставить("ОтгрузкаБезПереходаПраваСобственности", истина);
		КонецЕсли;
	КонецЕсли;
	
	Возврат СтруктураШапкиДокумента;
	
КонецФункции


Функция ОтобратьСтрокиПартийПоКодамОпераций(СтрокаКодовОпераций, ТаблицаПартийНДС, СтруктураПараметров)
	
	Перем СоответствиеКодовОперацийСтрокамНДСПартий;
	
	Результат = Новый ТаблицаЗначений;
		
	Для каждого Колонка ИЗ ТаблицаПартийНДС.Колонки Цикл
			
		Результат.Колонки.Добавить(Колонка.Имя,Колонка.ТипЗначения);
			
	КонецЦикла;
	
	Если СтруктураПараметров.Свойство("СоответствиеКодовОперацийСтрокамНДСПартий",СоответствиеКодовОперацийСтрокамНДСПартий) тогда

		СтруктураКодовОпераций = Новый Структура(СтрокаКодовОпераций);
			
		Для каждого Элемент из СтруктураКодовОпераций Цикл
			МассивСтрокПоКодуОперации = СоответствиеКодовОперацийСтрокамНДСПартий[Перечисления.КодыОперацийПартииТоваров[Элемент.Ключ]];
			Если МассивСтрокПоКодуОперации <> Неопределено Тогда
				Для Каждого СтрокаТаблицы ИЗ МассивСтрокПоКодуОперации Цикл
					НоваяСтрока = Результат.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицы);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	Иначе
		Возврат Результат;
	КонецЕсли;
		
	Возврат Результат;
	
КонецФункции //ОтобратьСтрокиПоКодамОпераций

Функция ОтобратьСтрокиПостроителемЗапроса(СтрокаКодовОпераций, ТаблицаЗначений)
	
	СтруктураКодовОпераций = Новый Структура(СтрокаКодовОпераций);
	
	ВидСравненияКодаОперации = ВидСравнения.ВСписке;
		
	СписокОтбора = Новый СписокЗначений;
	Для каждого Элемент из СтруктураКодовОпераций Цикл
		СписокОтбора.Добавить(Перечисления.КодыОперацийПартииТоваров[Элемент.Ключ]);
	КонецЦикла;
	
	ПостроительТаблицаПартийНДС = Новый ПостроительЗапроса();
	ПостроительТаблицаПартийНДС.ИсточникДанных = Новый ОписаниеИсточникаДанных(ТаблицаЗначений);
	Отбор = ПостроительТаблицаПартийНДС.Отбор;
	ЭлементОтбора = Отбор.Добавить("КодОперацииПартииТоваров");
	ЭлементОтбора.ВидСравнения = ВидСравненияКодаОперации;
	ЭлементОтбора.Значение = СписокОтбора;
	ЭлементОтбора.Использование = Истина;
		
	ПостроительТаблицаПартийНДС.Выполнить();
		
	Если ПостроительТаблицаПартийНДС.Результат.Пустой() тогда
		Возврат Неопределено;
	КонецЕсли;
		
	Возврат ПостроительТаблицаПартийНДС.Результат.Выгрузить();
	
КонецФункции //ОтобратьСтрокиПостроителемЗапроса

Функция ПолучитьТаблицуПартийДляСписанияНДС(СтруктураПараметров)
	
	// Партии могут списываться из регистров ПартииТоваровНаСкладахБухгалтерскийУчет и ПартииТоваровПереданныеБухгалтерскийУчет
	// Отберем из соответствующих таблиц партии с видом движения "расход"
	
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	ТаблицаПартий = СтруктураПараметров.ТаблицаДвиженийПартииТоваровНаСкладахБух.СкопироватьКолонки();
	ТаблицаПартий.Колонки.Добавить("РегистрУчета");
	Для каждого СтрокаПартииНаСкладах из СтруктураПараметров.ТаблицаДвиженийПартииТоваровНаСкладахБух Цикл
		Если СтрокаПартииНаСкладах.ВидДвижения = ВидДвиженияНакопления.Расход 
		   ИЛИ (СтрокаПартииНаСкладах.ВидДвижения = ВидДвиженияНакопления.Приход 
		   И   СтрокаПартииНаСкладах.КодОперации = КодыОпераций.ВозвратОтПокупателя) тогда
			CтрокаПартии = ТаблицаПартий.Добавить();
			ЗаполнитьЗначенияСвойств(CтрокаПартии,СтрокаПартииНаСкладах);
			Если СтрокаПартииНаСкладах.КодОперации = КодыОпераций.ВозвратОтПокупателяТекущийМесяц тогда
				// Возврат текущего месяца учитывается как сторно реализации
				CтрокаПартии.Количество = - CтрокаПартии.Количество;
				CтрокаПартии.Стоимость  = - CтрокаПартии.Стоимость;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Для каждого СтрокаПартииПереданные из СтруктураПараметров.ТаблицаДвиженийПартииТоваровПереданныеБух Цикл
		Если СтрокаПартииПереданные.ВидДвижения = ВидДвиженияНакопления.Расход тогда
			CтрокаПартии = ТаблицаПартий.Добавить();
			ЗаполнитьЗначенияСвойств(CтрокаПартии,СтрокаПартииПереданные);
		КонецЕсли;
	КонецЦикла;
	Возврат ТаблицаПартий;
	
КонецФункции

// Функция находит и возвращает документ, являющийся отправной точкой исправлений (либо ПТУ либо корректировку ПТУ)
// либо первоначальный документ ПТУ при передаче истины в параметр Исходный
Функция ПолучитьИсправляемыйДокументПоступления(ДокПоступления, Исходный = Ложь) Экспорт
	
	Если ЗначениеЗаполнено(ДокПоступления) 
		И ТипЗнч(ДокПоступления) = Тип("ДокументСсылка.КорректировкаПоступления")
		И (ДокПоступления.ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки ИЛИ Исходный) Тогда
		
		Возврат ПолучитьИсправляемыйДокументПоступления(ДокПоступления.ДокументПоступления, Исходный);
		
	Иначе
		Возврат ДокПоступления;
	КонецЕсли;	
	
КонецФункции	

// Функция находит и возвращает документ, являющийся отправной точкой исправлений (либо РТУ либо корректировку РТУ)
// либо первоначальный документ РТУ при передаче истины в параметр Исходный
Функция ПолучитьИсправляемыйДокументРеализации(ДокРеализации, Исходный = Ложь) Экспорт
	
	Если ЗначениеЗаполнено(ДокРеализации) 
		И ТипЗнч(ДокРеализации) = Тип("ДокументСсылка.КорректировкаРеализации")
		И (ДокРеализации.ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки ИЛИ Исходный) Тогда
		
		Возврат ПолучитьИсправляемыйДокументРеализации(ДокРеализации.ДокументРеализации, Исходный);
		
	Иначе
		Возврат ДокРеализации;
	КонецЕсли;	
	
КонецФункции

// Получает версию постановления в зависимости от переданной даты
//
Функция ПолучитьВерсиюПостановления(Дата) Экспорт
	
	НачалоПримененияИсправленныхСчетовФактур = Константы.НачалоПримененияИсправленныхСчетовФактур.Получить();
	
	Если ЗначениеЗаполнено(НачалоПримененияИсправленныхСчетовФактур)
		И Дата >= НачалоПримененияИсправленныхСчетовФактур Тогда
		Возврат 2; // Дата начала применения исправленных счетов-фактур задана и меньше или равна переданной даты
	Иначе
		Возврат 1; // Дата начала применения исправленных счетов-фактур не задана или задана, но больше, чем переданная дата 
	КонецЕсли;	
		
КонецФункции		

// Процедура формирует список выбора кодов видов операций
//
// Параметры
//  ЧастьЖурнала  - Перечисления.ЧастиЖурналаУчетаСчетовФактур - в зависимости от значения параметра 
//                 формируется список выбора
//  СписокВыбора  - СписокЗначений - формируемый список кодов видов операций
//
Процедура ЗаполнитьСписокКодовВидовОпераций(ЧастьЖурнала, СписокВыбора) Экспорт
	
	СписокВыбора.Очистить();
	
	Если ЧастьЖурнала = Перечисления.ЧастиЖурналаУчетаСчетовФактур.ПолученныеСчетаФактуры Тогда
		
		СписокВыбора.Добавить("01", "01 - полученные товары, работы, услуги");
		СписокВыбора.Добавить("02", "02 - авансы выданные");
		СписокВыбора.Добавить("03", "03 - возврат от покупателя");
		СписокВыбора.Добавить("04", "04 - полученные товары, работы, услуги от комитента");
		СписокВыбора.Добавить("05", "05 - авансы выданные комитенту");
		СписокВыбора.Добавить("10", "10 - полученные безвозмездно товары, работы, услуги");
		СписокВыбора.Добавить("11", "11 - полученные товары, права, п.3,4,5.1 статьи 154, пп.1-4 статьи 155 НК");
		СписокВыбора.Добавить("12", "12 - авансы выданные за товары, права, п.3,4,5.1 статьи 154, пп.1-4 статьи 155 НК");
		СписокВыбора.Добавить("13", "13 - капитальное строительство, модернизация (реконструкция) объектов недвижимости");
        		
	ИначеЕсли ЧастьЖурнала = Перечисления.ЧастиЖурналаУчетаСчетовФактур.ВыставленныеСчетаФактуры Тогда
		
		СписокВыбора.Добавить("01", "01 - реализованные товары, работы, услуги");
		СписокВыбора.Добавить("02", "02 - авансы полученные");
		СписокВыбора.Добавить("03", "03 - возврат поставщику");
		СписокВыбора.Добавить("04", "04 - реализованные товары, работы, услуги комитента");
		СписокВыбора.Добавить("05", "05 - авансы полученные за товары, работы, услуги комитента");
		СписокВыбора.Добавить("06", "06 - налоговый агент, статья 161 НК");
		СписокВыбора.Добавить("07", "07 - списание за счет прибыли, пп.2 п.1 статьи 146 НК");
		СписокВыбора.Добавить("08", "08 - строительно-монтажные работы, пп.3 п.1 статьи 146 НК");
		СписокВыбора.Добавить("09", "09 - суммы, связанные с расчетами по оплате, статья 162 НК");
		СписокВыбора.Добавить("10", "10 - переданные безвозмездно товары, работы, услуги");
		СписокВыбора.Добавить("11", "11 - реализованные товары, права, п.3,4,5.1 статьи 154, пп.1-4 статьи 155 НК");
		СписокВыбора.Добавить("12", "12 - авансы полученные за товары, права, п.3,4,5.1 статьи 154, пп.1-4 статьи 155 НК");
		СписокВыбора.Добавить("13", "13 - капитальное строительство, модернизация (реконструкция) объектов недвижимости");
            		
	КонецЕсли;	
		      
КонецПроцедуры	

// Функция определяет счет учета НДС по виду ценности
Функция ОпределитьСчетУчетаНДС(ВидЦенности)
	
	Если Не ЗначениеЗаполнено(ВидЦенности) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ВидЦенности = Перечисления.ВидыЦенностей.Материалы
		Или ВидЦенности = Перечисления.ВидыЦенностей.Товары Тогда
		Возврат ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымМПЗ;
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги Тогда
		Возврат ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.Оборудование 
		Или ВидЦенности = Перечисления.ВидыЦенностей.ОС Тогда
		Возврат ПланыСчетов.Хозрасчетный.НДСприПриобретенииОсновныхСредств;
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ТаможенныеПлатежи
		Или ВидЦенности = Перечисления.ВидыЦенностей.ТаможенныеПлатежиОС Тогда
		Возврат ПланыСчетов.Хозрасчетный.НДСуплачиваемыйТаможеннымОрганам;
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.НМА Тогда
		Возврат ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымНематериальнымАктивам;
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ОбъектыНезавершенногоСтроительства Тогда
		Возврат ПланыСчетов.Хозрасчетный.НДСприСтроительствеОсновныхСредств;
	Иначе
		Возврат ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
	КонецЕсли;
	
КонецФункции

// Формирует список счетов учета ценностей
// ОС - основных средств
// НМА - нематериальных активов
// ВНА - внеоборотных активов
// ОбъектыСтроительства - объектов строительства
// Материалы - материалов
//
Функция ОпределитьСчетаУчетаЦенностей(ОбъектыУчета = "", ДатаОбъекта = '00010101')

	ПланСчетовБУ = ПланыСчетов.Хозрасчетный;
	
	СчетаУчетаЗатрат = Новый СписокЗначений();
	Если ОбъектыУчета = "Оборудование" Или ОбъектыУчета = "ВНА" Тогда
		Если ДатаОбъекта >= '20060101' Тогда
			СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ОборудованиеКУстановке);
		Иначе 
			Возврат СчетаУчетаЗатрат;
		КонецЕсли;
	КонецЕсли;
	Если ОбъектыУчета = "ОС" Или ОбъектыУчета = "ВНА" Тогда
		Если ДатаОбъекта < '20060101' Тогда
			СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ОборудованиеКУстановке);
		КонецЕсли;
		СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств);
	КонецЕсли; 
	Если ОбъектыУчета = "НМА" Или ОбъектыУчета = "ВНА" Тогда
		СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ПриобретениеНематериальныхАктивов);
	КонецЕсли;  
	Если ОбъектыУчета = "ОбъектыСтроительства" Или ОбъектыУчета = "ВНА" Тогда
		СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.СтроительствоОбъектовОсновныхСредств);
	КонецЕсли;
	Если ОбъектыУчета = "Материалы" Тогда
		СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.Материалы);
	КонецЕсли;  
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Хозрасчетный.Ссылка
		|ИЗ
		|	ПланСчетов.Хозрасчетный КАК Хозрасчетный
		|ГДЕ
		|	Хозрасчетный.Ссылка В ИЕРАРХИИ(&СписокСчетов)
		|	И Хозрасчетный.ЗапретитьИспользоватьВПроводках = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("СписокСчетов",СчетаУчетаЗатрат);
	
	СчетаУчетаЗатрат.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
	Возврат СчетаУчетаЗатрат;

КонецФункции

// Функция определяет вид ценнности по переданным в нее субконто счета учета.
// 
Функция ПолучитьЦенностьПоСубконто(Субконто1, Субконто2, Субконто3)

	ВидЦенности = Неопределено;

	МассивСубконто = Новый Массив;
	МассивСубконто.Добавить(Субконто1);
	МассивСубконто.Добавить(Субконто2);
	МассивСубконто.Добавить(Субконто3);

	Для каждого Субконто Из МассивСубконто Цикл

		Если ТипЗнч(Субконто) = Тип("СправочникСсылка.Номенклатура") Тогда
			ВидЦенности = Субконто;

		ИначеЕсли ТипЗнч(Субконто) = Тип("СправочникСсылка.ОсновныеСредства") Тогда
			ВидЦенности = Субконто;

		ИначеЕсли ТипЗнч(Субконто) = Тип("СправочникСсылка.НематериальныеАктивы") Тогда
			ВидЦенности = Субконто;

		ИначеЕсли ТипЗнч(Субконто) = Тип("СправочникСсылка.РасходыБудущихПериодов") Тогда
			ВидЦенности = Субконто;

		ИначеЕсли ТипЗнч(Субконто) = Тип("СправочникСсылка.СтатьиЗатрат") Тогда
			ВидЦенности = Субконто;
			
		ИначеЕсли ТипЗнч(Субконто) = Тип("СправочникСсылка.ПрочиеДоходыИРасходы") Тогда
			ВидЦенности = Субконто;
			
		КонецЕсли; 

		// Если вид ценности определен, то прекращаем поиск
		Если ВидЦенности <> Неопределено Тогда
			Прервать;
		КонецЕсли;

	КонецЦикла;

	Возврат ВидЦенности;

КонецФункции // ПолучитьЦенностьПоСубконто()

// Выполняет общие для всех документов действия связанные с пометкой на удаление
// счета-фактуры при удалении документа, являющегося основание данного счета-фактуры.
//
// Параметры:
//  ДокументОбъект  - объект документа, 
//  ВидСчетаФактуры - строка, вид счета-фактуры, по умолчанию "СчетФактураВыданный"
//
Функция СинхронизацияПометкиНаУдалениеУСчетаФактуры(ДокументОбъект, ВидСчетаФактуры = "СчетФактураВыданный", Отказ = Ложь) Экспорт
	
	Если ДокументОбъект.ЭтоНовый() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ Док.ПометкаУдаления
	                |	ИЗ 
	                |   	Документ." + ДокументОбъект.Метаданные().Имя + " КАК Док
	                |   ГДЕ Док.Ссылка = &ДокументСсылка";

	Запрос.УстановитьПараметр("ДокументСсылка" , ДокументОбъект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Результат = РезультатЗапроса.Выгрузить();
	
	Если ДокументОбъект.ПометкаУдаления <> ?(Результат.Количество() > 0, Результат[0].ПометкаУдаления,ложь) Тогда

		// Произошло изменение пометки на удаление
		// Попытаемся найти счет-фактуру
		СтруктураОтбора = Новый Структура("ПометкаУдаления", Не ДокументОбъект.ПометкаУдаления);
		СчетФактура = НайтиПодчиненныйСчетФактуру(ДокументОбъект.Ссылка, ВидСчетаФактуры, СтруктураОтбора, ДокументОбъект.Ссылка);

		//Если потерпели неудачу, то необходимо ввести новый документ 
		Если ЗначениеЗаполнено(СчетФактура) И Не СчетФактура = ДокументОбъект.Ссылка Тогда
			Попытка
				// Есть счет-фактура, нужно установить для него пометку удаления
				СчетФактураОбъект = СчетФактура.ПолучитьОбъект();
				Если ДокументОбъект.ПометкаУдаления Тогда
					// Если в счете-фаткуре несколько оснований, счет-фактура не помечается на удаление,
					// а очищается ссылка на текущее основание.
					МетаданныеДокумента = СчетФактураОбъект.Метаданные();
					
					Если МетаданныеДокумента.ТабличныеЧасти.Найти("ДокументыОснования") <> Неопределено
						И СчетФактураОбъект.ДокументыОснования.Количество() > СчетФактураОбъект.ДокументыОснования.НайтиСтроки(Новый Структура("ДокументОснование",ДокументОбъект.Ссылка)).Количество() Тогда
						СтрокиКУдалению = СчетФактураОбъект.ДокументыОснования.НайтиСтроки(Новый Структура("ДокументОснование",ДокументОбъект.Ссылка));
						Для каждого СтрокаКУдалению Из СтрокиКУдалению Цикл
							СчетФактураОбъект.ДокументыОснования.Удалить(СтрокаКУдалению);
						КонецЦикла;
						СчетФактураОбъект.ДокументОснование = СчетФактураОбъект.ДокументыОснования[0].ДокументОснование;
						СчетФактураОбъект.Записать();
						ОбщегоНазначения.Сообщение("Из документа «" + СчетФактура + "» удалена ссылка на «"+ДокументОбъект+"».");
						Возврат СчетФактура;
					КонецЕсли; 
				КонецЕсли; 
				
				СчетФактураОбъект.УстановитьПометкуУдаления(ДокументОбъект.ПометкаУдаления);
				Если ДокументОбъект.ПометкаУдаления Тогда
					ОбщегоНазначения.Сообщение("Документ «" + СчетФактура + "» помечен на удаление.")
				Иначе
					ОбщегоНазначения.Сообщение("У документа «" + СчетФактура + "» снята пометка на удаление.")
				КонецЕсли;
				Возврат СчетФактура;
			Исключение
				Отказ = Истина;
				Возврат Неопределено;
			КонецПопытки;
				
		КонецЕсли;

	КонецЕсли;

КонецФункции // СинхронизацияПометкиНаУдалениеУСчетаФактуры()

// Выполняет общие для всех документов действия связанные с пометкой на удаление
// счета-фактуры при удалении документа, являющегося основание данного счета-фактуры.
//
// Параметры:
//  ДокументОбъект  - объект документа, 
//  ВидСчетаФактуры - строка, вид счета-фактуры, по умолчанию "СчетФактураВыданный"
//
Процедура УстановкаПометкиНаУдалениеУСчетаФактуры(ДокументОбъект, ВидСчетаФактуры = "СчетФактураВыданный", ПометкаНаУдаление = Истина) Экспорт

	// Произошло изменение пометки на удаление
	//Попытаемся найти счет-фактуру
	СчетФактура = НайтиПодчиненныйСчетФактуру(ДокументОбъект.Ссылка, ВидСчетаФактуры);

	//Если потерпели неудачу, то необходимо ввести новый документ 
	Если ЗначениеЗаполнено(СчетФактура) И СчетФактура.ПометкаУдаления <> ПометкаНаУдаление Тогда

		// Есть счет-фактура, нужно установить для него пометку удаления
		СчетФактураОбъект = СчетФактура.ПолучитьОбъект();
		СчетФактураОбъект.УстановитьПометкуУдаления(ПометкаНаУдаление);
		Если ПометкаНаУдаление Тогда
			ОбщегоНазначения.Сообщение("Документ <" + СчетФактураОбъект + "> помечен на удаление.")
		Иначе
			ОбщегоНазначения.Сообщение("У документа <" + СчетФактураОбъект + "> снята пометка на удаление.")
		КонецЕсли;

	КонецЕсли;

КонецПроцедуры // СинхронизацияПометкиНаУдалениеУСчетаФактуры()

// Выполняет общие для всех документов действия связанные с проведением
// счета-фактуры при проведении или отмене проведения документа, являющегося основание данного счета-фактуры.
//
// Параметры:
//  ДокументОбъект  - объект документа, 
//  ВидСчетаФактуры - строка, вид счета-фактуры, по умолчанию "СчетФактураВыданный"
//
Процедура СинхронизацияПроведенияУСчетаФактуры(ДокументОбъект, ВидСчетаФактуры = "СчетФактураВыданный", Отказ = Неопределено) Экспорт

	СчетФактура = НайтиПодчиненныйСчетФактуру(ДокументОбъект.Ссылка, ВидСчетаФактуры);

	//Если потерпели неудачу, то необходимо ввести новый документ 
	Если ЗначениеЗаполнено(СчетФактура)
		И СчетФактура <> ДокументОбъект.Ссылка 
		И (ТипЗнч(СчетФактура) = Тип("ДокументСсылка.СчетФактураПолученный") ИЛИ ТипЗнч(СчетФактура) = Тип("ДокументСсылка.СчетФактураВыданный")) Тогда
		
		Если ДокументОбъект.Проведен И НЕ СчетФактура.Проведен Тогда
			// Есть счет-фактура не проведен, нужно провести (счет-фактура не проведен
			Если НЕ СчетФактура.ПометкаУдаления Тогда
				Попытка
					СчетФактураОбъект = СчетФактура.ПолучитьОбъект();
					СчетФактураОбъект.Записать(РежимЗаписиДокумента.Проведение);
				Исключение
					ОбщегоНазначения.СообщитьОбОшибке("Не удалось провести документ <" + СчетФактураОбъект + ">", Отказ, , СтатусСообщения.Важное);
				КонецПопытки;
			КонецЕсли;
		ИначеЕсли НЕ ДокументОбъект.Проведен И СчетФактура.Проведен Тогда
			// Есть счет-фактура проведен, нужно отменить проведение
			Если НЕ СчетФактура.ПометкаУдаления Тогда
				Попытка
					СчетФактураОбъект = СчетФактура.ПолучитьОбъект();
					СчетФактураОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
				Исключение
					ОбщегоНазначения.СообщитьОбОшибке("Не удалось отменить проведение документа <" + СчетФактураОбъект + ">", Отказ, , СтатусСообщения.Важное);
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры // СинхронизацияПроведенияУСчетаФактуры()

Функция ПроводитьПоРазделуУчетаНДС(ДатаДокумента) Экспорт
	
	//ДатаНачалаУчетаНДС = Константы.ДатаНачалаАвтоматическогоОтраженияВУчетеНДС.Получить();
	
	//Возврат ДатаНачалаУчетаНДС < ДатаДокумента;
	
	Возврат Истина;
	
КонецФункции

// Процедура проверяет соответствие реквизитов счета-фактуры и документа-основания.
// В случае несоответствия реквизиты счета-фактуры перезаполняются и выдается сообщение пользователю.
//
// Параметры:
//		- ДокОбъект - документ-основание
//		- Сообщать  - флаг, если истина, то выводить сообщение пользователю, по умолчанию = Истина
//
// Возврат:
//		- Истина, если различий не найдено, Ложь в противном случае
//
Функция ПроверитьСоответствиеРеквизитовСчетаФактуры(ДокОбъект, ВидДокумента = "СчетФактураВыданный", Сообщать = Истина, НайденныйСФ = Неопределено) Экспорт
	
	Если ТипЗнч(ДокОбъект.Ссылка) = Тип("ДокументСсылка.АвансовыйОтчет") Тогда 
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Таб.СчетФактура КАК СчетФактура
		|ИЗ
		|	Документ.АвансовыйОтчет.Товары КАК Таб
		|ГДЕ
		|	Таб.Ссылка = &Ссылка
		|	И Таб.ПредъявленСФ
		|	И Таб.СчетФактура <> ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Таб.СчетФактура
		|ИЗ
		|	Документ.АвансовыйОтчет.Прочее КАК Таб
		|ГДЕ
		|	Таб.Ссылка = &Ссылка
		|	И Таб.ПредъявленСФ
		|	И Таб.СчетФактура <> ЗНАЧЕНИЕ(Документ.СчетФактураПолученный.ПустаяСсылка)";
		Запрос.УстановитьПараметр("Ссылка", ДокОбъект.Ссылка);
		СчетаФактуры = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СчетФактура");
		
		Если СчетаФактуры.Количество() = 0 Тогда
			Возврат Истина;
		КонецЕсли;
	Иначе
		
		СчетаФактуры = Новый Массив;
		Если НайденныйСФ = Неопределено Тогда
			СчетФактура = НайтиПодчиненныйСчетФактуру( ДокОбъект.Ссылка, ВидДокумента);
			НайденныйСФ = СчетФактура;
		Иначе
			СчетФактура = НайденныйСФ;
		КонецЕсли;
		
		Если СчетФактура = Неопределено Тогда
			Возврат Истина;
		КонецЕсли;
		
		СчетаФактуры.Добавить(СчетФактура);
		
	КонецЕсли;
	
	Для каждого СчетФактура Из СчетаФактуры Цикл
		
		Если НЕ ЗначениеЗаполнено(СчетФактура) Тогда
			Продолжить;
		КонецЕсли;
		
		Если СчетФактура.ПометкаУдаления Тогда
			
			ОбщегоНазначения.СообщитьОбОшибке(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru='Документ ""%1"" помечен на удаление. Реквизиты документа автоматически не перезаполнены'"),
					СчетФактура),
					Ложь,
					"",
					СтатусСообщения.Внимание);
					
			Продолжить;
			
		КонецЕсли;
		
		// ЭлектронныеДокументы
		Если ЭлектронныеДокументы.ЕстьРабочийЭСФ(СчетФактура) Тогда
			// Имеется ЭД в актуальном статусе - перезаполнять реквизиты СФ не следует.
			ОбщегоНазначения.СообщитьОбОшибке(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru='На основании документа ""%1"" сформирован ЭД. Реквизиты счета-фактуры автоматически не перезаполнены'"),
					СчетФактура),
					Ложь,
					"",
					СтатусСообщения.Внимание);
			Продолжить;
			
		КонецЕсли;
		// Конец ЭлектронныеДокументы
	
		СчетФактураОбъект = СчетФактура.ПолучитьОбъект();		
		
		Попытка
			СчетФактураОбъект.Заблокировать();
			Если СчетФактураОбъект.ПроверитьЗаполнение() Тогда				
				
				СчетФактураОбъект.ДополнительныеСвойства.Вставить("СообщитьОбИзмененииРеквизитов", Истина);			
				Если ПолучитьВерсиюПостановления(СчетФактураОбъект.Дата) = 2 Тогда
					Если ДокОбъект.Проведен Тогда
	            		Если СчетФактура.Проведен Тогда
							СчетФактураОбъект.Записать(РежимЗаписиДокумента.Проведение);
						Иначе	
							СчетФактураОбъект.Записать();
						КонецЕсли;
					Иначе
						Если СчетФактура.Проведен Тогда
							СчетФактураОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
						Иначе	
							СчетФактураОбъект.Записать();
						КонецЕсли;
					КонецЕсли;
				Иначе
					СчетФактураОбъект.Записать();
				КонецЕсли;
			
			Иначе
				ОбщегоНазначения.СообщитьОбОшибке(
					СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru='Реквизиты документа ""%1"" автоматически не перезаполнены и могут быть неактуальными'"),
						СчетФактура),
					Ложь,
					"",
					СтатусСообщения.Внимание);
			КонецЕсли;
		Исключение
			ОбщегоНазначения.СообщитьОбОшибке(
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru='Реквизиты документа ""%1"" автоматически не перезаполнены и могут быть неактуальными'"),
					СчетФактура),
				Ложь,
				"",
				СтатусСообщения.Внимание);
			Продолжить;
		КонецПопытки;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ДляСчетаФактурыНеТребуетсяКонтрагент(СчетФактура) Экспорт
	
	Возврат ТипЗнч(СчетФактура) = Тип("ДокументСсылка.ОтчетОРозничныхПродажах")
			Или ТипЗнч(СчетФактура) = Тип("ДокументСсылка.ПриходныйКассовыйОрдер")
			Или ТипЗнч(СчетФактура) = Тип("ДокументСсылка.НачислениеНДСпоСМРхозспособом");
			
КонецФункции

Функция ДляСчетаФактурыНеТребуетсяОплата(СчетФактура) Экспорт
	
	Возврат ТипЗнч(СчетФактура) = Тип("ДокументСсылка.ВозвратТоваровПоставщику")
		Или ТипЗнч(СчетФактура) = Тип("ДокументСсылка.ВозвратТоваровПоставщикуИзНТТ") 
		Или ТипЗнч(СчетФактура) = Тип("ДокументСсылка.ОтражениеРеализацииТоваровИУслугНДС")
		Или Не Метаданные.РегистрыНакопления.РасчетыПоРеализацииВУсловныхЕдиницахОрганизации.Измерения.Документ.Тип.СодержитТип(ТипЗнч(СчетФактура));
		
КонецФункции

Функция ПроводитьДокументДляЦелейНДС(СтруктураШапкиДокумента) Экспорт
		
	Если СтруктураШапкиДокумента.Свойство("ОрганизацияПрименяетУСН")
		И СтруктураШапкиДокумента.ОрганизацияПрименяетУСН тогда
		Возврат Ложь;
	ИначеЕсли СтруктураШапкиДокумента.Свойство("ОтражатьВБухгалтерскомУчете")
		И Не СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете Тогда
		Возврат Ложь;
	ИначеЕсли СтруктураШапкиДокумента.Свойство("УчитыватьНДС") 
		И Не СтруктураШапкиДокумента.УчитыватьНДС Тогда
		Возврат Ложь
	Иначе
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

Процедура ДополнитьСтруктуруШапкиДокументаДляНДС(СтруктураШапкиДокумента, ДополнитьПараметрамиПартионногоУчета = Ложь) Экспорт
	
	УчетнаяПолитика = Неопределено;
	
	Если Не СтруктураШапкиДокумента.Свойство("ОрганизацияПрименяетУСН") 
		Или Не СтруктураШапкиДокумента.Свойство("СложныйУчетНДС") Тогда
		
		УчетнаяПолитика = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация);
		
		Если Не СтруктураШапкиДокумента.Свойство("ОрганизацияПрименяетУСН") Тогда
			СтруктураШапкиДокумента.Вставить("ОрганизацияПрименяетУСН", ?(Не ЗначениеЗаполнено(УчетнаяПолитика), 
																		Ложь, УчетнаяПолитика.СистемаНалогообложения = Перечисления.СистемыНалогообложения.Упрощенная));
		КонецЕсли;
	
		Если Не СтруктураШапкиДокумента.Свойство("СложныйУчетНДС") Тогда
			СтруктураШапкиДокумента.Вставить("СложныйУчетНДС", ?(Не ЗначениеЗаполнено(УчетнаяПолитика), 
																Ложь, УчетнаяПолитика.СложныйУчетНДС));
		КонецЕсли;
		
	КонецЕсли;	
	
	Если Не СтруктураШапкиДокумента.Свойство("ИспользуетсяРасширеннаяАналитикаУчета") Тогда
		СтруктураШапкиДокумента.Вставить("ИспользуетсяРасширеннаяАналитикаУчета", УправлениеЗапасами.ИспользуетсяРасширеннаяАналитикаУчета(СтруктураШапкиДокумента.Дата));
	КонецЕсли;
	
	Если ДополнитьПараметрамиПартионногоУчета Тогда
		ДополнитьПараметрамиПартионногоУчетаНДС(СтруктураШапкиДокумента, УчетнаяПолитика)	
	КонецЕсли;
	
КонецПроцедуры

Функция ЕстьСложныйУчетНДСПоНоменклатурнойГруппе(Организация, Дата, НоменклатурнаяГруппа) Экспорт
	
	Отбор = Новый Структура("Организация, НоменклатурнаяГруппа", Организация, НоменклатурнаяГруппа);
	ДанныеПоНоменклатурнойГруппе = РегистрыСведений.НоменклатурныеГруппыДляРеализацииБезНДСиНДС0.ПолучитьПоследнее(Дата, Отбор);
	Возврат ДанныеПоНоменклатурнойГруппе.СложныйУчетНДС;
	
КонецФункции

Функция ВидыЦенностейНалоговыйАгент() Экспорт
	
	ВидыЦенностей_НА = Новый СписокЗначений;
	ВидыЦенностей_НА.Добавить(Перечисления.ВидыЦенностей.НалоговыйАгентАренда);
	ВидыЦенностей_НА.Добавить(Перечисления.ВидыЦенностей.НалоговыйАгентИностранцы);
	ВидыЦенностей_НА.Добавить(Перечисления.ВидыЦенностей.НалоговыйАгентРеализацияИмущества);
	
	Возврат ВидыЦенностей_НА;
	
КонецФункции

Функция СчетОтнесенияНДС(СтруктураШапкиДокумента) Экспорт
	
	Если СтруктураШапкиДокумента.ВидДокумента = "ОтчетОРозничныхПродажах" Тогда 
		Возврат ПланыСчетов.Хозрасчетный.НДС;
	ИначеЕсли СтруктураШапкиДокумента.Дата < '20060101'
		И СтруктураШапкиДокумента.Свойство("МоментОпределенияНалоговойБазыНДС") 
		И СтруктураШапкиДокумента.МоментОпределенияНалоговойБазыНДС = Перечисления.МоментыОпределенияНалоговойБазыНДС.ПоОплате Тогда
		Возврат ПланыСчетов.Хозрасчетный.РасчетыПоНДСотложенномуДляУплатыВБюджет;
	ИначеЕсли СтруктураШапкиДокумента.Свойство("ОтгрузкаБезПереходаПравСобственности")
		И СтруктураШапкиДокумента.ОтгрузкаБезПереходаПравСобственности Тогда
		Возврат ПланыСчетов.Хозрасчетный.НДСНачисленныйПоОтгрузке;
	Иначе
		Возврат ПланыСчетов.Хозрасчетный.НДС;
	КонецЕсли;

КонецФункции

Функция ВидыЦенностиНалоговыйАгентПоступление() Экспорт
	
	ВидыЦенностей = Новый Массив;
	ВидыЦенностей.Добавить(Перечисления.ВидыЦенностей.НалоговыйАгентАренда);
	ВидыЦенностей.Добавить(Перечисления.ВидыЦенностей.НалоговыйАгентРеализацияИмущества);
	ВидыЦенностей.Добавить(Перечисления.ВидыЦенностей.НалоговыйАгентИностранцы);
	
	Возврат ВидыЦенностей;
	
КонецФункции

Функция НалоговыйАгентЗаСчетСобственныхСредств(ВидЦенностиВидДоговора) Экспорт
	
	Если ТипЗнч(ВидЦенностиВидДоговора) = Тип("ПеречислениеСсылка.ВидыЦенностей") Тогда
		Если ВидЦенностиВидДоговора = Перечисления.ВидыЦенностей.НалоговыйАгентИностранцы Тогда
			Возврат Истина;
		Иначе
			Возврат Ложь;
		КонецЕсли;
	Иначе
		Если ВидЦенностиВидДоговора = Перечисления.ВидыАгентскихДоговоров.Нерезидент Тогда
			Возврат Истина;
		Иначе
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
КонецФункции

//////////////////////////////////////////////////////////////////////////
//  ОПЕРАТИВНЫЕ ДВИЖЕНИЯ РЕГИСТРОВ ПОДСИСТЕМЫ НДС

// Формирует список счетов учета косвенных расходов
Функция ОпределитьСчетаУчетаКосвенныхРасходов() Экспорт

	ПланСчетовБУ = ПланыСчетов.Хозрасчетный;
	
	СчетаУчетаЗатрат = Новый СписокЗначений();
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОсновноеПроизводство);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОсновноеПроизводствоНеОблагаемоеЕНВД);
	
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ВспомогательныеПроизводства);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ВспомогательныеПроизводстваНеОблагаемоеЕНВД);
	
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОбщепроизводственныеРасходы);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОбщепроизводственныеРасходыНеОблагаемыеЕНВД);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОбщепроизводственныеРасходыРаспределяемые);
	
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОбщехозяйственныеРасходы);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОбщехозяйственныеРасходыНеОблагаемыеЕНВД);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОбщехозяйственныеРасходыРаспределяемые);
	
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ИздержкиОбращения);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ИздержкиОбращенияНеОблагаемыеЕНВД);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ИздержкиОбращенияРаспределяемые);
	
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.КоммерческиеРасходы);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.КоммерческиеРасходыНеОблагаемыеЕНВД);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.КоммерческиеРасходыРаспределяемые);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Хозрасчетный.Ссылка
	|ИЗ
	|	ПланСчетов.Хозрасчетный КАК Хозрасчетный
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.СчетаУчетаПоДеятельностиЕНВД КАК СчетаУчетаПоДеятельностиЕНВД
	|	ПО
	|		Хозрасчетный.Ссылка = СчетаУчетаПоДеятельностиЕНВД.Счет
	|	
	|ГДЕ
	|	Хозрасчетный.Ссылка В ИЕРАРХИИ(&СписокСчетов)
	|	И Не Хозрасчетный.ЗапретитьИспользоватьВПроводках
	|	И (СчетаУчетаПоДеятельностиЕНВД.Счет ЕСТЬ NULL 
	|	   ИЛИ СчетаУчетаПоДеятельностиЕНВД.ПодлежитРаспределению)
	|";
	
	Запрос.УстановитьПараметр("СписокСчетов",СчетаУчетаЗатрат);
	
	СчетаУчетаЗатрат.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
	Возврат СчетаУчетаЗатрат;

КонецФункции

// Формирует список счетов учета производственных расходов.
//
Функция ОпределитьСчетаУчетаПроизводственныхРасходов() Экспорт

	ПланСчетовБУ = ПланыСчетов.Хозрасчетный;
	
	СчетаУчетаЗатрат = Новый СписокЗначений();
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ОсновноеПроизводство);
	СчетаУчетаЗатрат.Добавить(ПланСчетовБУ.ВспомогательныеПроизводства);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	Хозрасчетный.Ссылка
	               |ИЗ
	               |	ПланСчетов.Хозрасчетный КАК Хозрасчетный
	               |ГДЕ
	               |	Хозрасчетный.Ссылка В ИЕРАРХИИ(&СписокСчетов)";
	
	Запрос.УстановитьПараметр("СписокСчетов",СчетаУчетаЗатрат);
	
	СчетаУчетаЗатрат.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
	Возврат СчетаУчетаЗатрат;

КонецФункции // ОпределитьСчетаУчетаПроизводственныхРасходов()
 
// Формирует список счетов ОС, НМА и объектов строительства
Функция ОпределитьСчетаУчетаОСиНМА(ОбъектыУчета = "", ДатаОбъекта = '00010101') Экспорт

	ПланСчетовБУ = ПланыСчетов.Хозрасчетный;
	
	СчетаУчетаЗатрат = Новый СписокЗначений();
	
	Если ОбъектыУчета = "Оборудование" 
		Или Не ЗначениеЗаполнено(ОбъектыУчета) Тогда
		Если ДатаОбъекта >= '20060101' Тогда
			СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ОборудованиеКУстановке);
		Иначе 
			Возврат СчетаУчетаЗатрат;
		КонецЕсли;
	КонецЕсли;
	
	Если ОбъектыУчета = "ОС" 
		Или Не ЗначениеЗаполнено(ОбъектыУчета) Тогда
		Если ДатаОбъекта < '20060101' Тогда
			СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ОборудованиеКУстановке);
		КонецЕсли;
		СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств);
	КонецЕсли; 
	
	Если ОбъектыУчета ="НМА" 
		Или Не ЗначениеЗаполнено(ОбъектыУчета) Тогда
		СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.ПриобретениеНематериальныхАктивов);
	КонецЕсли;  
	
	Если Не ЗначениеЗаполнено(ОбъектыУчета) тогда
		СчетаУчетаЗатрат.Добавить(ПланыСчетов.Хозрасчетный.СтроительствоОбъектовОсновныхСредств);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Хозрасчетный.Ссылка
		|ИЗ
		|	ПланСчетов.Хозрасчетный КАК Хозрасчетный
		|ГДЕ
		|	Хозрасчетный.Ссылка В ИЕРАРХИИ(&СписокСчетов)
		|	И Хозрасчетный.ЗапретитьИспользоватьВПроводках = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("СписокСчетов",СчетаУчетаЗатрат);
	
	СчетаУчетаЗатрат.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
	Возврат СчетаУчетаЗатрат;

КонецФункции

// Процедура вызывается из модулей документов списания
Процедура СформироватьДвиженияПоРегиструНДСКосвенныеРасходы_СписаниеМатериаловНаКосвенныеРасходы(СтруктураШапкиДокумента, ТаблицаДвиженийПартий, Движения, Отказ)

	УчетнаяПолитикаНУ = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация);
    Если НЕ ЗначениеЗаполнено(УчетнаяПолитикаНУ) Тогда
		Отказ = Истина;
	КонецЕсли; 
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	Если (УчетнаяПолитикаНУ.СистемаНалогообложения = Перечисления.СистемыНалогообложения.Упрощенная) тогда
		// Движения по этому документу делать не нужно
		Возврат;
	КонецЕсли;
	
	Если УчетнаяПолитикаНУ.СложныйУчетНДС Тогда 
		
		СчетаУчетаКосвенныхРасходов = ОпределитьСчетаУчетаКосвенныхРасходов();
		
		ТаблицаДвижений_НДСКосвенныеРасходы	= Движения.ТаблицаДвиженийНДСКосвенныеРасходы;
		
		Для Каждого СтрокаДок Из ТаблицаДвиженийПартий Цикл
			
			Если НЕ ЗначениеЗаполнено(СтрокаДок.СчетФактура) Тогда
				// Обрабатываем только записи с заполненными счетами-фактурами
				Продолжить;
			КонецЕсли;
			
			Если СтрокаДок.СуммаБезНДС = 0 и СтрокаДок.НДС = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Если (СтруктураШапкиДокумента.ВидДокумента = "КомплектацияНоменклатуры") 
			  И ((СтруктураШапкиДокумента.ВидОперации = Перечисления.ВидыОперацийКомплектацияНоменклатуры.ВыпускПродукции)
			  ИЛИ (СтруктураШапкиДокумента.ВидОперации = Перечисления.ВидыОперацийКомплектацияНоменклатуры.ПоступлениеОтПереработчика)) Тогда
				Если СтруктураШапкиДокумента.ВидКомплектации = Перечисления.ВидыКомплектации.Сборка Тогда
					СтатьяЗатрат = СтрокаДок.СтатьяЗатрат;
				Иначе
					СтатьяЗатрат = СтруктураШапкиДокумента.СтатьяЗатрат;
				КонецЕсли;
			Иначе	
				Если Не СтруктураШапкиДокумента.Свойство("СтатьяЗатрат") Тогда
					Если ТаблицаДвиженийПартий.Колонки.Найти("СтатьяЗатрат") <> Неопределено Тогда
						СтатьяЗатрат = СтрокаДок.СтатьяЗатрат;
					Иначе
						ВидыСубконтоСчетаЗатрат = СтруктураШапкиДокумента.СчетЗатрат.ВидыСубконто;
						Для НомерСубконто = 1 По ВидыСубконтоСчетаЗатрат.Количество() Цикл
							Если Не (СтрокаДок["КорСубконтоСписанияБУ" + НомерСубконто] = Неопределено)
								И ТипЗнч(СтрокаДок["КорСубконтоСписанияБУ" + НомерСубконто]) = Тип("СправочникСсылка.СтатьиЗатрат") Тогда
								СтатьяЗатрат = СтрокаДок["КорСубконтоСписанияБУ" + НомерСубконто];
								Прервать;
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				Иначе
					СтатьяЗатрат = СтруктураШапкиДокумента.СтатьяЗатрат;
				КонецЕсли; 
			КонецЕсли;	
			// Если счет учета не соответствует счету учета косвенных расходов, то движения делать не нужно
			Если Не (СчетаУчетаКосвенныхРасходов.НайтиПоЗначению(СтрокаДок.КорСчетБУ) = Неопределено) Тогда
				Если ЗначениеЗаполнено(СтатьяЗатрат)
					Тогда // Необходимо включить запись в состав косвенных расходов для последующего распределения
					
					СтрокаДвиженияКР = ТаблицаДвижений_НДСКосвенныеРасходы.Добавить();
					ЗаполнитьЗначенияСвойств(СтрокаДвиженияКР,СтрокаДок); 
					
					СтрокаДвиженияКР.ОтражатьВНалоговомУчете = СтруктураШапкиДокумента.ОтражатьВНалоговомУчете;
					СтрокаДвиженияКР.Организация	= СтруктураШапкиДокумента.Организация;
					СтрокаДвиженияКР.СтатьяЗатрат 	= СтатьяЗатрат;
					СтрокаДвиженияКР.Заказ 			= СтрокаДок.ЗаказСписания;
					СтрокаДвиженияКР.СчетЗатрат 	= СтрокаДок.КорСчетСписанияБУ;
					
					СтрокаДвиженияКР.Затрата               = СтрокаДок.Номенклатура;
					СтрокаДвиженияКР.ХарактеристикаЗатраты = СтрокаДок.ХарактеристикаНоменклатуры;
					СтрокаДвиженияКР.СерияЗатраты          = СтрокаДок.СерияНоменклатуры;
					
					ВидыСубконтоСчетаЗатрат = СтрокаДок.КорСчетСписанияБУ.ВидыСубконто;
					Для НомерСубконто = 1 По ВидыСубконтоСчетаЗатрат.Количество() Цикл
						Если не (СтрокаДок["КорСубконтоСписанияБУ" + НомерСубконто] = Неопределено) тогда
							СтрокаДвиженияКР["Субконто"+НомерСубконто] = СтрокаДок["КорСубконтоСписанияБУ"+НомерСубконто];
						КонецЕсли; 
					КонецЦикла;
					
					
					Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете Тогда
						СтрокаДвиженияКР.СчетЗатратНУ = СтрокаДок.КорСчетСписанияНУ;
						
						ВидыСубконтоСчетаЗатрат = СтрокаДок.КорСчетСписанияНУ.ВидыСубконто;
						Для НомерСубконто = 1 По ВидыСубконтоСчетаЗатрат.Количество() Цикл
							Если Не (СтрокаДок["КорСубконтоСписанияБУ" + НомерСубконто] = Неопределено) тогда
								СтрокаДвиженияКР["СубконтоНУ"+НомерСубконто] = СтрокаДок["КорСубконтоСписанияБУ"+НомерСубконто];
							КонецЕсли; 
						КонецЦикла;
					КонецЕсли;
					
					СтрокаДвиженияКР.СуммаБезНДС = СтрокаДок.Стоимость - СтрокаДок.НДС;
					СтрокаДвиженияКР.НДС         = СтрокаДок.НДС;
					
				КонецЕсли; 
			КонецЕсли;
		КонецЦикла;
		
		Если ТаблицаДвижений_НДСКосвенныеРасходы.Количество() > 0 тогда
			ТаблицаДвижений_НДСКосвенныеРасходы.ЗаполнитьЗначения(Движения.Период,"Период");
			Движения.Вставить("ИзмененыДвиженияНДСКосвенныеРасходы", Истина);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // СформироватьДвиженияПоРегиструНДСКосвенныеРасходы_СписаниеМатериаловНаКосвенныеРасходы()

Процедура РаспределитьРасходыПоВНАнаСпособыОтраженияРасходовПоАмортизации(СтруктураШапкиДокумента, СтруктураПараметров, ДанныеДляОбработки, Отказ)
	
	Если не СтруктураШапкиДокумента.Свойство("ОрганизацияПрименяетУСН") 
		или не СтруктураШапкиДокумента.Свойство("СложныйУчетНДС")
		Тогда
		УчетнаяПолитика = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация);
		СтруктураШапкиДокумента.Вставить("ОрганизацияПрименяетУСН",(ЗначениеЗаполнено(УчетнаяПолитика) И (УчетнаяПолитика.СистемаНалогообложения = Перечисления.СистемыНалогообложения.Упрощенная)));
		СтруктураШапкиДокумента.Вставить("СложныйУчетНДС",(ЗначениеЗаполнено(УчетнаяПолитика) И УчетнаяПолитика.СложныйУчетНДС));
	КонецЕсли; 
	
	Если СтруктураШапкиДокумента.ОрганизацияПрименяетУСН тогда
		// Движения по этому документу делать не нужно
		Возврат;
	КонецЕсли;

	Если не СтруктураШапкиДокумента.СложныйУчетНДС Тогда
		// Движения по этому документу делать не нужно
		Возврат;
	КонецЕсли;
	
	ЕстьКолонкаСпособОтраженияРасходов = не ДанныеДляОбработки.Колонки.Найти("СпособОтраженияРасходов") = Неопределено;
	ЕстьКолонкаНазначениеИспользования = не ДанныеДляОбработки.Колонки.Найти("НазначениеИспользования") = Неопределено;
	
	Если не (ЕстьКолонкаСпособОтраженияРасходов ИЛИ ЕстьКолонкаНазначениеИспользования) Тогда
		// Отсутствует базис распределения
		Возврат;
	КонецЕсли;
	
	// Отражение списанных партий в составе косвенных расходов
	ТаблицаНДСПартииСписания = ДанныеДляОбработки.СкопироватьКолонки();
	
	БазисРаспределенияПоСпособуОтражения = Новый Соответствие;
	СчетаУчетаКосвенныхРасходов = ОпределитьСчетаУчетаКосвенныхРасходов();
	СчетаУчетаПроизводственныхРасходов = ОпределитьСчетаУчетаПроизводственныхРасходов();
	СтрокиКУдалению = Новый Массив();
	
	ТаблицаНДСПартииСписания.Колонки.Добавить("ТаблицаРаспределенияРасходов");

	Для каждого СтрокаСписания Из ДанныеДляОбработки Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаСписания.СчетФактура) тогда
			Продолжить;
		ИначеЕсли ?(ЕстьКолонкаСпособОтраженияРасходов, Не ЗначениеЗаполнено(СтрокаСписания.СпособОтраженияРасходов),
			Не ЗначениеЗаполнено(СтрокаСписания.НазначениеИспользования))
			тогда
			Продолжить;
		ИначеЕсли СтрокаСписания.Стоимость = 0 и СтрокаСписания.НДС = 0 тогда
			Продолжить;
		КонецЕсли;
		
		СпособОтражения = ?(ЕстьКолонкаСпособОтраженияРасходов, СтрокаСписания.СпособОтраженияРасходов,
										СтрокаСписания.НазначениеИспользования.СпособОтраженияРасходов);
		
		Если БазисРаспределенияПоСпособуОтражения[СпособОтражения] = Неопределено тогда 
			БазисСпособаОтражения = СпособОтражения.Способы.Выгрузить();
			БазисСпособаОтражения.Колонки.Добавить("ОтражатьВСоставеКР", Новый ОписаниеТипов("Булево"));
			БазисСпособаОтражения.Колонки.Добавить("ОтражатьВСоставеПР", Новый ОписаниеТипов("Булево"));
			
			Для каждого СтрокаСпособаОтражения Из БазисСпособаОтражения Цикл
				Если СтрокаСпособаОтражения.Коэффициент = 0 тогда
					Продолжить;
				ИначеЕсли (СчетаУчетаКосвенныхРасходов.НайтиПоЗначению(СтрокаСпособаОтражения.СчетЗатрат) = Неопределено) Тогда
					Продолжить;
				Иначе
					
					НоменклатурнаяГруппа = Неопределено;
					СложныйУчетНДСПоНоменклатурнойГруппе = Ложь;
					Если СчетаУчетаПроизводственныхРасходов.НайтиПоЗначению(СтрокаСпособаОтражения.СчетЗатрат) <> Неопределено Тогда
						НоменклатурнаяГруппа = СтрокаСпособаОтражения.НоменклатурнаяГруппа;
						СложныйУчетНДСПоНоменклатурнойГруппе = ЭтоНоменклатурнаяГруппаДляРеализацииБезНДСиНДС0(СтруктураШапкиДокумента.Организация, НоменклатурнаяГруппа, СтруктураПараметров);
					КонецЕсли;
					
					Если ЗначениеЗаполнено(СтрокаСпособаОтражения.СтатьяЗатрат) 
					   И (СчетаУчетаПроизводственныхРасходов.НайтиПоЗначению(СтрокаСпособаОтражения.СчетЗатрат) = Неопределено
						  ИЛИ СчетаУчетаПроизводственныхРасходов.НайтиПоЗначению(СтрокаСпособаОтражения.СчетЗатрат) <> Неопределено
							  И НЕ ЗначениеЗаполнено(НоменклатурнаяГруппа)) Тогда
			 			// Движения по регистру НДС косвенные расходы
						СтрокаСпособаОтражения.ОтражатьВСоставеКР = Истина;
					ИначеЕсли ЗначениеЗаполнено(СтрокаСпособаОтражения.СтатьяЗатрат) 
						И (СчетаУчетаПроизводственныхРасходов.НайтиПоЗначению(СтрокаСпособаОтражения.СчетЗатрат) <> Неопределено)
						И СложныйУчетНДСПоНоменклатурнойГруппе Тогда
			 			// Движения по регистру НДС незавершенное производство
						СтрокаСпособаОтражения.ОтражатьВСоставеПР = Истина;
					КонецЕсли;

				КонецЕсли; 
			КонецЦикла; 
			
			Если БазисСпособаОтражения.Найти(Истина,"ОтражатьВСоставеКР") = Неопределено Тогда
				БазисРаспределенияПоСпособуОтражения.Вставить(СпособОтражения, Ложь);
			Иначе
				БазисРаспределенияПоСпособуОтражения.Вставить(СпособОтражения, БазисСпособаОтражения);
			КонецЕсли; 
		
		КонецЕсли;
		
		Если БазисРаспределенияПоСпособуОтражения[СпособОтражения] = Ложь тогда
			//Строка не отражается в составе КР
			Продолжить;
		Иначе
			СтрокаКРаспределению = ТаблицаНДСПартииСписания.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаКРаспределению, СтрокаСписания);
			СтрокаКРаспределению.ТаблицаРаспределенияРасходов = БазисРаспределенияПоСпособуОтражения[СпособОтражения].Скопировать();
		КонецЕсли;
	КонецЦикла;
	
	Если ТаблицаНДСПартииСписания.Количество()=0 Тогда
		// Дальнейшая отработка не требуется
		Возврат;
	КонецЕсли;
	
	/////////////////////////////////////////////////////////////////////////////////
	// Подготовка таблицы списания по партиям товаров по данным партионного учета НДС
	СписокРаспределяемыхКолонок = Новый Структура("Стоимость, НДС","Коэффициент","Коэффициент");
	СписокИсключаемыхКолонок = новый Структура("QuieryId,Активность"+
										",ДействияНДСПокупки_ВключитьВСтоимость,ДействияНДСПокупки_ИсключитьИзСтоимости,ДействияНДСПокупки_ПредположениеСтавки0"+
										",ДоговорКонтрагента,ДоговорПоставщика,ДокументОприходования,Количество,Комиссионный"+
										",МоментВремени,Период,Регистратор,СодержаниеПроводки,СписанныеПартииВР,СписанныеПартииПР,СписыватьПоУказаннойСтоимости,СпособОтраженияРасходов,СпособПогашенияСтоимости,Ссылка"+
										",НомерСтроки,Партия, ВидДвижения, СуммаБезНДС");
										

	Для каждого КолонкаРаспределения Из БазисСпособаОтражения.Колонки Цикл
		Если не ТаблицаНДСПартииСписания.Колонки.Найти(КолонкаРаспределения.Имя) = Неопределено Тогда
			ТаблицаНДСПартииСписания.Колонки.Удалить(ТаблицаНДСПартииСписания.Колонки.Найти(КолонкаРаспределения.Имя));
		КонецЕсли; 
	КонецЦикла; 
		
	ТаблицаРасходовКРаспределению = ОбщегоНазначения.РазвернутьПоВложеннойТаблице(ТаблицаНДСПартииСписания, "ТаблицаРаспределенияРасходов",СписокРаспределяемыхКолонок, СписокИсключаемыхКолонок);
	ТаблицаРасходовКРаспределению.Колонки.Удалить(ТаблицаРасходовКРаспределению.Колонки.Подразделение);
	ТаблицаРасходовКРаспределению.Колонки.ПодразделениеОрганизации.Имя = "Подразделение";
	
	Если ТаблицаРасходовКРаспределению.Колонки.Найти("СуммаБезНДС") = Неопределено Тогда
		ТаблицаРасходовКРаспределению.Колонки.Добавить("СуммаБезНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	КонецЕсли; 
	СтрокиКосвенныхРасходов = ТаблицаРасходовКРаспределению.НайтиСтроки(Новый Структура("ОтражатьВСоставеКР", Истина));
	ТаблицаКосвенныхРасходов = РегистрыНакопления.НДСКосвенныеРасходы.СоздатьНаборЗаписей().ВыгрузитьКолонки();
	Для каждого СтрокаКосвенныхРасходов Из СтрокиКосвенныхРасходов Цикл
		СтрокаКосвенныхРасходов.СуммаБезНДС = СтрокаКосвенныхРасходов.Стоимость - СтрокаКосвенныхРасходов.НДС;
		ЗаполнитьЗначенияСвойств(ТаблицаКосвенныхРасходов.Добавить(),СтрокаКосвенныхРасходов);
	КонецЦикла; 

	Если ТаблицаКосвенныхРасходов.Количество()>0 Тогда
		СформироватьДвиженияНДСКосвенныеРасходы(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаКосвенныхРасходов, Отказ,СчетаУчетаКосвенныхРасходов,СчетаУчетаПроизводственныхРасходов);
	КонецЕсли;
	
	СтрокиПроизводственныхРасходов = ТаблицаРасходовКРаспределению.НайтиСтроки(Новый Структура("ОтражатьВСоставеПР", Истина));
	ТаблицаПроизводственныхРасходов = ТаблицаРасходовКРаспределению.СкопироватьКолонки();
	
	Для каждого СтрокаПроизводственныхРасходов Из СтрокиПроизводственныхРасходов Цикл
		СтрокаПроизводственныхРасходов.СуммаБезНДС = СтрокаПроизводственныхРасходов.Стоимость - СтрокаПроизводственныхРасходов.НДС;
		ЗаполнитьЗначенияСвойств(ТаблицаПроизводственныхРасходов.Добавить(),СтрокаПроизводственныхРасходов);
	КонецЦикла; 

	Если ТаблицаПроизводственныхРасходов.Количество()>0 Тогда
		СформироватьДвиженияНДСНезавершенноеПроизводство(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаПроизводственныхРасходов, Отказ);
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьДвиженияНДСКосвенныеРасходы(СтруктураШапкиДокумента, СтруктураПараметров, ДанныеДляОбработки, Отказ,СчетаУчетаКосвенныхРасходов = Неопределено,СчетаУчетаПроизводственныхРасходов = Неопределено)
	
	Если ДанныеДляОбработки.Колонки.Найти("СтатьяЗатрат") = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
	Если не ЗначениеЗаполнено(СчетаУчетаКосвенныхРасходов) Тогда
		СчетаУчетаКосвенныхРасходов				= ОпределитьСчетаУчетаКосвенныхРасходов();
	КонецЕсли; 
	Если не ЗначениеЗаполнено(СчетаУчетаПроизводственныхРасходов) Тогда
		СчетаУчетаПроизводственныхРасходов		= ОпределитьСчетаУчетаПроизводственныхРасходов();
	КонецЕсли; 
	
	ЕстьКолонкаНоменклатурнаяГруппа = не ДанныеДляОбработки.Колонки.Найти("НоменклатурнаяГруппа") = Неопределено;
	
	Для каждого СтрокаДокумента из ДанныеДляОбработки Цикл

		Если ЗначениеЗаполнено(СтрокаДокумента.СтатьяЗатрат) 
		   И (СчетаУчетаПроизводственныхРасходов.НайтиПоЗначению(СтрокаДокумента.СчетЗатрат) = Неопределено
			  ИЛИ СчетаУчетаПроизводственныхРасходов.НайтиПоЗначению(СтрокаДокумента.СчетЗатрат) <> Неопределено
				  И НЕ ?(ЕстьКолонкаНоменклатурнаяГруппа, ЗначениеЗаполнено(СтрокаДокумента.НоменклатурнаяГруппа), Ложь)) Тогда
			
			Движение = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСКосвенныеРасходы", СтруктураПараметров);
			
			ЗаполнитьЗначенияСвойств(Движение,СтрокаДокумента);
			
			Движение.Активность            = Истина;
			Движение.ВидДвижения           = ВидДвиженияНакопления.Приход;
		КонецЕсли;

	КонецЦикла;

КонецПроцедуры//СформироватьДвиженияНДСКосвенныеРасходы()

//////////////////////////////////////////////////////////////////////////
// НДС РЕАЛИЗАЦИИ

// Начисляет НДС при реализации по бухгалтерскому учету
//
// Параметры:
//	Нет.
//
Процедура НачислитьНДСРеализации(НДС, СтрокаДокумента, СтруктураПараметров) Экспорт
	
	// При нулевом НДС проводки не формируем.
	Если НДС=0 Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(СтруктураПараметров) = Тип("Структура") тогда
		ТаблицаДвижений_Хозрасчетный		= СтруктураПараметров.ДвиженияХозрасчетный;
	Иначе
		ТаблицаДвижений_Хозрасчетный		= СтруктураПараметров.Хозрасчетный;
	КонецЕсли;
	
	ВтораяПроводка = ТаблицаДвижений_Хозрасчетный.Добавить();
	ВтораяПроводка.Период        = СтруктураПараметров.Период;
	ВтораяПроводка.Регистратор   = СтруктураПараметров.Регистратор;
	ВтораяПроводка.Активность    = Истина;
	ВтораяПроводка.Содержание = "Реализация";
	ВтораяПроводка.Организация   = СтрокаДокумента.Организация;
	
	// Счет расходов по НДС - могут быть бва варианта субсчет 91 и субсчет 90
	Если БухгалтерскийУчет.ЭтоСубсчет(СтрокаДокумента.КорСчетБУ, ПланыСчетов.Хозрасчетный.ПрочиеДоходыИРасходы) тогда
		ВтораяПроводка.СчетДт = СтрокаДокумента.КорСчетБУ;
		Если ТипЗнч(СтрокаДокумента.КорСубконтоБУ2) = Тип("СправочникСсылка.ПрочиеДоходыИРасходы") Тогда
			БухгалтерскийУчет.УстановитьСубконто(ВтораяПроводка.СчетДт, ВтораяПроводка.СубконтоДт, 1, СтрокаДокумента.КорСубконтоБУ2);
		КонецЕсли;
	Иначе
		ВтораяПроводка.СчетДт = ПланыСчетов.Хозрасчетный.Продажи_НДС;
	КонецЕсли;
	
	Если ТипЗнч(СтрокаДокумента.КорСубконтоБУ2) = Тип("СправочникСсылка.НоменклатурныеГруппы") Тогда
		БухгалтерскийУчет.УстановитьСубконто(ВтораяПроводка.СчетДт, ВтораяПроводка.СубконтоДт, 1, СтрокаДокумента.КорСубконтоБУ2);
	КонецЕсли;
	
	БухгалтерскийУчет.УстановитьСубконто(ВтораяПроводка.СчетДт, ВтораяПроводка.СубконтоДт, 2, СтрокаДокумента.СтавкаНДС);
	
	МоментыОпределенияНалоговойБазыНДС = УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("МоментОпределенияНалоговойБазыНДС", "Бух", СтруктураПараметров);			
	
	// Отчет о розничных продажах должен формировать проводку по отнесению НДС на счет 68 непосредственно,
	// вне зависимости от момента определения налоговой базы для НДС, указанного в учетной политике, так 
	// как при реализации в розницу выручка, отраженная в отчете о розничных продажах сразу считается оплаченной
	Если СтрокаДокумента.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.РеализацияРозница
	   ИЛИ МоментыОпределенияНалоговойБазыНДС = Перечисления.МоментыОпределенияНалоговойБазыНДС.ПоОтгрузке
	   Тогда
			ВтораяПроводка.СчетКт = ПланыСчетов.Хозрасчетный.НДС;
			ВтораяПроводка.СубконтоКт.ВидыПлатежейВГосБюджет = Перечисления.ВидыПлатежейВГосБюджет.Налог;
	Иначе
			ВтораяПроводка.СчетКт = ПланыСчетов.Хозрасчетный.РасчетыПоНДСотложенномуДляУплатыВБюджет;
			ВтораяПроводка.СубконтоКт.Контрагенты = СтрокаДокумента.КорСубконтоЗадолженностиБУ1;
			ВтораяПроводка.СубконтоКт.СФВыданные  = СтруктураПараметров.Регистратор;
	КонецЕсли;
	
	ВтораяПроводка.Сумма = НДС;
	
КонецПроцедуры // НачислитьНДСРеализации()

////////////////////////////////////////////////////////////////////////////////////////////////////
//  ОТРАЖЕНИЕ Предположения ставки 0% при реализации

Процедура ОтразитьПредположениеСтавки0(СтруктураШапкиДокумента, ТаблицаСписания, СтруктураПараметров, Заголовок) Экспорт

	Если ТипЗнч(СтруктураШапкиДокумента.Ссылка) = Тип("ДокументСсылка.РеализацияОтгруженныхТоваров")
		И СтруктураШапкиДокумента.НачислятьНДСПоОтгрузке Тогда
		Возврат;
	КонецЕсли;
	
	Построитель_ТаблицаСписания = Новый ПостроительЗапроса();
	ОписаниеИсточника_ТаблицаСписания = Новый ОписаниеИсточникаДанных(ТаблицаСписания);
	Построитель_ТаблицаСписания.ИсточникДанных = ОписаниеИсточника_ТаблицаСписания;
	Отбор = Построитель_ТаблицаСписания.Отбор;
	
	Отбор.Добавить("ДействияНДСПокупки_ПредположениеСтавки0");
	Отбор["ДействияНДСПокупки_ПредположениеСтавки0"].Значение = Истина;
	Отбор["ДействияНДСПокупки_ПредположениеСтавки0"].Использование = Истина;
	
	Построитель_ТаблицаСписания.Выполнить();
	ДанныеДляОбработки = Построитель_ТаблицаСписания.Результат.Выгрузить();
	Если ДанныеДляОбработки.Колонки.Найти("СуммаБезНДС") = Неопределено тогда	
		ДанныеДляОбработки.Колонки.Добавить("СуммаБезНДС",Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	КонецЕсли; 
	
	Если ДанныеДляОбработки.Количество()>0 Тогда
		СтрокиКУдалению = новый Массив();
		Для каждого СтрокаТаблицы Из ДанныеДляОбработки Цикл
			Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.СчетФактура) Тогда
				СтрокиКУдалению.Добавить(СтрокаТаблицы);
			КонецЕсли; 
		КонецЦикла; 
		Для каждого СтрокаКУдалению Из СтрокиКУдалению Цикл
			ДанныеДляОбработки.Удалить(СтрокаКУдалению);
		КонецЦикла; 
	КонецЕсли;
	
	Если ДанныеДляОбработки.Количество() = 0 Тогда
		//Отражение предположения 0% по данному набору не требуется
		Возврат;
	КонецЕсли; 
	
	Для каждого СтрокаОбрабатываемая  Из ДанныеДляОбработки Цикл
		СтрокаОбрабатываемая.СуммаБезНДС = СтрокаОбрабатываемая.Стоимость - СтрокаОбрабатываемая.НДС;
	КонецЦикла; 
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация",  СтруктураШапкиДокумента.Организация);
	Запрос.УстановитьПараметр("СчетаФактуры",       ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(ДанныеДляОбработки.ВыгрузитьКолонку("СчетФактура")));
	Запрос.УстановитьПараметр("ПустойКонтрагент",   Справочники.Контрагенты.ПустаяСсылка());
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НДСПредъявленныйОбороты.Поставщик,
	|	НДСПредъявленныйОбороты.СчетФактура
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный.Обороты(
	|		,
	|		,
	|		,
	|		Организация = &Организация
	|		    И СчетФактура В (&СчетаФактуры)) КАК НДСПредъявленныйОбороты
	|ГДЕ
	|	НДСПредъявленныйОбороты.Поставщик <> &ПустойКонтрагент";
	
	КонтрагентПоСчетуФактуре = Запрос.Выполнить().Выгрузить();
	ДанныеДляОбработки.Колонки.Добавить("Поставщик");
	Для каждого СтрокаОбрабатываемая  Из ДанныеДляОбработки Цикл
		СтрокаКонтрагента = КонтрагентПоСчетуФактуре.Найти(СтрокаОбрабатываемая.СчетФактура,"СчетФактура");
		Если не СтрокаКонтрагента = Неопределено Тогда
		    СтрокаОбрабатываемая.Поставщик = СтрокаКонтрагента.Поставщик;
		КонецЕсли; 
	КонецЦикла;
	
	ДанныеДляОбработки.Колонки.Добавить("Событие");
	ДанныеДляОбработки.ЗаполнитьЗначения(Перечисления.СобытияПоНДСПокупки.ПредполагаетсяСтавка0,"Событие");
	
	Если ДанныеДляОбработки.Колонки.Найти("ДокументОтгрузки") = неопределено Тогда
	 	ДанныеДляОбработки.Колонки.Добавить("ДокументОтгрузки");
	КонецЕсли; 
	
	ДанныеДляОбработки.ЗаполнитьЗначения(СтруктураШапкиДокумента.Ссылка,"ДокументОтгрузки");

	Если ДанныеДляОбработки.Колонки.Найти("ВидДвижения") = неопределено Тогда
	 	ДанныеДляОбработки.Колонки.Добавить("ВидДвижения");
	КонецЕсли; 
	
	ДанныеДляОбработки.ЗаполнитьЗначения(ВидДвиженияНакопления.Приход,"ВидДвижения");
	
	// Отразить в регистре НДСПредъявленныйРеализация0
	
	Если ДанныеДляОбработки.Колонки.Найти("Состояние") = неопределено Тогда
	 	ДанныеДляОбработки.Колонки.Добавить("Состояние");
	КонецЕсли;
	ДанныеДляОбработки.ЗаполнитьЗначения(Перечисления.НДССостоянияРеализация0.ОжидаетсяПодтверждение,"Состояние");
	
	Для каждого СтрокаСписания Из ДанныеДляОбработки Цикл
		Если СтруктураШапкиДокумента.ВидДокумента = "ВозвратТоваровОтПокупателя" Тогда
			Если ЗначениеЗаполнено(СтрокаСписания.ДокументПередачи) Тогда
				СтрокаСписания.ДокументОтгрузки = СтрокаСписания.ДокументПередачи;
			КонецЕсли; 
		КонецЕсли; 
		Движение = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПредъявленныйРеализация0",СтруктураПараметров);
		ЗаполнитьЗначенияСвойств(Движение,СтрокаСписания);
	КонецЦикла; //Для каждого СтрокаСписания Из ДанныеДляОбработки Цикл
	
	////////////////////////////////////////////////////////
	// Движения по НДС партии и по регистру бухгалтерии

	Для каждого СтрокаСписания Из ДанныеДляОбработки Цикл
		СформироватьПроводкиПоПредположениюСтавки0(СтруктураШапкиДокумента, СтрокаСписания, СтруктураПараметров.ДвиженияХозрасчетный, Заголовок);
	КонецЦикла; //Для каждого СтрокаСписания Из ДанныеДляОбработки Цикл
	// Движения по НДС партии и по регистру бухгалтерии
	////////////////////////////////////////////////////////
	
КонецПроцедуры // ОтразитьПредположениеСтавки0()

Процедура СформироватьПроводкиПоПредположениюСтавки0(СтруктураШапкиДокумента,СтрокаДвижения, НаборДвиженийХозрасчетный,Заголовок)
	Если НЕ ЗначениеЗаполнено(СтрокаДвижения.НДС) тогда
		//Формирование проводки не требуется
		Возврат;
	ИначеЕсли (НЕ ЗначениеЗаполнено(СтрокаДвижения.СчетУчетаНДС))
	 Тогда
		// Недостаточно данных для формирования проводки по данной строке
		ОбщегоНазначения.СообщитьОбОшибке("Не хватает данных для формирования проводки по отнесению НДС на счет учета НДС по товарам реализованным по ставке 0% (экспорт).",, Заголовок,СтатусСообщения.Внимание);
		Возврат;
	КонецЕсли;

	// отразим факт включения НДС в стоимость соотвествующей проводкой 
	СтрокаДвиженияПроводка = НаборДвиженийХозрасчетный.Добавить();
	
	// проводка, отражающая включение НДС в стоимость
	СтрокаДвиженияПроводка.СчетДт = ПланыСчетов.Хозрасчетный.НДСПоТоварамРеализованнымПоСтавке0; 
	БухгалтерскийУчет.УстановитьСубконто(СтрокаДвиженияПроводка.СчетДт, СтрокаДвиженияПроводка.СубконтоДт, "Контрагенты", СтрокаДвижения.Поставщик);
	БухгалтерскийУчет.УстановитьСубконто(СтрокаДвиженияПроводка.СчетДт, СтрокаДвиженияПроводка.СубконтоДт, "СФПолученные", СтрокаДвижения.СчетФактура);
	БухгалтерскийУчет.УстановитьСубконто(СтрокаДвиженияПроводка.СчетДт, СтрокаДвиженияПроводка.СубконтоДт, "ДокументыРеализации", СтрокаДвижения.ДокументОтгрузки);

	СтрокаДвиженияПроводка.СчетКт = СтрокаДвижения.СчетУчетаНДС; // 19.хх
	БухгалтерскийУчет.УстановитьСубконто(СтрокаДвиженияПроводка.СчетКт, СтрокаДвиженияПроводка.СубконтоКт, "Контрагенты", СтрокаДвижения.Поставщик);
	БухгалтерскийУчет.УстановитьСубконто(СтрокаДвиженияПроводка.СчетКт, СтрокаДвиженияПроводка.СубконтоКт, "СФПолученные", СтрокаДвижения.СчетФактура);

	СтрокаДвиженияПроводка.Содержание = "В связи с применением НДС 0% по реализации";
	СтрокаДвиженияПроводка.Сумма        = СтрокаДвижения.НДС;

	СтрокаДвиженияПроводка.Период       = СтруктураШапкиДокумента.Дата;
	СтрокаДвиженияПроводка.Организация  = СтрокаДвижения.Организация;
	СтрокаДвиженияПроводка.НомерЖурнала = "НДС";
	СтрокаДвиженияПроводка.НДСПродукции = Истина;
	
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////
//  ДВИЖЕНИЯ ПО НДС ПРИ ИСПОЛЕНИИ КОМИССИОНЕРОМ ОБЯЗАННОСТЕЙ НАЛОГОВОГО АГЕНТА

Процедура ОтразитьНДСНалоговогоАгентаКомиссионер(СтруктураШапкиДокумента, ТаблицаВыручки, Движения)
	
	Если СтруктураШапкиДокумента.УчитыватьНДС Тогда
		Для Каждого СтрокаТаблицы Из ТаблицаВыручки Цикл
			ОтражатьНДСКомитента = СтруктураШапкиДокумента.Дата >= '20060101000000' И СтрокаТаблицы.Комиссионный И СтрокаТаблицы.ДоговорКомиссии.УчетАгентскогоНДС;
			Если ОтражатьНДСКомитента Тогда
				
				// Нужно дополнительно сформировать проводку по начислению НДС налогового агента
				Если ТипЗнч(Движения) = Тип("Структура") тогда
					Проводка = Движения.ДвиженияХозрасчетный.Добавить();
				Иначе	
					Проводка = Движения.Хозрасчетный.Добавить();
				КонецЕсли;

				Проводка.Период 		= СтруктураШапкиДокумента.Дата;
				Проводка.Организация	= СтруктураШапкиДокумента.Организация;
				Проводка.Содержание 	= "Начислен НДС в качестве налогового агента";

				Проводка.СчетДт			= СтрокаТаблицы.СчетРасчетовСКомитентом;
				Если ТаблицаВыручки.Колонки.Найти("Комитент") <> Неопределено Тогда
					БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Контрагенты", СтрокаТаблицы.Комитент);
				Иначе
					БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Контрагенты", СтрокаТаблицы.ДоговорКомиссии.Владелец);
				КонецЕсли;
				БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Договоры", СтрокаТаблицы.ДоговорКомиссии);
				
				Проводка.СчетКт			= ПланыСчетов.Хозрасчетный.НДС;
				БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"ВидыПлатежейВГосБюджет", Перечисления.ВидыПлатежейВГосБюджет.Налог);
									
				Проводка.Сумма			= СтрокаТаблицы.НДС;
				
				Если СтрокаТаблицы.СчетРасчетовСКомитентом.Валютный Тогда
					ВалютаРасчетовСКомитентом = СтрокаТаблицы.ДоговорКомиссии.ВалютаВзаиморасчетов;
					Проводка.ВалютаДт        = ВалютаРасчетовСКомитентом;
					Если ВалютаРасчетовСКомитентом = СтруктураШапкиДокумента.ВалютаВзаиморасчетов Тогда
						Проводка.ВалютнаяСуммаДт = СтрокаТаблицы.КорВалютнаяСуммаНДСЗадолженностиБУ;
					Иначе
						ВалютаРасчетовСКомитентом_КурсКратность = МодульВалютногоУчета.ПолучитьКурсВалюты(ВалютаРасчетовСКомитентом, СтруктураШапкиДокумента.Дата);
						Проводка.ВалютнаяСуммаДт = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(СтрокаТаблицы.НДС,
																			СтруктураШапкиДокумента.ВалютаРегламентированногоУчета,
																			ВалютаРасчетовСКомитентом,
																			1,ВалютаРасчетовСКомитентом_КурсКратность.Курс, 
																			1,ВалютаРасчетовСКомитентом_КурсКратность.Кратность);
					КонецЕсли; 
				КонецЕсли;
									
				
			КонецЕсли;
			
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////////////////////////
//  ОТРАЖЕНИЯ ДВИЖЕНИЙ СВЯЗАННЫХ С ОБЪЕКТАМИ СТРОИТЕЛЬСТВА, ОС И НМА

Процедура СформироватьДвиженияПоРегиструНДСпоОСиНМА_СписаниеМатериаловНаОСиНМА(СтруктураШапкиДокумента, ТаблицаДвиженийПартий, Движения, Отказ)

	УчетнаяПолитикаНУ = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация);
	Если НЕ ЗначениеЗаполнено(УчетнаяПолитикаНУ) Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если (УчетнаяПолитикаНУ.СистемаНалогообложения = Перечисления.СистемыНалогообложения.Упрощенная) тогда
		// Движения по этому документу делать не нужно
		Возврат;
	КонецЕсли;
	
	ТаблицаДвижений_НДСпоОСиНМА	= Движения.ТаблицаДвиженийНДСпоОСиНМА;

	ТаблицаДвижений_НДСпоОСиНМА.Колонки.СуммаБезНДС.Имя = "Стоимость";
	
	ОсобыеУсловияБлокировкиВычета2006 = (СтруктураШапкиДокумента.Дата >= '20060101');
	Если ОсобыеУсловияБлокировкиВычета2006 Тогда
		ВидыЦенностей_ВычетБлокируется = новый СписокЗначений();
		ВидыЦенностей_ВычетБлокируется.Добавить(Перечисления.ВидыЦенностей.ОС);
		ВидыЦенностей_ВычетБлокируется.Добавить(Перечисления.ВидыЦенностей.Оборудование);
		ВидыЦенностей_ВычетБлокируется.Добавить(Перечисления.ВидыЦенностей.ТаможенныеПлатежиОС);
	КонецЕсли; 
	
	Для каждого СтрокаТаблицыДвиженияПартий из ТаблицаДвиженийПартий Цикл

		Если НЕ ЗначениеЗаполнено(СтрокаТаблицыДвиженияПартий.СчетФактура) Тогда
			// Обрабатываем только записи с заполненными счетами-фактурами
			Продолжить;
		КонецЕсли;
		
		Если не ТаблицаДвиженийПартий.Колонки.Найти("ОбъектСтроительства")=Неопределено 
			и ЗначениеЗаполнено(СтрокаТаблицыДвиженияПартий.ОбъектСтроительства)
			Тогда
			ОбъектОСиНМА = СтрокаТаблицыДвиженияПартий.ОбъектСтроительства;
			Состояние 	= Перечисления.НДССостоянияОСНМА.ОжидаетсяПринятиеКУчетуОбъектаСтроительства;
			Событие		= Перечисления.СобытияПоНДСПокупки.ПереданНДСНаСтроительство;
       Иначе
			ВидыСубконтоСчетаЗатрат = СтрокаТаблицыДвиженияПартий.КорСчетСписанияБУ.ВидыСубконто;
			Для НомерСубконто = 1 По ВидыСубконтоСчетаЗатрат.Количество() Цикл
				Если Не (СтрокаТаблицыДвиженияПартий["КорСубконтоСписанияБУ" + НомерСубконто] = Неопределено) Тогда
					Если (ТипЗнч(СтрокаТаблицыДвиженияПартий["КорСубконтоСписанияБУ" + НомерСубконто]) = Тип("СправочникСсылка.ОбъектыСтроительства")) Тогда
						ОбъектОСиНМА = СтрокаТаблицыДвиженияПартий["КорСубконтоСписанияБУ" + НомерСубконто];
						Состояние 	= Перечисления.НДССостоянияОСНМА.ОжидаетсяПринятиеКУчетуОбъектаСтроительства;
						Событие		= Перечисления.СобытияПоНДСПокупки.ПереданНДСНаСтроительство;
						Прервать;
					ИначеЕсли (ТипЗнч(СтрокаТаблицыДвиженияПартий["КорСубконтоСписанияБУ" + НомерСубконто]) = Тип("СправочникСсылка.НематериальныеАктивы")) Тогда
						ОбъектОСиНМА = СтрокаТаблицыДвиженияПартий["КорСубконтоСписанияБУ" + НомерСубконто];
						Состояние 	= Перечисления.НДССостоянияОСНМА.ОжидаетсяВводВЭксплуатацию;
						Событие		= Перечисления.СобытияПоНДСПокупки.ОСВведеноВЭксплуатацию;
						Прервать;
					КонецЕсли;	
				КонецЕсли; 
			КонецЦикла;
		КонецЕсли;
		
		Если ОбъектОСиНМА = Справочники.ОбъектыСтроительства.ПустаяСсылка() Тогда
			ОбщегоНазначения.СообщитьОбОшибке("Объект строительства не указан!");
		ИначеЕсли ОбъектОСиНМА = Справочники.НематериальныеАктивы.ПустаяСсылка() Тогда
			ОбщегоНазначения.СообщитьОбОшибке("Объект НМА не указан!");
		ИначеЕсли ОбъектОСиНМА = Неопределено Тогда
			//В структуре шапки нет объекта строительства или НМА
			Продолжить;
		КонецЕсли;	
		
		
		
		СтрокаТаблицыДвижений_НДСпоОСиНМА = ТаблицаДвижений_НДСпоОСиНМА.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаТаблицыДвижений_НДСпоОСиНМА,СтрокаТаблицыДвиженияПартий);
		
		// Колонка Стоимость у нас будет фактически колонкой СуммаБезНДС рег. НДСпоОСиНМА
		СтрокаТаблицыДвижений_НДСпоОСиНМА.Стоимость = СтрокаТаблицыДвижений_НДСпоОСиНМА.Стоимость - СтрокаТаблицыДвижений_НДСпоОСиНМА.НДС;
		
		Если ОсобыеУсловияБлокировкиВычета2006 Тогда
			СтрокаТаблицыДвижений_НДСпоОСиНМА.НеВлияетНаВычет = (ВидыЦенностей_ВычетБлокируется.НайтиПоЗначению(СтрокаТаблицыДвижений_НДСпоОСиНМА.ВидЦенности) = неопределено);
		КонецЕсли; 
		
		СтрокаТаблицыДвижений_НДСпоОСиНМА.Объект = ОбъектОСиНМА;
		СтрокаТаблицыДвижений_НДСпоОСиНМА.Состояние = Состояние;
		СтрокаТаблицыДвижений_НДСпоОСиНМА.Событие = Событие;
		
	КонецЦикла;
	
	ТаблицаДвижений_НДСпоОСиНМА.Колонки.Стоимость.Имя = "СуммаБезНДС";

	Если ТаблицаДвижений_НДСпоОСиНМА.Количество() > 0 тогда
		ТаблицаДвижений_НДСпоОСиНМА.ЗаполнитьЗначения(Движения.Период,"Период");
		Движения.Вставить("ИзмененыДвиженияНДСпоОСиНМА", Истина);
	КонецЕсли;
	
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////
// НДС ПРОИЗВОДСТВА

Процедура СформироватьДвиженияНДСНезавершенноеПроизводство(СтруктураШапкиДокумента, СтруктураПараметров, ДанныеДляОбработки, Отказ)
	
	Если Не УправлениеЗапасами.ИспользуетсяРасширеннаяАналитикаУчета(СтруктураШапкиДокумента.Дата) Тогда
	
		ТаблицаНДСКосвенныеРасходы = ДанныеДляОбработки.СкопироватьКолонки();
	
		Для каждого СтрокаДокумента из ДанныеДляОбработки Цикл

			Если ЭтоНоменклатурнаяГруппаДляРеализацииБезНДСиНДС0(СтрокаДокумента.Организация, СтрокаДокумента.НоменклатурнаяГруппа, СтруктураПараметров) Тогда
				
				Движение = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСНезавершенноеПроизводство", СтруктураПараметров);
				
				ЗаполнитьЗначенияСвойств(Движение,СтрокаДокумента);
				
				Движение.Активность            = Истина;
				Движение.ВидДвижения           = ВидДвиженияНакопления.Приход;
				Движение.СчетУчета             = СтрокаДокумента.КорСчетБУ;
				Движение.Затрата               = СтрокаДокумента.Номенклатура;
				Движение.ХарактеристикаЗатраты = СтрокаДокумента.ХарактеристикаНоменклатуры;
				Движение.КодОперации           = Перечисления.КодыОперацийНезавершенноеПроизводство.СписаниеПартийВПроизводствоОперативно;
				
				СтруктураРеквизитов = Новый Структура("ВестиУчетПоСериямВНЗП");
				УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтрокаДокумента.Номенклатура, СтруктураРеквизитов);
		
				Если СтруктураРеквизитов.ВестиУчетПоСериямВНЗП Тогда
					Движение.СерияЗатраты = СтрокаДокумента.СерияНоменклатуры;
				КонецЕсли;
				
				Если ЗначениеЗаполнено(СтрокаДокумента.ЗаказСписания) Тогда
					Движение.Заказ = СтрокаДокумента.ЗаказСписания;
				ИначеЕсли ЗначениеЗаполнено(СтрокаДокумента.Заказ) Тогда
					Движение.Заказ = СтрокаДокумента.Заказ;
				Иначе
					Движение.Заказ = Неопределено;
				КонецЕсли;
			ИначеЕсли НЕ ЗначениеЗаполнено(СтрокаДокумента.НоменклатурнаяГруппа) тогда
				НоваяСтрока = ТаблицаНДСКосвенныеРасходы.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрокаДокумента);
			КонецЕсли;

		КонецЦикла;
		
	Иначе
		
		ТаблицаНДСКосвенныеРасходы = ДанныеДляОбработки.Скопировать();

	КонецЕсли;
	
	Если ТаблицаНДСКосвенныеРасходы.Количество() > 0 тогда
		// Списываем на косвенные расходы
		СформироватьДвиженияПоРегиструНДСКосвенныеРасходы_СписаниеМатериаловНаКосвенныеРасходы(СтруктураШапкиДокумента, ТаблицаНДСКосвенныеРасходы, СтруктураПараметров, Отказ);	
	КонецЕсли;

КонецПроцедуры//СформироватьДвиженияНДСНезавершенноеПроизводство()

// Возвращает признак принадлежности номенклатурной группы к реализации по ставке 0% и без НДС
//
// Параметры:
//	Нет.
//
// Возвращаемое значение:
//	
//
Функция ЭтоНоменклатурнаяГруппаДляРеализацииБезНДСиНДС0(Организация, НоменклатурнаяГруппа, СтруктураПараметров) Экспорт
	
	Возврат СтруктураПараметров.НоменклатурныеГруппыДляРеализацииБезНДСиНДС0.НайтиСтроки(Новый Структура("НоменклатурнаяГруппа, Организация", НоменклатурнаяГруппа, Организация)).Количество()>0;
	
КонецФункции // ЭтоНоменклатурнаяГруппаДляРеализацииБезНДСиНДС0(СтрокаДокумента.НоменклатурнаяГруппа, СтруктураПараметров)

// Возвращает номенклатурные группы для реализации по ставке 0% и без НДС 
//
// Параметры:
//	Нет.
//
// Возвращаемое значение:
//	ТаблицаЗначений
//
Функция ПолучитьНоменклатурныеГруппыДляРеализацииБезНДСиНДС0(ДатаКон, МассивОрганизаций, СтруктураПараметров) Экспорт
	
	Инд=0;
	Если ТипЗнч(МассивОрганизаций) = Тип("Массив") Тогда
		Пока Инд<МассивОрганизаций.Количество() Цикл
			Если УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СложныйУчетНДС", "Нал", СтруктураПараметров)=Ложь Тогда
				МассивОрганизаций.Удалить(Инд);
			Иначе
				Инд=Инд+1;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	НоменклатурныеГруппыДляРеализацииБезНДСиНДС0СрезПоследних.Организация,
	|	НоменклатурныеГруппыДляРеализацииБезНДСиНДС0СрезПоследних.НоменклатурнаяГруппа
	|ИЗ
	|	РегистрСведений.НоменклатурныеГруппыДляРеализацииБезНДСиНДС0.СрезПоследних(&ДатаКон, Организация В (&МассивОрганизаций)) КАК НоменклатурныеГруппыДляРеализацииБезНДСиНДС0СрезПоследних
	|
	|ГДЕ
	|	(НоменклатурныеГруппыДляРеализацииБезНДСиНДС0СрезПоследних.СложныйУчетНДС = ИСТИНА)");
	
	Запрос.УстановитьПараметр("ДатаКон", ДатаКон);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции // ПолучитьНоменклатурныеГруппыДляРеализацииБезНДСиНДС0()

//////////////////////////////////////////////////////////////////////////
// ВОЗВРАТ ТОВАРОВ ПОСТАВЩИКУ

Процедура ДвиженияВозвратаТоваровПоставщикуПоРегистрамПодсистемыНДС(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаПартий, ТаблицаВозвратов, Отказ, Заголовок)

	Если не СтруктураШапкиДокумента.УчитыватьНДС Тогда
		Возврат;
	ИначеЕсли СтруктураШапкиДокумента.ОрганизацияПрименяетУСН тогда
		// Движения по этому документу делать не нужно
		Возврат;
	ИначеЕсли ТаблицаВозвратов.Количество()=0 Тогда
		// Возврат товаров не осуществлялся
		Возврат;
	ИначеЕсли СтруктураШапкиДокумента.Свойство("ВидОперации") и СтруктураШапкиДокумента.ВидОперации = Перечисления.ВидыОперацийВозвратТоваровПоставщику.ИзПереработки Тогда
		// Это не наши ценности (были даны в переработку), следовательно НДС по ним учитывать не нужно
		Возврат;
	ИначеЕсли СтруктураШапкиДокумента.ДоговорКонтрагента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомитентом Тогда
		// Это не наши ценности (договор комиссии), следовательно НДС по ним отражать не нужно
		Возврат;
	КонецЕсли;
	
	СчетНДС = ПланыСчетов.Хозрасчетный.НДС;
	
	
	ТаблицаПоПартиямБУ = РаспределитьПартииПоТаблицеСписания(ТаблицаПартий, ТаблицаВозвратов, СтруктураШапкиДокумента, СтруктураПараметров);
	
	ТаблицаПоПартиямБУ.Колонки.Добавить("НомерСтрокиТаблицыПоПартиямБУ", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(10,0)));
	
	НомерСтроки = 0;
	Для каждого СтрокаПартииБУ Из ТаблицаПоПартиямБУ Цикл
		НомерСтроки = НомерСтроки +1;
		СтрокаПартииБУ.НомерСтрокиТаблицыПоПартиямБУ = НомерСтроки;
	КонецЦикла; 
	
	//////////////////////////////////////////////////////////////////////////
	// Попытка списания товаров по партионному учету НДС
		
	/////////////////////////////////////////////////////////////////////////////////
	
	//При учете "По средней" или если партионный учет по БУ не ведется - партия может быть незаполнена.
	Если ТаблицаПоПартиямБУ.Колонки.Найти("Партия") = Неопределено Тогда
		ТаблицаПоПартиямБУ.Колонки.Добавить("Партия");
	КонецЕсли; 
	
	ТаблицаНДСПартииСписания = ОпределитьПартииСписанияПоРегиструНДСПартии(СтруктураШапкиДокумента, ТаблицаПоПартиямБУ.Скопировать(), Отказ, Заголовок, Истина, Ложь, СтруктураПараметров);
	// Подготовка таблицы списания по партиям товаров по данным партионного учета НДС
	/////////////////////////////////////////////////////////////////////////////////

	/////////////////////////////////////////////////////////////////////////////////
	// НДС по партиям - отразить непосредственое списание.
	Если не ТаблицаНДСПартииСписания.Количество() = 0 Тогда
		//Партии найдены (хотя бы частично). Отразим в партионном учете НДС.
		ТаблицаДвиженийПартии = СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров;
		СтруктураПараметров.Вставить("ИзмененыДвиженияНДСПартииТоваров", Истина);
		
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаНДСПартииСписания, ТаблицаДвиженийПартии);
		ТаблицаДвиженийПартии.ЗаполнитьЗначения(СтруктураПараметров.Период,"Период");
		
		// Делаем не расход, а сторно прихода по регистру.
		Для каждого СтрокаПартии Из ТаблицаДвиженийПартии Цикл
			СтрокаПартии.Стоимость	= - СтрокаПартии.Стоимость;
			СтрокаПартии.НДС		= - СтрокаПартии.НДС;
			СтрокаПартии.Количество	= - СтрокаПартии.Количество;
		КонецЦикла; 
		
		/////////////////////////////////////////////////////////////////////////////////
		// НДС по ОС - ТМЦ могли принадлежать к будущим ОС,
		// в этом случае при возврате необходимо снять блокировку с вычета.
		УчетНДСФормированиеДвижений.СформироватьДвиженияПоРегиструНДСпоОСиНМА_ПеремещениеОборудования(СтруктураШапкиДокумента, ТаблицаДвиженийПартии, СтруктураПараметров, Отказ);
		// НДС по ОС
		/////////////////////////////////////////////////////////////////////////////////
		
	КонецЕсли; 
	// НДС по партиям - отразить непосредственое списание.
	///////////////////////////
	СуммаНДСПоСтрокам = ОбщегоНазначения.СформироватьТаблицуЗначений(ТаблицаПоПартиямБУ,Новый структура("НомерСтрокиТаблицыПоПартиямБУ, НДС,СуммаБезНДС"));
	
	ТаблицаПроводокПоНДС = Новый ТаблицаЗначений();
	ТаблицаПроводокПоНДС.Колонки.Добавить("НомерСтрокиДокумента", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(10,0)));
	ТаблицаПроводокПоНДС.Колонки.Добавить("НомерСтрокиТаблицыПоПартиямБУ", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(10,0)));
	ТаблицаПроводокПоНДС.Колонки.Добавить("СчетФактура");
	ТаблицаПроводокПоНДС.Колонки.Добавить("Поставщик", Новый ОписаниеТИпов("СправочникСсылка.Контрагенты"));
	ТаблицаПроводокПоНДС.Колонки.Добавить("СчетУчетаНДС");
	ТаблицаПроводокПоНДС.Колонки.Добавить("НДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаПроводокПоНДС.Колонки.Добавить("НДСВал", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	// Попытка списания товаров по партионному учету НДС
	//////////////////////////////////////////////////////////////////////////
	
	СокращеннаяТаблицаСФВозвратов = ТаблицаНДСПартииСписания.Скопировать();
	СокращеннаяТаблицаСФВозвратов.Свернуть("НомерСтрокиДокумента, НомерСтрокиТаблицыПоПартиямБУ, СчетФактура,Номенклатура,ВидЦенности, СтавкаНДС, НДСВключенВСтоимость,СчетУчетаНДС, ДокументПартии, ПартияСовпадаетСУказаннымДокументомДляВозврата","Количество,Стоимость, НДС,КорВалютнаяСуммаНДСЗадолженностиБУ");
	СокращеннаяТаблицаСФВозвратов.Колонки.Добавить("СуммаБезНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	
	// Определение поставщика по счету-фактуре
	Если СокращеннаяТаблицаСФВозвратов.Количество()>0 Тогда
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Организация",  СтруктураШапкиДокумента.Организация);
		Запрос.УстановитьПараметр("СчетаФактуры",       ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(СокращеннаяТаблицаСФВозвратов.ВыгрузитьКолонку("СчетФактура"),Истина));
		Запрос.УстановитьПараметр("ПустойКонтрагент",   Справочники.Контрагенты.ПустаяСсылка());
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	НДСПредъявленныйОбороты.Поставщик,
		|	НДСПредъявленныйОбороты.СчетФактура
		|ИЗ
		|	РегистрНакопления.НДСПредъявленный.Обороты(
		|		,
		|		,
		|		,
		|		Организация = &Организация
		|		    И СчетФактура В (&СчетаФактуры)) КАК НДСПредъявленныйОбороты
		|ГДЕ
		|	НДСПредъявленныйОбороты.Поставщик <> &ПустойКонтрагент";
		
		КонтрагентПоСчетуФактуре = Запрос.Выполнить().Выгрузить();
		СокращеннаяТаблицаСФВозвратов.Колонки.Добавить("Поставщик", Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
		
		Для каждого СтрокаОбрабатываемая  Из СокращеннаяТаблицаСФВозвратов Цикл
			СтрокаОбрабатываемая.СуммаБезНДС = СтрокаОбрабатываемая.Стоимость - СтрокаОбрабатываемая.НДС;
			
			СтрокаКонтрагента = КонтрагентПоСчетуФактуре.Найти(СтрокаОбрабатываемая.СчетФактура,"СчетФактура");
			Если не СтрокаКонтрагента = Неопределено Тогда
			    СтрокаОбрабатываемая.Поставщик = СтрокаКонтрагента.Поставщик;
			КонецЕсли; 
		КонецЦикла;
	КонецЕсли; 
	
	ОтразитьВКнигеПродаж =  (СтруктураШапкиДокумента.Дата>='20060530');

	Если ОтразитьВКнигеПродаж Тогда
		Если Не СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда
			ВидНачисления = Перечисления.НДСВидНачисления.НДСВосстановлен;
		Иначе
			ВидНачисления = Перечисления.НДСВидНачисления.РеализацияСНДС;
		КонецЕсли;
	КонецЕсли;
	
	Для каждого СтрокаВозврата Из ТаблицаПоПартиямБУ Цикл
		
		Если ОтразитьВКнигеПродаж И СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда
			Если СтрокаВозврата.СтавкаНДС = Перечисления.СтавкиНДС.НДС0 Тогда
				ВидНачисления = Перечисления.НДСВидНачисления.Реализация0;
			ИначеЕсли СтрокаВозврата.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС Тогда
				ВидНачисления = Перечисления.НДСВидНачисления.РеализацияБезНДС;
			КонецЕсли;
		КонецЕсли;
		
		УказанДокументВозврата = ЗначениеЗаполнено(СтрокаВозврата.ДокументПартии) И Не СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат;
		
		ОтработанНДСпоСтроке = СуммаНДСПоСтрокам.Найти(СтрокаВозврата.НомерСтрокиТаблицыПоПартиямБУ,"НомерСтрокиТаблицыПоПартиямБУ");
		
		СтрокиПартийВозврата = СокращеннаяТаблицаСФВозвратов.НайтиСтроки(Новый Структура("НомерСтрокиТаблицыПоПартиямБУ",СтрокаВозврата.НомерСтрокиТаблицыПоПартиямБУ));
		
		Если ОтразитьВКнигеПродаж Тогда
		    Если СтруктураШапкиДокумента.НДСВключенВСтоимость И СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда
			    // НДС был включен в стоимость а не отражен в книге покупок.
				// Формирование записи в книге продаж не требуется, так как НДС в книге покупок не отражался)
			Иначе
				//Отработка по регистру НДС начисленный возврата поставщику

				СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСНачисленный", СтруктураПараметров);
				СтрокаДвижения.Период 		= СтруктураПараметров.Период;
				СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
				СтрокаДвижения.СчетФактура	= ?(УказанДокументВозврата, СтрокаВозврата.ДокументПартии, СтруктураШапкиДокумента.Ссылка);
				СтрокаДвижения.ВидЦенности	= СтрокаВозврата.ВидЦенности;
				СтрокаДвижения.СтавкаНДС	= СтрокаВозврата.СтавкаНДС;
				СтрокаДвижения.СчетУчетаНДС	= СтрокаВозврата.СчетУчетаНДС;
				СтрокаДвижения.Покупатель	= СтруктураШапкиДокумента.Контрагент;
				СтрокаДвижения.ВидНачисления = ВидНачисления;
				
				СтрокаДвижения.СуммаБезНДС	= СтрокаВозврата.СуммаБезНДС;
				СтрокаДвижения.НДС			= СтрокаВозврата.НДС;
				СтрокаДвижения.Событие		= ?(Не СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат, 
				                                Перечисления.СобытияПоНДСПродажи.ВосстановлениеНДС,
												Перечисления.СобытияПоНДСПродажи.НДСНачисленКУплате);
				СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Приход;
				// Если возврат отражается как начисления, проводки формируются по таблице начисления
				Если СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда
					ПроводкаНДСПоСтроке = ТаблицаПроводокПоНДС.Добавить();
					ЗаполнитьЗначенияСвойств(ПроводкаНДСПоСтроке, СтрокаВозврата);
					ПроводкаНДСПоСтроке.НДС 		= СтрокаВозврата.НДС;
					ПроводкаНДСПоСтроке.НДСВал 		= СтрокаВозврата.КорВалютнаяСуммаНДСЗадолженностиБУ;
				КонецЕсли;
					
			КонецЕсли; 
		ИначеЕсли ?(УказанДокументВозврата,Истина, не СтруктураШапкиДокумента.НДСВключенВСтоимость) Тогда
		// Сторнирование поступления НДС по регистру "НДС предъявленный"
			СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПредъявленный", СтруктураПараметров);
		
			СтрокаДвижения.Период 		= СтруктураПараметров.Период;
			СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
			СтрокаДвижения.СчетФактура	= ?(УказанДокументВозврата, СтрокаВозврата.ДокументПартии, СтруктураШапкиДокумента.Ссылка);
			СтрокаДвижения.ВидЦенности	= СтрокаВозврата.ВидЦенности;
			СтрокаДвижения.СтавкаНДС	= СтрокаВозврата.СтавкаНДС;
			СтрокаДвижения.СчетУчетаНДС	= СтрокаВозврата.СчетУчетаНДС;
			СтрокаДвижения.Поставщик	= СтруктураШапкиДокумента.Контрагент;
				
			СтрокаДвижения.СуммаБезНДС	= (-1)* СтрокаВозврата.СуммаБезНДС;
			СтрокаДвижения.НДС			= (-1)* СтрокаВозврата.НДС;
			СтрокаДвижения.Событие		= Перечисления.СобытияПоНДСПокупки.ПредъявленНДСПоставщиком;
			СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Приход;
		
		КонецЕсли; 
		
	    Если Не СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда
			Для каждого СтрокаПартииВозврата Из СтрокиПартийВозврата Цикл
				
				Если СтрокаПартииВозврата.ПартияСовпадаетСУказаннымДокументомДляВозврата Тогда
					Если не СтрокаПартииВозврата.Количество = 0 тогда
						// По партиеобразующему движению
						Если СтрокаПартииВозврата.НДСвключенВСтоимость Тогда
							Если ОтразитьВКнигеПродаж Тогда
								Если не СтруктураШапкиДокумента.НДСВключенВСтоимость Тогда
									//Отмена отражение возврата поставщику в регистре "НДС начисленный"
									//по строке списаной партии
									СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСНачисленный", СтруктураПараметров);
									СтрокаДвижения.Период 		= СтруктураПараметров.Период;
									СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
									СтрокаДвижения.СчетФактура	= ?(УказанДокументВозврата, СтрокаВозврата.ДокументПартии, СтруктураШапкиДокумента.Ссылка);
									СтрокаДвижения.ВидЦенности	= СтрокаВозврата.ВидЦенности;
									СтрокаДвижения.СтавкаНДС	= СтрокаВозврата.СтавкаНДС;
									СтрокаДвижения.СчетУчетаНДС	= СтрокаВозврата.СчетУчетаНДС;
									СтрокаДвижения.Покупатель	= СтруктураШапкиДокумента.Контрагент;
									СтрокаДвижения.ВидНачисления = Перечисления.НДСВидНачисления.НДСВосстановлен;
										
									СтрокаДвижения.СуммаБезНДС	= (-1)* СтрокаПартииВозврата.СуммаБезНДС;
									СтрокаДвижения.НДС			= (-1)* СтрокаПартииВозврата.НДС;
									СтрокаДвижения.Событие		= Перечисления.СобытияПоНДСПродажи.ВосстановлениеНДС;
									СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Приход;
								 КонецЕсли;
								
							Иначе
								// Сторно расхода по регистру "НДС предъявленный", произведенного при включении НДС в стоимость
								СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПредъявленный", СтруктураПараметров);
								СтрокаДвижения.Период 		= СтруктураПараметров.Период;
								СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
								СтрокаДвижения.СчетФактура	= СтрокаПартииВозврата.СчетФактура;
								СтрокаДвижения.ВидЦенности	= СтрокаПартииВозврата.ВидЦенности;
								СтрокаДвижения.СтавкаНДС	= СтрокаПартииВозврата.СтавкаНДС;
								СтрокаДвижения.СчетУчетаНДС	= СтрокаПартииВозврата.СчетУчетаНДС;
								СтрокаДвижения.Поставщик	= СтруктураШапкиДокумента.Контрагент;
								
								СтрокаДвижения.СуммаБезНДС	= (-1)* СтрокаПартииВозврата.СуммаБезНДС;
								СтрокаДвижения.НДС			= (-1)* СтрокаПартииВозврата.НДС;
								СтрокаДвижения.Событие		= Перечисления.СобытияПоНДСПокупки.НДСВключенВСтоимость;
								СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Расход;
							
								// Сторнирование записи по регистру "НДС включенный в стоимость" записи, введенной ранее
								СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСВключенныйВСтоимость", СтруктураПараметров);
								СтрокаДвижения.Период 		= СтруктураПараметров.Период;
								СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
								СтрокаДвижения.СчетФактура	= СтрокаПартииВозврата.СчетФактура;
								СтрокаДвижения.ВидЦенности	= СтрокаПартииВозврата.ВидЦенности;
								СтрокаДвижения.СтавкаНДС	= СтрокаПартииВозврата.СтавкаНДС;
								СтрокаДвижения.СчетУчетаНДС	= СтрокаПартииВозврата.СчетУчетаНДС;
								СтрокаДвижения.Поставщик	= СтруктураШапкиДокумента.Контрагент;
								
								СтрокаДвижения.СуммаБезНДС	= (-1)* СтрокаПартииВозврата.СуммаБезНДС;
								СтрокаДвижения.НДС			= (-1)* СтрокаПартииВозврата.НДС;
							КонецЕсли;
								
							// Формирование проводки по НДС не требуется, был включен в стоимость ранее
							ОтработанНДСпоСтроке.НДС = ОтработанНДСпоСтроке.НДС - СтрокаПартииВозврата.НДС;
							ОтработанНДСпоСтроке.СуммаБезНДС = ОтработанНДСпоСтроке.СуммаБезНДС - СтрокаПартииВозврата.СуммаБезНДС;
							
						Иначе
							// Формирование проводки требуется, НДС считаем отработанным
							ОтработанНДСпоСтроке.НДС = ОтработанНДСпоСтроке.НДС - СтрокаПартииВозврата.НДС;
							ОтработанНДСпоСтроке.СуммаБезНДС = ОтработанНДСпоСтроке.СуммаБезНДС - СтрокаПартииВозврата.СуммаБезНДС;
							
							ПроводкаНДСПоСтроке = ТаблицаПроводокПоНДС.Добавить();
							ЗаполнитьЗначенияСвойств(ПроводкаНДСПоСтроке, СтрокаПартииВозврата);
							ПроводкаНДСПоСтроке.Поставщик 	= СтруктураШапкиДокумента.Контрагент;
							
							Если ОтразитьВКнигеПродаж и СтруктураШапкиДокумента.НДСВключенВСтоимость Тогда
								//Отражение возврата поставщику в регистре "НДС начисленный"
								//Не отражался ранее так как предполагалось, что НДС включен в стоимость 
								// (не отражен в книге покупок) и не требует отражения в книге продаж
								СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСНачисленный", СтруктураПараметров);
								СтрокаДвижения.Период 		= СтруктураПараметров.Период;
								СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
								СтрокаДвижения.СчетФактура	= ?(УказанДокументВозврата, СтрокаВозврата.ДокументПартии, СтруктураШапкиДокумента.Ссылка);
								СтрокаДвижения.ВидЦенности	= СтрокаВозврата.ВидЦенности;
								СтрокаДвижения.СтавкаНДС	= СтрокаВозврата.СтавкаНДС;
								СтрокаДвижения.СчетУчетаНДС	= СтрокаВозврата.СчетУчетаНДС;
								СтрокаДвижения.Покупатель	= СтруктураШапкиДокумента.Контрагент;
								СтрокаДвижения.ВидНачисления = Перечисления.НДСВидНачисления.НДСВосстановлен;
										
								СтрокаДвижения.СуммаБезНДС	= СтрокаПартииВозврата.СуммаБезНДС;
								СтрокаДвижения.НДС			= СтрокаПартииВозврата.НДС;
								СтрокаДвижения.Событие		= Перечисления.СобытияПоНДСПродажи.ВосстановлениеНДС;
								СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Приход;
							 КонецЕсли;
							
						КонецЕсли;
					Иначе 
						// По доп. расходам
						Если не СтрокаПартииВозврата.НДСвключенВСтоимость Тогда
							// Если по доп. расходам не производилось включение НДС в стоимость ранее, необходимо сделать это сейчас,
							// так как ценности не используются и не будут использоваться в дальнейшем для деятельности с НДС.
							
							Если Не ОтразитьВКнигеПродаж Тогда
								// Расход по регистру "НДС предъявленный" (включении НДС в стоимость)
								СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПредъявленный", СтруктураПараметров);
								СтрокаДвижения.Период 		= СтруктураПараметров.Период;
								СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
								СтрокаДвижения.СчетФактура	= СтрокаПартииВозврата.СчетФактура;
								СтрокаДвижения.ВидЦенности	= СтрокаПартииВозврата.ВидЦенности;
								СтрокаДвижения.СтавкаНДС	= СтрокаПартииВозврата.СтавкаНДС;
								СтрокаДвижения.СчетУчетаНДС	= СтрокаПартииВозврата.СчетУчетаНДС;
								СтрокаДвижения.Поставщик	= СтрокаПартииВозврата.Поставщик;
								
								СтрокаДвижения.СуммаБезНДС	= СтрокаПартииВозврата.СуммаБезНДС;
								СтрокаДвижения.НДС			= СтрокаПартииВозврата.НДС;
								СтрокаДвижения.Событие		= Перечисления.СобытияПоНДСПокупки.НДСВключенВСтоимость;
								СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Расход;
							
								ПроводкаНДСПоСтроке = ТаблицаПроводокПоНДС.Добавить();
								ЗаполнитьЗначенияСвойств(ПроводкаНДСПоСтроке, СтрокаПартииВозврата);
								
								// Формирование записи по регистру "НДС включенный в стоимость"
								СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСВключенныйВСтоимость", СтруктураПараметров);
								СтрокаДвижения.Период 		= СтруктураПараметров.Период;
								СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
								СтрокаДвижения.СчетФактура	= СтрокаПартииВозврата.СчетФактура;
								СтрокаДвижения.ВидЦенности	= СтрокаПартииВозврата.ВидЦенности;
								СтрокаДвижения.СтавкаНДС	= СтрокаПартииВозврата.СтавкаНДС;
								СтрокаДвижения.СчетУчетаНДС	= СтрокаПартииВозврата.СчетУчетаНДС;
								СтрокаДвижения.Поставщик	= СтрокаПартииВозврата.Поставщик;
								
								СтрокаДвижения.СуммаБезНДС	= СтрокаПартииВозврата.СуммаБезНДС;
								СтрокаДвижения.НДС			= СтрокаПартииВозврата.НДС;
							КонецЕсли;

						КонецЕсли;
					КонецЕсли;
				иначе //не Если СтрокаПартииВозврата.ПартияСовпадаетСУказаннымДокументомДляВозврата
					
					// Спсываем другую партию. Включение в стоимость по флагу документа "НДС включен в стоимость"
					Если не СтрокаПартииВозврата.НДСвключенВСтоимость = СтруктураШапкиДокумента.НДСвключенВСтоимость Тогда
						ЗнакОперации = ?(СтруктураШапкиДокумента.НДСвключенВСтоимость,1,-1);// 1 включение; -1 исключение
						
						// Движение по регистру "НДС предъявленный"
						Если Не ОтразитьВКнигеПродаж Тогда
							СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПредъявленный", СтруктураПараметров);
							СтрокаДвижения.Период 		= СтруктураПараметров.Период;
							СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
							СтрокаДвижения.СчетФактура	= СтрокаПартииВозврата.СчетФактура;
							СтрокаДвижения.ВидЦенности	= СтрокаПартииВозврата.ВидЦенности;
							СтрокаДвижения.СтавкаНДС	= СтрокаПартииВозврата.СтавкаНДС;
							СтрокаДвижения.СчетУчетаНДС	= СтрокаПартииВозврата.СчетУчетаНДС;
							СтрокаДвижения.Поставщик	= СтрокаПартииВозврата.Поставщик;
							
							СтрокаДвижения.Событие		= Перечисления.СобытияПоНДСПокупки.НДСВключенВСтоимость;
							
							СтрокаДвижения.СуммаБезНДС	= ЗнакОперации * СтрокаПартииВозврата.СуммаБезНДС;
							СтрокаДвижения.НДС			= ЗнакОперации * СтрокаПартииВозврата.НДС;
							
							СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Расход;
							
							ПроводкаНДСПоСтроке = ТаблицаПроводокПоНДС.Добавить();
							ЗаполнитьЗначенияСвойств(ПроводкаНДСПоСтроке, СтрокаПартииВозврата);
							Если не ЗнакОперации = 1 Тогда
								ПроводкаНДСПоСтроке.НДС 		= ЗнакОперации * СтрокаПартииВозврата.НДС;
							КонецЕсли; 
							
						
							// Формирование записи по регистру "НДС включенный в стоимость"
							СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСВключенныйВСтоимость", СтруктураПараметров);
							СтрокаДвижения.Период 		= СтруктураПараметров.Период;
							СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
							СтрокаДвижения.СчетФактура	= СтрокаПартииВозврата.СчетФактура;
							СтрокаДвижения.ВидЦенности	= СтрокаПартииВозврата.ВидЦенности;
							СтрокаДвижения.СтавкаНДС	= СтрокаПартииВозврата.СтавкаНДС;
							СтрокаДвижения.СчетУчетаНДС	= СтрокаПартииВозврата.СчетУчетаНДС;
							СтрокаДвижения.Поставщик	= СтрокаПартииВозврата.Поставщик;
								
							СтрокаДвижения.СуммаБезНДС	= ЗнакОперации * СтрокаПартииВозврата.СуммаБезНДС;
							СтрокаДвижения.НДС			= ЗнакОперации * СтрокаПартииВозврата.НДС;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла; 
			
			Если не ОтработанНДСпоСтроке.НДС =0 или не ОтработанНДСпоСтроке.СуммаБезНДС = 0 тогда
				// Не вся сумма НДС по строке отработана
				Если УказанДокументВозврата Тогда
					Если СтруктураШапкиДокумента.НДСвключенВСтоимость Тогда
						// Необходимо отменить включение НДС в стоимость по указанному документу
						// Формирование проводки не требуется
						ЗнакОперации = -1;// 1 включение; -1 исключение
						
						Если Не ОтразитьВКнигеПродаж Тогда
							// Движение по регистру "НДС предъявленный"
							СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСПредъявленный", СтруктураПараметров);
							СтрокаДвижения.Период 		= СтруктураПараметров.Период;
							СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
							СтрокаДвижения.СчетФактура	= СтрокаВозврата.ДокументПартии;
							СтрокаДвижения.ВидЦенности	= СтрокаВозврата.ВидЦенности;
							СтрокаДвижения.СтавкаНДС	= СтрокаВозврата.СтавкаНДС;
							СтрокаДвижения.СчетУчетаНДС	= СтрокаВозврата.СчетУчетаНДС;
							СтрокаДвижения.Поставщик	= СтруктураШапкиДокумента.Контрагент;
							
							СтрокаДвижения.Событие		= Перечисления.СобытияПоНДСПокупки.НДСВключенВСтоимость;
							
							СтрокаДвижения.СуммаБезНДС	= ЗнакОперации * ОтработанНДСпоСтроке.СуммаБезНДС;
							СтрокаДвижения.НДС			= ЗнакОперации * ОтработанНДСпоСтроке.НДС;
							
							СтрокаДвижения.ВидДвижения	= ВидДвиженияНакопления.Расход;
							
							// Формирование записи по регистру "НДС включенный в стоимость"
							СтрокаДвижения = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСВключенныйВСтоимость", СтруктураПараметров);
							СтрокаДвижения.Период 		= СтруктураПараметров.Период;
							СтрокаДвижения.Организация	= СтруктураШапкиДокумента.Организация;
							СтрокаДвижения.СчетФактура	= СтрокаВозврата.ДокументПартии;
							СтрокаДвижения.ВидЦенности	= СтрокаВозврата.ВидЦенности;
							СтрокаДвижения.СтавкаНДС	= СтрокаВозврата.СтавкаНДС;
							СтрокаДвижения.СчетУчетаНДС	= СтрокаВозврата.СчетУчетаНДС;
							СтрокаДвижения.Поставщик	= СтруктураШапкиДокумента.Контрагент;
								
							СтрокаДвижения.СуммаБезНДС	= ЗнакОперации * ОтработанНДСпоСтроке.СуммаБезНДС;
							СтрокаДвижения.НДС			= ЗнакОперации * ОтработанНДСпоСтроке.НДС;
						КонецЕсли;
					Иначе
						Если не ОтработанНДСпоСтроке.НДС = 0 Тогда
							// Требуется проводка по отнесению НДС на счет расчетов по претензиям
							ПроводкаНДСПоСтроке = ТаблицаПроводокПоНДС.Добавить();
							ЗаполнитьЗначенияСвойств(ПроводкаНДСПоСтроке, СтрокаВозврата);
							
							ПроводкаНДСПоСтроке.СчетФактура	= СтрокаВозврата.ДокументПартии;
							ПроводкаНДСПоСтроке.Поставщик 	= СтруктураШапкиДокумента.Контрагент;
							ПроводкаНДСПоСтроке.НДС 		= ОтработанНДСпоСтроке.НДС;
						КонецЕсли; 
					КонецЕсли; 
				Иначе //не Если УказанДокументВозврата Тогда
					Если СтруктураШапкиДокумента.НДСвключенВСтоимость Тогда
						// НДС был включен в стоимость, но формирование сторнирующих записей по регситрам не требуется,
						// так как не был документ для списания, а по возврату записей в регистре НДС включенный в стоимость нет
						// Формирование проводки не требуется
					Иначе
						Если не ОтработанНДСпоСтроке.НДС = 0 Тогда
							// Требуется проводка по отнесению НДС на счет расчетов по претензиям
							ПроводкаНДСПоСтроке = ТаблицаПроводокПоНДС.Добавить();
							ЗаполнитьЗначенияСвойств(ПроводкаНДСПоСтроке, СтрокаВозврата);
							
							ПроводкаНДСПоСтроке.СчетФактура	= СтруктураШапкиДокумента.Ссылка;
							ПроводкаНДСПоСтроке.Поставщик 	= СтруктураШапкиДокумента.Контрагент;
							ПроводкаНДСПоСтроке.НДС 		= ОтработанНДСпоСтроке.НДС;
						КонецЕсли; 
					КонецЕсли; 
				КонецЕсли; 
			КонецЕсли; 
			
			// Сторнируем начисление агентского НДС.
			Если СтруктураШапкиДокумента.УчетАгентскогоНДС Тогда
				 
				СтрокаДвижений_НДСНачисленный = УправлениеЗапасамиПартионныйУчет.ДобавитьДвижениеВСтруктуруПараметров("НДСНачисленный", СтруктураПараметров);
				
				СтрокаДвижений_НДСНачисленный.Период 		= СтруктураПараметров.Период;
				СтрокаДвижений_НДСНачисленный.Организация	= СтруктураШапкиДокумента.Организация;
				СтрокаДвижений_НДСНачисленный.Покупатель	= СтруктураШапкиДокумента.Контрагент;
				СтрокаДвижений_НДСНачисленный.СчетФактура	= ?(УказанДокументВозврата, СтрокаВозврата.ДокументПартии, СтруктураШапкиДокумента.Ссылка);
				СтрокаДвижений_НДСНачисленный.ВидЦенности	= СтрокаВозврата.ВидЦенности;
				СтрокаДвижений_НДСНачисленный.СтавкаНДС		= СтрокаВозврата.СтавкаНДС;
				СтрокаДвижений_НДСНачисленный.ВидНачисления = Перечисления.НДСВидНачисления.НДСНачисленКУплате;
				
				СтрокаДвижений_НДСНачисленный.СуммаБезНДС	= (-1)* СтрокаВозврата.СуммаБезНДС;
				СтрокаДвижений_НДСНачисленный.НДС			= (-1)* СтрокаВозврата.НДС;
				
				СтрокаДвижений_НДСНачисленный.Событие 		= Перечисления.СобытияПоНДСПродажи.НДСНачисленКУплате;
				СтрокаДвижений_НДСНачисленный.ДатаСобытия 	= СтруктураШапкиДокумента.Дата;
				
				СтрокаДвижений_НДСНачисленный.ВидДвижения	= ВидДвиженияНакопления.Приход;
				
				СтрокаДвижений_НДСНачисленный.СчетУчетаНДС	= СчетНДС;
				
				// Формирование проводки по сторнированию начисления НДС при исп. обязанностей налогового агента
				Проводка =  СтруктураПараметров.ДвиженияХозрасчетный.Добавить();
				
				Проводка.Период = СтруктураПараметров.Период;
				Проводка.Организация = СтруктураШапкиДокумента.Организация;
				Проводка.Сумма = СтрокаВозврата.НДС;
				Проводка.СписаниеПартий = Истина;
				Проводка.НДСПродукции = Истина;
				Проводка.Содержание = "Сторнирован НДС, начисленный в качестве налогового агента";
				
				Проводка.СчетДт = СчетНДС;
				БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт, Проводка.СубконтоДт, "ВидыПлатежейВГосБюджет", Перечисления.ВидыПлатежейВГосБюджет.Налог);

				Проводка.СчетКт = СтруктураШапкиДокумента.СчетУчетаРасчетовПоПретензиям;
				БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "Контрагенты", СтруктураШапкиДокумента.Контрагент);
				БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "Договоры", 	СтруктураШапкиДокумента.ДоговорКонтрагента);
					
				Если Проводка.СчетКт.Валютный Тогда
					Если не СтруктураШапкиДокумента.Свойство("ВалютаВзаиморасчетов") Тогда
						СтруктураШапкиДокумента.Вставить("ВалютаВзаиморасчетов",СтруктураШапкиДокумента.ДоговорКонтрагента.ВалютаВзаиморасчетов);
					КонецЕсли; 
					
					Проводка.ВалютаКт = СтруктураШапкиДокумента.ВалютаВзаиморасчетов;
					Проводка.ВалютнаяСуммаКт = СтрокаВозврата.КорВалютнаяСуммаНДСЗадолженностиБУ;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла; 
	
	Если ОтразитьВКнигеПродаж и СтруктураПараметров.ТаблицаДвиженийНДСНачисленный.Количество()>1 Тогда
		ТаблицаДвижений_НДСНачисленный = СтруктураПараметров.ТаблицаДвиженийНДСНачисленный;
		// Сворачивание записей регистра "НДС Начисленный"
		СуммовыеКолонки = "СуммаБезНДС, НДС";
		ГруппировочныеКолонки = "";
		Для каждого Колонка Из ТаблицаДвижений_НДСНачисленный.Колонки Цикл
			Если Колонка.Имя = "СуммаБезНДС" или Колонка.Имя = "НДС" Тогда
				Продолжить;
			Иначе
				ГруппировочныеКолонки = ГруппировочныеКолонки + Колонка.Имя+ ",";
			КонецЕсли; 
		КонецЦикла;
		ГруппировочныеКолонки = Лев(ГруппировочныеКолонки, СтрДлина(ГруппировочныеКолонки)-1);
			
		ТаблицаДвижений_НДСНачисленный.Свернуть(ГруппировочныеКолонки,СуммовыеКолонки); 
			
		// Удаление записей с пустыми суммами
		СтрокиКУдалению =  ТаблицаДвижений_НДСНачисленный.НайтиСтроки(Новый Структура("СуммаБезНДС, НДС",0,0));
		Для каждого СтрокаКУдалению Из СтрокиКУдалению Цикл
			ТаблицаДвижений_НДСНачисленный.Удалить(СтрокаКУдалению);
		КонецЦикла; 
	КонецЕсли; 

	//Формирование проводок по отнесению НДС на счет расчетов по претензиям
	НомерСтрокиТаблицыПоПартиямБУ = 0;
	Коэффициент = 0;
	
	Если Не СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда
		ТаблицаПроводокПоНДС.Свернуть("НомерСтрокиДокумента, НомерСтрокиТаблицыПоПартиямБУ, Поставщик, СчетФактура, СчетУчетаНДС","НДС, НДСВал");
	Иначе
		ТаблицаПроводокПоНДС.Свернуть("НомерСтрокиДокумента","НДС, НДСВал");
	КонецЕсли;
	
	Для каждого СтрокаТЧ Из ТаблицаПроводокПоНДС Цикл
	    Если СтрокаТЧ.НДС =0 Тогда
			Продолжить;
		КонецЕсли; 
		Проводка =  СтруктураПараметров.ДвиженияХозрасчетный.Добавить();

		Проводка.Период = СтруктураПараметров.Период;
		Проводка.Организация = СтруктураШапкиДокумента.Организация;
		Проводка.Содержание = "Возврат поставщику";
		Проводка.СписаниеПартий = Истина;
		Проводка.НДСПродукции = Истина;
		Проводка.Сумма = СтрокаТЧ.НДС;

		Проводка.СчетДт = СтруктураШапкиДокумента.СчетУчетаРасчетовПоПретензиям;
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Контрагенты", СтруктураШапкиДокумента.Контрагент);
		БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Договоры", СтруктураШапкиДокумента.ДоговорКонтрагента);
			
		Если Не СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда

			Если Проводка.СчетДт.Валютный Тогда
				Если не СтруктураШапкиДокумента.Свойство("ВалютаВзаиморасчетов") Тогда
					СтруктураШапкиДокумента.Вставить("ВалютаВзаиморасчетов",СтруктураШапкиДокумента.ДоговорКонтрагента.ВалютаВзаиморасчетов);
				КонецЕсли; 
				Проводка.ВалютаДт = СтруктураШапкиДокумента.ВалютаВзаиморасчетов;
				Если СтруктураШапкиДокумента.ВалютаВзаиморасчетов = СтруктураШапкиДокумента.ВалютаРегламентированногоУчета Тогда
					Проводка.ВалютнаяСуммаДт = Проводка.Сумма;
				Иначе
					Если не НомерСтрокиТаблицыПоПартиямБУ = СтрокаТЧ.НомерСтрокиТаблицыПоПартиямБУ Тогда
						НомерСтрокиТаблицыПоПартиямБУ = СтрокаТЧ.НомерСтрокиТаблицыПоПартиямБУ;
						СтрокаТаблицыПоПартиямБУ = ТаблицаПоПартиямБУ.Найти(НомерСтрокиТаблицыПоПартиямБУ,"НомерСтрокиТаблицыПоПартиямБУ");
						Если не СтрокаТаблицыПоПартиямБУ.НДС = 0 Тогда
							Коэффициент = ?(СтрокаТаблицыПоПартиямБУ.КорВалютнаяСуммаНДСЗадолженностиБУ =0,1,СтрокаТаблицыПоПартиямБУ.КорВалютнаяСуммаНДСЗадолженностиБУ/СтрокаТаблицыПоПартиямБУ.НДС);
						Иначе
							Коэффициент = ?(СтрокаТаблицыПоПартиямБУ.КорВалютнаяСуммаЗадолженностиБУ =0 или СтрокаТаблицыПоПартиямБУ.СуммаЗадолженностиБУ = 0,1,СтрокаТаблицыПоПартиямБУ.КорВалютнаяСуммаЗадолженностиБУ/СтрокаТаблицыПоПартиямБУ.СуммаЗадолженностиБУ);
						КонецЕсли; 
					КонецЕсли; 
					Проводка.ВалютнаяСуммаДт = Окр(Проводка.Сумма*Коэффициент,2);
				КонецЕсли; 
				
				СтрокаТЧ.НДСВал = Проводка.ВалютнаяСуммаДт;
			КонецЕсли;
				
			Проводка.СчетКт = СтрокаТЧ.СчетУчетаНДС;
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Контрагенты",     СтрокаТЧ.Поставщик);
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"СФПолученные",    СтрокаТЧ.СчетФактура);
			
		Иначе
			Если Проводка.СчетДт.Валютный Тогда
				Если не СтруктураШапкиДокумента.Свойство("ВалютаВзаиморасчетов") Тогда
					СтруктураШапкиДокумента.Вставить("ВалютаВзаиморасчетов",СтруктураШапкиДокумента.ДоговорКонтрагента.ВалютаВзаиморасчетов);
				КонецЕсли;
				
				Проводка.ВалютаДт = СтруктураШапкиДокумента.ВалютаВзаиморасчетов;
				Если СтруктураШапкиДокумента.ВалютаВзаиморасчетов = СтруктураШапкиДокумента.ВалютаРегламентированногоУчета Тогда
					Проводка.ВалютнаяСуммаДт = Проводка.Сумма;
				Иначе
					Проводка.ВалютнаяСуммаДт = СтрокаТЧ.НДСВал;
				КонецЕсли; 
			КонецЕсли;
			
			Проводка.СчетКт = ПланыСчетов.Хозрасчетный.НДС;
			БухгалтерскийУчет.УстановитьСубконто(Проводка.СчетКт, Проводка.СубконтоКт, "ВидыПлатежейВГосБюджет", Перечисления.ВидыПлатежейВГосБюджет.Налог);
		КонецЕсли;
	
	КонецЦикла;
	
	ВозвратНДС = ТаблицаПроводокПоНДС.Итог("НДС");
	ВозвратНДСВал = ТаблицаПроводокПоНДС.Итог("НДСВал");
	
	СтруктураПараметров.Вставить("ВозвратНДС",   ВозвратНДС);
	СтруктураПараметров.Вставить("ВозвратНДСВал",ВозвратНДСВал);
	
	Если СтруктураШапкиДокумента.УчетАгентскогоНДС И Не СтруктураШапкиДокумента.ПоставщикуВыставляетсяСчетФактураНаВозврат Тогда
		ПроводкаНДСПоСтроке = ТаблицаПроводокПоНДС.Добавить();
		//ПроводкаНДСПоСтроке.НомерСтрокиТаблицыПоПартиямБУ = СтрокаВозврата.НомерСтрокиТаблицыПоПартиямБУ;
		//ПроводкаНДСПоСтроке.СчетФактура	= СтрокаВозврата.ДокументПартии;
		//ПроводкаНДСПоСтроке.Поставщик 	= СтруктураШапкиДокумента.Контрагент;
		ПроводкаНДСПоСтроке.НДС 		= (-1) * ТаблицаПоПартиямБУ.Итог("НДС");
		
		Если СтруктураШапкиДокумента.СчетУчетаРасчетовПоПретензиям.Валютный Тогда
			ПроводкаНДСПоСтроке.НДСВал 		= (-1) * ТаблицаПоПартиямБУ.Итог("КорВалютнаяСуммаНДСЗадолженностиБУ");
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры // ДвиженияПоРегистрамПодсистемыНДС()

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ, ФОРМИРУЮЩИЕ СТРУКТУРУ ДАННЫХ ДЛЯ ПЕРЕДАЧИ В УЧЕТ НДС

Процедура ОпределитьСоставКолонокТаблицаСписанныхПартийНДС(СтруктураПараметров, СписокИспользуемыхОпераций, СтруктураКолонок, СписаниеОС = Ложь) Экспорт
	
	КодыОпераций = СтруктураПараметров.КодыОпераций;
	//**************************************************
	// Возможно получение информации из шапки документа
	СтруктураКолонок.Вставить("Организация");
	СтруктураКолонок.Вставить("ДоговорКонтрагента");
	СтруктураКолонок.Вставить("ОтражатьВБухгалтерскомУчете");
	СтруктураКолонок.Вставить("ОтражатьВНалоговомУчете");
	// Возможно получение информации из шапки документа
	//**************************************************
	
	СтруктураКолонок.Вставить("Движение"); // Часть информации о проведении получается из параметров движения списанной партии
	СтруктураКолонок.Вставить("НомерСтрокиДокумента"); 
	//СтруктураКолонок.Вставить("СчетУчета");
	СтруктураКолонок.Вставить("Номенклатура");
	СтруктураКолонок.Вставить("ВидЦенности");// ? Вид ценности, определенный в документе для начисления
	СтруктураКолонок.Вставить("Склад");
	СтруктураКолонок.Вставить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	СтруктураКолонок.Вставить("Стоимость", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	СтруктураКолонок.Вставить("КорСчетБУ");
	СтруктураКолонок.Вставить("СчетДоходовБУ");
	
	СтруктураКолонок.Вставить("СуммаЗадолженностиБУ");
	СтруктураКолонок.Вставить("КорВалютнаяСуммаНДСЗадолженностиБУ");// Возврат поставщику, НА Комитент
	СтруктураКолонок.Вставить("СуммаНДС");
	СтруктураКолонок.Вставить("СтавкаНДС");
	
	СтруктураКолонок.Вставить("СтатьяЗатрат"); 
	
	// Для парт.учета и ОС (если не ведется сложный учет НДС)
	СтруктураКолонок.Вставить("СтатьяЗатратНДС");
	СтруктураКолонок.Вставить("НазначениеИспользования"); // Для передачи материалов в экспл.
	СтруктураКолонок.Вставить("СчетРасходовБУ"); // Возврат от покупателя
	СтруктураКолонок.Вставить("НоменклатурнаяГруппа");
	СтруктураКолонок.Вставить("ПодразделениеОрганизации");
	СтруктураКолонок.Вставить("НомерКорСтроки");
	
	
	СтруктураКолонок.Вставить("ВидТабличнойЧасти");// Для анализа отражения в НДС
	СтруктураКолонок.Вставить("КодОперацииПартииТоваров");// Для анализа отражения в НДС
	
	СтруктураКолонок.Вставить("ДокументОприходования");
	
	// Колонки по набору условий
	
	//***************************************************
	// Возврат поставщику
	Если НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратПоставщику) = НЕОПРЕДЕЛЕНО Тогда
	
		//СтруктураКолонок.Вставить("НомерСтроки"); // Возврат поставщику = НомерСтрокиТаблицыПоПартиямБУ
		СтруктураКолонок.Вставить("КорВалютнаяСуммаЗадолженностиБУ");
		СтруктураКолонок.Вставить("СчетУчетаНДС");
		//СтруктураКолонок.Вставить("ДокументПартии");
		СтруктураКолонок.Вставить("КорСчетЗадолженностиБУ");
		СтруктураКолонок.Вставить("КорСубконтоЗадолженностиБУ1");
		СтруктураКолонок.Вставить("КорСубконтоЗадолженностиБУ2");
		СтруктураКолонок.Вставить("КорСубконтоЗадолженностиБУ3");
		
	КонецЕсли;
	// Возврат поставщику
	//***************************************************
	
	
	//***************************************************
	// Возврат от пукумателя
	Если НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтПокупателя) = НЕОПРЕДЕЛЕНО Тогда
		СтруктураКолонок.Вставить("СубконтоБУ");
		СтруктураКолонок.Вставить("КорСубконтоБУ2");
	КонецЕсли;	
	// Возврат от пукумателя
	//***************************************************
	
	//***************************************************
	// Сложный учет НДС
	СтруктураКолонок.Вставить("Партия");
	СтруктураКолонок.Вставить("ДокументПартии");
	СтруктураКолонок.Вставить("ДокументПередачи");
	СтруктураКолонок.Вставить("ВестиПартионныйУчетПоСериям"); // Для парт.учета и ОС (если не ведется сложный учет НДС)
	СтруктураКолонок.Вставить("СерияНоменклатуры"); // Для парт.учета и ОС (если не ведется сложный учет НДС)
	СтруктураКолонок.Вставить("ХарактеристикаНоменклатуры"); // Для парт.учета и ОС (если не ведется сложный учет НДС)
	СтруктураКолонок.Вставить("ЗаказПартии"); // Для парт.учета и ОС (если не ведется сложный учет НДС)
	СтруктураКолонок.Вставить("ОбъектСтроительства"); // Для передачи оборудования в монтаж
	
	Если СтруктураПараметров.ТипЗначенияРегистратора = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах") Тогда
		СтруктураКолонок.Вставить("СчетФактура");
		СтруктураКолонок.Вставить("Покупатель");
		СтруктураКолонок.Вставить("ДатаСФ");
		СтруктураКолонок.Вставить("ВыставленСФ");
	КонецЕсли;
	
	Если УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СложныйУчетНДС", "Нал", СтруктураПараметров) = истина 
	  Или (Не СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ПринятиеКУчетуОС) = Неопределено) 
	  Или СписаниеОС
	  Тогда
		
		//СтруктураКолонок.Вставить("ОбособленныйУчетТоваровПоЗаказамПокупателей"); // Для парт.учета 
		
		//***************************************************
		// Включение НДС в стоимость/Исключение из стоимости, косвенные расходы и производство
		СтруктураКолонок.Вставить("ЗаказСписания"); // Для парт.учета
		
		//СтруктураКолонок.Вставить("КорСчетБУ");
		СтруктураКолонок.Вставить("КорСубконтоБУ1");
		СтруктураКолонок.Вставить("КорСубконтоБУ2");
		СтруктураКолонок.Вставить("КорСубконтоБУ3");
		
		СтруктураКолонок.Вставить("СчетУчетаНУ");
		СтруктураКолонок.Вставить("КорСчетНУ");
		СтруктураКолонок.Вставить("КорСубконтоНУ1");
		СтруктураКолонок.Вставить("КорСубконтоНУ2");
		СтруктураКолонок.Вставить("КорСубконтоНУ3");
		СтруктураКолонок.Вставить("ПостояннаяРазница");
		СтруктураКолонок.Вставить("ВременнаяРазница");
		
		// Включение НДС в стоимость/Исключение из стоимости, косвенные расходы и производство
		//***************************************************
		
		//*****************************
		// Для последующего поступления
		Если НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтКомиссионера) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтПереработчика) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтПокупателя) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВыпускПоОперацииСтоимость) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВыпускПродукцииФиксНаСклад) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.Комплектация) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.КорректировкаСерийИХарактеристик) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ПередачаВПереработку) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ПередачаНаКомиссию) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ПеремещениеМеждуСкладами) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.РезервированиеПодЗаказ) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.СнятиеРезерваПодЗаказ) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВключениеАктиваВСоставМПЗ) = неопределено
			ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.СписаниеПоОрдеру) = неопределено
			Тогда
			////СтруктураКолонок.Вставить("ОбособленныйУчетТоваровПоЗаказамПокупателейПоступление"); // Для парт.учета . Поступление
			СтруктураКолонок.Вставить("ИзменитьСклад");// Для парт.учета . Поступление
			СтруктураКолонок.Вставить("СкладПолучатель");// Для парт.учета . Поступление
			СтруктураКолонок.Вставить("КоличествоПоступление");// Для парт.учета . Поступление
			СтруктураКолонок.Вставить("СтоимостьПоступление");// Для парт.учета . Поступление
			СтруктураКолонок.Вставить("НоменклатураНовая");// Для парт.учета . Поступление
			СтруктураКолонок.Вставить("ИзменитьСерию");// Для парт.учета . Поступление
			СтруктураКолонок.Вставить("ИзменитьХарактеристику");// Для парт.учета . Поступление
			СтруктураКолонок.Вставить("СерияНоменклатурыНовая"); // Для парт.учета . Поступление
			СтруктураКолонок.Вставить("ХарактеристикаНоменклатурыНовая"); // Для парт.учета . Поступление
			СтруктураКолонок.Вставить("ДокументОприходованияНовый");
			СтруктураКолонок.Вставить("Качество");// Включение НДС в стоимость/Исключение из стоимости . Поступление
			СтруктураКолонок.Вставить("КачествоНовое");// Включение НДС в стоимость/Исключение из стоимости . Поступление

		КонецЕсли; 
		// Для последующего поступления
		//*****************************
	КонецЕсли; 
	// Сложный учет НДС
	//***************************************************
	
КонецПроцедуры

Функция ПолучитьТаблицуПартийПоДокументу(СтруктураПараметров, ТаблицаСписания)
	
	// Партии могут списываться из регистров ПартииТоваровНаСкладахБухгалтерскийУчет и ПартииТоваровПереданныеБухгалтерскийУчет
	// Отберем из соответствующих таблиц партии с видом движения "расход"
	
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	ТаблицаПартий = СтруктураПараметров.ТаблицаДвиженийПартииТоваровНаСкладахБух.СкопироватьКолонки();
	ТаблицаПартий.Колонки.Добавить("РегистрУчета");
	Для каждого СтрокаПартииНаСкладах из ТаблицаСписания Цикл
		CтрокаПартии = ТаблицаПартий.Добавить();
		ЗаполнитьЗначенияСвойств(CтрокаПартии,СтрокаПартииНаСкладах);
		
		CтрокаПартии.ВидДвижения = ВидДвиженияНакопления.Расход;
		
		CтрокаПартии.КодОперации = СтрокаПартииНаСкладах.КодОперацииПартииТоваров;
		CтрокаПартии.СчетУчета =  СтрокаПартииНаСкладах.СчетУчетаБУ;
		
		CтрокаПартии.КорСубконто1 =  СтрокаПартииНаСкладах.КорСубконтоБУ1;
		CтрокаПартии.КорСубконто2 =  СтрокаПартииНаСкладах.КорСубконтоБУ2;
		CтрокаПартии.КорСубконто3 =  СтрокаПартииНаСкладах.КорСубконтоБУ3;
	КонецЦикла;
	
	Возврат ТаблицаПартий;
	
КонецФункции

Функция ПреобразоватьТаблицуСписанныхПартийДляНДС(СтруктураПараметров)
	
	Перем ВидыЦенностейПоСчетамУчета;
	
	СоответствиеЗаказов = Новый Соответствие;
	
	КодыОпераций = Перечисления.КодыОперацийПартииТоваров;
	
	СписокИспользуемыхОпераций = Новый СписокЗначений;
	СписокИспользуемыхОпераций.ЗагрузитьЗначения(ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(СтруктураПараметров.ТаблицаСписанныхПартий.ВыгрузитьКолонку("КодОперацииПартииТоваров"),Истина, Истина));
	
	ЕстьСложныйУчетНДС = (УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СложныйУчетНДС", "Нал", СтруктураПараметров) = Истина);
		
	СписаниеОС = Ложь;
	Если Не ЕстьСложныйУчетНДС Тогда
		Для Каждого СтрокаСписания Из СтруктураПараметров.ТаблицаСписанныхПартий Цикл
			Если СтрокаСписания.СчетУчетаБУ = ПланыСчетов.Хозрасчетный.ОборудованиеКУстановке
			Или СтрокаСписания.СчетУчетаБУ.ПринадлежитЭлементу(ПланыСчетов.Хозрасчетный.ОборудованиеКУстановке)
			Или СтрокаСписания.СчетУчетаБУ = ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств
			Или СтрокаСписания.СчетУчетаБУ.ПринадлежитЭлементу(ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств) Тогда
				СписаниеОС = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Определение состава колонок 
	БазоваяСтруктураКолонок = Новый Структура;
	ОпределитьСоставКолонокТаблицаСписанныхПартийНДС(СтруктураПараметров, СписокИспользуемыхОпераций, БазоваяСтруктураКолонок, СписаниеОС);
	
	ЕстьВозвратПоставщику	= (НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратПоставщику) = Неопределено);
	
	ЕстьПоступлениеПоРезультатамСписания = (ЕстьСложныйУчетНДС Или СписаниеОС) И
	(НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтКомиссионера) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтПереработчика) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтПокупателя) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВыпускПоОперацииСтоимость) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВыпускПродукцииФиксНаСклад) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.Комплектация) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.КорректировкаСерийИХарактеристик) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ПередачаВПереработку) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ПередачаНаКомиссию) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ПеремещениеМеждуСкладами) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.РезервированиеПодЗаказ) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.СнятиеРезерваПодЗаказ) = неопределено
	ИЛИ НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВключениеАктиваВСоставМПЗ) = неопределено);
	
	
	РаспределеннаяТаблица = СтруктураПараметров.ТаблицаСписанныхПартий.Скопировать(,ОбщегоНазначения.ВыгрузитьСтруктуруВСтроку(БазоваяСтруктураКолонок));
	
	Если ЕстьСложныйУчетНДС Тогда
		РаспределеннаяТаблица.Колонки.КорСубконтоБУ1.Имя = "КорСубконтоСписанияБУ1";
		РаспределеннаяТаблица.Колонки.КорСубконтоБУ2.Имя = "КорСубконтоСписанияБУ2";
		РаспределеннаяТаблица.Колонки.КорСубконтоБУ3.Имя = "КорСубконтоСписанияБУ3";
		
		РаспределеннаяТаблица.Колонки.КорСубконтоНУ1.Имя = "КорСубконтоСписанияНУ1";
		РаспределеннаяТаблица.Колонки.КорСубконтоНУ2.Имя = "КорСубконтоСписанияНУ2";
		РаспределеннаяТаблица.Колонки.КорСубконтоНУ3.Имя = "КорСубконтоСписанияНУ3";
		
	ИначеЕсли НЕ СписокИспользуемыхОпераций.НайтиПоЗначению(КодыОпераций.ВозвратОтПокупателя) = неопределено Тогда
		РаспределеннаяТаблица.Колонки.КорСубконтоБУ2.Имя = "КорСубконтоСписанияБУ2";
	КонецЕсли;
	
	РаспределеннаяТаблица.Колонки.СуммаНДС.Имя = "НДС";
	РаспределеннаяТаблица.Колонки.СуммаЗадолженностиБУ.Имя = "СуммаБезНДС";
	
	// Ключ - название колонки
	// Значение - описание типа для добавляемой колонки
	СтруктураКолонокРаспределеннойТаблицы = Новый Структура();
	СтруктураКолонокРаспределеннойТаблицы.Вставить("СчетУчетаБУ", Новый описаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("СчетУчетаНУ", Новый описаниеТипов("ПланСчетовСсылка.Налоговый"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("КорСчетСписанияБУ", Новый описаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("КорСчетСписанияНУ", Новый описаниеТипов("ПланСчетовСсылка.Налоговый"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("СчетУчетаЦенности", Новый описаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("ПринятыеСчетУчетаБУ", Новый описаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("ПринятыеСчетУчетаНУ", Новый описаниеТипов("ПланСчетовСсылка.Налоговый"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("Ценность");
	
	СтруктураКолонокРаспределеннойТаблицы.Вставить("Комиссионный", Новый описаниеТипов("Булево"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("УчетАгентскогоНДС", Новый описаниеТипов("Булево"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("ДоговорКомиссии", Новый описаниеТипов("СправочникСсылка.ДоговорыКонтрагентов"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("СчетРасчетовСКомитентом", Новый описаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	
	СтруктураКолонокРаспределеннойТаблицы.Вставить("ВидЦенности", Новый описаниеТипов("ПеречислениеСсылка.ВидыЦенностей"));
	
	СтруктураКолонокРаспределеннойТаблицы.Вставить("Партия", РаспределеннаяТаблица.Колонки.ДокументОприходования.ТипЗначения);
	СтруктураКолонокРаспределеннойТаблицы.Вставить("ОбособленныйУчетТоваровПоЗаказамПокупателей", Новый описаниеТипов("Булево"));
	СтруктураКолонокРаспределеннойТаблицы.Вставить("Подразделение",Новый описаниеТипов("СправочникСсылка.ПодразделенияОрганизаций"));
	
	СтруктураКолонокРаспределеннойТаблицы.Вставить("КоличествоПоступление", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3)));
	
	Для Каждого Элемент из СтруктураКолонокРаспределеннойТаблицы цикл
		Если РаспределеннаяТаблица.Колонки.Найти(Элемент.Ключ) = Неопределено тогда
			Если Элемент.Значение = Неопределено Тогда
				РаспределеннаяТаблица.Колонки.Добавить(Элемент.Ключ);
			Иначе
				РаспределеннаяТаблица.Колонки.Добавить(Элемент.Ключ,Элемент.Значение);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	РаспределеннаяТаблица.ЗагрузитьКолонку(РаспределеннаяТаблица.ВыгрузитьКолонку("ДокументОприходования"),"Партия");
	РаспределеннаяТаблица.ЗагрузитьКолонку(РаспределеннаяТаблица.ВыгрузитьКолонку("КорСчетБУ"),"КорСчетСписанияБУ");
	РаспределеннаяТаблица.ЗагрузитьКолонку(РаспределеннаяТаблица.ВыгрузитьКолонку("Номенклатура"),"Ценность");
	Если ЕстьСложныйУчетНДС Тогда
		РаспределеннаяТаблица.ЗагрузитьКолонку(РаспределеннаяТаблица.ВыгрузитьКолонку("ПодразделениеОрганизации"),"Подразделение");
		РаспределеннаяТаблица.ЗагрузитьКолонку(РаспределеннаяТаблица.ВыгрузитьКолонку("КорСчетНУ"),"КорСчетСписанияНУ");
	КонецЕсли;
	
	СтруктураПоискаНУ = Новый Структура("НомерСтрокиДокумента, ДокументОприходования, ОтражатьВНалоговомУчете", , , Истина);
	СтрокаПартии = Новый Структура("ВидДвижения, Количество, КоличествоПоступление, СчетУчета, СерияНоменклатуры, Заказ, ДокументОприходования, КодОперации, Организация", , 0, 0);
	
	МассивСтрокКУдалению = Новый Массив();
	Для каждого СтрокаТаблицыСписания из РаспределеннаяТаблица цикл
		
		Если Не СтрокаТаблицыСписания.ОтражатьВБухгалтерскомУчете тогда
			МассивСтрокКУдалению.Добавить(СтрокаТаблицыСписания);
			Продолжить;
		КонецЕсли;
		
		РегистрУчета = "НаСкладах";
		
		ЗаполнитьЗначенияСвойств(СтрокаПартии, СтрокаТаблицыСписания.Движение);
		
		Если СтрокаПартии.ВидДвижения = ВидДвиженияНакопления.Приход 
			И  Не СтрокаТаблицыСписания.КодОперацииПартииТоваров = КодыОпераций.ВозвратОтПокупателя тогда
			МассивСтрокКУдалению.Добавить(СтрокаТаблицыСписания);
			//ТаблицаСписанныхПартий, ошибочная ситуация: ВидДвижения = ВидДвиженияНакопления.Приход
			Продолжить;
		КонецЕсли;
		
		Если СтрокаПартии.ВидДвижения = ВидДвиженияНакопления.Расход 
  		  И  СтрокаТаблицыСписания.КодОперацииПартииТоваров = КодыОпераций.ВозвратОтПокупателя тогда
			// Возврат текущего месяца учитывается как сторно реализации
			СтрокаПартии.Количество = - СтрокаПартии.Количество;
		КонецЕсли;		
		
		// НДС по таре не учитывается
		Если СтрокаТаблицыСписания.КодОперацииПартииТоваров = КодыОпераций.ПередачаТарыКонтрагенту 
		   Или СтрокаТаблицыСписания.ВидТабличнойЧасти = Перечисления.ВидыТабличныхЧастей.Тара
			тогда
			МассивСтрокКУдалению.Добавить(СтрокаТаблицыСписания);
			Продолжить;
		КонецЕсли;
		
		Если СтрокаТаблицыСписания.Количество <= 0 тогда
			МассивСтрокКУдалению.Добавить(СтрокаТаблицыСписания);
			//ТаблицаСписанныхПартий, ошибочная ситуация: СтрокаТаблицыСписания.Количество <= 0
			Продолжить;
		КонецЕсли;
		
		Если СтрокаТаблицыСписания.Количество > СтрокаПартии.Количество тогда
			КоэффСписания = СтрокаПартии.Количество/СтрокаТаблицыСписания.Количество;
		Иначе
			КоэффСписания = 1;
		КонецЕсли;
		
		СтрокаРаспределеннойТаблицы = СтрокаТаблицыСписания;
		
		СтрокаРаспределеннойТаблицы.СчетУчетаЦенности = СтрокаПартии.СчетУчета;
		СтрокаРаспределеннойТаблицы.СчетУчетаБУ		  = СтрокаПартии.СчетУчета;
		СтрокаРаспределеннойТаблицы.ВидЦенности	= ОпределитьВидЦенности(СтрокаРаспределеннойТаблицы.Номенклатура,СтрокаРаспределеннойТаблицы.СчетУчетаБУ,,,,,,,,ВидыЦенностейПоСчетамУчета);
		
		СтрокаРаспределеннойТаблицы.НДС = Окр(СтрокаТаблицыСписания.НДС * КоэффСписания,2,1);
		СтрокаРаспределеннойТаблицы.СуммаБезНДС = Окр(СтрокаТаблицыСписания.СуммаБезНДС * КоэффСписания,2,1) - СтрокаРаспределеннойТаблицы.НДС;
		
		// Возврат поставщику, НА Комитент
		СтрокаРаспределеннойТаблицы.КорВалютнаяСуммаНДСЗадолженностиБУ = Окр(СтрокаТаблицыСписания.КорВалютнаяСуммаНДСЗадолженностиБУ* КоэффСписания,2,1);
		//***************************************************
		// Возврат поставщику
		Если ЕстьВозвратПоставщику Тогда
			СтрокаРаспределеннойТаблицы.КорВалютнаяСуммаЗадолженностиБУ = Окр(СтрокаТаблицыСписания.КорВалютнаяСуммаЗадолженностиБУ* КоэффСписания,2,1);
		КонецЕсли;	
		// Возврат поставщику
		//***************************************************
		
		//***************************************************
		// Сложный учет НДС
		Если ЕстьСложныйУчетНДС Тогда
			// Серия в документе может отличаться от серии в партии
			// Например заказ покупателя с пустой серией может списывать партии с непустой серией
			СтрокаРаспределеннойТаблицы.СерияНоменклатуры = СтрокаПартии.СерияНоменклатуры;
			
			//***************************************************
			// Включение НДС в стоимость/Исключение из стоимости, косвенные расходы и производство
			Если не ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ1) тогда
				СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ1 = СтрокаРаспределеннойТаблицы.КорСубконтоСписанияБУ1;
			КонецЕсли;
			Если не ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ2) тогда
				СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ2 = СтрокаРаспределеннойТаблицы.КорСубконтоСписанияБУ2;
			КонецЕсли;
			Если не ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ2) тогда
				СтрокаРаспределеннойТаблицы.КорСубконтоСписанияНУ2 = СтрокаРаспределеннойТаблицы.КорСубконтоСписанияБУ2;
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(СтрокаРаспределеннойТаблицы.КорСчетСписанияБУ) тогда
				СтрокаРаспределеннойТаблицы.КорСчетСписанияБУ = СтрокаРаспределеннойТаблицы.СчетУчетаБУ;
			КонецЕсли;
			
			Если СтрокаПартии.Заказ <> Документы.ЗаказПокупателя.ПустаяСсылка() тогда
				ОбособленныйУчетТоваровПоЗаказамПокупателей = СоответствиеЗаказов[СтрокаПартии.Заказ];
				
				Если ОбособленныйУчетТоваровПоЗаказамПокупателей = Неопределено Тогда
					
					СтруктураЗаказа = Новый Структура("ДоговорКонтрагента");
					УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтрокаПартии.Заказ, СтруктураЗаказа);
					
					СтруктураДоговора = Новый Структура("ОбособленныйУчетТоваровПоЗаказамПокупателей");
					УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтруктураЗаказа.ДоговорКонтрагента, СтруктураДоговора);
					
					СтрокаРаспределеннойТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = СтруктураДоговора.ОбособленныйУчетТоваровПоЗаказамПокупателей;
					СоответствиеЗаказов.Вставить(СтрокаПартии.Заказ, СтруктураДоговора.ОбособленныйУчетТоваровПоЗаказамПокупателей);
					
				Иначе
					СтрокаРаспределеннойТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = ОбособленныйУчетТоваровПоЗаказамПокупателей;
				КонецЕсли;
			Иначе
				СтрокаРаспределеннойТаблицы.ОбособленныйУчетТоваровПоЗаказамПокупателей = Ложь;
			КонецЕсли;
			// Включение НДС в стоимость/Исключение из стоимости
			//***************************************************
			
			//*****************************
			// Для последующего поступления
			Если ЕстьПоступлениеПоРезультатамСписания Тогда
				Если СтрокаТаблицыСписания.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателя тогда
					СтрокаРаспределеннойТаблицы.СкладПолучатель = СтрокаРаспределеннойТаблицы.Склад;
				КонецЕсли;
			КонецЕсли; 
			// Для последующего поступления
			//*****************************
		КонецЕсли; 
		// Сложный учет НДС
		//***************************************************
		
		СтрокаРаспределеннойТаблицы.Количество = СтрокаПартии.Количество;
		СтрокаРаспределеннойТаблицы.КоличествоПоступление = СтрокаПартии.КоличествоПоступление;
		
		СтрокаРаспределеннойТаблицы.Комиссионный  = УправлениеЗапасамиПартионныйУчет.КомиссионныйТовар(СтрокаРаспределеннойТаблицы.СчетУчетаБУ);
		
		Если СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.Реализация
			ИЛИ СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.РеализацияКомиссия
			ИЛИ СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.РеализацияРозница
			ИЛИ СтрокаРаспределеннойТаблицы.КодОперацииПартииТоваров = КодыОпераций.ВозвратОтПокупателя
			Тогда
			
			Если СтрокаРаспределеннойТаблицы.Комиссионный тогда
				СтруктураРеквизитовДокумента = Новый Структура("Контрагент,ДоговорКонтрагента");
				Если ЗначениеЗаполнено(СтрокаПартии.ДокументОприходования) Тогда
					
					УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтрокаПартии.ДокументОприходования, СтруктураРеквизитовДокумента);
					СтрокаРаспределеннойТаблицы.ДоговорКомиссии = СтруктураРеквизитовДокумента.ДоговорКонтрагента;
					СтруктураРеквизитовДоговора = Новый Структура("УчетАгентскогоНДС");
					УправлениеЗапасамиПартионныйУчет.ПолучитьРеквизитыОбъекта(СтруктураРеквизитовДокумента.ДоговорКонтрагента, СтруктураРеквизитовДоговора);
					
					СтрокаРаспределеннойТаблицы.УчетАгентскогоНДС = СтруктураРеквизитовДоговора.УчетАгентскогоНДС;
					СчетаРасчетов = БухгалтерскийУчетРасчетовСКонтрагентами.ПолучитьСчетаРасчетовСКонтрагентом(СтрокаТаблицыСписания.Организация, СтруктураРеквизитовДокумента.Контрагент, 
					СтруктураРеквизитовДокумента.ДоговорКонтрагента);
					
					СтрокаРаспределеннойТаблицы.СчетРасчетовСКомитентом = СчетаРасчетов.СчетРасчетовСКомитентом;
				Иначе
					СтрокаРаспределеннойТаблицы.УчетАгентскогоНДС = Ложь;
					СтрокаРаспределеннойТаблицы.Комиссионный = Ложь;
				КонецЕсли; 
				
			КонецЕсли;
		КонецЕсли;
		
		//Поиск соответствующей строки списания, отражаемой в налоговом учете
		Если Не СтрокаТаблицыСписания.ОтражатьВНалоговомУчете Тогда
			СтруктураПоискаНУ.НомерСтрокиДокумента = СтрокаТаблицыСписания.НомерСтрокиДокумента;
			СтруктураПоискаНУ.ДокументОприходования = СтрокаТаблицыСписания.ДокументОприходования;
			Если РаспределеннаяТаблица.НайтиСтроки(СтруктураПоискаНУ).Количество() <> 0 Тогда
				СтрокаРаспределеннойТаблицы.ОтражатьВНалоговомУчете = Истина;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	Для каждого СтрокаКУдалению Из МассивСтрокКУдалению Цикл
		РаспределеннаяТаблица.Удалить(СтрокаКУдалению);
	КонецЦикла;
	
	Возврат РаспределеннаяТаблица;
	
КонецФункции // ()

// СЛУЖЕБНЫЕ ФУНКЦИИ
/////////////////////

// Процедура используется для проведения документов по регистрам подсистемы НДС
// Вызывается из обработки "Проведение документов по регистрам НДС" и из 
// документа "Расчет НДС по продукции"
Процедура ДвижениеНДСпоТаблицеДокументов(ТаблицаДокументов,ФормироватьПроводки = Истина) Экспорт
	
	Для Каждого Строка из ТаблицаДокументов Цикл
		
		ТаблицаСписания = УправлениеЗапасамиПартионныйУчет.ПолучитьТаблицуСтрокДокументов(Строка.Регистратор);
		ДополнитьСписанныеТоварыДаннымиПоКомиссии(Строка.Регистратор, ТаблицаСписания);
		Если ТаблицаСписания.Количество()>0 Тогда
			
			#Если Клиент Тогда
				Состояние("Проведение по НДС документа " + ТаблицаСписания[0].Регистратор);
			#КонецЕсли
			
			СтруктураПараметров = Новый Структура;
			
			// Приведение таблицы списания к требуемому виду
			УправлениеЗапасамиПартионныйУчет.ПодготовитьТаблицуСписания(СтруктураПараметров,ТаблицаСписания, Ложь, Истина, Истина);
			
			МоментКон = Новый МоментВремени(ТаблицаСписания[0].Период, ТаблицаСписания[0].Регистратор);
			
			СтруктураПараметров.Вставить("УчетнаяПолитика", УправлениеЗапасамиПартионныйУчет.ПолучитьУчетнуюПолитику(МоментКон,,,,,ТаблицаСписания[0].Организация));
			
			СтруктураПараметров.Вставить("ТолькоДвиженияНДС");
			
			Организация = ТаблицаСписания[0].Организация;
			
			СтруктураПараметров.Вставить("ЕстьСтрокиОтражатьВБухгалтерскомУчете", 	ТаблицаСписания.Найти(Истина, "ОтражатьВБухгалтерскомУчете")<>Неопределено);
			СтруктураПараметров.Вставить("ЕстьСтрокиОтражатьВНалоговомУчете", 		Ложь);
			СтруктураПараметров.Вставить("ТолькоВключениеНДСВСтоимостьНУ", 			Истина);
			СтруктураПараметров.Вставить("ЕстьСтрокиОтражатьВУправленческомУчете", 	Ложь);
			СтруктураПараметров.Вставить("ЕстьСтрокиОтражатьВМеждународномУчете", 	Ложь);
			
			// Движения - наборы записей по регистрам
			УправлениеЗапасамиПартионныйУчет.СоздатьНаборыЗаписей(СтруктураПараметров, ТаблицаСписания, ТаблицаСписания[0].Регистратор);
			
			// Подготовка наборов записей
			УправлениеЗапасамиПартионныйУчет.ПодготовитьНаборыЗаписей(СтруктураПараметров, ТаблицаСписания, ТаблицаСписания[0].Период, ТаблицаСписания[0].Регистратор, Истина, Ложь);
			
			//Сохраним партионные регистры БУ
			ЗагрузитьВТаблицуЗначенийСписанныеПартии(СтруктураПараметров, "ДвиженияПартииТоваровНаСкладахБух", 			"ТаблицаДвиженийПартииТоваровНаСкладахБух");
			ЗагрузитьВТаблицуЗначенийСписанныеПартии(СтруктураПараметров, "ДвиженияПартииТоваровПереданныеБух", 		"ТаблицаДвиженийПартииТоваровПереданныеБух");
			ЗагрузитьВТаблицуЗначенийСписанныеПартии(СтруктураПараметров, "ДвиженияПартииМатериаловВЭксплуатацииБух", 	"ТаблицаДвиженийПартииМатериаловВЭксплуатацииБух");
			
			ЗагрузитьВТаблицуЗначенийСписанныеПартии(СтруктураПараметров, "ДвиженияНезавершенноеПроизводствоБух", 		"ТаблицаДвиженийНезавершенноеПроизводствоБух");
			ЗагрузитьВТаблицуЗначенийСписанныеПартии(СтруктураПараметров, "ДвиженияБракВПроизводствеБух", 				"ТаблицаДвиженийБракВПроизводствеБух");
			ЗагрузитьВТаблицуЗначенийСписанныеПартии(СтруктураПараметров, "ДвиженияЗатратыБух", 						"ТаблицаДвиженийЗатратыБух");
			
			СтруктураПараметров.ИзмененыДвиженияСтоимостьОСБух = Ложь;
			
			ВыполнитьДвиженияПоНДС(СтруктураПараметров, ТаблицаСписания);
			
			Если НЕ ФормироватьПроводки Тогда
				СтруктураПараметров.Вставить("ИзмененыДвиженияХозрасчетный", Ложь);
				СтруктураПараметров.Вставить("ИзмененыДвиженияНалоговый", 	 Ложь);
			КонецЕсли;
			
			УправлениеЗапасамиПартионныйУчет.ЗаписатьДвиженияДокумента(СтруктураПараметров, ТаблицаСписания, Истина);
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБОЛОЧКИ ДЛЯ ВЫЗОВА СООТВЕТСТВУЮЩИХ ПРОЦЕДУР И ФУНКЦИЙ ИЗ МОДУЛЯ УЧЕТ НДС

//
//
Процедура ВыполнитьДвиженияНДСНалоговогоАгентаКомиссионер(СтруктураШапкиДокумента, РаспределеннаяТаблицаСписания, СтруктураПараметров)

	Строка = "Комплектация,Реализация,РеализацияКомиссия,РеализацияРозница";
	
	ДанныеДляОбработки = ОтобратьСтрокиПостроителемЗапроса(Строка, РаспределеннаяТаблицаСписания);
	
	Если ДанныеДляОбработки = Неопределено тогда
		Возврат;
	КонецЕсли;
	
	ОтразитьНДСНалоговогоАгентаКомиссионер(СтруктураШапкиДокумента, ДанныеДляОбработки, СтруктураПараметров);

КонецПроцедуры

Процедура ВыполнитьДвиженияПоРегиструНДСпоОСиНМА_СписаниеМатериаловНаОСиНМА(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ)
	
	// НДС по ОС - при списании ТМЦ они могут перестать принадлежать к будущим ОС,
	// в этом случае необходимо снять блокировку с вычета.
	// Если в результате перемещения ТМЦ будет отнесено на счет учета ОС, необходимо включить блокировку.
	
	Строка = "СписаниеНаВложенияВоВнеоборотныеАктивы, СписаниеНаСтроительствоОбъектовОС";
			
	ДанныеДляОбработки = ОтобратьСтрокиПартийПоКодамОпераций(Строка, ТаблицаНДСПартииСписания, СтруктураПараметров);
	
	СформироватьДвиженияПоРегиструНДСпоОСиНМА_СписаниеМатериаловНаОСиНМА(СтруктураШапкиДокумента, ДанныеДляОбработки, СтруктураПараметров, Отказ);

КонецПроцедуры

Процедура ВыполнитьДвиженияПоРегиструНДСпоОСиНМА_ПеремещениеОборудования(СтруктураШапкиДокумента, СтруктураПараметров, Отказ)
	
	// НДС по ОС - при списании ТМЦ они могут перестать принадлежать к будущим ОС,
	// в этом случае необходимо снять блокировку с вычета.
	// Если в результате перемещения ТМЦ будет отнесено на счет учета ОС, необходимо включить блокировку.
	
	Строка = "ВозвратОтКомиссионера, ВозвратОтПереработчика, ВозвратПоставщику, ВыпускПоОперацииСтоимость, ВыпускПродукцииФиксНаСклад, ВключениеНДСВСтоимость,
			| Комплектация, ПередачаВПереработку, ПередачаМатериаловВЭксплуатацию, ПередачаНаКомиссию, ПередачаОборудованияВМонтаж, 
			| ПеремещениеМеждуСкладами, ПринятиеКУчетуОС, ПринятиеКУчетуОССоСписаниемНаЗатраты, Реализация, РеализацияКомиссия,
			| РеализацияРозница, СписаниеНаБрак, СписаниеНаВложенияВоВнеоборотныеАктивы, СписаниеНаЗатраты, СписаниеНаСтроительствоОбъектовОС,
			| СписаниеПартийВПроизводствоОперативно, СписаниеПартийПереданныхВПроизводство, СписаниеПоИнвентаризации, ВключениеАктиваВСоставМПЗ";
			
	СтруктураКодовОпераций = Новый Структура(Строка);
	СписокОтбора = Новый СписокЗначений;
	
	Для каждого Элемент из СтруктураКодовОпераций Цикл
		СписокОтбора.Добавить(Перечисления.КодыОперацийПартииТоваров[Элемент.Ключ]);
	КонецЦикла;
	
	ДанныеДляОбработки = Новый ТаблицаЗначений;
		
	Для каждого Колонка из СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.Колонки Цикл
			
		ДанныеДляОбработки.Колонки.Добавить(Колонка.Имя,Колонка.ТипЗначения);
			
	КонецЦикла;
	
	Для каждого Строка из СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров Цикл
		Если СписокОтбора.НайтиПоЗначению(Строка.КодОперацииПартииТоваров)<> Неопределено тогда
			 НоваяСтрока = ДанныеДляОбработки.Добавить();
			 ЗаполнитьЗначенияСвойств(НоваяСтрока,Строка);
		КонецЕсли;
	КонецЦикла;
	
	УчетНДСФормированиеДвижений.СформироватьДвиженияПоРегиструНДСпоОСиНМА_ПеремещениеОборудования(СтруктураШапкиДокумента, ДанныеДляОбработки, СтруктураПараметров, Отказ);

КонецПроцедуры

Процедура ВыполнитьДвиженияПоступленияПоРегиструНДСПартииТоваровКомплектацияВыпуск(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ)
	
	Если Не СтруктураШапкиДокумента.ВидДокумента = "КомплектацияНоменклатуры" 
		Или Не (СтруктураШапкиДокумента.Свойство("ВидОперации") 
				И СтруктураШапкиДокумента.ВидОперации = Перечисления.ВидыОперацийКомплектацияНоменклатуры.ВыпускПродукции) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТаблицаНДСПартииСписания.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаДвиженийПартии = СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.СкопироватьКолонки();
		
	КолНДСПартииТоваров = СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.Количество();
	
	ЕстьСерияНоменклатурыНовая = ТаблицаНДСПартииСписания.Колонки.Найти("СерияНоменклатурыНовая") <> Неопределено;
	
	Для Каждого СтрокаВыборки Из ТаблицаНДСПартииСписания Цикл
	
		НоваяСтрока = ТаблицаДвиженийПартии.Добавить();
		НоваяСтрока.Активность = Истина;
		НоваяСтрока.ВидДвижения = ВидДвиженияНакопления.Приход;
		НоваяСтрока.Период = СтруктураШапкиДокумента.Дата;
		
		НоваяСтрока.Организация = СтруктураШапкиДокумента.Организация;
		НоваяСтрока.СчетУчета = СтрокаВыборки.СчетУчета;
		
		НоваяСтрока.Номенклатура = СтрокаВыборки.Номенклатура;
		НоваяСтрока.ХарактеристикаНоменклатуры = СтрокаВыборки.ХарактеристикаНоменклатуры;
		
		Если СтруктураШапкиДокумента.ПартионныйУчетНДСвРазрезеСерийИХарактеристик
		   И СтрокаВыборки.ВестиПартионныйУчетПоСериям
		   И ЕстьСерияНоменклатурыНовая
		Тогда
			НоваяСтрока.СерияНоменклатуры = СтрокаВыборки.СерияНоменклатурыНовая;
		Иначе
			НоваяСтрока.СерияНоменклатуры = Неопределено;
		КонецЕсли;
		
		НоваяСтрока.Партия = СтрокаВыборки.Регистратор;
		
		НоваяСтрока.Заказ = Неопределено;
		
		НоваяСтрока.Склад = СтрокаВыборки.СкладПолучатель;
		
		НоваяСтрока.Количество = СтрокаВыборки.Количество;
		НоваяСтрока.Стоимость = 0;
		
		НоваяСтрока.СписаниеПартий = Истина;
		
	КонецЦикла;	
	
	// Добавим колонки для обработки заказа покупателя.
	ТаблицаДвиженийПартии.Колонки.Добавить("ОбособленныйУчетТоваровПоЗаказамПокупателей");
	ТаблицаДвиженийПартии.ЗаполнитьЗначения(Ложь,"ОбособленныйУчетТоваровПоЗаказамПокупателей");
			
	ТаблицаДвиженийПартии.Колонки.Добавить("ЗаказПокупателя");
	ТаблицаДвиженийПартии.ЗаполнитьЗначения(Неопределено,"ЗаказПокупателя");
	
	ТаблицаДвиженийПартии.Колонки.СчетУчета.Имя = "СчетУчетаЦенности";
		
	УчетНДСФормированиеДвижений.СформироватьДвиженияПоступленияПоРегиструНДСПартииТоваров(СтруктураШапкиДокумента, ТаблицаДвиженийПартии, СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров, Отказ);

	// Устанавливаем флаги модификации
	СтруктураПараметров.ИзмененыДвиженияНДСПартииТоваров = СтруктураПараметров.ИзмененыДвиженияНДСПартииТоваров 
								ИЛИ (КолНДСПартииТоваров <> СтруктураПараметров.ТаблицаДвиженийНДСПартииТоваров.Количество());
									
КонецПроцедуры//ВыполнитьДвиженияПоступленияПоРегиструНДСПартииТоваров

Процедура ВыполнитьДвиженияНДСНезавершенноеПроизводство(СтруктураШапкиДокумента, СтруктураПараметров, ТаблицаНДСПартииСписания, Отказ)
	
	Если ?(СтруктураШапкиДокумента.Свойство("СложныйУчетНДС"),НЕ СтруктураШапкиДокумента.СложныйУчетНДС,
		НЕ (УправлениеЗапасамиПартионныйУчет.ПолучитьПараметрУчетнойПолитикиПартионногоУчета("СложныйУчетНДС", "Нал", СтруктураПараметров) = Истина))
		Тогда
		
		Возврат;
	КонецЕсли; 
	
	Если УправлениеЗапасами.ИспользуетсяРасширеннаяАналитикаУчета(СтруктураШапкиДокумента.Дата) Тогда
		Возврат;//При использовании расширенной аналитики движения по регистру НДСНезавершенноеПроизводство не формируются
	КонецЕсли;	
	
	ДанныеДляОбработки = Новый ТаблицаЗначений;
	
	ИспользоватьРА = УправлениеЗапасами.ИспользуетсяРасширеннаяАналитикаУчета(СтруктураШапкиДокумента.Дата);
	
	Для каждого Колонка ИЗ ТаблицаНДСПартииСписания.Колонки Цикл
			
		ДанныеДляОбработки.Колонки.Добавить(Колонка.Имя,Колонка.ТипЗначения);
			
	КонецЦикла;
	
		Для Каждого Строка из ТаблицаНДСПартииСписания Цикл
			
			ХарактерЗатрат = УправлениеЗатратами.ПолучитьХарактерЗатратПоСчетуЗатрат(Строка.КорСчетБУ, Строка.СтатьяЗатрат);
			Если ХарактерЗатрат = Перечисления.ХарактерЗатрат.ПроизводственныеРасходы Тогда
					НоваяСтрока = ДанныеДляОбработки.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока,Строка);
			КонецЕсли;

		КонецЦикла;
	
	// Получили движения, для которых может произойти списание на незавершенное производство
	СформироватьДвиженияНДСНезавершенноеПроизводство(СтруктураШапкиДокумента, СтруктураПараметров, ДанныеДляОбработки, Отказ);

КонецПроцедуры//ВыполнитьДвиженияНДСНезавершенноеПроизводство

Процедура ВыполнитьДвиженияПоРегистрамНДССписаниеРасходовпоВНА(СтруктураШапкиДокумента, РаспределеннаяТаблицаСписания, СтруктураПараметров, Отказ)
	
	СтрокаКодовОпераций = "ПередачаМатериаловВЭксплуатацию";//, ПринятиеКУчетуОС, ПринятиеКУчетуОССоСписаниемНаЗатраты";
	
	ДанныеДляОбработки = ОтобратьСтрокиПостроителемЗапроса(СтрокаКодовОпераций, РаспределеннаяТаблицаСписания);
	
	Если ДанныеДляОбработки = Неопределено тогда
		Возврат;
	КонецЕсли;
	
	Если не СтруктураШапкиДокумента.УчитыватьНДС Тогда
		Возврат;
	КонецЕслИ;
		
	РаспределитьРасходыПоВНАнаСпособыОтраженияРасходовПоАмортизации(СтруктураШапкиДокумента, СтруктураПараметров, ДанныеДляОбработки, Отказ);
	
КонецПроцедуры

Функция ПолучитьТаблицуПоступлениеНМА(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоНМА;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоНМА);
	
	Возврат ТаблицаПоНМА;
	
КонецФункции

Функция ПолучитьТаблицуНачислениеНДСпоСМРхозспособом(ДокументОбъект, Ошибка, ДляКнигиПродаж = Ложь)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоСМРхозспособом;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Неопределено);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоСМРхозспособом);
	
	Возврат ТаблицаПоСМРхозспособом;
	
КонецФункции

Функция ПолучитьТаблицуРеализацияОтгруженныхТоваров(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Ошибка);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам);
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуАктОбОказанииПроизводственныхУслуг(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоУслугам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Ошибка);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоУслугам);
	
	Возврат ТаблицаПоУслугам;
	
КонецФункции

Функция ПолучитьТаблицуПередачаОС(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента, Ошибка);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам);
	
	ТаблицаПоТоварам.Колонки.ОсновноеСредство.Имя = "Номенклатура";
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

Функция ПолучитьТаблицуПередачаНМА(ДокументОбъект, Ошибка)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам;
	
	ДокументОбъект.ПодготовитьСтруктуруШапкиДокумента("", СтруктураШапкиДокумента);
	
	ДокументОбъект.ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам);
	
	ТаблицаПоТоварам.Колонки.НематериальныйАктив.Имя = "Номенклатура";
	
	Возврат ТаблицаПоТоварам;
	
КонецФункции

//Определяет применяется ли упрощенный учет НДС
//
Функция ПолучитьУПУпрощенныйУчетНДС(Организация, Знач Дата, УчетнаяПолитика = Неопределено) Экспорт

	Возврат Ложь;
	//Если Не ЗначениеЗаполнено(Организация) Тогда
	//	Возврат Ложь;
	//КонецЕсли;
	//
	//Если Не ЗначениеЗаполнено(Дата) Тогда
	//	Дата = ТекущаяДата();
	//КонецЕсли;

	//Если УчетнаяПолитика <> Неопределено
	//	и УчетнаяПолитика.Количество() > 0
	//	И УчетнаяПолитика.Организация = Организация
	//	И УчетнаяПолитика.Период = НачалоМесяца(Дата)
	//	И УчетнаяПолитика.Свойство("УпрощенныйУчетНДС") Тогда
	//	Возврат УчетнаяПолитика.УпрощенныйУчетНДС;
	//КонецЕсли;
	//
	//ОшибкаВПолучении = Ложь;
	//УчетнаяПолитика = ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитики(Дата, ОшибкаВПолучении, Организация,,Ложь);
	//	
	//Возврат ?(ОшибкаВПолучении, Ложь, УчетнаяПолитика.УпрощенныйУчетНДС);

КонецФункции

// Определяет дату документов из колонки таблицы значений с именем, переданным в параметре КолонкаДокумента
// и записывает ее в колонку с именем, переданным в параметре КолонкаСДатой.
// Колонки с такими именами должны существовать.
//
Процедура ЗаполнитьДатуДокументовВТаблице(Таблица, КолонкаДокумента, КолонкаСДатой) Экспорт

	КэшПоТипам = Новый Соответствие;

	Для каждого СтрокаТаблицы Из Таблица Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаТаблицы[КолонкаДокумента]) тогда 
			Продолжить;
		КонецЕсли;
		
		ТипТекущегоДокумента = ТипЗнч(СтрокаТаблицы[КолонкаДокумента]);
		МассивТипа = КэшПоТипам[ТипТекущегоДокумента];
		Если МассивТипа = Неопределено Тогда
			МассивТипа = Новый Массив;
			КэшПоТипам.Вставить(ТипТекущегоДокумента, МассивТипа);
		КонецЕсли;
		МассивТипа.Добавить(СтрокаТаблицы[КолонкаДокумента]);
	КонецЦикла;
	
	Если КэшПоТипам.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;

	Для каждого КлючИЗначение Из КэшПоТипам Цикл
		ИмяМетаданных = Метаданные.НайтиПоТипу(КлючИЗначение.Ключ).Имя;

		Запрос.Текст = Запрос.Текст 
		+ ?(Запрос.Текст = "", "",
		" 
		|ОБЪЕДИНИТЬ ВСЕ")
		+ "
		|	ВЫБРАТЬ
		|		Док.Ссылка КАК Ссылка,
		|		Док.Дата КАК Дата
		|	ИЗ Документ." + ИмяМетаданных + " КАК Док
		|	ГДЕ Док.Ссылка В (&ДокументыТипа_" + ИмяМетаданных + ")";
		ОбщегоНазначения.УдалитьПовторяющиесяЭлементыМассива(КлючИЗначение.Значение);
		Запрос.УстановитьПараметр("ДокументыТипа_" + ИмяМетаданных, КлючИЗначение.Значение);
		
	КонецЦикла;
	
    Таблица.Индексы.Добавить(КолонкаДокумента);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить(КолонкаДокумента, Выборка.Ссылка);
		НайденныеСтроки = Таблица.НайтиСтроки(ПараметрыОтбора);
		Для каждого Строка Из НайденныеСтроки Цикл
			Строка[КолонкаСДатой] = Выборка.Дата;
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Процедуры и функции обновления ИБ

// Документы виды КорректировочныйСчетФактура... более не используется
// производится замена их на документы КорректировкаПоступления/КорректировкаРеализации
// с регистрацией счетов-фактур
//
Процедура ОбработатьКорректировочныеСчетаФактуры() Экспорт
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
		
	СчетДоходов              = ПланыСчетов.Хозрасчетный.ВыручкаНеОблагаемаяЕНВД;
	СчетРасходов             = ПланыСчетов.Хозрасчетный.СебестоимостьПродажНеОблагаемаяЕНВД;
	
	// Обработка корректировочных счетов-фактур выданных
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УдалитьКорректировочныйСчетФактураВыданный.Ссылка,
	|	УдалитьКорректировочныйСчетФактураВыданный.СчетФактура КАК ДокументРеализации,
	|	УдалитьКорректировочныйСчетФактураВыданный.Номер КАК НомерСчетаФактуры,
	|	УдалитьКорректировочныйСчетФактураВыданный.Дата КАК Дата,
	|	УдалитьКорректировочныйСчетФактураВыданный.Организация КАК Организация,
	|	УдалитьКорректировочныйСчетФактураВыданный.Контрагент КАК Контрагент,
	|	УдалитьКорректировочныйСчетФактураВыданный.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	УдалитьКорректировочныйСчетФактураВыданный.ВалютаДокумента КАК ВалютаДокумента,
	|	УдалитьКорректировочныйСчетФактураВыданный.СчетФактура.Номер КАК НомерИсходногоДокумента,
	|	УдалитьКорректировочныйСчетФактураВыданный.СчетФактура.Дата КАК ДатаИсходногоДокумента,
	|	УдалитьКорректировочныйСчетФактураВыданный.ТоварыИУслуги.(
	|		Номенклатура КАК Номенклатура,
	|		КоличествоДоИзменения КАК КоличествоДоИзменения,
	|		КоличествоПослеИзменения КАК Количество,
	|		ЦенаДоИзменения КАК ЦенаДоИзменения,
	|		ЦенаПослеИзменения КАК Цена,
	|		СтоимостьБезНДСДоИзменения КАК СуммаДоИзменения,
	|		СтоимостьБезНДСПослеИзменения КАК Сумма,
	|		СтавкаНДС КАК СтавкаНДС,
	|		СуммаНДСДоИзменения КАК СуммаНДСДоИзменения,
	|		СуммаНДСПослеИзменения КАК СуммаНДС,
	|		ЕСТЬNULL(УдалитьКорректировочныйСчетФактураВыданный.ТоварыИУслуги.Номенклатура.Услуга, ЛОЖЬ) КАК Услуга,
	|		НаименованиеНоменклатуры КАК Содержание,
	|		ВидЦенности КАК ВидЦенности
	|	)
	|ИЗ
	|	Документ.УдалитьКорректировочныйСчетФактураВыданный КАК УдалитьКорректировочныйСчетФактураВыданный
	|ГДЕ
	|	УдалитьКорректировочныйСчетФактураВыданный.Проведен";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НовыйДокументКорректировки = Документы.КорректировкаРеализации.СоздатьДокумент();
		НовыйДокументКорректировки.ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение;
		
		ЗаполнитьЗначенияСвойств(НовыйДокументКорректировки, Выборка);		
		
		ВыборкаТоварыИУслуги = Выборка.ТоварыИУслуги.Выбрать();
		Пока ВыборкаТоварыИУслуги.Следующий() Цикл
			
			Если ВыборкаТоварыИУслуги.Услуга Тогда
				НоваяСтрока = НовыйДокументКорректировки.Услуги.Добавить();	
			Иначе
				НоваяСтрока = НовыйДокументКорректировки.Товары.Добавить();
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаТоварыИУслуги);
			
			Если НЕ ВыборкаТоварыИУслуги.Услуга Тогда
				СчетУчетаНДС = "";
				ПолучитьСчетУчетаПоВидуЦенности(НоваяСтрока.СчетУчетаБУ, СчетУчетаНДС, ВыборкаТоварыИУслуги.ВидЦенности, Выборка.ДоговорКонтрагента, ВалютаРегламентированногоУчета);
			КонецЕсли;			
			
			НоваяСтрока.СчетРасходовБУ             = СчетРасходов;
			НоваяСтрока.СчетДоходовБУ              = СчетДоходов;			
			
		КонецЦикла;
		
		НовыйДокументКорректировки.КорректироватьБУиНУ = Ложь;
		НовыйДокументКорректировки.Комментарий         = "## Создан на основании: " + Выборка.Ссылка + " ##";
		
	    Попытка
    	    НовыйДокументКорректировки.Записать(РежимЗаписиДокумента.Проведение);
			Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			
			// Создаем счет-фактуру		
			СчетФактура = Документы.СчетФактураВыданный.СоздатьДокумент();			
			СчетФактура.Заполнить(НовыйДокументКорректировки.Ссылка); 
			СчетФактура.ОпределениеПараметровСчетаФактуры();
			СчетФактура.Контрагент                  = Выборка.Контрагент;
			СчетФактура.ДоговорКонтрагента          = Выборка.ДоговорКонтрагента;
			СчетФактура.Номер                       = Выборка.НомерСчетаФактуры;
			СчетФактура.Дата                        = Выборка.Дата;
			СчетФактура.ВидСчетаФактуры				= Перечисления.ВидСчетаФактурыВыставленного.Корректировочный;
			СчетФактура.НомерИсходногоДокумента     = Выборка.НомерИсходногоДокумента;
			СчетФактура.ДатаИсходногоДокумента      = Выборка.ДатаИсходногоДокумента;
			СчетФактура.Комментарий                 = "## Создан на основании: " + Выборка.Ссылка + " ##";
			
			СчетФактура.ДатаНомерДокументовОплаты.Добавить();
						
			Попытка
				СчетФактура.Записать(РежимЗаписиДокумента.Проведение);				
			Исключение
				ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
			КонецПопытки;
			
		Исключение
			ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
		КонецПопытки;
		
	КонецЦикла;	
	
	// Обработка корректировочных счетов-фактур полученных
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УдалитьКорректировочныйСчетФактураПолученный.Ссылка,
	|	УдалитьКорректировочныйСчетФактураПолученный.Дата КАК Дата,
	|	УдалитьКорректировочныйСчетФактураПолученный.Организация КАК Организация,
	|	УдалитьКорректировочныйСчетФактураПолученный.Контрагент КАК Контрагент,
	|	УдалитьКорректировочныйСчетФактураПолученный.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	УдалитьКорректировочныйСчетФактураПолученный.СчетФактура КАК ДокументПоступления,
	|	УдалитьКорректировочныйСчетФактураПолученный.НомерВходящегоДокумента КАК НомерВходящегоДокумента,
	|	УдалитьКорректировочныйСчетФактураПолученный.ДатаВходящегоДокумента КАК ДатаВходящегоДокумента,
	|	УдалитьКорректировочныйСчетФактураПолученный.ВалютаДокумента КАК ВалютаДокумента,
	|	УдалитьКорректировочныйСчетФактураПолученный.СчетФактура.ДатаВходящегоДокумента КАК ДатаИсходногоДокумента,
	|	УдалитьКорректировочныйСчетФактураПолученный.СчетФактура.НомерВходящегоДокумента КАК НомерИсходногоДокумента,
	|	УдалитьКорректировочныйСчетФактураПолученный.ВосстановлениеНДС.(
	|		СтавкаНДС КАК СтавкаНДС,
	|		СуммаНДС КАК СуммаНДС,
	|		УдалитьКорректировочныйСчетФактураПолученный.ВосстановлениеНДС.Сумма - УдалитьКорректировочныйСчетФактураПолученный.ВосстановлениеНДС.СуммаНДС КАК Сумма,
	|		ВидЦенности КАК ВидЦенности
	|	),
	|	УдалитьКорректировочныйСчетФактураПолученный.ВычетНДС.(
	|		СтавкаНДС КАК СтавкаНДС,
	|		СуммаНДС КАК СуммаНДС,
	|		УдалитьКорректировочныйСчетФактураПолученный.ВычетНДС.Сумма - УдалитьКорректировочныйСчетФактураПолученный.ВычетНДС.СуммаНДС КАК Сумма,
	|		ВидЦенности КАК ВидЦенности
	|	)
	|ИЗ
	|	Документ.УдалитьКорректировочныйСчетФактураПолученный КАК УдалитьКорректировочныйСчетФактураПолученный
	|ГДЕ
	|	УдалитьКорректировочныйСчетФактураПолученный.Проведен";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НовыйДокументКорректировки = Документы.КорректировкаПоступления.СоздатьДокумент();
		НовыйДокументКорректировки.ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение;
		НовыйДокументКорректировки.ВосстановитьНДС = Истина;
		НовыйДокументКорректировки.УчитыватьНДС    = Истина;
		
		ЗаполнитьЗначенияСвойств(НовыйДокументКорректировки, Выборка);		
		
		ВыборкаВосстановлениеНДС = Выборка.ВосстановлениеНДС.Выбрать();
		Пока ВыборкаВосстановлениеНДС.Следующий() Цикл			
			Если ВыборкаВосстановлениеНДС.ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги Тогда
				НоваяСтрока = НовыйДокументКорректировки.Услуги.Добавить();			
				НоваяСтрока.СтавкаНДС           = ВыборкаВосстановлениеНДС.СтавкаНДС;
				НоваяСтрока.СуммаДоИзменения    = ВыборкаВосстановлениеНДС.Сумма;
				НоваяСтрока.СуммаНДСДоИзменения = ВыборкаВосстановлениеНДС.СуммаНДС;
				НоваяСтрока.ЕстьВДокументеПоступления = Истина;			
				ПолучитьСчетУчетаПоВидуЦенности(НоваяСтрока.СчетЗатрат, НоваяСтрока.СчетУчетаНДС, ВыборкаВосстановлениеНДС.ВидЦенности, Выборка.ДоговорКонтрагента, ВалютаРегламентированногоУчета);
			Иначе
				НоваяСтрока = НовыйДокументКорректировки.Товары.Добавить();			
				НоваяСтрока.СтавкаНДС           = ВыборкаВосстановлениеНДС.СтавкаНДС;
				НоваяСтрока.СуммаДоИзменения    = ВыборкаВосстановлениеНДС.Сумма;
				НоваяСтрока.СуммаНДСДоИзменения = ВыборкаВосстановлениеНДС.СуммаНДС;
				НоваяСтрока.ЕстьВДокументеПоступления = Истина;			
				ПолучитьСчетУчетаПоВидуЦенности(НоваяСтрока.СчетУчетаБУ, НоваяСтрока.СчетУчетаНДС, ВыборкаВосстановлениеНДС.ВидЦенности, Выборка.ДоговорКонтрагента, ВалютаРегламентированногоУчета);
			КонецЕсли;
		КонецЦикла;
		
		ВыборкаВычетНДС = Выборка.ВычетНДС.Выбрать();
		Пока ВыборкаВычетНДС.Следующий() Цикл			
			Если ВыборкаВычетНДС.ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги Тогда
				НоваяСтрока = НовыйДокументКорректировки.Услуги.Добавить();			
				НоваяСтрока.СтавкаНДС = ВыборкаВычетНДС.СтавкаНДС;
				НоваяСтрока.Сумма     = ВыборкаВычетНДС.Сумма;
				НоваяСтрока.СуммаНДС  = ВыборкаВычетНДС.СуммаНДС;
				НоваяСтрока.ЕстьВДокументеПоступления = Истина;
				ПолучитьСчетУчетаПоВидуЦенности(НоваяСтрока.СчетЗатрат, НоваяСтрока.СчетУчетаНДС, ВыборкаВычетНДС.ВидЦенности, Выборка.ДоговорКонтрагента, ВалютаРегламентированногоУчета);
			Иначе
				НоваяСтрока = НовыйДокументКорректировки.Товары.Добавить();			
				НоваяСтрока.СтавкаНДС = ВыборкаВычетНДС.СтавкаНДС;
				НоваяСтрока.Сумма     = ВыборкаВычетНДС.Сумма;
				НоваяСтрока.СуммаНДС  = ВыборкаВычетНДС.СуммаНДС;
				НоваяСтрока.ЕстьВДокументеПоступления = Истина;
				ПолучитьСчетУчетаПоВидуЦенности(НоваяСтрока.СчетУчетаБУ, НоваяСтрока.СчетУчетаНДС, ВыборкаВычетНДС.ВидЦенности, Выборка.ДоговорКонтрагента, ВалютаРегламентированногоУчета);
			КонецЕсли;
		КонецЦикла;
		
		НовыйДокументКорректировки.корректироватьБУиНУ = Ложь;
		НовыйДокументКорректировки.Комментарий         = "## Создан на основании: " + Выборка.Ссылка + " ##";
		
	    Попытка
    	    НовыйДокументКорректировки.Записать(РежимЗаписиДокумента.Проведение);
			Выборка.Ссылка.ПолучитьОбъект().УстановитьПометкуУдаления(Истина);
			
			// Создаем счет-фактуру		
			СчетФактура = Документы.СчетФактураПолученный.СоздатьДокумент();			
			СчетФактура.Заполнить(НовыйДокументКорректировки.Ссылка);
			СчетФактура.ОпределениеПараметровСчетаФактуры();
			СчетФактура.Контрагент                  = Выборка.Контрагент;
			СчетФактура.ДоговорКонтрагента          = Выборка.ДоговорКонтрагента;
			СчетФактура.НомерВходящегоДокумента     = Выборка.НомерВходящегоДокумента;
			СчетФактура.ДатаВходящегоДокумента      = Выборка.ДатаВходящегоДокумента;
			СчетФактура.Дата                        = Выборка.Дата;
			СчетФактура.ВидСчетаФактуры             = Перечисления.ВидСчетаФактурыПолученного.Корректировочный;
			СчетФактура.НомерИсходногоДокумента     = Выборка.НомерИсходногоДокумента;
			СчетФактура.ДатаИсходногоДокумента      = Выборка.ДатаИсходногоДокумента;
			СчетФактура.Комментарий                 = "## Создан на основании: " + Выборка.Ссылка + " ##";
			
			Попытка
				СчетФактура.Записать(РежимЗаписиДокумента.Проведение);				
			Исключение
				ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
			КонецПопытки;
			
		Исключение
			ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
		КонецПопытки;
		
	КонецЦикла;	
	
КонецПроцедуры

Процедура ПолучитьСчетУчетаПоВидуЦенности(СчетУчета, СчетУчетаНДС, ВидЦенности, ДоговорКонтрагента, ВалютаРегламентированногоУчета)
		
	Если ВидЦенности = Перечисления.ВидыЦенностей.АвансыВыданные Тогда
		ИмяСчета = "РасчетыПоАвансамВыданным";
		Если ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "УЕ";
		ИначеЕсли ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И НЕ ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "Вал";
		КонецЕсли;
		СчетУчета    =  ПланыСчетов.Хозрасчетный[ИмяСчета];
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоАвансамИПредоплатамВыданным;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.АвансыПолученные Тогда
		ИмяСчета = "РасчетыПоАвансамПолученным";
		Если ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "УЕ";
		ИначеЕсли ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И НЕ ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "Вал";
		КонецЕсли;
		СчетУчета    =  ПланыСчетов.Хозрасчетный[ИмяСчета];
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоАвансамИПредоплатам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.АвансыПолученные0 Тогда
		ИмяСчета = "РасчетыПоАвансамПолученным";
		Если ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "УЕ";
		ИначеЕсли ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И НЕ ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "Вал";
		КонецЕсли;
		СчетУчета    =  ПланыСчетов.Хозрасчетный[ИмяСчета];
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоАвансамИПредоплатам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ВнутреннееПотребление Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымМПЗ;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.Возврат Тогда
		ИмяСчета = "РасчетыПоПретензиям";
		Если ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "УЕ";
		ИначеЕсли ДоговорКонтрагента.ВалютаВзаиморасчетов <> ВалютаРегламентированногоУчета 
			И НЕ ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			ИмяСчета = ИмяСчета + "Вал";
		КонецЕсли;
		СчетУчета    =  ПланыСчетов.Хозрасчетный[ИмяСчета];
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымМПЗ;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ИмуществоСУчетомНДС Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.СтроительствоОбъектовОсновныхСредств;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымМПЗ;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.КомандировочныеРасходы Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.Материалы Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.СырьеИМатериалы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымМПЗ;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентАренда Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.РасчетыНДСНалоговогоАгента;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентРеализацияИмущества Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.РасчетыНДСНалоговогоАгента;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентИностранцы Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.РасчетыНДСНалоговогоАгента;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.НалоговыйАгентКомитент Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.РасчетыНДСНалоговогоАгента;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.НМА Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ПриобретениеНематериальныхАктивов;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымНематериальнымАктивам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.Оборудование Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСприПриобретенииОсновныхСредств;

	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ОбъектыНезавершенногоСтроительства Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.СтроительствоОбъектовОсновныхСредств;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСприСтроительствеОсновныхСредств;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ОС Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСприПриобретенииОсновныхСредств;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ПосредническиеУслуги Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ПредставительскиеРасходы Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ПрочиеРаботыИУслуги Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.СМРПодрядные Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.СтроительствоОбъектовОсновныхСредств;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.СМРСобственнымиСилами Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.СтроительствоОбъектовОсновныхСредств;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.СуммыСвязанныеСРасчетамиПоОплате Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.РасчетыПоНДСотложенномуДляУплатыВБюджет;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ТаможенныеПлатежи Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСуплачиваемыйТаможеннымОрганам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ТаможенныеПлатежиОС Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСуплачиваемыйТаможеннымОрганам;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.Товары Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ТоварыНаСкладах;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымМПЗ;
		
	ИначеЕсли ВидЦенности = Перечисления.ВидыЦенностей.ТоварыУслугиКомитентов Тогда
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ТоварыНаСкладе;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымМПЗ;
	Иначе
		СчетУчета    =  ПланыСчетов.Хозрасчетный.ОбщехозяйственныеРасходы;
	  	СчетУчетаНДС = 	ПланыСчетов.Хозрасчетный.НДСпоПриобретеннымУслугам;
	КонецЕсли;
		
КонецПроцедуры

// У счетов-фактур полученных добавлен реквизит ВидСчетаФактуры
// 
Процедура УстановитьВидСчетаФактурыПолученного() Экспорт
	
	#Если Клиент Тогда
	//Обновление документов "Счет-фактура полученный" установка вида счета-фактуры
	Состояние("Выполняется обновление документов ""Счет-фактура полученный""");
	#КонецЕсли
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетФактураПолученный.Ссылка
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыПолученного.ПустаяСсылка)";
	
	Результат = Запрос.Выполнить();
	Если Не Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			СчетФактура = Выборка.Ссылка.ПолучитьОбъект();
						
			Если СчетФактура.УдалитьНаАванс Тогда
				СчетФактура.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаАванс;
			Иначе
				СчетФактура.ВидСчетаФактуры = Перечисления.ВидСчетаФактурыПолученного.НаПоступление;
			КонецЕсли;
			
			Попытка
				СчетФактура.ОбменДанными.Загрузка = Истина;
				СчетФактура.Записать(РежимЗаписиДокумента.Запись);
			Исключение
				ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;
	
	#Если Клиент Тогда
		Состояние("");
	#КонецЕсли

	
КонецПроцедуры

// Процедура производит установку даты применения Постановления 1137 в значение 01.04.2012
//
Процедура УстановитьДатуПримененияПостановления1137() Экспорт 
	
	НачалоПримененияИсправленныхСчетовФактур = Константы.НачалоПримененияИсправленныхСчетовФактур.Получить();
	
	Если НЕ ЗначениеЗаполнено(НачалоПримененияИсправленныхСчетовФактур)
		ИЛИ НачалоПримененияИсправленныхСчетовФактур > '20120401' Тогда
		
		Константы.НачалоПримененияИсправленныхСчетовФактур.Установить('20120401');
		
	КонецЕсли;
		
КонецПроцедуры

// В документ добавлена новая т.ч. Покупатели, в неё необходимо добавить одну строку.
// В колонку Покупатель пишем контрагента-комиссионера из шапки
//
Процедура ЗаполнитьТЧПокупателиОтчетКомиссионераОПродажах() Экспорт
	
	#Если Клиент Тогда
	//Обновление документов "Отчет комиссионера о продажах", добавление строки в табличную часть Покупатели
	Состояние("Выполняется обновление документов ""Отчет комиссионера о продажах""");
	#КонецЕсли
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажах.Ссылка КАК Ссылка,
	|	ОтчетКомиссионераОПродажах.Контрагент
	|ПОМЕСТИТЬ ВТ_ОтчетыКомиссионера
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетКомиссионераОПродажах.Ссылка,
	|	ОтчетКомиссионераОПродажах.Контрагент
	|
	|ИМЕЮЩИЕ
	|	КОЛИЧЕСТВО(ОтчетКомиссионераОПродажах.Покупатели.НомерСтроки) = 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ОтчетыКомиссионера.Ссылка КАК ОтчетКомиссионера,
	|	СчетФактураВыданный.Ссылка КАК Ссылка,
	|	СчетФактураВыданный.Дата КАК Дата,
	|	ВЫБОР
	|		КОГДА СчетФактураВыданный.Проведен
	|			ТОГДА 2
	|		КОГДА СчетФактураВыданный.ПометкаУдаления
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК Приоритет
	|ПОМЕСТИТЬ ВТ_СчетФактуры
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ОтчетыКомиссионера КАК ВТ_ОтчетыКомиссионера
	|		ПО СчетФактураВыданный.ДокументОснование = ВТ_ОтчетыКомиссионера.Ссылка
	|			И (СчетФактураВыданный.ВидСчетаФактуры = ЗНАЧЕНИЕ(Перечисление.ВидСчетаФактурыВыставленного.НаРеализацию))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ОтчетКомиссионера,
	|	Приоритет
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_СчетФактуры.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	МАКСИМУМ(ВТ_СчетФактуры.Приоритет) КАК Приоритет
	|ПОМЕСТИТЬ ВТ_Приоритет
	|ИЗ
	|	ВТ_СчетФактуры КАК ВТ_СчетФактуры
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_СчетФактуры.ОтчетКомиссионера
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ОтчетКомиссионера,
	|	Приоритет
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ОтчетыКомиссионера.Ссылка КАК Ссылка,
	|	ВТ_ОтчетыКомиссионера.Контрагент КАК Покупатель,
	|	ВЫБОР
	|		КОГДА ВТ_СчетФактуры.Ссылка ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВыставленСФ,
	|	ВТ_СчетФактуры.Дата КАК ДатаСФ,
	|	ВТ_СчетФактуры.Ссылка КАК СчетФактура
	|ИЗ
	|	ВТ_ОтчетыКомиссионера КАК ВТ_ОтчетыКомиссионера
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Приоритет КАК ВТ_Приоритет
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_СчетФактуры КАК ВТ_СчетФактуры
	|			ПО ВТ_Приоритет.ОтчетКомиссионера = ВТ_СчетФактуры.ОтчетКомиссионера
	|				И ВТ_Приоритет.Приоритет = ВТ_СчетФактуры.Приоритет
	|		ПО ВТ_ОтчетыКомиссионера.Ссылка = ВТ_Приоритет.ОтчетКомиссионера";
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			ОтчетКомиссионера = Выборка.Ссылка.ПолучитьОбъект();
			СтрокаТЧ = ОтчетКомиссионера.Покупатели.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТЧ, Выборка);
						
			Попытка
				ОтчетКомиссионера.ОбменДанными.Загрузка = Истина;
				ОтчетКомиссионера.Записать(РежимЗаписиДокумента.Запись);
			Исключение
				ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки());
			КонецПопытки;
		КонецЦикла;
	КонецЕсли;
	
	#Если Клиент Тогда
		Состояние("");
	#КонецЕсли
	
КонецПроцедуры