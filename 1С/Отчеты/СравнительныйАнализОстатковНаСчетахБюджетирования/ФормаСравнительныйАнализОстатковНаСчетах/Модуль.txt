Перем ВысотаЗаголовка;
Перем ИдентификаторОкнаРасшифровки;
Перем ФормаНастройка;
Перем СтруктураРеквизитов;
Перем НеВосстанавливатьНастройку Экспорт;
Перем СтруктураСвязиЭлементовСДанными;

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Управляет пометками кнопок ком. панели
//
// Параметры:
//	Нет.
//
Процедура УправлениеПометкамиКнопокКоманднойПанели()
	
	Если ПоказыватьЗаголовок Тогда
		ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Заголовок.Пометка = Истина;
		ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Подменю.Кнопки.Заголовок.Пометка = Истина;

	Иначе
		ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Заголовок.Пометка = Ложь;
		ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Подменю.Кнопки.Заголовок.Пометка = Ложь;

	КонецЕсли;
		
КонецПроцедуры // УправлениеПометкамиКнопокКоманднойПанели()

// Обновляет таблицу отчета
//
// Параметры:
//	Нет.
//
Процедура ОбновитьТаблицуОтчета() Экспорт

	СформироватьОтчет(ЭлементыФормы.ДокументРезультат, ПоказыватьЗаголовок, ВысотаЗаголовка);

	Если ЗначениеЗаполнено(ВысотаЗаголовка) Тогда
		ЭлементыФормы.ДокументРезультат.Область(1,,ВысотаЗаголовка).Видимость = ПоказыватьЗаголовок;
	КонецЕсли;
	
	ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.ДокументРезультат;

	УправлениеПометкамиКнопокКоманднойПанели();
	
КонецПроцедуры // ОбновитьОтчет()

//  Управляет выводом заголовка
//
// Параметры:
//	Нет.
//
Процедура ВыводЗаголовка()

	Если ЗначениеЗаполнено(ВысотаЗаголовка) Тогда
		ЭлементыФормы.ДокументРезультат.Область(1,,ВысотаЗаголовка).Видимость = ПоказыватьЗаголовок;
	КонецЕсли;

	УправлениеПометкамиКнопокКоманднойПанели();
	
КонецПроцедуры // ВыводЗаголовка()

// Формирует структуру, в которую складываются настройки
//
Функция СформироватьСтруктуруДляСохраненияНастроек() Экспорт
	
	СтруктНастр = Новый Структура;
	СтруктНастр.Вставить("НастройкиПостроителя", ПостроительОтчета.ПолучитьНастройки());
	СтруктНастр.Вставить("ЗаголовокПомечен", ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Заголовок.Пометка);
	СтруктНастр.Вставить("ТаблицаСценарии", ТаблицаСценарии.Выгрузить());
	СтруктНастр.Вставить("Показатели", Показатели.Выгрузить());
	СтруктНастр.Вставить("ВыводитьАбсолютныеОтклонения", ВыводитьАбсолютныеОтклонения);
	СтруктНастр.Вставить("ВыводитьОтносительныеОтклонения", ВыводитьОтносительныеОтклонения);
	
	Возврат СтруктНастр;
	
КонецФункции

// Заполняет настройки из структуры
//
Процедура ВосстановитьНастройкиИзСтруктуры(СтруктураСНастройками) Экспорт

	ПостроительОтчета.УстановитьНастройки(СтруктураСНастройками.НастройкиПостроителя);
	ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Заголовок.Пометка = СтруктураСНастройками.ЗаголовокПомечен;
	ТаблицаСценарии.Загрузить(СтруктураСНастройками.ТаблицаСценарии);
	Показатели.Загрузить(СтруктураСНастройками.Показатели);
    ВыводитьАбсолютныеОтклонения=СтруктураСНастройками.ВыводитьАбсолютныеОтклонения;
	ВыводитьОтносительныеОтклонения=СтруктураСНастройками.ВыводитьОтносительныеОтклонения;

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ НАЖАТИЯ КНОПОК КОМАНДНОЙ ПАНЕЛИ

// Процедура - обработчик нажатия кнопки "Настройка".
//
Процедура КоманднаяПанельФормыНастройка(Кнопка)
	
	//ВызовСтандартнойНастройки(ЭтаФорма);
	
	ФормаНастройка = ОтчетОбъект.ПолучитьФорму("ФормаНастройка", ЭтаФорма);

	СтруктураСНастройками = СформироватьСтруктуруДляСохраненияНастроек();
	
	РезультатОткрытия = ФормаНастройка.ОткрытьМодально();

	Если РезультатОткрытия = Истина Тогда

		// Если изменились показатели - надо переписывать текст построителя
		// Запоминаем текущую настройку
		Настройки = ПостроительОтчета.ПолучитьНастройки(Истина, Истина, Истина, Истина);

		// Перезаполнение объекта (с новым текстом запроса)
		ЗаполнитьНачальныеНастройки();

		// Восстанавливаем запомненную настройку
		ПостроительОтчета.УстановитьНастройки(Настройки, Истина, Истина, Истина, Истина);
	
		ОбновитьТаблицуОтчета();

	Иначе
		//форму закрыли эскейпом или по "Закрыть" - восстановим настройки, отчет формировать не будем!
		//восстанавливаем значения
		НеВосстанавливатьНастройку = Ложь;
		ВосстановитьНастройкиИзСтруктуры(СтруктураСНастройками);
	КонецЕсли;
	
КонецПроцедуры

// Процедура - обработчик нажатия кнопки "Обновить".
//
Процедура КоманднаяПанельФормыОбновить(Кнопка)

	ОбновитьТаблицуОтчета();

КонецПроцедуры // ВыполнитьНажатие()

// Процедура - обработчик нажатия кнопки "Заголовок".
//
Процедура КоманднаяПанельЗаголовок(Кнопка)
	ПоказыватьЗаголовок = Не ПоказыватьЗаголовок;
	ВыводЗаголовка();
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ


// Процедура - обработчик события перед открытием формы
//
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	Если неВосстанавливатьНастройку<>Истина Тогда
		
		ЗаполнитьНачальныеНастройки();
		
		Если ТипЗнч(СохраненныеНастройки)=Тип("Структура") И ТипЗнч(СохраненныеНастройки.НастройкиПостроителя)=Тип("НастройкиПостроителяОтчета") Тогда
				ПостроительОтчета.УстановитьНастройки(СохраненныеНастройки.НастройкиПостроителя);
		КонецЕсли;

		ВысотаЗаголовка = 0;

		Заголовок=мНазваниеОтчета;
		
	КонецЕсли;
	
КонецПроцедуры // ПередОткрытием()     ЭтотОбъект

// Процедура - обработчик события при открытии формы
//
Процедура ПриОткрытии()
		
	Если НЕ (НеВосстанавливатьНастройку = Истина) Тогда
		
		Если ТипЗнч(СохраненныеНастройки) = Тип("Структура") Тогда

			//Это, что выше, не работает при еще не открытой форме.
			УправлениеПометкамиКнопокКоманднойПанели();

		КонецЕсли;
	Иначе
		//в следующий раз настройку мы все-таки восстановим - форма уже открыта...
		НеВосстанавливатьНастройку = Ложь;
		
	КонецЕсли;
		
	УправлениеПометкамиКнопокКоманднойПанели();
	
КонецПроцедуры

// Процедура - обработчик события перед сохранением значений формы
//
Процедура ПередСохранениемЗначений(Отказ)

	СохраненныеНастройки = СформироватьСтруктуруДляСохраненияНастроек();

КонецПроцедуры // ПередСохранениемЗначений()

// Процедура - обработчик события после восстановления значений формы
//
Процедура ПослеВосстановленияЗначений()

	Если НеВосстанавливатьНастройку<>Истина Тогда

		Если ТипЗнч(СохраненныеНастройки) = Тип("Структура") Тогда

			ВосстановитьНастройкиИзСтруктуры(СохраненныеНастройки);

			ЗаполнитьНачальныеНастройки();
			
			Если ТипЗнч(СохраненныеНастройки.НастройкиПостроителя)=Тип("НастройкиПостроителяОтчета") Тогда
				ПостроительОтчета.УстановитьНастройки(СохраненныеНастройки.НастройкиПостроителя);
			КонецЕсли;
			
			Если Открыта() Тогда
				//Это, что выше, не работает при еще не открытой форме.
				УправлениеПометкамиКнопокКоманднойПанели();
			КонецЕсли;
			
			Заголовок=мНазваниеОтчета;

		КонецЕсли;

	КонецЕсли; 

КонецПроцедуры // ПослеВосстановленияЗначений()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ

// Процедура - обработчик события "Обработка расшифровки" поля табличного документа ДокументРезультат
//
Процедура ДокументРезультатОбработкаРасшифровки(Элемент, РасшифровкаСтроки, СтандартнаяОбработка)
	
	Если Элемент.ТекущаяОбласть.Лево>2 Тогда
		
		РасшифровкаСтроки=Элемент.Область(Элемент.ТекущаяОбласть.Верх, 1).Расшифровка;
		
		Если ТипЗнч(РасшифровкаСтроки) = Тип("Структура") Тогда
			
			// Расшифровка колонки находится в заголовке колонки
			РасшифровкаКолонки = Элемент.Область(ВысотаЗаголовка+1, Элемент.ТекущаяОбласть.Лево).Расшифровка;
			
			Расшифровка = Новый Структура;
			
			Для каждого Строка Из РасшифровкаСтроки Цикл
				
				Расшифровка.Вставить(Строка.Ключ, Строка.Значение);
				
			КонецЦикла;
			
			Если ТипЗнч(РасшифровкаКолонки) = Тип("Структура") Тогда
				
				Для каждого Строка Из РасшифровкаКолонки Цикл
					Расшифровка.Вставить(Строка.Ключ, Строка.Значение);
				КонецЦикла;
				
			КонецЕсли;
			
			ОбработкаРасшифровкиОтчетаБюджетирования(Расшифровка, СтандартнаяОбработка, ОтчетОбъект);
			
		ИначеЕсли ТипЗнч(Элемент.ТекущаяОбласть.Расшифровка) = Тип("Структура") Тогда
			
			СтандартнаяОбработка=Ложь;
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры // ДокументРезультатОбработкаРасшифровки()