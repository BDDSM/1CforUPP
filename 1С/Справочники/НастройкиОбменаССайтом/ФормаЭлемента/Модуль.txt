Перем мЖирныйШрифт;
Перем мОбычныйШрифт;

////////////////////////////////////////////////////////////////////////////////
// СЕРВИСНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

Процедура УстановитьДоступностьИВидимостьЭлементовФормы()
	
	ЭлементыФормы.ПанельОсновная.Страницы.ВыгрузкаТоваров.Видимость = ОбменТоварами;
	ЭлементыФормы.ПанельОсновная.Страницы.ОбменЗаказами.Видимость = ОбменЗаказами;
	
	Если ВыгружатьНаСайт Тогда
		
		ЭлементыФормы.ПанельНазначение.ТекущаяСтраница = ЭлементыФормы.ПанельНазначение.Страницы.СтраницаСайт;	
		
	Иначе
		
		ЭлементыФормы.ПанельНазначение.ТекущаяСтраница = ЭлементыФормы.ПанельНазначение.Страницы.СтраницаКаталог;	
				
	КонецЕсли;
	
	// параметры соединения
	ЭлементыФормы.НадписьСерверПрокси.Доступность = HTTPОбменПроксиИспользование;
	ЭлементыФормы.HTTPОбменПроксиСервер.Доступность = HTTPОбменПроксиИспользование;
	
	ЭлементыФормы.НадписьПортПрокси.Доступность = HTTPОбменПроксиИспользование;
	ЭлементыФормы.HTTPОбменПроксиПорт.Доступность = HTTPОбменПроксиИспользование;
	
	ЭлементыФормы.НадписьИмяПользователяПрокси.Доступность = HTTPОбменПроксиИспользование;
	ЭлементыФормы.HTTPОбменПроксиИмяПользователя.Доступность = HTTPОбменПроксиИспользование;
	
	ЭлементыФормы.НадписьПарольПрокси.Доступность = HTTPОбменПроксиИспользование;
	ЭлементыФормы.HTTPОбменПроксиПароль.Доступность = HTTPОбменПроксиИспользование;
	
	// доступность узла обмена	
	Если ОбменТоварами И ВыгружатьТолькоИзменения Тогда
		ЭлементыФормы.ПанельУзелТовары.Свертка = РежимСверткиЭлементаУправления.Нет;	
	Иначе
		ЭлементыФормы.ПанельУзелТовары.Свертка = РежимСверткиЭлементаУправления.Верх;	
	КонецЕсли;
	
	Если ОбменЗаказами И ВыгружатьТолькоИзменения Тогда
		ЭлементыФормы.ПанельУзелЗаказы.Свертка = РежимСверткиЭлементаУправления.Нет;	
	Иначе
		ЭлементыФормы.ПанельУзелЗаказы.Свертка = РежимСверткиЭлементаУправления.Верх;	
	КонецЕсли;
	
	ЭлементыФормы.ПереключательПроводитьОперативно.Видимость = ПроводитьДокументы;
	ЭлементыФормы.ПереключательПРоводитьНеОперативно.Видимость = ПроводитьДокументы;	
	
	УстановитьТекстНадписиРегламентнойНастройки();
		
Конецпроцедуры

Процедура ВыполнитьОбменЕслиВозможно()
	
	Если Модифицированность ИЛИ ЭтоНовый() Тогда
		
		Ответ = Вопрос("Для проведения обмена необходимо сохранить настройку. Сохранить изменения?", РежимДиалогаВопрос.ДаНет);
		
		Если НЕ Ответ = КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли;
		
		Если НЕ ЗаписатьВФорме() Тогда
			Возврат;
		КонецЕсли;
		
	КонецЕсли; 
	
	ПроцедурыОбменаССайтом.ВыполнитьАвтообмен(Ссылка, Ложь);
	
КонецПроцедуры	

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ПриОткрытии()
	
	ПроцедурыОбменаССайтом.НастроитьПостроительОтчета(ПостроительОтчета);
		
	Если ЭтоНовый()
		И НЕ ЗначениеЗаполнено(ПараметрОбъектКопирования) Тогда
		
		ЗаполнитьПоУмолчанию();
	    ПроцедурыОбменаССайтом.ЗаполнитьОтборПостроителя(ПостроительОтчета);
		
	Иначе
		
		ТаблицаОтбора = СохраненныеНастройкиПостроителя.Получить();
		ПроцедурыОбменаССайтом.ЗаполнитьОтборПостроителя(ПостроительОтчета);

		Если ТаблицаОтбора <> Неопределено Тогда 
			ОбщегоНазначения.ЗаполнитьОтборПоТаблицеЗначений(ПостроительОтчета.Отбор, ТаблицаОтбора);
		КонецЕсли;	
		
	КонецЕсли;	
	
	УстановитьЗначенияПеременныхРегламентныхНастроек();
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
	ОбновитьДоступностьАвтообмена();
	
КонецПроцедуры

Процедура ПереключательПолнаяВыгрузкаПриИзменении(Элемент)
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
КонецПроцедуры

Процедура ПереключательВыгрузкаИзмененийПриИзменении(Элемент)
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
КонецПроцедуры

Процедура УзелПланаОбменаПриИзменении(Элемент)
	
	Если Не ЗначениеЗаполнено(УзелОбменаТоварами) Тогда
		Возврат;
	КонецЕсли;
	
	Если УзелОбменаТоварами = ПланыОбмена.ОбменССайтомТоварами.ЭтотУзел() Тогда
		
		Сообщить("Выбранный узел соответствует текущей информационной базе. Выберите другой узел или создайте новый.");
		УзелОбменаТоварами = Неопределено;
		
	КонецЕсли;	
		
КонецПроцедуры

Процедура КаталогВыгрузкиНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	
	ДиалогВыбора.Заголовок 				 	 = "Выберите каталог для обмена данными";
	ДиалогВыбора.ПредварительныйПросмотр 	 = Ложь;
    ДиалогВыбора.Каталог 				 	 = Элемент.Значение;
	ДиалогВыбора.ПроверятьСуществованиеФайла = Истина;
	
	Если ДиалогВыбора.Выбрать() Тогда
		Элемент.Значение = ДиалогВыбора.Каталог;
	КонецЕсли;
	
КонецПроцедуры

Процедура КаталогВыгрузкиОткрытие(Элемент, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Элемент.Значение) Тогда
		ЗапуститьПриложение("explorer " + Элемент.Значение);
	КонецЕсли;	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ)
	
	ТаблицаОтбора = УправлениеОтчетами.ПолучитьКопиюОтбораВТЗ(ПостроительОтчета.Отбор);
	
	СохраненныеНастройкиПостроителя = Новый ХранилищеЗначения(ТаблицаОтбора);
	
	ЭтоФайловаяИБ = ОпределитьЭтаИнформационнаяБазаФайловая();
	
	Если ЭтоФайловаяИБ Тогда
		
		ПользовательДляВыполненияРеглЗаданий = Константы.ПользовательДляВыполненияРегламентныхЗаданийВФайловомВарианте.Получить();
		
		Если ИспользоватьРегламентныеЗадания
			И НЕ ЗначениеЗаполнено(ПользовательДляВыполненияРеглЗаданий) Тогда
			
			Сообщить("Не установлена константа ""Пользователь, для выполнения регламентных заданий в файловом режиме"". Периодический обмен выполняться не будет!", СтатусСообщения.ОченьВажное);
			
		КонецЕсли;
		
	КонецЕсли;
	
	// для помеченой на удаление настройки обмен автоматически не производится
	Если (ПометкаУдаления И ИспользоватьРегламентныеЗадания) Тогда
			
		Сообщить("Настройка помечена на удаление. Автоматический обмен по ней производится не будет!", СтатусСообщения.Важное);	
					
	КонецЕсли;
	
КонецПроцедуры

Процедура ДействияФормыДействиеВыполнитьОбмен(Кнопка)
	
	ВыполнитьОбменЕслиВозможно();
	
КонецПроцедуры
 
Процедура ПереключательНазначениеСайтПриИзменении(Элемент)
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
КонецПроцедуры

Процедура ПроверитьНажатие(Элемент)
	
	ДополнительнаяИнформация = "";
	ТекстСообщенияПользователю = ПроцедурыОбменаССайтом.ВыполнитьТестовоеПодключениеКСерверуHTTP(ЭтотОбъект, ДополнительнаяИнформация);
	
	Если Не ПустаяСтрока(ДополнительнаяИнформация) Тогда 
		
		Сообщить(ДополнительнаяИнформация);
		
	КонецЕсли;
	
	Предупреждение(ТекстСообщенияПользователю);	
		
КонецПроцедуры

Процедура ФлажокИспользоватьПроксиСерверПриИзменении(Элемент)
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
КонецПроцедуры

Процедура ПереключательЗаписыватьПриИзменении(Элемент)
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
КонецПроцедуры

Процедура ОбновитьДоступностьАвтообмена()
	
	ЭлементыФормы.НастройкаРегламентногоЗадания.Доступность = ИспользоватьРегламентныеЗадания;
	ЭлементыФормы.НадписьРасписаниеРегламентногоЗаданияНастройки.Доступность = ИспользоватьРегламентныеЗадания;	
	
КонецПроцедуры


Процедура УстановитьТекстНадписиРегламентнойНастройки()
	
	Перем ТекстЗаголовка, ТекстРасписания, РассписаниеАктивно;
	
	ПроцедурыОбменаДаннымиКлиент.ПолучитьТекстЗаголовкаИРасписанияРегламентнойНастройки(мРегламентноеЗадание, ТекстЗаголовка, ТекстРасписания, РассписаниеАктивно);
	ЭлементыФормы.НастройкаРегламентногоЗадания.Заголовок = ТекстЗаголовка;
	ЭлементыФормы.НадписьРасписаниеРегламентногоЗаданияНастройки.Заголовок = ТекстРасписания;
	ЭлементыФормы.НадписьРасписаниеРегламентногоЗаданияНастройки.Шрифт = ?(РассписаниеАктивно И ИспользоватьРегламентныеЗадания, мЖирныйШрифт, мОбычныйШрифт);	
	
КонецПроцедуры

Процедура ИспользоватьРегламентныеЗаданияПриИзменении(Элемент)

	ОбновитьДоступностьАвтообмена();
	
	УстановитьТекстНадписиРегламентнойНастройки();
	
	Если ИспользоватьРегламентныеЗадания Тогда
		
		НадписьРасписаниеРегламентногоЗаданияНажатие(ЭлементыФормы.НадписьРасписаниеРегламентногоЗаданияНастройки);
		
	Конецесли;
	
КонецПроцедуры

Процедура НадписьРасписаниеРегламентногоЗаданияНажатие(Элемент)
	
	РедактированиеРасписанияРегламентногоЗадания(мРегламентноеЗадание, РегламентноеЗадание);
		
КонецПроцедуры


Процедура РедактированиеРасписанияРегламентногоЗадания(ОбъектЗадания, РеквизитЗадания)
	
	Если ОбъектЗадания = Неопределено Тогда
		
		ОбъектЗадания = ПолучитьОбъектРегламентногоЗадания();		
			
	КонецЕсли;
	
	Если ОбъектЗадания = Неопределено Тогда
		
		ОбъектЗадания = РегламентныеЗадания.СоздатьРегламентноеЗадание("ЗаданиеОбменССайтом");
				
		ОбъектЗадания.Наименование = Наименование;
		ОбъектЗадания.Использование = Истина;
	        		
	КонецЕсли;
	
	// редактирование самого расписания непосредственно
	Диалог = Новый ДиалогРасписанияРегламентногоЗадания(ОбъектЗадания.Расписание);
		
	Если Диалог.ОткрытьМодально() Тогда
		
		ОбъектЗадания.Расписание = Диалог.Расписание;
		ОбъектЗадания.Записать();
		РеквизитЗадания = Строка(ОбъектЗадания.УникальныйИдентификатор);
		
	Иначе
		
		ОбъектЗадания = ПолучитьОбъектРегламентногоЗадания();
		
	КонецЕсли;
	
	УстановитьТекстНадписиРегламентнойНастройки();	
	
КонецПроцедуры

Процедура НадписьРасписаниеРегламентногоЗаданияНастройкиНажатие(Элемент)
	
	РедактированиеРасписанияРегламентногоЗадания(мРегламентноеЗадание, РегламентноеЗадание);
		
КонецПроцедуры

Процедура РедактироватьНастройкиРегламентногоЗадания(ОбъектЗадания, РеквизитЗадания)
	
	Если ОбъектЗадания = Неопределено Тогда
		
		ОбъектЗадания = ПолучитьОбъектРегламентногоЗадания();				
			
	КонецЕсли;
	
	Диалог = ПолучитьОбщуюФорму("ДиалогРегламентногоЗадания");
	Диалог.РегламентноеЗадание = ОбъектЗадания;
	Диалог.Наименование = Наименование;
	Диалог.МетаданныеВыбор = "ЗаданиеОбменССайтом";
	
	Если Диалог.ОткрытьМодально() <> Истина Тогда
		
		ОбъектЗадания = ПолучитьОбъектРегламентногоЗадания();
				
	Иначе
		
		Модифицированность = Истина;
		ОбъектЗадания = Диалог.РегламентноеЗадание;
				
	КонецЕсли;	
	
	Если ОбъектЗадания <> Неопределено Тогда
		
		РеквизитЗадания = Строка(ОбъектЗадания.УникальныйИдентификатор);
		
	КонецЕсли;
	
	УстановитьТекстНадписиРегламентнойНастройки();	
	
КонецПроцедуры
 
Процедура НастройкаРегламентногоЗаданияНажатие(Элемент)
	
	РедактироватьНастройкиРегламентногоЗадания(мРегламентноеЗадание, РегламентноеЗадание);
	
КонецПроцедуры

Процедура ПослеЗаписи()
	
	Если ВладелецФормы <> Неопределено Тогда
		
		ОповеститьОЗаписиНовогоОбъекта(Ссылка);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ДействияФормыОткрытьМониторОбменов(Кнопка)
	
	Если ЭтоНовый() Тогда
		Возврат;
	КонецЕсли;
	
	ПроцедурыОбменаДаннымиКлиент.ОткрытьМониторОбменовДляНастройки(Ссылка, ЭтаФорма);
	
КонецПроцедуры

Процедура НадписьСсылкаНаСайтНажатие(Элемент)
	
	ЗапуститьПриложение("http://www.1c-bitrix.ru/1c/");
	
КонецПроцедуры

Процедура ПолеКартинкиЛоготипНажатие(Элемент)
	
	ЗапуститьПриложение("http://www.1c-bitrix.ru");
	
КонецПроцедуры

Процедура НадписьНадписьПодробнееОСтандартеCML2Нажатие(Элемент)
	
	ЗапуститьПриложение("http://www.commerceml.ru/standard.htm");
	
КонецПроцедуры

Процедура НадписьНадписьПодробнееОТехнологииОбменаНажатие(Элемент)
	
	ЗапуститьПриложение("http://www.v8.1c.ru/edi/edi_app/130");	
	
КонецПроцедуры

Процедура ОбменТоварамиПриИзменении(Элемент)
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
КонецПроцедуры

Процедура ОбменЗаказамиПриИзменении(Элемент)
	
	УстановитьДоступностьИВидимостьЭлементовФормы();
	
КонецПроцедуры

Процедура УзелОбменаЗаказамиПриИзменении(Элемент)
	
	Если Не ЗначениеЗаполнено(УзелОбменаЗаказами) Тогда
		Возврат;
	КонецЕсли;
	
	Если УзелОбменаЗаказами = ПланыОбмена.ОбменССайтомЗаказами.ЭтотУзел() Тогда
		
		Сообщить("Выбранный узел соответствует текущей информационной базе. Выберите другой узел или создайте новый.");
		УзелОбменаЗаказами = Неопределено;
		
	КонецЕсли;	
	
КонецПроцедуры

мРегламентноеЗадание = Неопределено;

мЖирныйШрифт = Новый Шрифт(,,Истина);
мОбычныйШрифт = Новый Шрифт();